<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ä¸²ä¸€ä¸²</title>
  
  <subtitle>æ–­èˆç¦»</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://luxiaowan.github.io/"/>
  <updated>2020-04-27T15:30:46.963Z</updated>
  <id>http://luxiaowan.github.io/</id>
  
  <author>
    <name>cc</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>èŠä¸€èŠMySQLäº‹åŠ¡</title>
    <link href="http://luxiaowan.github.io/2020/04/27/%E8%81%8A%E4%B8%80%E8%81%8AMySQL%E4%BA%8B%E5%8A%A1/"/>
    <id>http://luxiaowan.github.io/2020/04/27/èŠä¸€èŠMySQLäº‹åŠ¡/</id>
    <published>2020-04-27T07:30:00.000Z</published>
    <updated>2020-04-27T15:30:46.963Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-äº‹åŠ¡ä¸ºä½•ç‰©"><a class="markdownIt-Anchor" href="#ä¸€-äº‹åŠ¡ä¸ºä½•ç‰©"></a> ä¸€ã€äº‹åŠ¡ä¸ºä½•ç‰©</h3><p>äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯ä¿éšœç¨‹åºä¸­ä¸€ç»„æ“ä½œçš„åŸå­æ€§çš„çº¦æŸï¼Œå®ƒä½¿äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½æŒ‡å‘åŒä¸€ä¸ªç»“æœï¼Œä¹Ÿå°±æ˜¯è¦ä¹ˆæ‰€æœ‰çš„æ“ä½œéƒ½æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œéƒ½æ‰§è¡Œå¤±è´¥ï¼Œä¸å…è®¸å‡ºç°å…¶ä»–ç»“æœã€‚ä¾‹å¦‚é“¶è¡Œè½¬è´¦ï¼Œä»Aè´¦æˆ·æ‰£é™¤é‡‘é¢ï¼Œå‘Bè´¦æˆ·æ·»åŠ é‡‘é¢ï¼Œè¿™ä¸¤ä¸ªæ•°æ®åº“æ“ä½œçš„æ€»å’Œæ„æˆä¸€ä¸ªå®Œæ•´çš„é€»è¾‘è¿‡ç¨‹ï¼Œä¸å¯æ‹†åˆ†ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºä¸€ä¸ªäº‹åŠ¡ã€‚åœ¨MySQLä¸­ï¼Œç›®å‰åªæœ‰InnoDBå¼•æ“æ”¯æŒäº‹åŠ¡ã€‚</p><h3 id="äºŒ-äº‹åŠ¡çš„ç‰¹æ€§"><a class="markdownIt-Anchor" href="#äºŒ-äº‹åŠ¡çš„ç‰¹æ€§"></a> äºŒã€äº‹åŠ¡çš„ç‰¹æ€§</h3><p>æ•°æ®åº“ç®¡ç†ç³»ç»Ÿåœ¨å†™å…¥æˆ–æ›´æ–°æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºä¿è¯äº‹åŠ¡æ˜¯æ­£ç¡®å¯é çš„ï¼Œéœ€è¦å…·å¤‡å››ä¸ªç‰¹æ€§ï¼šåŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰å’ŒæŒä¹…æ€§ï¼ˆDurabilityï¼‰ã€‚</p><ul><li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šä¸€ä¸ªäº‹ç‰©ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸ä¼šåœ¨ä¸­é—´æŸä¸ªç¯èŠ‚ç»“æŸã€‚è‹¥äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½ä¼šè¢«å›æ»šåˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»æ²¡æ‰§è¡Œè¿‡ä¸€æ ·ã€‚</li><li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡æ“ä½œçš„æ•°æ®ä»ä¸€ä¸ªçŠ¶æ€è½¬æ¢ä¸ºå¦ä¸€ä¸ªçŠ¶æ€ï¼Œä½†æ˜¯å¯¹äºæ•´ä¸ªæ•°æ®çš„å®Œæ•´æ€§ä¿æŒç¨³å®šï¼Œä¹Ÿå°±æ˜¯åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œç»“æŸä¹‹åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚</li><li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ•°æ®åº“å…è®¸å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œï¼Œéš”ç¦»æ€§æ˜¯ä¸ºäº†é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ï¼Œäº‹åŠ¡ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚äº‹åŠ¡éš”ç¦»æœ‰å››ç§çº§åˆ«ï¼šæœªæäº¤è¯»ï¼ˆRead UnCommittedï¼‰ã€å·²æäº¤è¯»ï¼ˆRead Commitedï¼‰ã€å¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰ã€ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰</li><li>æŒä¹…æ€§ï¼šäº‹åŠ¡æˆåŠŸæäº¤ä¹‹åï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä¾¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</li></ul><h3 id="ä¸‰-ä¸ºä»€ä¹ˆè¦æœ‰å››ç§éš”ç¦»çº§åˆ«"><a class="markdownIt-Anchor" href="#ä¸‰-ä¸ºä»€ä¹ˆè¦æœ‰å››ç§éš”ç¦»çº§åˆ«"></a> ä¸‰ã€ä¸ºä»€ä¹ˆè¦æœ‰å››ç§éš”ç¦»çº§åˆ«</h3><p>SQLæ ‡å‡†å®šä¹‰äº†4ç§éš”ç¦»çº§åˆ«ç”¨æ¥é™å®šä¸åŒçš„äº‹åŠ¡åœºæ™¯ï¼ŒæŒ‰ç…§éš”ç¦»çº§åˆ«ä»ä½åˆ°é«˜ä¸ºï¼šè¯»æœªæäº¤ã€è¯»å·²æäº¤ã€å¯é‡å¤è¯»ã€ä¸²è¡ŒåŒ–ï¼Œçº§åˆ«è¶Šé«˜ï¼Œæ‰€æ”¯æŒçš„å¹¶å‘åº¦è¶Šä½ã€‚</p><blockquote><p>ä¸åŒçš„éš”ç¦»çº§åˆ«ä¼šé€ æˆä¸åŒçš„å½±å“ï¼Œä½“ç°åœ¨æ•°æ®ä¸Šå°±æ˜¯è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚</p></blockquote><ul><li>è„è¯»ï¼šAäº‹åŠ¡è¯»å–äº†Bäº‹åŠ¡ä¸­æœªæäº¤çš„æ•°æ®ï¼Œåœ¨Aäº‹åŠ¡æäº¤ä¹‹å‰ï¼ŒBäº‹åŠ¡è¿›è¡Œäº†å›æ»šï¼Œæ­¤æ—¶Aäº‹åŠ¡ä¸­çš„æ•°æ®å°±ä¸æ­£ç¡®äº†ï¼Œæ‰€ä»¥è¢«å®šä¹‰ä¸ºè„æ•°æ®ã€‚</li><li>ä¸å¯é‡å¤è¯»ï¼šAäº‹åŠ¡åœ¨ç¬¬ä¸€æ¬¡è¯»å–ä¹‹ååˆ°ç¬¬äºŒæ¬¡è¯»å–ä¹‹å‰ï¼ŒBäº‹åŠ¡å¯¹è¯¥æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œå¯¼è‡´Aäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™å°±æ˜¯ä¸å¯é‡å¤è¯»</li><li>å¹»è¯»ï¼šå¹»è¯»ä¸€èˆ¬å‘ç”Ÿåœ¨èŒƒå›´æŸ¥è¯¢çš„æƒ…å†µä¸‹ï¼ŒAäº‹åŠ¡ç¬¬ä¸€æ¬¡è¯»å–ä¸€æ‰¹æ•°æ®ï¼Œåœ¨ç¬¬äºŒæ¬¡è¯»å–ä¹‹å‰ï¼ŒBäº‹åŠ¡å‘æ•°æ®åº“ä¸­æ’å…¥äº†æ–°çš„ç¬¦åˆAäº‹åŠ¡æŸ¥è¯¢æ¡ä»¶çš„æ•°æ®ï¼Œæ­¤æ—¶Aäº‹åŠ¡ç¬¬äºŒæ¬¡è¯»å–å‡ºæ¥çš„æ•°æ®æ¡æ•°ä¸ä¸€è‡´ï¼Œè¿™ç§æƒ…å†µå¯¹äºAäº‹åŠ¡æ¥è¯´å°±æ˜¯å‡ºç°äº†å¹»è¯»ã€‚</li></ul><blockquote><p>äº‹åŠ¡éš”ç¦»çº§åˆ«</p></blockquote><ul><li>è¯»æœªæäº¤ï¼ˆRead UnCommittedï¼‰ï¼šè¯¥éš”ç¦»çº§åˆ«ä¸‹çš„äº‹åŠ¡å¯ä»¥çœ‹åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ‰§è¡Œç»“æœï¼Œä¼šå¼•èµ·è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼Œåœ¨å®é™…åº”ç”¨ä¸­å‡ ä¹ä¸ä¼šä½¿ç”¨è¯¥çº§åˆ«çš„äº‹åŠ¡ã€‚</li><li>è¯»å·²æäº¤ï¼ˆRead Committedï¼‰ï¼šè¿™æ˜¯å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆå¦‚Oracleã€é˜¿é‡Œäº‘çš„MySQLï¼‰ç­‰ï¼Œä½†ä¸æ˜¯å®˜æ–¹MySQLé»˜è®¤çš„ã€‚å®ƒä¸å…è®¸äº‹åŠ¡çœ‹åˆ°æœªæäº¤çš„äº‹åŠ¡ä¸­çš„æ•°æ®ï¼Œä½¿äº‹åŠ¡åªèƒ½çœ‹è§å·²ç»æäº¤çš„äº‹åŠ¡æ‰€åšçš„æ”¹å˜ã€‚è¯¥éš”ç¦»çº§åˆ«ä¼šå¼•èµ·ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚</li><li>å¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰ï¼šè¿™æ˜¯å®˜æ–¹MySQLçš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå®ƒç¡®ä¿åŒä¸€äº‹åŠ¡å¤šæ¬¡è¯»å–çš„æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚è¯¥éš”ç¦»çº§åˆ«è§£å†³çš„ä¸»è¦æ˜¯å¯¹æ•°æ®åº“è¿›è¡ŒUPDATEæ“ä½œé€ æˆçš„æ•°æ®æ”¹å˜ï¼Œä½†è¿˜æ˜¯ä¼šå¼•èµ·å¹»è¯»çš„æƒ…å†µå‘ç”Ÿï¼Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸‹é»˜è®¤æä¾›MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æœºåˆ¶è§£å†³äº†å¹»è¯»çš„é—®é¢˜ã€‚</li><li>ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ï¼šè¿™æ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œä¸²è¡Œçš„æ„æ€ä¹Ÿå°±æ˜¯æ¯æ¬¡åªå…è®¸ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼Œäº‹åŠ¡æŒ‰ç…§å…ˆæ¥ååˆ°çš„è§„åˆ™è¿›è¡Œæ’é˜Ÿä¸€æ¬¡æ‰§è¡Œï¼Œè¿™æ ·åœ¨äº‹åŠ¡ä¹‹é—´å°±ä¸ä¼šç›¸äº’å†²çªï¼Œä»è€Œè§£å†³äº†å¹»è¯»çš„é—®é¢˜ã€‚ä½†æ˜¯ä¸²è¡ŒåŒ–æ‰§è¡Œäº‹åŠ¡çš„æ–¹å¼ä¼šä¸¥é‡å½±å“äº‹åŠ¡çš„æ‰§è¡Œæ•ˆç‡ï¼Œé«˜å¹¶å‘æ“ä½œä¸‹ä¼šé€ æˆäº‹åŠ¡å †ç§¯å’Œè¶…æ—¶ï¼Œä¸€èˆ¬åœ¨å®é™…åº”ç”¨ä¸­å¾ˆå°‘ä½¿ç”¨ï¼Œè™½ç„¶å®ƒå¾ˆå®‰å…¨ã€‚</li></ul><p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬äº†è§£äº†äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä¹ŸçŸ¥é“æ¯ç§éš”ç¦»çº§åˆ«æ‰€è§£å†³çš„äº‹æƒ…ï¼Œåšä¸€ä¸‹æ±‡æ€»ï¼š</p><table><thead><tr><th style="text-align:center">äº‹åŠ¡éš”ç¦»çº§åˆ«</th><th style="text-align:center">è„è¯»</th><th style="text-align:center">ä¸å¯é‡å¤è¯»</th><th style="text-align:center">å¹»è¯»</th></tr></thead><tbody><tr><td style="text-align:center">è¯»æœªæäº¤</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td></tr><tr><td style="text-align:center">è¯»å·²æäº¤</td><td style="text-align:center">N</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td></tr><tr><td style="text-align:center">å¯é‡å¤è¯»</td><td style="text-align:center">N</td><td style="text-align:center">N</td><td style="text-align:center">Y</td></tr><tr><td style="text-align:center">ä¸²è¡ŒåŒ–</td><td style="text-align:center">N</td><td style="text-align:center">N</td><td style="text-align:center">N</td></tr></tbody></table><h3 id="å››-å¦‚ä½•æŸ¥çœ‹å’Œè®¾ç½®æ•°æ®åº“çš„éš”ç¦»çº§åˆ«"><a class="markdownIt-Anchor" href="#å››-å¦‚ä½•æŸ¥çœ‹å’Œè®¾ç½®æ•°æ®åº“çš„éš”ç¦»çº§åˆ«"></a> å››ã€å¦‚ä½•æŸ¥çœ‹å’Œè®¾ç½®æ•°æ®åº“çš„éš”ç¦»çº§åˆ«</h3><ol><li><p>æŸ¥çœ‹æ•°æ®åº“å½“å‰çš„äº‹åŠ¡éš”ç¦»çº§åˆ«</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select @@tx_isolation</span><br></pre></td></tr></table></figure><p><img src="/images/image-20200427173518185.png" alt="image-20200427173518185"></p></li><li><p>ä¿®æ”¹æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«</p><p>ä¿®æ”¹è¯­å¥æ ¼å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set [global | session] transaction isolation level [read uncommitted | read committed | repeatable read | serializable]</span><br></pre></td></tr></table></figure><p><code>session</code>ï¼šå½“å‰sessionå†…çš„äº‹åŠ¡</p><p><code>global</code>ï¼šåº”ç”¨äºä¹‹åæ–°åˆ›å»ºçš„sessionï¼Œå·²ç»å­˜åœ¨çš„sessionä¸å—å½±å“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set session transaction isolation level read committed</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å½“å‰çš„éš”ç¦»çº§åˆ«å·²ç»è¢«ä¿®æ”¹ä¸ºRCäº†ã€‚</p><p><img src="/images/image-20200427174522929.png" alt="image-20200427174522929"></p></li></ol><h3 id="äº”-å°"><a class="markdownIt-Anchor" href="#äº”-å°"></a> äº”ã€å°ğŸŒ°</h3><ol><li><p>åˆ›å»ºä¸€å¼ è¡¨å¤‡ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create table cc_isolation_test</span><br><span class="line">(</span><br><span class="line">    id   int auto_increment primary key,</span><br><span class="line">    name varchar(30) null</span><br><span class="line">) engine=innodb default charset=utf8</span><br><span class="line">    comment &apos;äº‹åŠ¡éš”ç¦»çº§åˆ«æµ‹è¯•è¡¨&apos;;</span><br><span class="line"></span><br><span class="line"># æ’å…¥ä¸€æ¡æ•°æ®</span><br><span class="line">insert into cc_isolation_test(name) values(&apos;cc&apos;);</span><br></pre></td></tr></table></figure></li><li><p>RUçº§åˆ«</p><ul><li><p>ä¿®æ”¹sessionçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºRU</p><p>æ‰“å¼€ä¸¤ä¸ªsessionçª—å£ï¼Œå°†äº‹åŠ¡éš”ç¦»çº§åˆ«å‡ä¿®æ”¹ä¸ºRUã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ä¿®æ”¹éš”ç¦»çº§åˆ«ä¸ºRU</span><br><span class="line">set session transaction isolation level read uncommitted ;</span><br><span class="line"># éªŒè¯</span><br><span class="line">select @@tx_isolation;</span><br></pre></td></tr></table></figure><p><img src="/images/image-20200427184245389.png" alt="image-20200427184245389"></p></li><li><p>è„è¯»éªŒè¯</p><ol><li><p>åœ¨ä¸¤ä¸ªçª—å£ä¸­å‡å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œåœ¨Aäº‹åŠ¡ä¸­è¿›è¡ŒæŸ¥è¯¢æ“ä½œï¼Œåœ¨Bäº‹åŠ¡ä¸­è¿›è¡Œæ›´æ–°æ“ä½œä½†ä¸æäº¤</p></li><li><p>Aäº‹åŠ¡ï¼šè¿›è¡ŒæŸ¥è¯¢æ“ä½œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">select * from cc_isolation_test;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶æŸ¥åˆ°çš„æ•°æ®ä¸ºæ­£å¸¸æ•°æ®ï¼š</p><img src="/images/image-20200427185221292.png" alt="image-20200427185221292" style="zoom:50%;"></li><li><p>Bäº‹åŠ¡ï¼šè¿›è¡Œæ›´æ–°æ“ä½œä½†ä¸æäº¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">update cc_isolation_test set name=&apos;cc1&apos; where id=1;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œä¹‹åå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„è¡¨ä¸­ï¼Œæ•°æ®æ˜¯æœªè¢«ä¿®æ”¹çš„ï¼Œå› ä¸ºBäº‹åŠ¡å°šæœªæäº¤</p><img src="/images/image-20200427190836436.png" alt="image-20200427190836436" style="zoom:50%;"></li><li><p>Aäº‹åŠ¡ï¼šå†æ¬¡è¿›è¡ŒæŸ¥è¯¢æ“ä½œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from cc_isolation_test;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427190607659.png" alt="image-20200427190607659" style="zoom:50%;"><p>æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®ä¸­ï¼Œnameç«Ÿç„¶å˜æˆäº†cc1ï¼Œä¹Ÿå°±æ˜¯è¯´Aäº‹åŠ¡ä¸­è¯»å–åˆ°äº†Bäº‹åŠ¡ä¸­å°šæœªæäº¤çš„æ•°æ®ï¼Œå¦‚æœæ­¤æ—¶Bäº‹åŠ¡å›æ»šï¼ŒAäº‹åŠ¡ä¸­nameçš„å€¼ä»ç„¶æ˜¯è¯»åˆ°çš„cc1ï¼Œä¹Ÿå°±å‡ºç°äº†è„æ•°æ®ï¼Œæ‰€ä»¥RUçº§åˆ«ä¸‹ä¼šå‡ºç°è„è¯»çš„é—®é¢˜ã€‚</p></li><li><p>å›¾è§£</p><table><thead><tr><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>start transaction;</td><td>start transaction;</td></tr><tr><td>select * from cc_isolation_test;</td><td></td></tr><tr><td></td><td>update cc_isolation_test set name=â€˜cc1â€™ where id=1;</td></tr><tr><td>select * from cc_isolation_test;</td><td></td></tr><tr><td></td><td>rollback;</td></tr><tr><td>commit;</td><td></td></tr></tbody></table></li></ol></li><li><p>ä¸å¯é‡å¤è¯»éªŒè¯</p><p>ä¸Šé¢æ¼”ç¤ºè„è¯»çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨Aäº‹åŠ¡ä¸­å¯¹æ•°æ®è¿›è¡Œäº†ä¸¤æ¬¡è¯»å–ï¼Œä¸”ä¸¤æ¬¡è¯»å–åˆ°çš„nameçš„å€¼ä¸ä¸€è‡´ï¼Œæ‰€ä»¥RUä¹Ÿé€ æˆäº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚</p></li><li><p>å¹»è¯»éªŒè¯</p><ol><li><p>Aäº‹åŠ¡ï¼šè¿›è¡ŒæŸ¥è¯¢æ“ä½œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">select * from cc_isolation_test;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427185221292.png" alt="image-20200427185221292" style="zoom:50%;"></li><li><p>Bäº‹åŠ¡ï¼šè¿›è¡Œæ’å…¥æ“ä½œä½†ä¸æäº¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">insert into cc_isolation_test(name) values(&apos;cc1&apos;);</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡æœªæäº¤ï¼Œæˆ‘ä»¬çš„è¡¨ä¸­è¿˜æ²¡å‡ºç°æ’å…¥çš„æ–°æ•°æ®</p><img src="/images/image-20200427190836436.png" alt="image-20200427190836436" style="zoom:50%;"></li><li><p>Aäº‹åŠ¡ï¼šå†æ¬¡è¿›è¡ŒæŸ¥è¯¢æ“ä½œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from cc_isolation_test;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢å‡ºæ¥ä¸¤æ¡æ•°æ®ï¼Œå’Œä¹‹å‰æŸ¥è¯¢çš„æ¡æ•°ä¸ä¸€æ ·ï¼Œä½†æ˜¯æˆ‘ä»¬æ•°æ®åº“ä¸­ä»…ä»…åªæœ‰ä¸€æ¡æ•°æ®ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å¹»è¯»ï¼Œæ­¤æ—¶è‹¥å°†Bäº‹åŠ¡å›æ»šæ‰ï¼ŒAäº‹åŠ¡æ‹¿ç€Bäº‹åŠ¡æœªæäº¤çš„æ•°æ®ç»§ç»­æ“ä½œï¼Œå®šä¼šå‡ºç°é—®é¢˜ã€‚</p></li><li><p>å›¾è§£</p><table><thead><tr><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>start transaction;</td><td>start transaction;</td></tr><tr><td>select * from cc_isolation_test;</td><td></td></tr><tr><td></td><td>insert into cc_isolation_test(name) values(â€˜cc1â€™);</td></tr><tr><td>select * from cc_isolation_test;</td><td></td></tr><tr><td></td><td>rollback;</td></tr><tr><td>commit;</td><td></td></tr></tbody></table></li></ol></li></ul></li><li><p>RCçº§åˆ«</p><ul><li><p>ä¿®æ”¹sessionçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºRC</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ä¿®æ”¹éš”ç¦»çº§åˆ«ä¸ºRC</span><br><span class="line">set session transaction isolation level read committed ;</span><br><span class="line"># éªŒè¯</span><br><span class="line">select @@tx_isolation;</span><br></pre></td></tr></table></figure></li></ul><img src="/images/image-20200427215936571.png" alt="image-20200427215936571" style="zoom:50%;"><ul><li><p>è„è¯»éªŒè¯</p><p>æ“ä½œæ­¥éª¤å’ŒRUçš„ä¸€è‡´ï¼Œä½†æ˜¯ç»“æœå´ä¸ç›¸åŒï¼Œæˆ‘ä»¬åœ¨Bäº‹åŠ¡ä¸­å¯¹<code>id=1</code>çš„æ•°æ®è¿›è¡Œä¿®æ”¹ä½†æ˜¯ä¸æäº¤äº‹åŠ¡ï¼Œåœ¨Aäº‹åŠ¡ä¸­æ˜¯è¯»å–ä¸åˆ°Bäº‹åŠ¡å¯¹è¯¥æ¡æ•°æ®çš„ä¿®æ”¹ï¼Œæ‰€ä»¥RCçº§åˆ«ä¸ä¼šå‡ºç°è„è¯»çš„é—®é¢˜ã€‚</p></li><li><p>ä¸å¯é‡å¤è¯»éªŒè¯</p><ol><li><p>Aäº‹åŠ¡ï¼šç¬¬ä¸€æ¬¡æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">select * from cc_isolation_test where id=1;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427193013689.png" alt="image-20200427193013689" style="zoom:50%;"></li><li><p>Bäº‹åŠ¡ï¼šä¿®æ”¹æ•°æ®å¹¶æäº¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start transaction ;</span><br><span class="line">update cc_isolation_test set name=&apos;cc1&apos; where id=1;</span><br><span class="line">commit ;</span><br></pre></td></tr></table></figure></li><li><p>Aäº‹åŠ¡ï¼šç¬¬äºŒæ¬¡æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">select * from cc_isolation_test where id=1;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427193112958.png" alt="image-20200427193112958" style="zoom:50%;"><p>åœ¨Aäº‹åŠ¡ä¸­è¯»å–åˆ°äº†Bäº‹åŠ¡æäº¤çš„æ•°æ®ï¼Œä¸ç¬¬ä¸€æ¬¡è¯»å–åˆ°çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡è¯»å–éƒ½æ˜¯ä»æ•°æ®åº“ä¸­è¯»å–æœ€æ–°çš„æ•°æ®ï¼Œè¿™ä¹Ÿè¯æ˜äº†å†RCçº§åˆ«ä¸‹ä¼šå‡ºç°ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚</p></li><li><p>å›¾è§£</p><table><thead><tr><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>start transaction;</td><td>start transaction;</td></tr><tr><td>select * from cc_isolation_test where id=1;</td><td></td></tr><tr><td></td><td>update cc_isolation_test set name=â€˜cc1â€™ where id=1;</td></tr><tr><td></td><td>commit;</td></tr><tr><td>select * from cc_isolation_test where id=1;</td><td></td></tr><tr><td>commit;</td><td></td></tr></tbody></table></li></ol></li><li><p>å¹»è¯»éªŒè¯</p><ol><li><p>Aäº‹åŠ¡ï¼šç¬¬ä¸€æ¬¡æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">select * from cc_isolation_test;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427193423746.png" alt="image-20200427193423746" style="zoom:50%;"></li><li><p>Bäº‹åŠ¡ï¼šä¿®æ”¹æ•°æ®å¹¶æäº¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start transaction ;</span><br><span class="line">insert into cc_isolation_test(name) values(&apos;cc2&apos;);</span><br><span class="line">commit ;</span><br></pre></td></tr></table></figure></li><li><p>Aäº‹åŠ¡ï¼šç¬¬äºŒæ¬¡æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from cc_isolation_test;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427193523968.png" alt="image-20200427193523968" style="zoom:50%;"><p>ä¸¤æ¬¡æŸ¥è¯¢çš„æ•°æ®æ¡æ•°ä¸åŒï¼Œåœ¨Aäº‹åŠ¡ä¸­è¯»å–åˆ°äº†Bäº‹åŠ¡æ–°æ’å…¥çš„æ•°æ®ï¼Œç›¸å¯¹äºç¬¬ä¸€æ¬¡æŸ¥è¯¢ç»“æœæ¥è¯´ï¼Œå‡ºç°äº†å¹»è¯»çš„é—®é¢˜ã€‚</p></li><li><p>å›¾è§£</p><table><thead><tr><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>start transaction;</td><td>start transaction;</td></tr><tr><td>select * from cc_isolation_test;</td><td></td></tr><tr><td></td><td>insert into cc_isolation_test(name) values(â€˜cc2â€™);</td></tr><tr><td></td><td>commit;</td></tr><tr><td>select * from cc_isolation_test;</td><td></td></tr><tr><td>commit;</td><td></td></tr></tbody></table></li></ol></li></ul></li><li><p>RRçº§åˆ«</p><ul><li><p>ä¿®æ”¹sessionçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºRR</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ä¿®æ”¹éš”ç¦»çº§åˆ«ä¸ºRC</span><br><span class="line">set session transaction isolation level read committed ;</span><br><span class="line"># éªŒè¯</span><br><span class="line">select @@tx_isolation;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427210838009.png" alt="image-20200427210838009" style="zoom:50%;"></li><li><p>è„è¯»éªŒè¯</p><p>æ“ä½œæ­¥éª¤å’ŒRCçš„ä¸€è‡´ï¼Œä½†æ˜¯ç»“æœå´ä¸ç›¸åŒï¼Œæˆ‘ä»¬åœ¨Bäº‹åŠ¡ä¸­å¯¹<code>id=1</code>çš„æ•°æ®è¿›è¡Œä¿®æ”¹ä½†æ˜¯ä¸æäº¤äº‹åŠ¡ï¼Œåœ¨Aäº‹åŠ¡ä¸­æ˜¯è¯»å–ä¸åˆ°Bäº‹åŠ¡å¯¹è¯¥æ¡æ•°æ®çš„ä¿®æ”¹ï¼Œæ‰€ä»¥RRçº§åˆ«ä¸ä¼šå‡ºç°è„è¯»çš„é—®é¢˜ã€‚</p></li><li><p>ä¸å¯é‡å¤è¯»éªŒè¯</p><ol><li><p>Aäº‹åŠ¡ï¼šç¬¬ä¸€æ¬¡æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">select * from cc_isolation_test where id=1;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427193112958.png" alt="image-20200427193112958" style="zoom:50%;"></li><li><p>Bäº‹åŠ¡ï¼šä¿®æ”¹æ•°æ®å¹¶æäº¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start transaction ;</span><br><span class="line">update cc_isolation_test set name=&apos;cc2&apos; where id=1;</span><br><span class="line">commit ;</span><br></pre></td></tr></table></figure></li><li><p>Aäº‹åŠ¡ï¼šç¬¬äºŒæ¬¡æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from cc_isolation_test where id=1;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427193112958.png" alt="image-20200427193112958" style="zoom:50%;"><p>é€šè¿‡ä¸¤æ¬¡è¯»å–ä¹‹åå‘ç°åœ¨Bäº‹åŠ¡æäº¤å‰åè¯»å–åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œè¿™æ ·è¯æ˜äº†RRçº§åˆ«æ˜¯æ”¯æŒé‡å¤è¯»çš„ï¼Œnice~</p></li><li><p>å›¾è§£</p><table><thead><tr><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>start transaction;</td><td>start transaction;</td></tr><tr><td>select * from cc_isolation_test where id=1;</td><td></td></tr><tr><td></td><td>update cc_isolation_test set name=â€˜cc2â€™ where id=1;</td></tr><tr><td></td><td>commit;</td></tr><tr><td>select * from cc_isolation_test where id=1;</td><td></td></tr><tr><td>commit;</td><td></td></tr></tbody></table></li></ol></li><li><p>å¹»è¯»éªŒè¯</p><ol><li><p>Aäº‹åŠ¡ï¼šè¿›è¡ŒæŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">select * from cc_isolation_test where id=1;</span><br></pre></td></tr></table></figure></li><li><p>Bäº‹åŠ¡ï¼šæ’å…¥æ•°æ®å¹¶æäº¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start transaction ;</span><br><span class="line">insert into cc_isolation_test(id, name) values(1, &apos;cc2&apos;);</span><br><span class="line">commit ;</span><br></pre></td></tr></table></figure></li><li><p>Aäº‹åŠ¡ï¼šæ’å…¥æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into cc_isolation_test(id, name) values(1, &apos;cc2&apos;);</span><br></pre></td></tr></table></figure><p>ä¸»é”®å†²çªäº†ï¼Œä½†æ˜¯åœ¨Aäº‹åŠ¡ä¸­ç¡®å®æ²¡æŸ¥è¯¢åˆ°id=1çš„æ•°æ®ï¼Œå…¶å®è¿™ä¸ªæ—¶å€™æ•°æ®åº“ä¸­å·²ç»æœ‰äº†id=1çš„æ•°æ®ï¼Œä½†åœ¨Aäº‹åŠ¡ä¸­å´æ²¡æœ‰æŸ¥è¯¢åˆ°ï¼Œè¿™å°±æ˜¯å¹»è¯»ã€‚</p></li><li><p>å›¾è§£</p><table><thead><tr><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>start transaction;</td><td>start transaction;</td></tr><tr><td>select * from cc_isolation_test where id=1;</td><td></td></tr><tr><td></td><td>insert into cc_isolation_test(id, name) values(1, â€˜cc2â€™);</td></tr><tr><td></td><td>commit;</td></tr><tr><td>insert into cc_isolation_test(id, name) values(1, â€˜cc2â€™);</td><td></td></tr><tr><td>commit;</td><td></td></tr></tbody></table></li></ol></li></ul></li><li><p>Serializableçº§åˆ«</p><ul><li><p>ä¿®æ”¹sessionçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºSerializable</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set session transaction isolation level serializable;</span><br></pre></td></tr></table></figure><img src="/images/image-20200427215912469.png" alt="image-20200427215912469" style="zoom:50%;"></li><li><p>æ“ä½œ</p><p>å…ˆå¼€å¯äº‹åŠ¡Aï¼Œè¿›è¡ŒæŸ¥è¯¢ï¼Œä½†ä¸æäº¤ï¼›å†å¼€å¯äº‹åŠ¡Bï¼Œç„¶åè¿›è¡Œæ’å…¥æ“ä½œï¼Œä¼šå‘ç°æ“ä½œè¢«é˜»å¡äº†ï¼Œå¦‚ä¸‹å›¾ä¸­insertè¯­å¥æœ€åçš„æ—¶é—´å°±æ˜¯ç­‰å¾…çš„æ—¶é—´ï¼Œäº‹åŠ¡Bå¿…é¡»åœ¨äº‹åŠ¡Aæäº¤æˆ–å›æ»šä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸²è¡ŒåŒ–çš„æ„ä¹‰ï¼šåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªäº‹åŠ¡å¤„äºæ‰§è¡Œä¸­ï¼Œå…¶ä»–çº¿ç¨‹éƒ½è¦ç­‰å¾…ã€‚å¹¶å‘åº¦æœ€ä½ä½†å®‰å…¨æ€§æœ€é«˜ã€‚</p><img src="/images/image-20200427215828454.png" alt="image-20200427215828454" style="zoom:50%;"><p>å›¾è§£ï¼š</p><table><thead><tr><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>start transaction;</td><td>start transaction;</td></tr><tr><td>select * from cc_isolation_test;</td><td></td></tr><tr><td></td><td>insert into cc_isolation_test(name) values(â€˜cc2â€™);</td></tr><tr><td></td><td>commit;</td></tr><tr><td>select * from cc_isolation_test;</td><td></td></tr><tr><td>commit;</td><td></td></tr></tbody></table></li></ul></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¸€-äº‹åŠ¡ä¸ºä½•ç‰©&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ä¸€-äº‹åŠ¡ä¸ºä½•ç‰©&quot;&gt;&lt;/a&gt; ä¸€ã€äº‹åŠ¡ä¸ºä½•ç‰©&lt;/h3&gt;
&lt;p&gt;äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯ä¿éšœç¨‹åºä¸­ä¸€ç»„æ“ä½œçš„åŸå­æ€§çš„çº¦æŸï¼Œå®ƒä½¿äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½æŒ‡å‘åŒä¸€ä¸ªç»“æœï¼Œä¹Ÿå°±æ˜¯è¦ä¹ˆ
      
    
    </summary>
    
    
      <category term="MySQL" scheme="http://luxiaowan.github.io/categories/MySQL/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBootå¦‚ä½•ä»¥waråŒ…å½¢å¼è¿è¡Œ</title>
    <link href="http://luxiaowan.github.io/2020/04/26/SpringBoot%E5%A6%82%E4%BD%95%E4%BB%A5war%E5%8C%85%E5%BD%A2%E5%BC%8F%E8%BF%90%E8%A1%8C/"/>
    <id>http://luxiaowan.github.io/2020/04/26/SpringBootå¦‚ä½•ä»¥waråŒ…å½¢å¼è¿è¡Œ/</id>
    <published>2020-04-26T09:50:00.000Z</published>
    <updated>2020-04-26T14:40:37.649Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-ç®€ä»‹"><a class="markdownIt-Anchor" href="#ä¸€-ç®€ä»‹"></a> ä¸€ã€ç®€ä»‹</h3><p>SpringBootåº”ç”¨é»˜è®¤æ‰“åŒ…æˆå¯æ‰§è¡Œjaræ¨¡å¼æ–¹ä¾¿æˆ‘ä»¬çš„å¿«é€Ÿéƒ¨ç½²ï¼Œå¦‚æœæ˜¯webåº”ç”¨çš„è¯ï¼Œåˆ™é»˜è®¤ä½¿ç”¨å†…ç½®çš„tomcatä½œä¸ºservletå®¹å™¨ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦æ ¹æ®ä¸šåŠ¡ç‰¹æ€§å¯¹å®¹å™¨åšä¸€äº›ç‰¹æ®Šé…ç½®ï¼Œé‚£ä¹ˆSpringBootå†…ç½®çš„tomcatå®¹å™¨å°±æ— æ³•æ»¡è¶³æˆ‘ä»¬äº†ï¼Œå› æ­¤æˆ‘ä»¬å°±éœ€è¦æŠŠSpringBootåº”ç”¨æ‰“åŒ…æˆwaråŒ…ï¼Œè®©å…¶èƒ½å¤Ÿåœ¨å¤–éƒ¨tomcatä¸­è¿è¡Œã€‚</p><p>é‚£æˆ‘ä»¬ç›´æ¥æ‰“æˆwaråŒ…ç„¶åéƒ¨ç½²åˆ°tomcatæ˜¯å¦å¯è¡Œï¼Ÿæˆ‘ä»¬æ¥è¯•ä¸‹ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p><h3 id="äºŒ-ç›´æ¥å°†springbootæ‰“æˆwaråŒ…"><a class="markdownIt-Anchor" href="#äºŒ-ç›´æ¥å°†springbootæ‰“æˆwaråŒ…"></a> äºŒã€ç›´æ¥å°†SpringBootæ‰“æˆwaråŒ…</h3><ol><li><p>åˆ›å»ºä¸€ä¸ªSpringBoot webé¡¹ç›®ï¼Œå¹¶ä¿®æ”¹æ‰“åŒ…æ–¹å¼å’Œç«¯å£</p><ul><li><p>å¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CcSpringBootWarApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(CcSpringBootWarApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-war<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æ·»åŠ packagingå¹¶æŒ‡æ˜æ–¹å¼ä¸ºwar --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ç«¯å£ï¼Œä¸è¦å’Œtomcatçš„8080å†²çªï¼Œä¿®æ”¹tomcatçš„ä¹Ÿå¯ä»¥</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8990</span></span><br></pre></td></tr></table></figure></li></ul><p>ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ä¸€ä¸ªç®€å•çš„SpringBootåº”ç”¨æ‰€å…·æœ‰çš„ä¸œè¥¿</p></li><li><p>åˆ›å»ºä¸€ä¸ªAPI</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/cc"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"cc"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ‰“åŒ…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -Dmaven.test.skip=true</span><br></pre></td></tr></table></figure></li><li><p>æ”¾åˆ°tomcatä¸­å¯åŠ¨ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¿¡æ¯</p><p><img src="/images/image-20200426212704488.png" alt="image-20200426212704488"></p><p>æ²¡æœ‰æŠ¥é”™ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¿é—®ä¸€ä¸‹æ¥å£http://127.0.0.1/boot-war/ccï¼ŒæŠ¥äº†404ï¼Œè¯´æ˜æˆ‘ä»¬é¡¹ç›®æœªè¢«éƒ¨ç½²æˆåŠŸã€‚</p><p><img src="/images/image-20200426212841507.png" alt="image-20200426212841507"></p></li></ol><p>æœªéƒ¨ç½²æˆåŠŸï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬åœ¨æ‰“åŒ…çš„æ—¶å€™ï¼Œå°†å†…ç½®çš„tomcatçš„jaråŒ…ä¸€å¹¶æ‰“åˆ°waråŒ…ä¸­äº†ï¼Œè¿™æ—¶å’Œå¤–éƒ¨çš„tomcatå†²çªäº†ã€‚</p><h3 id="ä¸‰-ä¼˜åŒ–åçš„springbootæ‰“waråŒ…"><a class="markdownIt-Anchor" href="#ä¸‰-ä¼˜åŒ–åçš„springbootæ‰“waråŒ…"></a> ä¸‰ã€ä¼˜åŒ–åçš„SpringBootæ‰“waråŒ…</h3><ol><li><p>ä¿®æ”¹ä¾èµ–çš„tomcatåŒ…çš„scope</p><ul><li><p>ç¬¬ä¸€ç§æ–¹å¼</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥å±è”½æ‰<code>spring-boot-starter-web</code>ä¸­å‘ä¸‹ä¼ é€’çš„<code>spring-boot-starter-tomcat</code>åŒ…ï¼Œå¹¶å¼•å…¥<code>javax.servlet-api</code>åŒ…ï¼Œå¹¶å°†scopeè®¾ç½®ä¸º<code>provided</code>ï¼Œä¸ç„¶æ‰“åŒ…çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚</p></li><li><p>ç¬¬äºŒç§æ–¹å¼</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å°†<code>spring-boot-starter-tomcat</code>å’Œ<code>javax.servlet-api</code>çš„jaråŒ…çš„scopeè®¾ç½®ä¸º<code>provided</code>ä¾¿äºæ‰“åŒ…ã€‚</p></li></ul></li><li><p>ä¿®æ”¹å¯åŠ¨ç±»ï¼Œè®¾ç½®å¯åŠ¨é…ç½®</p><p>å‘å¸ƒåˆ°ç‹¬ç«‹çš„Tomcatéœ€è¦ç»§æ‰¿SpringBootServletInitializerç±»å¹¶é‡å†™configureæ–¹æ³•ï¼Œåœ¨waråŒ…éƒ¨ç½²è§£å‹åçš„æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ™®é€šwebé¡¹ç›®çš„web.xmlï¼Œä½†æ˜¯ä»ç„¶èƒ½å¯åŠ¨ï¼Œå°±æ˜¯å› ä¸ºSpringConfigç»§æ‰¿äº†SpringBootServletInitializerï¼Œæ‰€ä»¥æ‰“åŒ…çš„æ—¶å€™SpringBootåšäº†åˆå§‹åŒ–å·¥ä½œï¼Œè¿™ä¸ªç±»å°±æ˜¯ç”¨äºä»£æ›¿ä¼ ç»ŸMVCæ¨¡å¼ä¸­çš„web.xmlã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.builder.SpringApplicationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.support.SpringBootServletInitializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CcSpringBootWarApplication</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(CcSpringBootWarApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(CcSpringBootWarApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ‰“åŒ…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -Dmaven.test.skip=true</span><br></pre></td></tr></table></figure></li><li><p>éƒ¨ç½²</p><p>å°†waråŒ…æ”¾åˆ°å¤–éƒ¨tomcatçš„webappsç›®å½•ä¸‹ï¼Œç„¶åå¯åŠ¨tomcatåè®¿é—®http://127.0.0.1/boot-war/ccï¼Œè®¿é—®æ­£å¸¸ã€‚</p><p><img src="/images/image-20200426215949343.png" alt="image-20200426215949343"></p></li></ol><h3 id="å››-ç›´æ¥åˆ›å»ºwaré¡¹ç›®"><a class="markdownIt-Anchor" href="#å››-ç›´æ¥åˆ›å»ºwaré¡¹ç›®"></a> å››ã€ç›´æ¥åˆ›å»ºwaré¡¹ç›®</h3><p>åœ¨åˆ›å»ºåº”ç”¨çš„æ—¶å€™ï¼Œpackagingé€‰æ‹©Warï¼ˆç›®å‰åªæœ‰Jarå’ŒWarä¸¤ä¸ªé€‰é¡¹ï¼‰ï¼Œå°±èƒ½ç›´æ¥åˆ›å»ºå‡ºç¬¦åˆæ¡ä»¶çš„åº”ç”¨ï¼Œä¸éœ€è¦å†è¿›è¡Œä»»ä½•ä¿®æ”¹å°±å¯ä»¥ç›´æ¥æ‰“æˆwaråŒ…ã€‚</p><img src="/images/image-20200426220404239.png" alt="image-20200426220404239" style="zoom: 35%;"><p>åˆ›å»ºçš„åº”ç”¨å†…å®¹å¦‚ä¸‹ï¼š</p><img src="/images/image-20200426220312800.png" alt="image-20200426220312800" style="zoom:35%;">]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¸€-ç®€ä»‹&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ä¸€-ç®€ä»‹&quot;&gt;&lt;/a&gt; ä¸€ã€ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;SpringBootåº”ç”¨é»˜è®¤æ‰“åŒ…æˆå¯æ‰§è¡Œjaræ¨¡å¼æ–¹ä¾¿æˆ‘ä»¬çš„å¿«é€Ÿéƒ¨ç½²ï¼Œå¦‚æœæ˜¯webåº”ç”¨çš„è¯ï¼Œåˆ™é»˜è®¤ä½¿ç”¨å†…ç½®çš„tomcatä½œä¸ºserv
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="http://luxiaowan.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨LockSupportå®ç°çº¿ç¨‹äº¤æ›¿æ‰“å°1-100</title>
    <link href="http://luxiaowan.github.io/2020/04/25/%E4%BD%BF%E7%94%A8LockSupport%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B%E4%BA%A4%E6%9B%BF%E6%89%93%E5%8D%B01-100/"/>
    <id>http://luxiaowan.github.io/2020/04/25/ä½¿ç”¨LockSupportå®ç°çº¿ç¨‹äº¤æ›¿æ‰“å°1-100/</id>
    <published>2020-04-25T08:30:00.000Z</published>
    <updated>2020-04-25T12:15:18.820Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h3><p>LockSupportæ˜¯JDKåº•å±‚çš„åŸºäº<code>sun.misc.Unsafe</code>æ¥å®ç°çš„ç±»ï¼Œç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥å·¥å…·ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ï¼Œåœ¨AQSä¸­ï¼Œå°±æ˜¯é€šè¿‡è°ƒç”¨LockSupport.park()å’ŒLockSupport.unpark()æ¥å®ç°çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’çš„ï¼Œä¸æ¸…æ¥šçš„å¯ä»¥å…ˆäº†è§£ä¸€ä¸‹<a href="https://luxiaowan.github.io/2020/04/24/AQS%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%86%B5/">AQSåŸºæœ¬æ¦‚å†µ</a>ã€‚æ¯ä¸€ä¸ªä½¿ç”¨LockSupportçš„çº¿ç¨‹éƒ½ä¼šä¸ä¸€ä¸ªè®¸å¯å…³è”ï¼Œå¦‚æœè®¸å¯è¯åœ¨çº¿ç¨‹ä¸­å¯ç”¨ï¼Œåˆ™è°ƒç”¨park()å°†ä¼šç«‹å³è¿”å›ï¼Œå¦åˆ™å¯èƒ½å µå¡ï¼›è‹¥è®¸å¯è¯ä¸å¯ç”¨ï¼Œåˆ™è°ƒç”¨unpark()å°†å…¶è½¬ä¸ºå¯ç”¨çŠ¶æ€ã€‚è°ƒç”¨park()çš„æ¬¡æ•°è¦å°‘äºç­‰äºè°ƒç”¨unpark()çš„æ¬¡æ•°ï¼Œå¦åˆ™å°†ä¼šå¯¼è‡´è®¸å¯ä¸å¯ç”¨å¼•èµ·é˜»å¡ã€‚</p><h3 id="locksupportæ–¹æ³•ä»‹ç»"><a class="markdownIt-Anchor" href="#locksupportæ–¹æ³•ä»‹ç»"></a> LockSupportæ–¹æ³•ä»‹ç»</h3><p>LockSupportæä¾›çš„æ–¹æ³•ä¸å¤šï¼Œä¸”éƒ½æ˜¯ç±»æ–¹æ³•ï¼Œæ¥çœ‹ä¸‹ï¼š</p><ul><li>é˜»å¡çº¿ç¨‹<ol><li>park()ï¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œéœ€è¦åœ¨çº¿ç¨‹å†…è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨unpark()æˆ–è€…å°†çº¿ç¨‹ä¸­æ–­ï¼Œåˆ™ä»park()æ–¹æ³•ä¸­è¿”å›</li><li>park(Object blocker)ï¼šåŠŸèƒ½ä¸park()ç›¸åŒï¼Œå…¥å‚æ˜¯ä¸€ä¸ªObjectå¯¹è±¡ï¼Œç”¨æ¥è®°å½•å¯¼è‡´çº¿ç¨‹é˜»å¡çš„é˜»å¡å¯¹è±¡ï¼Œæ–¹ä¾¿è¿›è¡Œé—®é¢˜æ’æŸ¥</li><li>parkNanos(long nanos)ï¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œé˜»å¡æ—¶é•¿ä¸è¶…è¿‡nanosçº³ç§’ï¼Œè¶…æ—¶è‡ªåŠ¨è¿”å›</li><li>parkNanos(Object blocker, long nanos)ï¼šåŠŸèƒ½åŒparkNanos(long nanos)ï¼Œåœ¨å…¶åŸºç¡€ä¸Šå¢åŠ äº†Objectå¯¹è±¡ï¼Œç­‰åŒäºæ˜¯park(Object blocker)+parkNanos(long nanos)çš„ç»„åˆ</li><li>parkUtil(long deadline)ï¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°deadlineåè‡ªåŠ¨è¿”å›</li><li>parkUtil(Object blocker, long deadline)ï¼šï¼šç­‰åŒäºpark(Object blocker)+parkUtil(long deadline)çš„ç»„åˆ</li></ol></li><li>å”¤é†’çº¿ç¨‹<ol><li>unpar(Thread thread)ï¼šå”¤é†’å¤„äºé˜»å¡çŠ¶æ€çš„æŒ‡å®šçº¿ç¨‹</li></ol></li></ul><p>ä»¥ä¸Šå°±æ˜¯LockSupportçš„ä¸»è¦æ–¹æ³•ï¼Œæ¯ä¸€ç§parkæ–¹æ³•éƒ½æä¾›äº†ä¸€ä¸ªObjectå¯¹è±¡çš„å…¥å‚ï¼Œç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿è¿›è¡Œé—®é¢˜æ’æŸ¥ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹ä¸‹æ˜¯æ€ä¹ˆæ–¹ä¾¿çš„</p><ol><li><p>park()çš„çº¿ç¨‹æ ˆ</p><p><img src="/images/image-20200425175946604.png" alt="image-20200425175946604"></p></li><li><p>park(Object blocker)çš„çº¿ç¨‹æ ˆ</p><p><img src="/images/image-20200425180113595.png" alt="image-20200425180113595"></p></li></ol><p>ä½¿ç”¨Objectå…¥å‚çš„æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹æ ˆä¸­å‡ºç°äº†<code>parking to wait for</code>æç¤ºï¼Œå‘Šè¯‰æˆ‘ä»¬å› ä¸ºå“ªä¸ªå¯¹è±¡å‘ç”Ÿçš„é˜»å¡ï¼Œæ–¹ä¾¿æˆ‘ä»¬æŸ¥æ‰¾é˜»å¡æºå¤´ã€‚</p><h3 id="ä¾‹å­1"><a class="markdownIt-Anchor" href="#ä¾‹å­1"></a> ä¾‹å­1</h3><ol><li><p>ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°1-100</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.LockSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintNumTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicInteger num = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Print p1 = <span class="keyword">new</span> Print();</span><br><span class="line">        Print p2 = <span class="keyword">new</span> Print();</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(p1);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(p2);</span><br><span class="line">        t1.setName(<span class="string">"thread-cc-1"</span>);</span><br><span class="line">        t2.setName(<span class="string">"thread-cc-2"</span>);</span><br><span class="line">        p1.setT(t2);</span><br><span class="line">        p2.setT(t1);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">      <span class="comment">// å”¤é†’çº¿ç¨‹t1æ‰“å°å¥‡æ•°ï¼Œçº¿ç¨‹1æ‰“å°å¥‡æ•°ï¼Œçº¿ç¨‹2æ‰“å°å¶æ•°</span></span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">      <span class="comment">// å”¤é†’çº¿ç¨‹t2æ‰“å°å¥‡æ•°ï¼Œçº¿ç¨‹1æ‰“å°å¶æ•°ï¼Œçº¿ç¨‹2æ‰“å°å¥‡æ•°</span></span><br><span class="line">      <span class="comment">// LockSupport.unpark(t1);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Print</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Thread t;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">              <span class="comment">// è¿›å…¥ä¹‹åç«‹å³é˜»å¡</span></span><br><span class="line">                LockSupport.park();</span><br><span class="line">                <span class="keyword">if</span> (num.get() &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                    LockSupport.unpark(t);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" : "</span> + num.getAndIncrement());</span><br><span class="line">              <span class="comment">// å¥‡æ•°å”¤é†’å¶æ•°çº¿ç¨‹ï¼Œå¶æ•°å”¤é†’å¥‡æ•°çº¿ç¨‹</span></span><br><span class="line">                LockSupport.unpark(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setT</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.t = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹ä½¿ç”¨æ­»å¾ªç¯æ¥ä¿æŒè¿è¡ŒçŠ¶æ€ï¼Œç„¶åä½¿ç”¨returnæ¥ç»ˆæ­¢è¿è¡Œï¼Œè¿›å…¥å¾ªç¯ä¹‹åç«‹å³è°ƒç”¨LockSupport.park()é˜»å¡å½“å‰çº¿ç¨‹ï¼Œåœ¨è°ƒç”¨çº¿ç¨‹çš„start()æ–¹æ³•ä¹‹åä¸¤ä¸ªçº¿ç¨‹éƒ½å µå¡åœ¨run()æ–¹æ³•å¼€å§‹ä½ç½®ï¼Œåœ¨çº¿ç¨‹1ä¸­æ‰“å¼€çº¿ç¨‹2çš„è®¸å¯è¯ï¼Œåœ¨çº¿ç¨‹2ä¸­æ‰“å¼€çº¿ç¨‹1çš„è®¸å¯è¯ï¼Œè¾¾åˆ°äº¤æ›¿æ‰§è¡Œçš„ç›®çš„ã€‚æ­¤æ—¶çº¿ç¨‹éƒ½å µå¡äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­æ§åˆ¶å…ˆæ‰“å¼€å“ªä¸€ä¸ªçº¿ç¨‹çš„è®¸å¯è¯äº†ï¼Œå¦‚æœæƒ³è®©çº¿ç¨‹1æ‰“å°å¥‡æ•°ï¼Œçº¿ç¨‹2æ‰“å°å¶æ•°ï¼Œå°±å…ˆæŠŠçº¿ç¨‹1é˜»å¡çš„è®¸å¯è¯æ‰“å¼€ï¼Œè®©çº¿ç¨‹1å…ˆæ‰§è¡Œï¼›å¦‚æœæƒ³è®©çº¿ç¨‹1æ‰“å°å¶æ•°ï¼Œçº¿ç¨‹2æ‰“å°å¥‡æ•°ï¼Œå°±å…ˆæŠŠçº¿ç¨‹2é˜»å¡çš„è®¸å¯è¯æ‰“å¼€ï¼Œè®©çº¿ç¨‹2å…ˆæ‰§è¡Œã€‚</p><ul><li>t1æ‰“å°å¥‡æ•°ï¼Œt2æ‰“å°å¶æ•°</li></ul><img src="/images/image-20200425194737366.png" alt="image-20200425194737366" style="zoom:50%;"><ul><li><p>t1æ‰“å°å¶æ•°ï¼Œt2æ‰“å°å¥‡æ•°</p><img src="/images/image-20200425194937392.png" alt="image-20200425194937392" style="zoom:50%;"></li></ul></li><li><p>ä½¿ç”¨ä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°1-100</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.LockSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintNumTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicInteger num = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Print p1 = <span class="keyword">new</span> Print();</span><br><span class="line">        Print p2 = <span class="keyword">new</span> Print();</span><br><span class="line">        Print p3 = <span class="keyword">new</span> Print();</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(p1);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(p2);</span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(p3);</span><br><span class="line">        t1.setName(<span class="string">"thread-cc-1"</span>);</span><br><span class="line">        t2.setName(<span class="string">"thread-cc-2"</span>);</span><br><span class="line">        t3.setName(<span class="string">"thread-cc-3"</span>);</span><br><span class="line">        p1.setT(t2);</span><br><span class="line">        p2.setT(t3);</span><br><span class="line">        p3.setT(t1);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Print</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Thread t;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                LockSupport.park();</span><br><span class="line">                <span class="keyword">if</span> (num.get() &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                    LockSupport.unpark(t);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" : "</span> + num.getAndIncrement());</span><br><span class="line">                LockSupport.unpark(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setT</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.t = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç®€ä»‹&quot;&gt;&lt;/a&gt; ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;LockSupportæ˜¯JDKåº•å±‚çš„åŸºäº&lt;code&gt;sun.misc.Unsafe&lt;/code&gt;æ¥å®ç°çš„ç±»ï¼Œç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥å·¥å…·ç±»çš„åŸºæœ¬çº¿ç¨‹
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>AQSåŸºæœ¬æ¦‚å†µ</title>
    <link href="http://luxiaowan.github.io/2020/04/24/AQS%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%86%B5/"/>
    <id>http://luxiaowan.github.io/2020/04/24/AQSåŸºæœ¬æ¦‚å†µ/</id>
    <published>2020-04-24T04:20:00.000Z</published>
    <updated>2020-04-24T18:38:23.609Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-ç®€ä»‹"><a class="markdownIt-Anchor" href="#ä¸€-ç®€ä»‹"></a> ä¸€ã€ç®€ä»‹</h3><p>åœ¨Javaä¸­ï¼Œè°ˆåˆ°å¹¶å‘å°±ä¸å¾—ä¸è¯´åˆ°jdkä¸­çš„J.U.CåŒ…ï¼Œè€Œè¯´åˆ°æ­¤åŒ…å¿…å®šè¦è¯´åˆ°AQS(AbstractQueuedSynchronizer)ï¼Œä»ç±»åä¸Šå¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ã€ä½¿ç”¨é˜Ÿåˆ—å®ç°çš„åŒæ­¥å™¨ï¼ŒAQSæä¾›äº†ä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨äºæ„å»ºåŒæ­¥é”çš„åŸºç¡€æ¡†æ¶ï¼Œå†…éƒ¨é€šè¿‡volatileçš„å˜é‡stateæ¥è¡¨ç¤ºé”çš„çŠ¶æ€ï¼Œå½“state=0æ—¶è¡¨ç¤ºé”ç©ºé—²ï¼Œå½“state&gt;0æ—¶è¡¨ç¤ºé”è¢«å ç”¨ï¼Œå¦‚æœé”æ˜¯å¯é‡å…¥çš„ï¼Œæ¯”å¦‚ReentrantLockï¼Œstateçš„å€¼ä¼šéšç€é‡å…¥æ¬¡æ•°ä¸æ–­çš„+1ï¼Œåœ¨é”é‡Šæ”¾çš„æ—¶å€™éœ€è¦å°†stateè¿›è¡Œ-1ç›´åˆ°ç­‰äº0ï¼Œæ‰€ä»¥å¯¹äºé‡å…¥é”æ¥è¯´ï¼Œé‡å…¥å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šå°‘æ¬¡ï¼Œå¦åˆ™ä¼šä¸€ç›´å ç€é”å¯¼è‡´å…¶ä»–çº¿ç¨‹æ— æ³•ç”³è¯·åˆ°é”è€Œä¸€ç›´ç­‰å¾…ï¼Œæœ€ç»ˆæ’‘çˆ†CPUã€‚</p><p>AQSçš„æ ¸å¿ƒæ€æƒ³æ˜¯å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†èµ„æºåˆ†é…ç»™å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ï¼Œå¦‚æœæ­¤æ—¶æœ‰å…¶ä»–çº¿ç¨‹è¿‡æ¥è¯·æ±‚æ­¤å…±äº«èµ„æºï¼Œä¼šå‘ç°å…±äº«èµ„æºå·²ç»è¢«å ç”¨ï¼Œåˆ™é˜»å¡è¯¥çº¿ç¨‹ï¼Œå°†å…¶æ”¾å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</p><p>AQSçš„ç­‰å¾…é˜Ÿåˆ—åˆå«CLHé˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªFIFOæ€§è´¨çš„ï¼ŒCLHçš„åå­—æ¥è‡ªäºå®ƒçš„åˆ›å»ºè€…ï¼Œä¸‰ä½è€å‰è¾ˆçš„åå­—çš„é¦–å­—æ¯(Craig, Landin, Hagersten)ï¼ŒCLHé˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—ï¼ŒAQSå°†æ¯ä¸ªè¯·æ±‚å…±äº«èµ„æºä½†æœªæˆåŠŸçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªCLHé˜Ÿåˆ—çš„NodeèŠ‚ç‚¹å¹¶æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…åˆ†é…ã€‚</p><p><img src="/images/image-20200424221846794.png" alt="image-20200424221846794"></p><h3 id="äºŒ-aqsé”æ–¹å¼"><a class="markdownIt-Anchor" href="#äºŒ-aqsé”æ–¹å¼"></a> äºŒã€AQSé”æ–¹å¼</h3><p>AQSæä¾›äº†ç‹¬å é”å’Œå…±äº«é”ä¸¤ç§é”çš„å£°æ˜ï¼Œåœ¨å…¶å†…éƒ¨å¹¶æœªå¯¹é”è¿›è¡Œå…·ä½“å®ç°ï¼Œä»…ä»…æä¾›äº†ä¸€äº›æ¨¡æ¿æ–¹æ³•ï¼Œç”±å…·ä½“çš„å®ç°ç±»å†³å®šå¦‚ä½•å®ç°ã€‚</p><ul><li><p>ç‹¬å é”</p><p>ç‹¬å é”æ„æ€å°±æ˜¯åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹éœ¸å å…±äº«èµ„æºï¼Œå…¶ä»–è¯·æ±‚çš„çº¿ç¨‹å…¨éƒ¨ç­‰å¾…ï¼Œæ¯”å¦‚ReentrantLockã€‚çœ‹ä¸€ä¸‹å¤§è‡´çš„æµç¨‹ï¼š</p><img src="/images/image-20200424155241273.png" alt="image-20200424155241273" style="zoom:40%;"></li><li><p>å…±äº«é”</p><p>å…±äº«é”è®¾è®¡çš„åˆè¡·æ˜¯å…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…ä¸€ç»„äº‹ä»¶å®Œæˆï¼Œä¸»è¦å®ç°ä¸ºCountDownLatchï¼Œä¸»è¦åŸç†æ˜¯åœ¨åˆ›å»ºçš„æ—¶å€™ç»™stateè®¾å®šä¸€ä¸ªæ•°å€¼ï¼Œ è¡¨ç¤ºéœ€è¦ç­‰å¾…çš„äº‹ä»¶æ•°é‡ï¼Œè¿™ä¸ªå€¼éœ€è¦å’Œè¦ç­‰å¾…æ‰§è¡Œçš„çº¿ç¨‹æ•°ä¸€è‡´ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼Œå¯¹stateå‡ä¸€ï¼Œåœ¨stateä¸ç­‰äº0ä¹‹å‰ï¼Œåº”è¯¥ä¸€ç›´ç­‰å¾…ï¼Œé™¤éé‡åˆ°çº¿ç¨‹ä¸­æ–­æˆ–ç­‰å¾…è¶…æ—¶ã€‚</p><img src="/images/image-20200424203513738.png" alt="image-20200424203513738" style="zoom:40%;"></li></ul><h3 id="ä¸‰-aqsç­‰å¾…é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#ä¸‰-aqsç­‰å¾…é˜Ÿåˆ—"></a> ä¸‰ã€AQSç­‰å¾…é˜Ÿåˆ—</h3><p>å½“å…±äº«èµ„æºè¢«å ç”¨æ—¶ï¼Œå…¶ä»–è¯·æ±‚è¯¥èµ„æºçš„çº¿ç¨‹å°†ä¼šé˜»å¡ï¼Œç„¶åè¢«åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ã€‚å°±æ•°æ®ç»“æ„è€Œè¨€ï¼Œé˜Ÿåˆ—çš„å®ç°æ–¹å¼ä¸€ç§æ˜¯æ•°ç»„ï¼Œä¸€ç§æ˜¯é“¾è¡¨ï¼ŒAQSä¸­çš„ç­‰å¾…é˜Ÿåˆ—æ˜¯é€šè¿‡é“¾è¡¨çš„æ–¹å¼æ¥å®ç°çš„ï¼Œåå­—å«åšCLHé˜Ÿåˆ—ã€‚</p><ul><li><p>CLHé˜Ÿåˆ—èŠ‚ç‚¹æ˜¯é€šè¿‡AQSå†…éƒ¨Nodeç±»æ¥å°è£…çš„ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨(<code>volatile Thread thread</code>)ã€çŠ¶æ€(<code>volatile int waitStatus</code>)ã€å‰é©±èŠ‚ç‚¹(<code>volatile Node prev</code>)ã€åç»§èŠ‚ç‚¹(<code>volatile Node next</code>)ï¼Œè¿™äº›å˜é‡å…¨éƒ¨éƒ½æ˜¯volatileå…³é”®å­—ä¿®é¥°çš„ï¼Œä¿è¯äº†èŠ‚ç‚¹çš„åŸå­æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** å…±äº« */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ç‹¬å  */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å› ä¸ºè¶…æ—¶æˆ–è€…ä¸­æ–­ï¼ŒèŠ‚ç‚¹ä¼šè¢«è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œè¢«å–æ¶ˆçš„èŠ‚ç‚¹æ—¶ä¸ä¼šå‚ä¸åˆ°ç«äº‰ä¸­çš„ï¼Œä»–ä¼šä¸€ç›´ä¿æŒå–æ¶ˆçŠ¶æ€ä¸ä¼šè½¬å˜ä¸ºå…¶ä»–çŠ¶æ€ï¼›</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œå½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹å¦‚æœé‡Šæ”¾äº†åŒæ­¥çŠ¶æ€æˆ–è€…è¢«å–æ¶ˆï¼Œå°†ä¼šé€šçŸ¥åç»§èŠ‚ç‚¹ï¼Œä½¿åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¾—ä»¥è¿è¡Œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…åœ¨Conditionä¸Šï¼Œå½“å…¶ä»–çº¿ç¨‹å¯¹Conditionè°ƒç”¨äº†signal()åï¼Œæ”¹èŠ‚ç‚¹å°†ä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼ŒåŠ å…¥åˆ°åŒæ­¥çŠ¶æ€çš„è·å–ä¸­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºä¸‹ä¸€æ¬¡å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–å°†ä¼šæ— æ¡ä»¶åœ°ä¼ æ’­ä¸‹å»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ç­‰å¾…çŠ¶æ€ */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å‰é©±èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åç»§èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ */</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    Node nextWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** è¿”å›å‰ç½®èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">        Node p = prev;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, Node mode) &#123;</span><br><span class="line">        <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, <span class="keyword">int</span> waitStatus) &#123;</span><br><span class="line">        <span class="keyword">this</span>.waitStatus = waitStatus;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å…¥åˆ—</p><p>CLHé˜Ÿåˆ—æ˜¯åŒå‘é“¾è¡¨çš„FIFOé˜Ÿåˆ—ï¼ŒçŸ¥é“äº†è¿™ä¸ªç‰¹æ€§ä¹‹åï¼Œå¯¹äºå®ƒçš„å…¥åˆ—å°±åŸºæœ¬èƒ½æ˜äº†äº†ï¼Œæ¯æ¬¡å…¥åˆ—å‡æ”¾åœ¨é˜Ÿåˆ—æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹AQSçš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºCLHé˜Ÿåˆ—èŠ‚ç‚¹</span></span><br><span class="line">  Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">  <span class="comment">// è·å–å½“å‰çš„å°¾ç»“ç‚¹</span></span><br><span class="line">  Node pred = tail;</span><br><span class="line">  <span class="comment">// å¦‚æœå°¾ç»“ç‚¹ä¸ä¸ºnullï¼Œè¯´æ˜é˜Ÿåˆ—å·²å®Œæˆäº†åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹è®¾ç½®ä¸ºåŸå°¾ç»“ç‚¹</span></span><br><span class="line">    node.prev = pred;</span><br><span class="line">    <span class="comment">// å°†å½“å‰èŠ‚ç‚¹é€šè¿‡CASè®¾ç½®ä¸ºå°¾ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">      <span class="comment">// å°†åŸå°¾ç»“ç‚¹çš„åç½®èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">      pred.next = node;</span><br><span class="line">      <span class="comment">// è¿”å›å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é˜Ÿåˆ—ä¸ºç©ºçš„å¤„ç†</span></span><br><span class="line">  enq(node);</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ— é™å¾ªç¯å…¥é˜Ÿï¼Œç›´åˆ°æˆåŠŸ</span></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">// è·å–å°¾ç»“ç‚¹</span></span><br><span class="line">    Node t = tail;</span><br><span class="line">    <span class="comment">// å°¾ç»“ç‚¹ä¸ºç©ºï¼Œè¯´æ˜é˜Ÿåˆ—å°šæœªè¢«åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®å¤´ç»“ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">        <span class="comment">// è®¾ç½®å°¾ç»“ç‚¹ï¼Œå¤´å°¾ç›¸ç­‰åˆ™è¡¨ç¤ºé˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">        tail = head;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹è®¾ç½®ä¸ºåŸå°¾ç»“ç‚¹</span></span><br><span class="line">      node.prev = t;</span><br><span class="line">      <span class="comment">// å°†å½“å‰èŠ‚ç‚¹é€šè¿‡CASè®¾ç½®ä¸ºå°¾ç»“ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">        <span class="comment">// å°†åŸå°¾ç»“ç‚¹çš„åç½®èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">        t.next = node;</span><br><span class="line">        <span class="comment">// è¿”å›åŸå°¾ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­çœ‹åˆ°ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯é€šè¿‡CASæ–¹æ³•<code>compareAndSetHead(Node update)</code>å’Œ<code>compareAndSetTail(Node expect, Node update)</code>æ¥è®¾ç½®å¤´å°¾èŠ‚ç‚¹ï¼Œç¡®ä¿èŠ‚ç‚¹çš„æ·»åŠ æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨enq(Node node)æ–¹æ³•ä¸­é€šè¿‡æ— é™å¾ªç¯æ¥ä¿è¯èŠ‚ç‚¹å¯ç”¨è¢«æ­£ç¡®æ·»åŠ ï¼Œåªæœ‰åœ¨æˆåŠŸä¹‹åæ‰ä¼šè¿”å›ã€‚</p></li><li><p>å‡ºåˆ—</p><p>CLHé˜Ÿåˆ—éµå¾ªFIFOè§„åˆ™ï¼Œé¦–èŠ‚ç‚¹å…ˆå ç”¨å…±äº«èµ„æºï¼Œåœ¨çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†ä¼šå”¤é†’å®ƒçš„åç»§èŠ‚ç‚¹(next)ï¼Œåç»§èŠ‚ç‚¹åœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸä¹‹åå°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯åŒå‘é“¾è¡¨çš„ç§»åŠ¨ï¼Œå°†å¤´ç»“ç‚¹çš„nextæŒ‡å‘åŸé¦–èŠ‚ç‚¹çš„nextï¼Œç„¶åè¿™ä¸ªnextèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹è®¾ç½®ä¸ºnullï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦ä½¿ç”¨CASæ¥ä¿è¯ï¼Œå› ä¸ºåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">      <span class="comment">// å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹æ˜¯headçš„è¯ï¼Œåˆ™è¡¨æ˜è½®åˆ°å®ƒæ¥è·å–åŒæ­¥çŠ¶æ€äº†</span></span><br><span class="line">      <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">        <span class="comment">// åŠ é”æˆåŠŸï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´ç»“ç‚¹</span></span><br><span class="line">        setHead(node);</span><br><span class="line">        p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">        failed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> interrupted;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å½“å‰èŠ‚ç‚¹ä¸æ˜¯ç¬¬äºŒä¸ªèŠ‚ç‚¹ æˆ–è€…å†æ¬¡è·å–é”å¤±è´¥</span></span><br><span class="line">      <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·ï¼Œåœ¨æŒ‚èµ·åï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸­æ–­</span></span><br><span class="line">      <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">          parkAndCheckInterrupt())</span><br><span class="line">        interrupted = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (failed)</span><br><span class="line">      cancelAcquire(node);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHead</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">  head = node;</span><br><span class="line">  node.thread = <span class="keyword">null</span>;</span><br><span class="line">  node.prev = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">  Node p = prev;</span><br><span class="line">  <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line"><span class="comment">// å½“å‰èŠ‚ç‚¹å·²ç»è¢«è®¾ç½®ä¸ºç­‰å¾…å”¤é†’çš„çŠ¶æ€ï¼Œå¯ä»¥å®‰å…¨çš„æŒ‚èµ·äº†</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰èŠ‚ç‚¹nodeçš„å‰ä»»èŠ‚ç‚¹è¢«å–æ¶ˆï¼Œé‚£ä¹ˆè·³è¿‡è¿™äº›å–æ¶ˆçš„èŠ‚ç‚¹ï¼Œå½“è·³è¿‡ä¹‹åï¼Œé‡æ–°å°è¯•è·å–é”</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * é€šè¿‡å‰é¢çš„åˆ¤æ–­ï¼ŒwaitStatusä¸€å®šä¸æ˜¯ SIGNAL æˆ– CANCELLEDã€‚</span></span><br><span class="line"><span class="comment">         * æ¨æ–­å‡ºä¸€å®šæ˜¯ 0 or PROPAGATE</span></span><br><span class="line"><span class="comment">         * è°ƒç”¨è€…éœ€è¦å†æ¬¡å°è¯•ï¼Œåœ¨æŒ‚èµ·ä¹‹å‰èƒ½ä¸èƒ½è·å–åˆ°é”ï¼Œ</span></span><br><span class="line"><span class="comment">         * å› æ­¤ï¼Œå°†å½“å‰predçš„çŠ¶æ€è®¾ä¸ºSIGNALï¼Œå†æ¬¡å°è¯•è·å–é”ä¹‹åï¼Œå¦‚æœè¿˜æ²¡æœ‰å¾—åˆ°é”é‚£ä¹ˆæŒ‚èµ·</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªçº¿ç¨‹å¯¹äºé”çš„ä¸€æ¬¡ç«äº‰çš„ç»“æœæœ‰ä¸¤ç§ï¼š</p><ul><li>è¦ä¹ˆæˆåŠŸè·å–åˆ°é”(ä¸ç”¨è¿›å…¥åˆ°CLHé˜Ÿåˆ—)</li><li>è¦ä¹ˆè·å–å¤±è´¥è¢«æŒ‚èµ·ï¼Œç­‰å¾…ä¸‹æ¬¡å”¤é†’åç»§ç»­å¾ªç¯å°è¯•è·å–é”</li></ul><blockquote><p>å› ä¸ºAQSçš„é˜Ÿåˆ—æ˜¯FIFOçš„ï¼Œæ‰€ä»¥æ¯æ¬¡è¢«CPUå”¤é†’ä¹‹åï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯å¤´ç»“ç‚¹ï¼Œåˆ™ä¼šè¢«æŒ‚èµ·ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å®ç°äº†ç«äº‰çš„æ’é˜Ÿç­–ç•¥ã€‚</p></blockquote></li></ul><h3 id="å››-ç‹¬å é”reentrantlock"><a class="markdownIt-Anchor" href="#å››-ç‹¬å é”reentrantlock"></a> å››ã€ç‹¬å é”ReentrantLock</h3><ol><li><p>ç‹¬å é”çš„å®ç°ç±»æœ‰ReentrantLockã€ReentrantReadWriteLockã€ThreadPoolExecutorç­‰ï¼Œæˆ‘ä»¬æ‹¿ReentrantLockå­¦ä¹ ä¸€ä¸‹ç‹¬å é”çš„ä½¿ç”¨ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹ReentrantLockçš„åŸºæœ¬ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cc</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ReentrantLockä¼šä¿è¯åœ¨lock.lock()å’Œlock.unlock()ä¹‹é—´çš„ä»£ç å—åœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œå…¶ä½™çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç›´è‡³è·å–åˆ°é”ã€‚</p></li><li><p>ReentrantLockçš„åŸºæœ¬åŸç†</p><p>ReentrantLockå†…éƒ¨æœ‰å…¬å¹³é”(FairSync)å’Œéå…¬å¹³é”(NonfairSync)ï¼Œé»˜è®¤é‡‡ç”¨éå…¬å¹³é”ã€‚</p><ul><li>å…¬å¹³é”ï¼šæ¯ä¸ªçº¿ç¨‹æŠ¢å é”çš„é¡ºåºæŒ‰ç…§è°ƒç”¨lockæ–¹æ³•çš„é¡ºåºä¾æ¬¡è·å–é”</li><li>éå…¬å¹³é”ï¼šæ¯ä¸ªçº¿ç¨‹æŠ¢å é”çš„é¡ºåºå’Œè°ƒç”¨lockæ–¹æ³•çš„é¡ºåºæ— å…³ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹åˆ°æ¥ä¹‹åéƒ½å…ˆè·å–é”ï¼Œè·å–ä¸åˆ°çš„è¯å†åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤éå…¬å¹³é”</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync = <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºReentrantLockï¼Œå…¬å¹³é”oréå…¬å¹³é”</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// åŠ é”è§£é”ï¼Œä½¿ç”¨syncå®Œæˆ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº†è§£äº†ReentrantLockçš„é”ç«äº‰æœºåˆ¶ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒåˆ°åº•æ˜¯æ€ä¹ˆå®ç°ç‹¬å é”çš„ã€‚æ—¢ç„¶ReentrantLockçš„é”æ˜¯é€šè¿‡å…¬å¹³é”å’Œéå…¬å¹³é”æ¥å®ç°çš„ï¼Œé‚£ä¹ˆåŠ é”å’Œé‡Šæ”¾é”çš„å®ç°é€»è¾‘ä¹Ÿéƒ½åœ¨è¿™ä¸¤æŠŠé”ä¸­äº†ã€‚</p><ul><li><p>åŒæ­¥é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»§æ‰¿è‡ªAQS</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5179523762034025860L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ é”</span></span><br><span class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éå…¬å¹³é”åŠ é”</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–AQSçš„stateçš„å€¼</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœstate=0è¡¨ç¤ºå½“å‰å…±äº«èµ„æºç©ºé—²</span></span><br><span class="line">      <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºç‹¬å é”çš„æ‹¥æœ‰è€…</span></span><br><span class="line">        setExclusiveOwnerThread(current);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æ˜¯é”çš„æ‹¥æœ‰è€…ï¼Œåˆ™å¢åŠ stateçš„å€¼ï¼Œé‡å…¥é”çš„æ¦‚å¿µ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">      <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">      <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">      setState(nextc);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ é”å¤±è´¥</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–stateçš„å€¼å¹¶å‡å»è¦é‡Šæ”¾çš„é”æ•°é‡</span></span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºé”çš„æ‹¥æœ‰è€…ï¼Œå…¶å®å¯ä»¥æ›¿æ¢ä¸ºif(!isHeldExclusively())</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// state==0ï¼Œé”é‡Šæ”¾</span></span><br><span class="line">      free = <span class="keyword">true</span>;</span><br><span class="line">      <span class="comment">// è®¾ç½®æ‹¥æœ‰è€…ä¸ºç©º</span></span><br><span class="line">      setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°state</span></span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºé”çš„æ‹¥æœ‰è€…</span></span><br><span class="line">    <span class="keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conditionæ§åˆ¶å¯¹è±¡ï¼Œæä¾›lock.newCondition()æ–¹æ³•è°ƒç”¨</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> ConditionObject <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å½“å‰é”çš„æ‹¥æœ‰è€…çº¿ç¨‹</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> Thread <span class="title">getOwner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getState() == <span class="number">0</span> ? <span class="keyword">null</span> : getExclusiveOwnerThread();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–é”çš„é‡å…¥æ¬¡æ•°ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯é”çš„æ‹¥æœ‰è€…ï¼Œåˆ™è¿”å›0</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getHoldCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> isHeldExclusively() ? getState() : <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é”æ˜¯å¦è¢«å ç”¨äº†</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    setState(<span class="number">0</span>); <span class="comment">// reset to unlocked state</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Syncç±»æ˜¯å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŸºç±»ï¼Œé»˜è®¤æä¾›äº†éå…¬å¹³é”çš„åŠ é”é€»è¾‘ï¼Œä¹Ÿæä¾›äº†é€šç”¨çš„ä¸€äº›æ–¹æ³•ï¼Œå¤§éƒ¨åˆ†çš„æ–¹æ³•ä¹Ÿéƒ½è¢«finalä¿®é¥°ï¼Œä¸å…è®¸è¢«é‡è½½å’Œé‡å†™ã€‚</p></li><li><p>å…¬å¹³é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3000897897090466540L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®ç°Syncçš„lock()æŠ½è±¡æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// stateè®¾ç½®ä¸º1ï¼Œè°ƒç”¨åˆ°AQSä¸­çš„acquireæ–¹æ³•</span></span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…¬å¹³é”åŠ é”ï¼Œç”±AQSçš„acquireæ–¹æ³•è°ƒç”¨è¿‡æ¥</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–stateçš„å€¼</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// é”æœªè¢«å ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// é¦–å…ˆåˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">      <span class="comment">// é˜Ÿåˆ—ä¸ä¸ºç©ºåˆ™åŠ é”å¤±è´¥ï¼Œå¹¶æ”¾å…¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">      <span class="comment">// ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨CASä¿®æ”¹stateçš„å€¼ï¼ŒæˆåŠŸåå°±æ˜¯åŠ é”æˆåŠŸ</span></span><br><span class="line">      <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">          compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºé”çš„æ‹¥æœ‰è€…</span></span><br><span class="line">        setExclusiveOwnerThread(current);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é”è¢«å æœ‰ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰é”çš„æ‹¥æœ‰è€…</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">      <span class="comment">// é‡å…¥é”æœºåˆ¶</span></span><br><span class="line">      <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">      <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">      setState(nextc);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>éå…¬å¹³é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7316153563782823691L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ é”</span></span><br><span class="line">  <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// éå…¬å¹³çš„å…³é”®</span></span><br><span class="line">    <span class="comment">// çº¿ç¨‹è°ƒç”¨lock()åï¼Œä¸è®ºç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰æ²¡æœ‰ç­‰å¾…ä¸­çš„çº¿ç¨‹ï¼Œéƒ½ç”³è¯·ä¸€æ¬¡åŠ é”ï¼ŒCASæ“ä½œè®¾ç½®state=1ï¼Œåœ¨åŸçº¿ç¨‹æ‹¥æœ‰è€…é‡Šæ”¾é”åˆ°é˜Ÿåˆ—ä¸­å¤´ç»“ç‚¹åŠ é”æˆåŠŸä¹‹é—´å¯èƒ½ä¼šåŠ é”æˆåŠŸï¼Œè¿™å¯ä»¥ç†è§£ä¸ºæ’é˜Ÿçš„è¿‡ç¨‹ä¸­é‡åˆ°æ’é˜Ÿçš„</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">      setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="comment">// è°ƒç”¨AQSçš„acquireæ–¹æ³•</span></span><br><span class="line">      acquire(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”±AQSä¸­çš„acquireæ–¹æ³•è°ƒç”¨å›æ¥</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºSyncä¸­é»˜è®¤å®ç°äº†éå…¬å¹³é”ï¼Œæ‰€ä»¥åªè¦è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•å³å¯</span></span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>å°æ€»ç»“:</p><ol><li>å…¬å¹³é”ä¸éå…¬å¹³é”çš„é”é‡Šæ”¾æ­¥éª¤æ˜¯ä¸€è‡´çš„</li><li>è·å–é”çš„è¿‡ç¨‹ä¸ä¸€è‡´ï¼Œå…¬å¹³é”ä¼˜å…ˆæ‰§è¡Œç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ï¼Œéå…¬å¹³é”è®©å½“å‰çº¿ç¨‹æŠ¢å ï¼Œå¦‚æœä¸€ç›´è¢«æŠ¢å çš„è¯ï¼Œé˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹å¯èƒ½ä¸€ç›´éƒ½æ‰§è¡Œä¸äº†ã€‚</li></ol></blockquote></li><li><p>å…¶ä»–æ–¹æ³•</p><p>ReentrantLockè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å…¶ä»–çš„æ–¹æ³•ï¼Œæ–¹ä¾¿æˆ‘ä»¬çš„ä½¿ç”¨ã€‚</p><ul><li><p><code>getQueuedThreads()</code>ï¼šè·å–ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹ï¼Œè¿”å›ä¸€ä¸ªList&lt;Thread&gt;å¯¹è±¡ï¼ŒæŒ‰ç…§åŠ å…¥é˜Ÿåˆ—é¡ºåºå€’åº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Collection&lt;Thread&gt; <span class="title">getQueuedThreads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ArrayList&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;Thread&gt;();</span><br><span class="line">  <span class="comment">// ä»å°¾éƒ¨å¼€å§‹è¿­ä»£</span></span><br><span class="line">  <span class="keyword">for</span> (Node p = tail; p != <span class="keyword">null</span>; p = p.prev) &#123;</span><br><span class="line">    Thread t = p.thread;</span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span>)</span><br><span class="line">      list.add(t);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>tryLock()</code>ï¼šå°è¯•è·å–é”</p></li><li><p><code>isFair()</code>ï¼šè·å–å½“å‰é”æ˜¯å¦ä¸ºå…¬å¹³é”ï¼Œtrueä»£è¡¨å…¬å¹³é”</p></li><li><p><code>newCondition()</code>ï¼šé”æ§åˆ¶æ¡ä»¶ç±»å®ä¾‹ï¼Œç±»ä¼¼äºwaitå’Œnotify</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** ä½¿ç”¨æ–¹å¼:ArrayBlockingQueue */</span></span><br><span class="line"><span class="keyword">private</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">Condition notEmpty = lock.newCondition();</span><br><span class="line">Condition notFull = lock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  checkNotNull(e);</span><br><span class="line">  <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">  lock.lockInterruptibly();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (count == items.length)</span><br><span class="line">      notFull.await();</span><br><span class="line">    enqueue(e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  E x = (E) items[takeIndex];</span><br><span class="line">  items[takeIndex] = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (++takeIndex == items.length)</span><br><span class="line">    takeIndex = <span class="number">0</span>;</span><br><span class="line">  count--;</span><br><span class="line">  <span class="keyword">if</span> (itrs != <span class="keyword">null</span>)</span><br><span class="line">    itrs.elementDequeued();</span><br><span class="line">  notFull.signal();</span><br><span class="line">  <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">  lock.lockInterruptibly();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (count == <span class="number">0</span>)</span><br><span class="line">      notEmpty.await();</span><br><span class="line">    <span class="keyword">return</span> dequeue();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(E x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">  items[putIndex] = x;</span><br><span class="line">  <span class="keyword">if</span> (++putIndex == items.length)</span><br><span class="line">    putIndex = <span class="number">0</span>;</span><br><span class="line">  count++;</span><br><span class="line">  notEmpty.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="äº”-å…±äº«é”countdownlatch"><a class="markdownIt-Anchor" href="#äº”-å…±äº«é”countdownlatch"></a> äº”ã€å…±äº«é”CountDownLatch</h3><ol><li><p>CountDownLatchåŸºæœ¬åŸç†</p><p>CountDownLatchç¿»è¯‘ä¸€ä¸‹å°±æ˜¯&quot;å€’æ•°é—¨æ “&quot;ï¼Œå¯ä»¥ç†è§£ä¸ºç»™ä¸€ä¸ªé—¨ä¸Šäº†næŠŠé”ï¼Œç„¶åé”ä¸€æŠŠä¸€æŠŠçš„å¼€ï¼Œç›´åˆ°æ‰€æœ‰çš„é”éƒ½æ‰“å¼€ä¹‹åï¼Œé—¨æ‰èƒ½å½»åº•æ‰“å¼€ã€‚æ‰€ä»¥CountDownLatchåªæœ‰ä¸€ä¸ªæ„é€ å™¨ï¼Œæ„é€ å™¨ä¼ å…¥é”çš„æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡å°±å€’æ•°ä¸€æ¬¡ï¼Œå½“æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¸»çº¿ç¨‹æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ•°é‡éœ€è¦å’Œéœ€è¦æ‰§è¡Œçš„çº¿ç¨‹æ•°ä¸€è‡´ï¼Œå¦åˆ™ä¼šå‡ºç°æå‰é‡Šæ”¾å’Œæ— æ³•é‡Šæ”¾çš„æƒ…å†µã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (count &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"count &lt; 0"</span>);</span><br><span class="line">  <span class="keyword">this</span>.sync = <span class="keyword">new</span> Sync(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CountDownLatchä¸»è¦é€šè¿‡await()å’ŒcountDown()å®Œæˆé”ç­‰å¾…å’Œå€’æ•°ï¼Œæ²¡è°ƒç”¨ä¸€æ¬¡countDown()å°±å°†è®¡æ•°å™¨å‡ä¸€ï¼Œä¸€èˆ¬åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å†…è°ƒç”¨ï¼Œæ­¤æ–¹æ³•ä¸åŒºåˆ†è°ƒç”¨è€…ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹å†…è°ƒç”¨å¤šæ¬¡ï¼›await()æ–¹æ³•æ˜¯å°†è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä¸€èˆ¬æ˜¯ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹å†…è°ƒç”¨ï¼Œæ‰€æœ‰è°ƒç”¨äº†await()æ–¹æ³•çš„çº¿ç¨‹éƒ½å°†é™·å…¥ç­‰å¾…ï¼Œå¹¶ä¸”å…±äº«åŒä¸€æŠŠé”ï¼Œå½“CountDownLatchçš„é”é‡Šæ”¾å®Œä¹‹åï¼Œæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹éƒ½åŒæ—¶ç»“æŸç­‰å¾…å¹¶æ¢å¤æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// é˜»å¡</span></span><br><span class="line">  sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// é‡Šæ”¾å…±äº«é”</span></span><br><span class="line">  sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°åœ¨CountDownLatchä¸­ä¹Ÿæ˜¯é€šè¿‡Syncç±»æ¥æ§åˆ¶é”çš„ï¼Œå¹¶ä¸”Syncæ˜¯CountDownLatchçš„å†…éƒ¨ç±»ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Syncçš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4982264981922014374L</span>;</span><br><span class="line"></span><br><span class="line">  Sync(<span class="keyword">int</span> count) &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–é”çš„æ•°é‡</span></span><br><span class="line">    setState(count);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰å‰©ä½™çš„é”æ•°é‡</span></span><br><span class="line">    <span class="keyword">return</span> getState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®å‰©ä½™é”çš„æ•°é‡å†³å®šæ˜¯å¦åŠ é”æˆåŠŸï¼Œè‹¥è¿˜æœ‰å‰©ä½™é”ï¼Œåˆ™è¿”å›-1ï¼Œè¡¨ç¤ºåŠ é”æˆåŠŸï¼Œå¦åˆ™è¿”å›1ï¼Œè¡¨ç¤ºä¸å…è®¸åŠ é”</span></span><br><span class="line">    <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="keyword">int</span> c = getState();</span><br><span class="line">      <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// é”å·²å…¨éƒ¨é‡Šæ”¾ï¼Œä¸å…è®¸é‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// é”-1</span></span><br><span class="line">      <span class="keyword">int</span> nextc = c-<span class="number">1</span>;</span><br><span class="line">      <span class="comment">// é€šè¿‡CASè®¾ç½®stateå€¼ï¼Œç¡®ä¿å¹¶å‘å®‰å…¨</span></span><br><span class="line">      <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">        <span class="comment">// å½“nextcä¸º0çš„æ—¶å€™è¡¨ç¤ºé”å·²ç»å…¨éƒ¨é‡Šæ”¾äº†</span></span><br><span class="line">        <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>countDownæ–¹æ³•å·¥ä½œæ–¹å¼</p><p>tryReleaseShared()æ–¹æ³•åœ¨AQSçš„releaseShared()æ–¹æ³•ä¸­è°ƒç”¨ï¼Œæ–¹æ³•ä¸­åªæœ‰ä¸€ä¸ªifåˆ¤æ–­ï¼Œæ§åˆ¶é”é‡Šæ”¾çš„æ—¶æœºï¼ŒdoReleaseShared()æ–¹æ³•ä¸»è¦ä½œç”¨æ˜¯å”¤é†’è°ƒç”¨äº†await()æ–¹æ³•çš„çº¿ç¨‹ã€‚å¦‚æœCountDownLatchæ˜¯ç‹¬å å¼çš„ï¼Œé‚£ä¹ˆå½“è®¡æ•°å™¨ä¸ºå‡è‡³0æ—¶ï¼Œå°±åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œè¿™å°±ä¹±å¥—äº†ï¼Œä¸¥é‡BUGã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">    doReleaseShared();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">// è·å–ç­‰å¾…é˜Ÿåˆ—çš„å¤´ç»“ç‚¹</span></span><br><span class="line">    Node h = head;</span><br><span class="line">    <span class="comment">// å¤´ç»“ç‚¹ä¸ä¸ºç©ºä¸”ä¸æ˜¯å°¾ç»“ç‚¹ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">      <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">      <span class="comment">// SIGNALè¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…è¢«å”¤é†’</span></span><br><span class="line">      <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">        <span class="comment">// æ¸…æ¥šå½“å‰èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// å”¤é†’å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        unparkSuccessor(h);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">               !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœhè¿˜æ˜¯å¤´ç»“ç‚¹ï¼Œåˆ™è¯´æ˜ç­‰å¾…é˜Ÿåˆ—åœ¨ä¸Šé¢çš„ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (h == head)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">  <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// æ¸…é™¤å½“å‰èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">    compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">  Node s = node.next;</span><br><span class="line">  <span class="comment">// åç»§èŠ‚ç‚¹ä¸å­˜åœ¨æˆ–è€…è¯¥èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å·²ç»è¢«å–æ¶ˆç­‰å¾…</span></span><br><span class="line">  <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    s = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—ä»å°¾éƒ¨å¾€å‰éå†ï¼Œæ‰¾åˆ°æœ€åä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">      <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">        s = t;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">    <span class="comment">// å”¤é†’ç¦»å½“å‰èŠ‚ç‚¹æœ€è¿‘çš„å¤„äºç­‰å¾…çŠ¶æ€çš„èŠ‚ç‚¹çº¿ç¨‹</span></span><br><span class="line">    LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤æˆ‘ä»¬äº†è§£äº†CountDownLatchçš„countDown()æ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯æ¯æ¬¡è°ƒç”¨countDown()æ–¹æ³•éƒ½ä¼šå°†stateå‡1ï¼Œç›´åˆ°stateå‡è‡³0çš„æ—¶å€™ï¼Œè°ƒç”¨doReleaseShared()æ–¹æ³•å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰çº¿ç¨‹çš„ç­‰å¾…çŠ¶æ€éƒ½æ¸…é™¤æ‰(waitStatusé€šè¿‡CASè®¾ç½®ä¸º0)ã€‚</p></li><li><p>await()æ–¹æ³•å·¥ä½œæ–¹å¼</p><p>await()æ–¹æ³•è°ƒç”¨äº†Syncçš„acquireSharedInterruptibly()æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å…·æœ‰å…±äº«æ‰§è¡Œæƒé™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">  <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">  <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æœ‰æ‰§è¡Œæƒé™ï¼Œä¹Ÿå°±æ˜¯æ ¡éªŒæ˜¯å¦è¿˜æœ‰æœªé‡Šæ”¾çš„é”</span></span><br><span class="line">  <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// é˜»å¡</span></span><br><span class="line">    doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªå…±äº«æ¨¡å¼çš„èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">final</span> Node node = addWaiter(Node.SHARED);</span><br><span class="line">  <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">      <span class="comment">// å‰ç½®èŠ‚ç‚¹æ˜¯å¦ä¸ºheadèŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">        <span class="comment">// åŠ é”ï¼Œå¦‚æœè¿˜æœ‰é”æœªé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯state&gt;0ï¼Œæ–¹æ³•è¿”å›-1ï¼Œå¦åˆ™è¿”å›1</span></span><br><span class="line">        <span class="keyword">int</span> r = tryAcquireShared(arg);</span><br><span class="line">        <span class="comment">// é”å·²å…¨éƒ¨é‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´ç»“ç‚¹ï¼Œè¡¨ç¤ºæ‰€æœ‰çº¿ç¨‹éƒ½å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œé€€å‡ºforå¾ªç¯ï¼Œå¯ä»¥ç»§ç»­await()æ–¹æ³•ä¹‹åçš„ä»£ç </span></span><br><span class="line">          setHeadAndPropagate(node, r);</span><br><span class="line">          p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">          failed = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜å½“å‰é”è¿˜æœªé‡Šæ”¾å®Œï¼Œä½¿ç”¨LockSupport.park(this);æŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">      <span class="comment">// æ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šç­‰å¾…åœ¨æ­¤å¤„ï¼Œåœ¨countDown()æ–¹æ³•ä¸­è¢«LockSupport.unpark(s.thread);å”¤é†’åç»§ç»­ä»è¿™é‡Œæ‰§è¡Œ</span></span><br><span class="line">      <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">          parkAndCheckInterrupt())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (failed)</span><br><span class="line">      cancelAcquire(node);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHeadAndPropagate</span><span class="params">(Node node, <span class="keyword">int</span> propagate)</span> </span>&#123;</span><br><span class="line">  Node h = head;</span><br><span class="line">  setHead(node);</span><br><span class="line">  <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">      (h = head) == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.isShared())</span><br><span class="line">      <span class="comment">// é‡Šæ”¾å¹¶å”¤é†’ç»“æŸawait</span></span><br><span class="line">      doReleaseShared();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨åœºæ™¯</p><ul><li><p>åœºæ™¯1ï¼šåœ¨æ¯ä¸ªçº¿ç¨‹å†…è°ƒç”¨ä¸€æ¬¡countDown()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">  CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> fi = i;</span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(fi * <span class="number">1000</span>);</span><br><span class="line">        System.out.println(fi);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        latch.countDown();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">  &#125;</span><br><span class="line">  System.out.println(<span class="string">"before:"</span> + System.currentTimeMillis());</span><br><span class="line">  latch.await();</span><br><span class="line">  System.out.println(<span class="string">"after:"</span> + System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œç»“æœï¼š</p><p>0</p><p>before:1587753222118</p><p>1</p><p>2</p><p>after:1587753224118</p></blockquote></li><li><p>åœºæ™¯2ï¼šåœ¨æ¯ä¸ªçº¿ç¨‹å†…è°ƒç”¨ä¸‰æ¬¡countDown()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">  CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> fi = i;</span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(fi * <span class="number">1000</span>);</span><br><span class="line">        System.out.println(fi);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        latch.countDown();</span><br><span class="line">        latch.countDown();</span><br><span class="line">        latch.countDown();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">  &#125;</span><br><span class="line">  System.out.println(<span class="string">"before:"</span> + System.currentTimeMillis());</span><br><span class="line">  latch.await();</span><br><span class="line">  System.out.println(<span class="string">"after:"</span> + System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œç»“æœï¼š</p><p>0</p><p>before:1587753292096</p><p>after:1587753292096</p><p>1</p><p>2</p></blockquote></li></ul></li><li><p>æ€»ç»“</p><p>CountDownLatchæ˜¯é€šè¿‡ä¸€ä¸ªè®¡æ•°å™¨æ¥å®ç°çš„å…±äº«é”ï¼Œè®¡æ•°å™¨çš„å€¼å°±æ˜¯çº¿ç¨‹çš„æ•°é‡ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨CountDownLatchçš„å®ä¾‹æ–¹æ³•await()é˜»å¡æ‰€æœ‰çš„çº¿ç¨‹ï¼Œé˜»å¡åœ°ç‚¹åœ¨parkAndCheckInterrupt()æ–¹æ³•ä¸­ï¼›æ¯è°ƒç”¨ä¸€æ¬¡countDown()æ–¹æ³•éƒ½ä¼šå°†è®¡æ•°å™¨å‡1ï¼Œç›´åˆ°è®¡æ•°å™¨å½’é›¶ä¹‹åå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œä½¿await()æ‰§è¡Œç»“æŸï¼Œæ—¢ç„¶await()æ‰§è¡Œç»“æŸäº†ï¼Œé‚£ä¹ˆä¹Ÿå°±å¯ä»¥ç»§ç»­æ‰§è¡Œawait()çš„åç»­ä»£ç äº†ã€‚</p></li></ol><h3 id="å…­-æ€»ç»“"><a class="markdownIt-Anchor" href="#å…­-æ€»ç»“"></a> å…­ã€æ€»ç»“</h3><p>é€šè¿‡CountDownLatchå’ŒReentrantLockå¯ä»¥å‘ç°å‡ ä¸ªç‰¹ç‚¹ï¼š</p><ol><li>ç‹¬å é”çš„ä½¿ç”¨å’Œç”³è¯·åŠ é”çº¿ç¨‹å¼ºå…³è”ï¼Œæ¯æ­¤åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹éœ¸å ç€é”ï¼Œä¸”å¯ä»¥é€šè¿‡å½“å‰çº¿ç¨‹å’Œé”æ‹¥æœ‰è€…çº¿ç¨‹å¯¹æ¯”æ¥å®ç°é”çš„é‡å…¥</li><li>å…±äº«é”çš„ä½¿ç”¨å’Œçº¿ç¨‹å¼±å…³è”ï¼Œæ¯æ¬¡å¯ä»¥æ‰§è¡Œä¸€æ‰¹çº¿ç¨‹ä»»åŠ¡ï¼Œä½¿ç”¨stateæ¥æ§åˆ¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ï¼Œé€šè¿‡LockSupport.park()é˜»å¡è¿™æ‰¹ä»»åŠ¡ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¹‹åå°†stateçš„å€¼å‡1ï¼Œç›´è‡³å½’é›¶ï¼Œç„¶åé€šè¿‡LockSupport.unpark()é€€å‡ºé˜»å¡</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¸€-ç®€ä»‹&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ä¸€-ç®€ä»‹&quot;&gt;&lt;/a&gt; ä¸€ã€ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;åœ¨Javaä¸­ï¼Œè°ˆåˆ°å¹¶å‘å°±ä¸å¾—ä¸è¯´åˆ°jdkä¸­çš„J.U.CåŒ…ï¼Œè€Œè¯´åˆ°æ­¤åŒ…å¿…å®šè¦è¯´åˆ°AQS(AbstractQueuedSynchroni
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Canalå®ç°æ•°æ®åº“å’ŒRedisåŒæ­¥</title>
    <link href="http://luxiaowan.github.io/2020/04/24/%E4%BD%BF%E7%94%A8Canal%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8CRedis%E5%90%8C%E6%AD%A5/"/>
    <id>http://luxiaowan.github.io/2020/04/24/ä½¿ç”¨Canalå®ç°æ•°æ®åº“å’ŒRedisåŒæ­¥/</id>
    <published>2020-04-23T16:35:00.000Z</published>
    <updated>2020-04-23T17:43:57.412Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-ç®€ä»‹"><a class="markdownIt-Anchor" href="#ä¸€-ç®€ä»‹"></a> ä¸€ã€ç®€ä»‹</h3><p>Canalæ˜¯Javaå¼€å‘çš„åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æå·¥å…·ï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…å’Œæ¶ˆè´¹ï¼Œç›®å‰ä¸»è¦æ”¯æŒMySQLã€‚å®ƒçš„å·¥ä½œåŸç†æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†è‡ªå·±ä¼ªè£…æˆä¸€ä¸ªMySQL Slaveï¼Œä»MasteråŒæ­¥æ•°æ®ã€‚</p><ul><li>canal æ¨¡æ‹Ÿ MySQL slave çš„äº¤äº’åè®®ï¼Œä¼ªè£…è‡ªå·±ä¸º MySQL slave ï¼Œå‘ MySQL master å‘é€dump åè®®</li><li>MySQL master æ”¶åˆ° dump è¯·æ±‚ï¼Œå¼€å§‹æ¨é€ binary log ç»™ slave (å³ canal )</li><li>canal è§£æ binary log å¯¹è±¡(åŸå§‹ä¸º byte æµ)</li><li>è§£æåçš„æ•°æ®å†åšåç»­å¤„ç†</li></ul><p><img src="/images/canal.png" alt="img"></p><p>å…ˆäº†è§£ä¸€ä¸‹MySQLä¸»å¤‡å¤åˆ¶åŸç†ï¼š</p><ul><li>MySQL master å°†æ•°æ®å˜æ›´å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—( binary log, å…¶ä¸­è®°å½•å«åšäºŒè¿›åˆ¶æ—¥å¿—äº‹ä»¶binary log eventsï¼Œå¯ä»¥é€šè¿‡ show binlog events è¿›è¡ŒæŸ¥çœ‹)</li><li>MySQL slave å°† master çš„ binary log events æ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—(relay log)</li><li>MySQL slave é‡æ”¾ relay log ä¸­äº‹ä»¶ï¼Œå°†æ•°æ®å˜æ›´åæ˜ å®ƒè‡ªå·±çš„æ•°æ®</li></ul><h3 id="äºŒ-å‡†å¤‡å·¥ä½œ"><a class="markdownIt-Anchor" href="#äºŒ-å‡†å¤‡å·¥ä½œ"></a> äºŒã€å‡†å¤‡å·¥ä½œ</h3><ol><li>å¯¹äºè‡ªå»ºçš„MySQLï¼Œéœ€è¦å¼€å¯binlogå†™å…¥åŠŸèƒ½ï¼Œå¹¶é…ç½®biglog-formatä¸ºROWæ¨¡å¼ï¼Œè¿™æ ·æ‰èƒ½ä¸€è¡Œè¡Œçš„æ£€æµ‹åˆ°æ•°æ®çš„å˜åŠ¨</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin # å¼€å¯ binlog</span><br><span class="line">binlog-format=ROW # é€‰æ‹© ROW æ¨¡å¼</span><br><span class="line">server_id=1 # é…ç½® MySQL replaction éœ€è¦å®šä¹‰ï¼Œä¸è¦å’Œ canal çš„ slaveId é‡å¤</span><br></pre></td></tr></table></figure><ol start="2"><li>åˆ›å»ºcanalç”¨æˆ·å¹¶æˆæƒå…¶ä½œä¸ºMySQL Slaveçš„æƒé™</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER canal IDENTIFIED BY &apos;canal&apos;;</span><br><span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &apos;canal&apos;@&apos;%&apos;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><h3 id="ä¸‰-å¯åŠ¨canalæœåŠ¡"><a class="markdownIt-Anchor" href="#ä¸‰-å¯åŠ¨canalæœåŠ¡"></a> ä¸‰ã€å¯åŠ¨CanalæœåŠ¡</h3><ol><li><p>ä¸‹è½½canal</p><p>æˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯<a href="https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.deployer-1.1.4.tar.gz" target="_blank" rel="noopener">canal.deployer-1.1.4.tar.gz</a></p></li><li><p>è§£å‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf canal.deployer-1.1.4.tar.gz</span><br><span class="line">cd canal.deployer-1.1.4</span><br></pre></td></tr></table></figure><img src="/images/image-20200424004844430.png" alt="image-20200424004844430" style="zoom:50%;"></li><li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ˜¯MySQL Masterçš„è¿æ¥ä¿¡æ¯</p><p>æ‰“å¼€æ–‡ä»¶<code>conf/example/instance.properties</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># mysql serverId , v1.0.26+ will autoGen</span></span></span><br><span class="line">canal.instance.mysql.slaveId=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> gtid use <span class="literal">true</span>/<span class="literal">false</span></span></span><br><span class="line">canal.instance.gtidon=false</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> position info</span></span><br><span class="line">canal.instance.master.address=127.0.0.1:3306</span><br><span class="line">canal.instance.master.journal.name=</span><br><span class="line">canal.instance.master.position=</span><br><span class="line">canal.instance.master.timestamp=</span><br><span class="line">canal.instance.master.gtid=</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> rds oss binlog</span></span><br><span class="line">canal.instance.rds.accesskey=</span><br><span class="line">canal.instance.rds.secretkey=</span><br><span class="line">canal.instance.rds.instanceId=</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> table meta tsdb info</span></span><br><span class="line">canal.instance.tsdb.enable=true</span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.tsdb.url=jdbc:mysql://127.0.0.1:3306/canal_tsdb</span></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.tsdb.dbUsername=canal</span></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.tsdb.dbPassword=canal</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.standby.address =</span></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.standby.journal.name =</span></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.standby.position =</span></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.standby.timestamp =</span></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.standby.gtid=</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> username/password</span></span><br><span class="line">canal.instance.dbUsername=canal</span><br><span class="line">canal.instance.dbPassword=canal</span><br><span class="line">canal.instance.defaultDatabaseName=test_canal</span><br><span class="line">canal.instance.connectionCharset = UTF-8</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> druid Decrypt database password</span></span><br><span class="line">canal.instance.enableDruid=false</span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.pwdPublicKey=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALK4BUxdDltRRE5/zXpVEVPUgunvscYFtEip3pmLlhrWpacX7y7GCMo2/JM6LeHmiiNdH1FWgGCpUfircSwlWKUCAwEAAQ==</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> table regex</span></span><br><span class="line">canal.instance.filter.regex=.*\\..*</span><br><span class="line"><span class="meta">#</span><span class="bash"> table black regex</span></span><br><span class="line">canal.instance.filter.black.regex=</span><br><span class="line"><span class="meta">#</span><span class="bash"> table field filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.filter.field=test1.t_product:id/subject/keywords,test2.t_company:id/name/contact/ch</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> table field black filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">canal.instance.filter.black.field=test1.t_product:subject/product_image,test2.t_company:id/name/contact/ch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> mq config</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> canal.mq.topic=example</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dynamic topic route by schema or table regex</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> canal.mq.dynamicTopic=mytest1.user,mytest2\\..*,.*\\..*</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> canal.mq.partition=0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">hash</span> partition config</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> canal.mq.partitionsNum=3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> canal.mq.partitionHash=test.table:id^name,.*\\..*</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################################</span></span></span><br></pre></td></tr></table></figure><ul><li>canal.instance.connectionCharset ä»£è¡¨æ•°æ®åº“çš„ç¼–ç æ–¹å¼å¯¹åº”åˆ° java ä¸­çš„ç¼–ç ç±»å‹ï¼Œæ¯”å¦‚ UTF-8ï¼ŒGBK , ISO-8859-1</li><li>å¦‚æœç³»ç»Ÿæ˜¯1ä¸ª cpuï¼Œéœ€è¦å°† canal.instance.parser.parallel è®¾ç½®ä¸º false</li></ul></li><li><p>å¯åŠ¨canal</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/startup.sh</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹serverå’Œinstanceæ—¥å¿—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2020-04-23 23:48:59.048 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - ## set default uncaught exception handler</span><br><span class="line">2020-04-23 23:48:59.097 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - ## load canal configurations</span><br><span class="line">2020-04-23 23:48:59.110 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - ## start the canal server.</span><br><span class="line">2020-04-23 23:48:59.178 [main] INFO  com.alibaba.otter.canal.deployer.CanalController - ## start the canal server[192.168.0.106(192.168.0.106):11111]</span><br><span class="line">2020-04-23 23:49:00.243 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - ## the canal server is running now ......</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">er.setConnectionCharset(java.lang.String)]</span><br><span class="line">2020-04-23 23:48:59.793 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</span><br><span class="line">2020-04-23 23:48:59.794 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]</span><br><span class="line">2020-04-23 23:49:00.192 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance for 1-example</span><br><span class="line">2020-04-23 23:49:00.199 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --&gt; init table filter : ^.*\..*$</span><br><span class="line">2020-04-23 23:49:00.199 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --&gt; init table black filter :</span><br><span class="line">2020-04-23 23:49:00.206 [main] INFO  c.a.otter.canal.instance.core.AbstractCanalInstance - start successful....</span><br></pre></td></tr></table></figure></li><li><p>å…³é—­</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/stop.sh</span><br></pre></td></tr></table></figure></li></ol><h3 id="å››-åˆ›å»ºjavaå·¥ç¨‹"><a class="markdownIt-Anchor" href="#å››-åˆ›å»ºjavaå·¥ç¨‹"></a> å››ã€åˆ›å»ºJavaå·¥ç¨‹</h3><ol><li><p>å¼•å…¥canalå’ŒredisåŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.otter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal.client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºRedisUtilså·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RedisæœåŠ¡å™¨IP</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String      ADDR       = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redisçš„ç«¯å£å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>         PORT       = <span class="number">6379</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¿é—®å¯†ç </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String      AUTH       = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨è¿æ¥å®ä¾‹çš„æœ€å¤§æ•°ç›®ï¼Œé»˜è®¤å€¼ä¸º8ï¼›</span></span><br><span class="line">    <span class="comment">// å¦‚æœèµ‹å€¼ä¸º-1ï¼Œåˆ™è¡¨ç¤ºä¸é™åˆ¶ï¼›å¦‚æœpoolå·²ç»åˆ†é…äº†maxActiveä¸ªjediså®ä¾‹ï¼Œåˆ™æ­¤æ—¶poolçš„çŠ¶æ€ä¸ºexhausted(è€—å°½)ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>         MAX_ACTIVE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ§åˆ¶ä¸€ä¸ªpoolæœ€å¤šæœ‰å¤šå°‘ä¸ªçŠ¶æ€ä¸ºidle(ç©ºé—²çš„)çš„jediså®ä¾‹ï¼Œé»˜è®¤å€¼ä¹Ÿæ˜¯8ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>         MAX_IDLE   = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…å¯ç”¨è¿æ¥çš„æœ€å¤§æ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œé»˜è®¤å€¼ä¸º-1ï¼Œè¡¨ç¤ºæ°¸ä¸è¶…æ—¶ã€‚å¦‚æœè¶…è¿‡ç­‰å¾…æ—¶é—´ï¼Œåˆ™ç›´æ¥æŠ›å‡ºJedisConnectionExceptionï¼›</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>         MAX_WAIT   = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">int</span>       expireTime = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥æ± </span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> JedisPool pool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é™æ€ä»£ç ï¼Œåªåœ¨åˆæ¬¡è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="comment">//æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">        config.setMaxTotal(MAX_ACTIVE);</span><br><span class="line">        <span class="comment">//æœ€å¤šç©ºé—²å®ä¾‹</span></span><br><span class="line">        config.setMaxIdle(MAX_IDLE);</span><br><span class="line">        <span class="comment">//è¶…æ—¶æ—¶é—´</span></span><br><span class="line">        config.setMaxWaitMillis(MAX_WAIT);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        config.setTestOnBorrow(<span class="keyword">false</span>);</span><br><span class="line">        pool = <span class="keyword">new</span> JedisPool(config, ADDR, PORT, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–jediså®ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Jedis <span class="title">getJedis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pool.returnBrokenResource(jedis);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jedis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾jedisèµ„æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jedis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isBroken</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeResource</span><span class="params">(Jedis jedis, <span class="keyword">boolean</span> isBroken)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isBroken) &#123;</span><br><span class="line">                pool.returnBrokenResource(jedis);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pool.returnResource(jedis);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ˜¯å¦å­˜åœ¨key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">existKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> isBroken = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getJedis();</span><br><span class="line">            jedis.select(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> jedis.exists(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            isBroken = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeResource(jedis, isBroken);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  åˆ é™¤key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> isBroken = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getJedis();</span><br><span class="line">            jedis.select(<span class="number">0</span>);</span><br><span class="line">            jedis.del(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            isBroken = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeResource(jedis, isBroken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  å–å¾—keyçš„å€¼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">stringGet</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> isBroken = <span class="keyword">false</span>;</span><br><span class="line">        String lastVal = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getJedis();</span><br><span class="line">            jedis.select(<span class="number">0</span>);</span><br><span class="line">            lastVal = jedis.get(key);</span><br><span class="line">            jedis.expire(key, expireTime);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            isBroken = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeResource(jedis, isBroken);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lastVal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ·»åŠ stringæ•°æ®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">stringSet</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> isBroken = <span class="keyword">false</span>;</span><br><span class="line">        String lastVal = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getJedis();</span><br><span class="line">            jedis.select(<span class="number">0</span>);</span><br><span class="line">            lastVal = jedis.set(key, value);</span><br><span class="line">            jedis.expire(key, expireTime);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            isBroken = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeResource(jedis, isBroken);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lastVal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ·»åŠ hashæ•°æ®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hashSet</span><span class="params">(String key, String field, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isBroken = <span class="keyword">false</span>;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getJedis();</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.select(<span class="number">0</span>);</span><br><span class="line">                jedis.hset(key, field, value);</span><br><span class="line">                jedis.expire(key, expireTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            isBroken = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeResource(jedis, isBroken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºCanalClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.common.utils.AddressUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CanalClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºé“¾æ¥</span></span><br><span class="line">        CanalConnector connector = CanalConnectors</span><br><span class="line">                .newSingleConnector(<span class="keyword">new</span> InetSocketAddress(AddressUtils.getHostIp(), <span class="number">11111</span>), <span class="string">"example"</span>, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">int</span> batchSize = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connector.connect();</span><br><span class="line">            connector.subscribe(<span class="string">".*\\..*"</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Message message = connector.getWithoutAck(batchSize); <span class="comment">// è·å–æŒ‡å®šæ•°é‡çš„æ•°æ®</span></span><br><span class="line">                <span class="keyword">long</span> batchId = message.getId();</span><br><span class="line">                <span class="keyword">int</span> size = message.getEntries().size();</span><br><span class="line">                <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    printEntry(message.getEntries());</span><br><span class="line">                &#125;</span><br><span class="line">                connector.ack(batchId); <span class="comment">// æäº¤ç¡®è®¤</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printEntry</span><span class="params">(List&lt;Entry&gt; entrys)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN</span><br><span class="line">                    || entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            RowChange rowChage = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rowChage = RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ERROR ## parser of eromanga-event has an error , data:"</span> + entry.toString(),</span><br><span class="line">                        e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EventType eventType = rowChage.getEventType();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (RowData rowData : rowChage.getRowDatasList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (eventType == EventType.DELETE) &#123;</span><br><span class="line">                    <span class="comment">// åˆ é™¤ï¼Œè·å–åˆ é™¤å‰çš„æ•°æ®</span></span><br><span class="line">                    redisDelete(rowData.getBeforeColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventType == EventType.INSERT) &#123;</span><br><span class="line">                  <span class="comment">// æ–°å¢ï¼Œè·å–æ–°å¢åçš„æ•°æ®</span></span><br><span class="line">                    redisSet(rowData.getAfterColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// ä¿®æ”¹ï¼Œè·å–ä¿®æ”¹åçš„æ•°æ®</span></span><br><span class="line">                    <span class="comment">//                    printColumn(rowData.getBeforeColumnsList());</span></span><br><span class="line">                    redisSet(rowData.getAfterColumnsList());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisSet</span><span class="params">(List&lt;Column&gt; columns)</span> </span>&#123;</span><br><span class="line">        JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">      <span class="comment">// å­—æ®µå’Œå€¼çš„åˆ—è¡¨ï¼Œæ”¾å…¥jsonï¼Œåç»­ä½œä¸ºredisçš„å€¼</span></span><br><span class="line">        <span class="keyword">for</span> (Column column : columns) &#123;</span><br><span class="line">            json.put(column.getName(), column.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (columns.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          System.out.println(<span class="string">"set key: "</span> + columns.get(<span class="number">0</span>).getValue() + <span class="string">", value: "</span> + json.toJSONString());</span><br><span class="line">          <span class="comment">// è·å–ç¬¬ä¸€åˆ—ä¸»é”®çš„æ•°æ®</span></span><br><span class="line">            RedisUtils.stringSet(<span class="string">"demo:"</span> + columns.get(<span class="number">0</span>).getValue(), json.toJSONString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisDelete</span><span class="params">(List&lt;Column&gt; columns)</span> </span>&#123;</span><br><span class="line">        JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns) &#123;</span><br><span class="line">            json.put(column.getName(), column.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (columns.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          System.out.println(<span class="string">"delete key: "</span> + columns.get(<span class="number">0</span>).getValue());</span><br><span class="line">            RedisUtils.delKey(<span class="string">"demo:"</span> + columns.get(<span class="number">0</span>).getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="äº”-éªŒè¯"><a class="markdownIt-Anchor" href="#äº”-éªŒè¯"></a> äº”ã€éªŒè¯</h3><ol><li><p>å¯åŠ¨CanalClient.java</p></li><li><p>åˆ›å»ºæ•°æ®è¡¨test_canal</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test_canal` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(11) DEFAULT NULL,</span><br><span class="line">  `age` int(11) DEFAULT 0,</span><br><span class="line">  `sex` varchar(11) DEFAULT &apos;ç”·&apos;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `idx_name` (`name`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4</span><br></pre></td></tr></table></figure></li><li><p>æ ¡éªŒä¸€ä¸‹Redisä¸­ç›®å‰æ˜¯å¦ä¸ºç©º</p><p><img src="/images/image-20200424011739125.png" alt="image-20200424011739125"></p></li><li><p>æ’å…¥æ•°æ®</p><ul><li>æ’å…¥ä¸‰æ¡æ•°æ®</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO test_canal(name, age, sex) VALUES(&apos;cc0&apos;, 3, &apos;ç”·&apos;);</span><br><span class="line">INSERT INTO test_canal(name, age, sex) VALUES(&apos;cc1&apos;, 6, &apos;å¥³&apos;);</span><br><span class="line">INSERT INTO test_canal(name, age, sex) VALUES(&apos;cc2&apos;, 9, &apos;ç”·&apos;);</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹æ§åˆ¶å°</li></ul><p><img src="/images/image-20200424011949902.png" alt="image-20200424011949902"></p><ul><li>æŸ¥è¯¢Redisä¸­çš„æ•°æ®</li></ul><img src="/images/image-20200424012034154.png" alt="image-20200424012034154" style="zoom: 50%;"><p>éªŒè¯æˆåŠŸï¼Œæ•°æ®åŒæ­¥è¾¾åˆ°äº†æ¯«ç§’çº§ã€‚</p></li><li><p>ä¿®æ”¹æ•°æ®</p><ul><li>ä¿®æ”¹id=5çš„æ•°æ®</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE test_canal SET sex=&apos;11&apos; WHERE id=5;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹æ§åˆ¶å°</li></ul><img src="/images/image-20200424012346073.png" alt="image-20200424012346073" style="zoom:44%;"><ul><li>æŸ¥è¯¢Redisä¸­çš„æ•°æ®</li></ul><img src="/images/image-20200424012421781.png" alt="image-20200424012421781" style="zoom:50%;"><p>éªŒè¯æˆåŠŸï¼ŒRedisä¸­çš„sexåˆ—å·²ç»ä¿®æ”¹ä¸ºä½•MySQLè¡¨ä¸­ä¸€è‡´äº†</p></li><li><p>åˆ é™¤æ•°æ®</p><ul><li>åˆ é™¤id=5çš„æ•°æ®</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM test_canal WHERE id=5;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹æ§åˆ¶å°</li></ul><img src="/images/image-20200424012700399.png" alt="image-20200424012700399" style="zoom:50%;"><ul><li>æŸ¥è¯¢Redisä¸­çš„æ•°æ®</li></ul><img src="/images/image-20200424013951523.png" alt="image-20200424013951523" style="zoom:50%;"><p>éªŒè¯æˆåŠŸï¼ŒRedisä¸­çš„&quot;demo:5&quot;å·²ç»è¢«åˆ é™¤äº†</p></li></ol><h3 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h3><p>å…³äºæ›´å¤šçš„Canalä»‹ç»å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/alibaba/canal/wiki/%E7%AE%80%E4%BB%8B" target="_blank" rel="noopener">Canalå®˜æ–¹ä»‹ç»</a>ï¼Œæºç«¯ç›®å‰åªæ”¯æŒMySQLï¼Œç›®æ ‡ç«¯å¯ä»¥æ˜¯ä»»æ„ç»„ä»¶</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¸€-ç®€ä»‹&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ä¸€-ç®€ä»‹&quot;&gt;&lt;/a&gt; ä¸€ã€ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;Canalæ˜¯Javaå¼€å‘çš„åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æå·¥å…·ï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…å’Œæ¶ˆè´¹ï¼Œç›®å‰ä¸»è¦æ”¯æŒMySQLã€‚å®ƒçš„å·¥ä½œåŸç†æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†è‡ª
      
    
    </summary>
    
    
      <category term="Redis" scheme="http://luxiaowan.github.io/categories/Redis/"/>
    
    
      <category term="MySQL" scheme="http://luxiaowan.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Mavenä¸­optionalå’Œexclusionçš„åŒºåˆ«</title>
    <link href="http://luxiaowan.github.io/2020/04/23/Maven%E4%B8%ADoptional%E5%92%8Cexclusion%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <id>http://luxiaowan.github.io/2020/04/23/Mavenä¸­optionalå’Œexclusionçš„åŒºåˆ«/</id>
    <published>2020-04-23T03:20:00.000Z</published>
    <updated>2020-04-23T05:07:04.699Z</updated>
    
    <content type="html"><![CDATA[<p>ç”¨äº†é‚£ä¹ˆä¹…çš„Mavenï¼Œæˆ‘ä»¬éƒ½çŸ¥é“Mavençš„ä¾èµ–å…³ç³»å…·æœ‰ä¼ é€’æ€§ï¼Œæ¯”å¦‚Aä¾èµ–Bï¼ŒBä¾èµ–Cï¼Œé‚£ä¹ˆAä¹Ÿä¾èµ–äºCï¼Œå…·ä½“åœ¨é¡¹ç›®ä¸­çš„è¡¨ç°è§å›¾ï¼š</p><p><img src="/images/image-20200423122520591.png" alt="image-20200423122520591"></p><p>ä¸Šè¿°ä¾èµ–åœ¨pom.xmlä¸­çš„å…³ç³»æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">C(cc-spring-boot-starter-autoconfigure):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">B(cc-spring-boot-starter):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-starter-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">A(cc-starter-demo):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œé¡¹ç›®Aå¯èƒ½ä¸æ˜¯å¿…é¡»ä¾èµ–Cï¼Œå¦‚æœä¸åšå¤„ç†çš„è¯ï¼Œæœ€ç»ˆä¼šè®©é¡¹ç›®Aéå¸¸çš„è‡ƒè‚¿ï¼Œæ‰“çš„åŒ…éå¸¸å¤§ã€‚åœ¨Mavenä¸­ï¼Œæä¾›äº†ä¸¤ç§æ–¹å¼ç®¡ç†éå¿…é¡»çš„ä¾èµ–å…³ç³»ï¼šå¯é€‰ä¾èµ–(Optional Dependencies)å’Œä¾èµ–æ’é™¤(Dependency Exclusion)ã€‚</p><h3 id="ä¸€-ä¾èµ–æ’é™¤exclusion"><a class="markdownIt-Anchor" href="#ä¸€-ä¾èµ–æ’é™¤exclusion"></a> ä¸€ã€ä¾èµ–æ’é™¤(exclusion)</h3><p>åœ¨é¡¹ç›®Aä¸­ï¼Œä¸éœ€è¦ä¾èµ–é¡¹ç›®Cä¸­çš„<code>org.springframework.boot:spring-boot-configuration-processor</code>åŒ…ï¼Œä½†æ˜¯é¡¹ç›®Bä»ç„¶éœ€è¦ä¾èµ–å®ƒï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦åœ¨é¡¹ç›®Aä¸­å°†è¿™ä¸ªåŒ…æ’é™¤æ‰ï¼Œä½†æ˜¯åˆä¸èƒ½å½±å“å…¶ä»–é¡¹ç›®å¯¹è¿™ä¸ªåŒ…çš„ä¾èµ–ï¼Œå…³ç³»å›¾ä¸ºï¼š</p><p><img src="/images/image-20200423122841522.png" alt="image-20200423122841522"></p><p>æˆ‘ä»¬åªè¦åœ¨éœ€è¦æ’é™¤çš„é¡¹ç›®Aä¸­ï¼Œå¯¹ä¾èµ–çš„dependencyåŠ ä¸Šexclusionå¹¶æŒ‡å®šè¦æ’é™¤åŒ…çš„groupIdå’ŒartifactIdå³å¯ï¼Œä¸éœ€è¦æŒ‡å®šç‰ˆæœ¬å·ï¼Œè‹¥ä¸Šæœ‰é¡¹ç›®ä¾èµ–äº†å¤šä¸ªç›¸åŒåŒ…çš„ä¸åŒç‰ˆæœ¬ï¼Œåœ¨è¿™é‡Œä¼šå…¨éƒ¨éƒ½æ’é™¤æ‰ã€‚å¯¹åº”çš„pom.xmlæ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">C(cc-spring-boot-starter-autoconfigure):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">B(cc-spring-boot-starter):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-starter-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">A(cc-starter-demo):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="äºŒ-å¯é€‰ä¾èµ–optional"><a class="markdownIt-Anchor" href="#äºŒ-å¯é€‰ä¾èµ–optional"></a> äºŒã€å¯é€‰ä¾èµ–(optional)</h3><p>å¯é€‰ä¾èµ–å°±å‰å®³äº†ï¼Œåªå…è®¸åœ¨å½“å‰é¡¹ç›®ä½¿ç”¨ï¼Œä»ä¸å¾€ä¸‹ä¼ é€’ï¼Œä¸‹æ¸¸é¡¹ç›®è¦æ˜¯æƒ³ä½¿ç”¨çš„è¯éœ€è¦è‡ªå·±é‡æ–°å¼•å…¥ï¼Œæ¯”å¦‚<code>org.springframework.boot:spring-boot-configuration-processor</code>æ˜¯è‡ªåŠ¨ç”Ÿæˆé…ç½®å‚æ•°çš„åŠŸèƒ½æ€§åŒ…ï¼Œä¹Ÿä»…ä»…å°±åœ¨ç”Ÿæˆå‚æ•°å£°æ˜çš„æ—¶å€™ç”¨åˆ°ï¼Œæ²¡å¿…è¦å¾€ä¸‹ä¼ é€’ï¼Œé‚£ä¹ˆè¿™ç§å°±éœ€è¦åœ¨é¡¹ç›®Cä¸­åšæ§åˆ¶äº†ï¼Œä¸¥ç¦å®ƒä¾èµ–çš„åŒ…å‘ä¸‹ä¼ é€’ã€‚</p><p><img src="/images/image-20200423124556099.png" alt="image-20200423124556099"></p><p>æˆ‘ä»¬åœ¨é¡¹ç›®Cä¸­å°†<code>org.springframework.boot:spring-boot-configuration-processor</code>çš„optionalé€‰é¡¹è®¾ç½®ä¸ºtrueï¼Œé»˜è®¤ä¸ºfalseï¼ˆtrue: ä¸å‘ä¸‹ä¼ é€’ï¼Œfalse: å‘ä¸‹ä¼ é€’ï¼‰ï¼Œåœ¨<code>org.mybatis:mybatis</code>åŒ…ä¸­æœ‰å¤§é‡çš„åº”ç”¨ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œæ”¾å¼ å›¾ï¼š</p><img src="/images/image-20200423125547745.png" alt="image-20200423125547745" style="zoom:67%;"><p>é¡¹ç›®pom.xmlå†…å®¹å¦‚ä¸‹ï¼Œå…³æ³¨ä¸€ä¸‹é¡¹ç›®Cçš„ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">C(cc-spring-boot-starter-autoconfigure):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">B(cc-spring-boot-starter):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-starter-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">A(cc-starter-demo):</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h3><p>åœ¨Mavenä¾èµ–ç®¡ç†ä¸­ï¼Œæœ‰ä¾èµ–æ’é™¤å’Œå¯é€‰ä¾èµ–ä¸¤ç§æ–¹å¼å¯ä»¥å±è”½é¡¹ç›®ä¸éœ€è¦çš„åŒ…ï¼ŒåŒºåˆ«æ˜¯åªæƒ³åœ¨å½“å‰é¡¹ç›®ä½¿ç”¨çš„è¯å°±ç”¨å¯é€‰ä¾èµ–ï¼Œè‹¥åœ¨å½“å‰é¡¹ç›®ä¸æƒ³ä½¿ç”¨ä¾èµ–çš„åŒ…ä¸­çš„æŸä¸ªåŒ…ï¼Œåˆ™ç”¨ä¾èµ–æ’é™¤ã€‚</p><ol><li>å¯é€‰ä¾èµ–æ˜¯åœ¨ç¬¬ä¸€çº§è¢«å¼•ç”¨çš„åœ°æ–¹ä½¿ç”¨optionalæ ‡ç­¾å£°æ˜</li><li>ä¾èµ–æ’é™¤æ˜¯åœ¨å…·ä½“ä¸éœ€è¦ä¾èµ–çš„é‚£ä¸€çº§ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºæœ€åä¸€çº§ï¼‰ä½¿ç”¨exclusionæ§åˆ¶</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ç”¨äº†é‚£ä¹ˆä¹…çš„Mavenï¼Œæˆ‘ä»¬éƒ½çŸ¥é“Mavençš„ä¾èµ–å…³ç³»å…·æœ‰ä¼ é€’æ€§ï¼Œæ¯”å¦‚Aä¾èµ–Bï¼ŒBä¾èµ–Cï¼Œé‚£ä¹ˆAä¹Ÿä¾èµ–äºCï¼Œå…·ä½“åœ¨é¡¹ç›®ä¸­çš„è¡¨ç°è§å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/image-20200423122520591.png&quot; alt=&quot;image-20200
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
      <category term="Maven" scheme="http://luxiaowan.github.io/tags/Maven/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootè‡ªå®šä¹‰starter</title>
    <link href="http://luxiaowan.github.io/2020/04/23/SpringBoot%E8%87%AA%E5%AE%9A%E4%B9%89starter/"/>
    <id>http://luxiaowan.github.io/2020/04/23/SpringBootè‡ªå®šä¹‰starter/</id>
    <published>2020-04-22T17:16:00.000Z</published>
    <updated>2020-04-22T19:15:22.642Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-ç®€ä»‹"><a class="markdownIt-Anchor" href="#ä¸€-ç®€ä»‹"></a> ä¸€ã€ç®€ä»‹</h3><p>SpringBootç”±ä¼—å¤šçš„starterç»„æˆï¼Œè¿™äº›starterä¹Ÿè¢«ç§°ä¸ºæ˜¯åœºæ™¯å¯åŠ¨å™¨ï¼Œåœ¨å·¥ç¨‹ä¸­å¼•å…¥ç‰¹å®šçš„starterå†è¿›è¡Œå°‘é‡çš„é…ç½®å°±å¯ä»¥ä½¿ç”¨å…¶æä¾›çš„ç›¸åº”çš„åŠŸèƒ½äº†ï¼ŒSpringBootåœ¨ä¸æ–­çš„ç»´æŠ¤å’Œæ‰©å±•ä¸åŒåœºæ™¯çš„starterç»™ä½¿ç”¨è€…æä¾›æ›´å®Œå–„çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„starteråˆ¶å®šæˆ‘ä»¬è‡ªå·±çš„ç‰¹å®šåœºæ™¯ã€‚</p><h3 id="äºŒ-springbootä¸­çš„starter"><a class="markdownIt-Anchor" href="#äºŒ-springbootä¸­çš„starter"></a> äºŒã€SpringBootä¸­çš„starter</h3><ol><li><p>æˆ‘ä»¬æŸ¥çœ‹SpringBootæä¾›çš„starterå¯ä»¥å‘ç°æ‰€æœ‰çš„starteråŒ…ä¸‹éƒ½æ²¡æœ‰ä»»ä½•ä»£ç </p><img src="/images/image-20200423013229581.png" alt="starter" style="zoom:67%;"></li><li><p>æˆ‘ä»¬æ‰¾åˆ°<code>spring-boot-starter-data-redis.jar</code>åŒ…çš„pom.xmlæŸ¥çœ‹ä¸€ä¸‹å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starters<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Boot Data Redis Starter<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- çœç•¥ä¸€éƒ¨åˆ† --&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcl-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªstarterç»§æ‰¿è‡ª<code>spring-boot-starters</code>åŒ…ï¼Œå¹¶ä¸”æ‰€æœ‰çš„starteréƒ½å¼•å…¥äº†<code>spring-boot-starter</code>åŒ…ï¼ŒåŒ…ä¸­è¿˜å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©æ€§çš„å¼•å…¥å…¶ä»–çš„jaråŒ…ã€‚</p></li><li><p>è¿›å…¥åˆ°<code>spring-boot-starter</code>åŒ…ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒå¼•å…¥äº†<code>spring-boot-autoconfigure</code>åŒ…ï¼Œè¿™æ˜¯æˆ‘ä»¬å®Œæˆè‡ªåŠ¨é…ç½®çš„å…³é”®</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>spring-boot-autoconfigure.jar</code>çš„ç›®å½•ç»“æ„å‘ç°åŒ…å«äº†å„ç§starterçš„é…ç½®ä¿¡æ¯ã€‚</p><ul><li>æ ‡1ï¼šéœ€è¦è‡ªåŠ¨é…ç½®çš„ç±»å£°æ˜æ–‡ä»¶</li><li>æ ‡2ï¼šé…ç½®æ–‡ä»¶ä¸­è‡ªåŠ¨æç¤ºçš„å…ƒå±æ€§æ•°æ®å£°æ˜æ–‡ä»¶</li><li>æ ‡3ï¼šè‡ªåŠ¨é…ç½®æ§åˆ¶ç±»</li><li>æ ‡4ï¼šåœºæ™¯å±æ€§ç±»</li></ul><img src="/images/image-20200423015235559.png" alt="autoconfigure" style="zoom:67%;"></li></ol><p>ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªstarterçš„å…³é”®æ‰€åœ¨äº†ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯ï¼š</p><blockquote><ul><li>å¯åŠ¨å™¨starteråªæ˜¯ç”¨æ¥åšä¾èµ–ç®¡ç†çš„ï¼Œå…¶ä¸åº”è¯¥åŒ…å«ä»»ä½•ä»£ç å’Œé…ç½®ï¼Œéœ€è¦å¼•å…¥autoconfigureåŒ…</li><li>è‡ªåŠ¨è£…é…autoconfigureåŒ…ï¼Œéœ€è¦åŒ…å«æˆ‘ä»¬éœ€è¦è®©SpringBootè‡ªåŠ¨è£…é…çš„æ¨¡å—ï¼Œä»¥åŠèµ„æºé…ç½®ä¿¡æ¯ï¼Œæ€»çš„æ¥è¯´åŒ…æ‹¬ï¼šspring.factoriesã€spring-configuration-metadata.jsonã€XxxAutoConfigurationã€XxxProperties</li><li>ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦å¼•å…¥å¯åŠ¨å™¨starterå°±å¯ä»¥å®ç°è‡ªåŠ¨é…ç½®</li></ul></blockquote><h3 id="ä¸‰-è‡ªå®šä¹‰starterå‘½åè§„èŒƒ"><a class="markdownIt-Anchor" href="#ä¸‰-è‡ªå®šä¹‰starterå‘½åè§„èŒƒ"></a> ä¸‰ã€è‡ªå®šä¹‰starterå‘½åè§„èŒƒ</h3><ul><li>å®˜æ–¹å‘½åè§„èŒƒ<ul><li>è§„åˆ™ï¼šspring-boot-starter-æ¨¡å—å</li><li>ä¸¾ä¾‹ï¼šspring-boot-starter-data-redisã€spring-boot-starter-web</li></ul></li><li>è‡ªå®šä¹‰å‘½åè§„èŒƒ<ul><li>è§„åˆ™ï¼šæ¨¡å—å-spring-boot-starter</li><li>ä¸¾ä¾‹ï¼šcc-spring-boot-starter</li></ul></li></ul><h3 id="å››-è‡ªå®šä¹‰starter-demo"><a class="markdownIt-Anchor" href="#å››-è‡ªå®šä¹‰starter-demo"></a> å››ã€è‡ªå®šä¹‰starter demo</h3><p>æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸¤ä¸ªé¡¹ç›®ï¼šcc-spring-boot-autoconfigureå’Œcc-spring-boot-starter</p><ol><li><p>åˆ›å»ºcc-spring-boot-autoconfigureå·¥ç¨‹</p><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨å·¥ç¨‹åˆ›å»ºå®Œæˆä¹‹åï¼Œè¦åˆ é™¤å¯åŠ¨ç±»ã€application.propertieså’Œtestæ–‡ä»¶å¤¹</p><ul><li><p>pom.xmlå’Œæ§åˆ¶ç±»</p><ul><li><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starters<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>CcProperties</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.lu.autoconfigure.wt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"cc.config"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CcProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String  name = <span class="string">"cc"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age  = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String  birthday;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBirthday</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBirthday</span><span class="params">(String birthday)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.birthday = birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"CcProperties&#123;"</span> + <span class="string">"name='"</span> + name + <span class="string">'\''</span> + <span class="string">", age="</span> + age + <span class="string">", birthday='"</span> + birthday + <span class="string">'\''</span> + <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»çš„æœ‰äº›å±æ€§è¢«è®¾ç½®äº†å€¼ï¼Œè¿™äº›å€¼å°±æ˜¯å½“é…ç½®æ–‡ä»¶æœªé…ç½®å±æ€§æ—¶ä½¿ç”¨çš„é»˜è®¤å€¼ï¼Œè¿™å°±æ˜¯å‚æ•°é…ç½®è®¾ç½®é»˜è®¤å€¼çš„ä¸€ç§æ–¹å¼ã€‚è¿˜æœ‰ä¸€ç§ï¼Œç»§ç»­å¾€ä¸‹çœ‹</p></li><li><p>CcService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.lu.autoconfigure.wt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CcService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CcProperties ccProperties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCcProperties</span><span class="params">(CcProperties ccProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ccProperties = ccProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">info</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ccProperties.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæ™®é€šçš„ç±»ï¼Œæ²¡å•¥å¯è¯´çš„ï¼Œç»§ç»­å¾€ä¸‹</p></li><li><p>CcAutoConfiguration</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.lu.autoconfigure.wt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; CcService.class &#125;)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(&#123; CcProperties.class &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CcAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CcProperties ccProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(&#123; CcService.class &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CcService <span class="title">ccService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CcService ccService = <span class="keyword">new</span> CcService();</span><br><span class="line">      <span class="comment">// æ‰“ä¸ªæ—¥å¿—æŸ¥çœ‹æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨</span></span><br><span class="line">        System.out.println(<span class="string">"------auto register!------"</span>);</span><br><span class="line">        ccService.setCcProperties(ccProperties);</span><br><span class="line">        <span class="keyword">return</span> ccService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CcAutoConfigurationçš„å£°æ˜ä¸Šä½¿ç”¨äº†@ConditionalOnClasså’Œ@EnableConfigurationPropertiesåšåŠ è½½æ§åˆ¶ï¼Œç„¶ååœ¨ç±»ä¸­åˆ›å»ºäº†CcServiceçš„å®ä¾‹ï¼Œå¹¶ä¸”ä½¿ç”¨<code>@ConditionalOnMissingBean({ CcService.class })</code>æ¥æ§åˆ¶åˆ›å»ºæ¡ä»¶ã€‚</p></li></ul></li><li><p>spring.factorieså’Œspring-configuration-metadata.jsoné…ç½®</p><ul><li><p>spring.factories</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line">  <span class="attr">cc.lu.autoconfigurer.wt.CcAutoConfiguration</span></span><br></pre></td></tr></table></figure><p>å°†CcAutoConfigurationæ”¾ç»™EnableAutoConfigurationï¼Œå‘ŠçŸ¥SpringBootå¯åŠ¨çš„æ—¶å€™è¿›è¡Œæ£€æµ‹åŠ è½½ã€‚</p></li><li><p>spring-configuration-metadata.jsonå…ƒå±æ€§æ•°æ®é…ç½®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"groups"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"cc.config"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"cc.lu.autoconfigure.wt.CcProperties"</span>,</span><br><span class="line">      <span class="attr">"sourceType"</span>: <span class="string">"cc.lu.autoconfigure.wt.CcProperties"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"properties"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"cc.config.age"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"java.lang.Integer"</span>,</span><br><span class="line">      <span class="attr">"sourceType"</span>: <span class="string">"cc.lu.autoconfigure.wt.CcProperties"</span>,</span><br><span class="line">      <span class="attr">"defaultValue"</span>: <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"cc.config.birthday"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"java.lang.String"</span>,</span><br><span class="line">      <span class="attr">"sourceType"</span>: <span class="string">"cc.lu.autoconfigure.wt.CcProperties"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"cc.config.name"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"java.lang.String"</span>,</span><br><span class="line">      <span class="attr">"sourceType"</span>: <span class="string">"cc.lu.autoconfigure.wt.CcProperties"</span>,</span><br><span class="line">      <span class="attr">"defaultValue"</span>: <span class="string">"cc"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"hints"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶çš„ç›®çš„æ˜¯åœ¨propertiesæˆ–ymlæ–‡ä»¶ä¸­é…ç½®è‡ªå®šä¹‰å±æ€§çš„æ—¶å€™ï¼Œå¯ä»¥è‡ªåŠ¨æç¤ºï¼Œä¾‹å¦‚ï¼š</p><p><img src="/images/image-20200423023445975.png" alt="image-20200423023445975"></p><p>è¿™ä¸ªæ–‡ä»¶çœ‹ä¸Šå»å¥½åƒéå¸¸å¤æ‚ï¼Œå°¤å…¶æ˜¯å½“æˆ‘ä»¬æœ‰å‡ åä¸ªè‡ªå®šä¹‰é…ç½®å±æ€§çš„æ—¶å€™ï¼Œéš¾é“è¦ä¸€ä¸ªä¸ªå±æ€§çš„å»å†™å—ï¼Ÿç­”æ¡ˆæ˜¯å½“ç„¶ä¸ç”¨ï¼Œå¯ä»¥é€šè¿‡å¼•å…¥ä¸€ä¸ªjaråŒ…æ¥åœ¨æ‰“åŒ…çš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¼•å…¥ä¹‹åï¼Œæ‰§è¡Œå®Œå‘½ä»¤<code>mvn clean package</code>ä¹‹åï¼Œåˆ°target/classes/META-INFç›®å½•ä¸‹æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶</p><img src="/images/image-20200423024104706.png" alt="image-20200423024104706" style="zoom:60%;"></li></ul></li></ul><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„cc-spring-boot-autoconfigureå°±åˆ›å»ºå®Œæˆäº†ï¼Œå›ç„ä¸€çœ¼ï¼Œæ˜¯ä¸æ˜¯å’Œå®˜æ–¹çš„autoconfigureåŒ…å«çš„æ–‡ä»¶ä¸€è‡´äº†ã€‚</p></li><li><p>åˆ›å»ºcc-spring-boot-starterå·¥ç¨‹</p><p>ä¸€ä¸ªå¾ˆæ™®é€šçš„mavenå·¥ç¨‹ï¼Œå› ä¸ºstarterä¸­ä¸€èˆ¬ä¸åŒ…å«ä»»ä½•ä»£ç ï¼Œä»…ä»…ä½œä¸ºåŒ…çš„ä¾èµ–ç®¡ç†å·¥ç¨‹ï¼Œæ‰€ä»¥åˆ›å»ºå®Œæˆä¹‹åä¾ç„¶è¦åˆ é™¤å¯åŠ¨ç±»ã€application.propertieså’Œtestæ–‡ä»¶å¤¹ï¼Œå®ƒåªæœ‰ä¸€ä¸ªpom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>cc-spring-boot-starter<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºcc-starter-demoæµ‹è¯•å·¥ç¨‹</p><p>åˆ›å»ºä¸€ä¸ªå¸¸è§„çš„SpringBootå·¥ç¨‹ï¼Œå¼•å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„starterï¼Œå¹¶è®¾ç½®ç›¸å…³çš„é…ç½®ä¿¡æ¯ï¼Œå°±å¯ä»¥ä½¿ç”¨äº†ã€‚</p><ul><li><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.lu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>application.properties</p><p>ä¿®æ”¹birthdayå’Œnameä¸¤ä¸ªå±æ€§ï¼Œageä½¿ç”¨é»˜è®¤å€¼ï¼Œå¾…ä¼šçœ‹æ•ˆæœ</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cc.config.birthday</span>=<span class="string">2017-03-09</span></span><br><span class="line"><span class="meta">cc.config.name</span>=<span class="string">yc</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºä¸€ä¸ªController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.lu.starter.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cc.lu.autoconfigurer.wt.CcService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CcService ccService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/info"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(ccService.info());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="äº”-æµ‹è¯•"><a class="markdownIt-Anchor" href="#äº”-æµ‹è¯•"></a> äº”ã€æµ‹è¯•</h3><h5 id="1-æƒ…å†µä¸€"><a class="markdownIt-Anchor" href="#1-æƒ…å†µä¸€"></a> 1. æƒ…å†µä¸€</h5><ul><li><p>å¯åŠ¨cc-starter-demoå·¥ç¨‹ï¼ŒæŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼Œä¼šå‘ç°æˆ‘ä»¬åœ¨CcAutoConfigurationä¸­æ‰“å°çš„å­—ç¬¦ä¸²<code>------auto register!------</code>å‡ºç°åœ¨äº†æ§åˆ¶å°ï¼Œè¯´æ˜CcServiceçš„å®ä¾‹åˆ›å»ºæ˜¯åœ¨CcAutoConfigurationä¸­å®Œæˆçš„ã€‚</p><img src="/images/image-20200423030101381.png" alt="image-20200423030101381" style="zoom:60%;"></li><li><p>è®¿é—®http://127.0.0.1:8080/infoï¼ŒæŸ¥çœ‹æ§åˆ¶å°çš„æ—¥å¿—ï¼Œçœ‹åˆ°æˆ‘ä»¬åœ¨application.propertiesæ–‡ä»¶ä¸­é…ç½®çš„å€¼ç”Ÿæ•ˆäº†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„starterå†™çš„æ­£å¸¸ã€‚</p><img src="/images/image-20200423030335580.png" alt="image-20200423030335580" style="zoom:60%;"></li></ul><h5 id="2-æƒ…å†µäºŒ"><a class="markdownIt-Anchor" href="#2-æƒ…å†µäºŒ"></a> 2. æƒ…å†µäºŒ</h5><ul><li><p>åœ¨å¯åŠ¨ç±»ä¸­é‡æ–°å®šä¹‰CcServiceçš„å®ä¾‹åˆ›å»ºæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CcService <span class="title">ccService</span><span class="params">(CcProperties ccProperties)</span> </span>&#123;</span><br><span class="line">  CcService ccService = <span class="keyword">new</span> CcService();</span><br><span class="line">  <span class="comment">// æ‰“ä¸ªæ—¥å¿—æŸ¥çœ‹æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨</span></span><br><span class="line">  System.out.println(<span class="string">"====client register===="</span>);</span><br><span class="line">  ccService.setCcProperties(ccProperties);</span><br><span class="line">  <span class="keyword">return</span> ccService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨å·¥ç¨‹ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ˜¯æ‰“å°äº†å­—ç¬¦ä¸²<code>====client register====</code>è¿˜æ˜¯<code>------auto register!------</code></p><img src="/images/image-20200423030703200.png" alt="image-20200423030703200" style="zoom:67%;"><p>æ§åˆ¶å°æ‰“å°çš„æ˜¯æˆ‘ä»¬demoå·¥ç¨‹é‡Œåˆ›å»ºCcServiceå®ä¾‹æ–¹æ³•å†…çš„å­—ç¬¦ä¸²ï¼Œè€ŒCcAutoConfigurationå†…çš„æ‰“å°è¯­å¥æœªæ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨CcAutoConfigurationç±»ä¸­çš„æ–¹æ³•åŠ äº†<code>@ConditionalOnMissingBean({ CcService.class })</code>æ¥æ§åˆ¶å®ä¾‹çš„åˆ›å»ºã€‚(åˆ’çŸ¥è¯†ç‚¹ï¼Œçº¦å®šå¤§äºé…ç½®)</p></li></ul><h3 id="å…­-æ€»ç»“"><a class="markdownIt-Anchor" href="#å…­-æ€»ç»“"></a> å…­ã€æ€»ç»“</h3><p>é€šè¿‡è‡ªå®šä¹‰starteråˆ†æä¸€ä¸‹å…¶å·¥ä½œåŸç†ï¼š</p><ol><li>SpringBootåœ¨å¯åŠ¨æ—¶æ‰«æé¡¹ç›®ä¾èµ–çš„å…¨éƒ¨jaråŒ…ï¼Œå¹¶å¯»æ‰¾<code>META-INF/spring.factories</code>æ–‡ä»¶</li><li>æ ¹æ®<code>META-INF/spring.factories</code>åŠ è½½ç¬¦åˆæ¡ä»¶çš„<code>AutoConfigure</code>ç±»</li><li>æ ¹æ®<code>@Conditional</code>æ³¨è§£æ¡ä»¶è¿›è¡Œè‡ªåŠ¨é…ç½®ï¼Œå¹¶å°†Beanæ³¨å…¥åˆ°Spring Contextä¸­ã€‚</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¸€-ç®€ä»‹&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ä¸€-ç®€ä»‹&quot;&gt;&lt;/a&gt; ä¸€ã€ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;SpringBootç”±ä¼—å¤šçš„starterç»„æˆï¼Œè¿™äº›starterä¹Ÿè¢«ç§°ä¸ºæ˜¯åœºæ™¯å¯åŠ¨å™¨ï¼Œåœ¨å·¥ç¨‹ä¸­å¼•å…¥ç‰¹å®šçš„starterå†è¿›è¡Œå°‘é‡çš„
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="http://luxiaowan.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>è¯´è¯´SpringBootæ˜¯å¦‚ä½•å®ç°è‡ªåŠ¨è£…é…çš„</title>
    <link href="http://luxiaowan.github.io/2020/04/21/%E8%AF%B4%E8%AF%B4SpringBoot%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E7%9A%84/"/>
    <id>http://luxiaowan.github.io/2020/04/21/è¯´è¯´SpringBootæ˜¯å¦‚ä½•å®ç°è‡ªåŠ¨è£…é…çš„/</id>
    <published>2020-04-21T12:02:00.000Z</published>
    <updated>2020-04-22T16:09:55.197Z</updated>
    
    <content type="html"><![CDATA[<p>Spring Bootæ˜¯Springå®¶æ—ä¸­çš„æ–°å® ï¼Œå®ƒä¸ä»…ç»§æ‰¿äº†Springæ¡†æ¶åŸæœ‰çš„ä¼˜ç§€ç‰¹æ€§ï¼Œè¿˜é€šè¿‡ç®€åŒ–é…ç½®æ¥è¿›ä¸€æ­¥ç®€åŒ–Springåº”ç”¨ç¨‹åºçš„åˆ›å»ºå’Œå¼€å‘è¿‡ç¨‹ã€‚SpringBootæ¡†æ¶ä¸­æœ‰ä¸¤ä¸ªæœ€ä¸»è¦çš„ç­–ç•¥ï¼šå¼€ç®±å³ç”¨å’Œçº¦å®šä¼˜äºé…ç½®ã€‚</p><ul><li>å¼€ç®±å³ç”¨ï¼šåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å¼•å…¥mavenä¾èµ–åŒ…ï¼Œç„¶åä½¿ç”¨æ³¨è§£æ¥ä»£æ›¿ç¹ççš„XMLé…ç½®æ–‡ä»¶æ¥ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™è®©å¼€å‘äººå‘˜æ‘†è„±äº†å¤æ‚çš„é…ç½®å’ŒåŒ…ä¾èµ–ç®¡ç†çš„å·¥ä½œï¼Œæ›´åŠ ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚</li><li>çº¦å®šä¼˜äºé…ç½®ï¼šæŒ‰çº¦å®šç¼–ç¨‹æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡èŒƒå¼ï¼Œç³»ç»Ÿã€ç±»åº“ã€æ¡†æ¶åº”è¯¥å‡å®šåˆç†çš„é»˜è®¤å€¼ï¼Œè€Œéè¦æ±‚æä¾›ä¸å¿…è¦çš„é…ç½®ï¼Œä»è€Œæ—¢èƒ½è·å¾—é…ç½®ç®€å•çš„å¥½å¤„ï¼Œè€Œåˆä¸å¤±çµæ´»æ€§ã€‚</li></ul><p>æœ‰å…³SpringBootçš„æ¦‚å¿µå°±ä¸è¯´å¤ªå¤šäº†ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h3 id="è‡ªåŠ¨é…ç½®"><a class="markdownIt-Anchor" href="#è‡ªåŠ¨é…ç½®"></a> è‡ªåŠ¨é…ç½®</h3><p>SpringBootçš„è‡ªåŠ¨é…ç½®ä¹ä¸€çœ‹å¾ˆç¥å¥‡ï¼Œå…¶å®åŸç†éå¸¸ç®€å•ï¼Œå®ç°è‡ªåŠ¨é…ç½®çš„æ ¸å¿ƒå°±æ˜¯@Conditionalæ³¨è§£ã€‚</p><h4 id="ä¸€-conditionæ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#ä¸€-conditionæ˜¯ä»€ä¹ˆ"></a> ä¸€ã€@Conditionæ˜¯ä»€ä¹ˆ</h4><p>@Conditionæ˜¯Spring4çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œæ³¨è§£çš„æ³¨é‡Šç¬¬ä¸€å¥å†™åˆ°â€œè¡¨æ˜ä»…å½“æ‰€æœ‰ç»„ä»¶éƒ½ç¬¦åˆæ³¨å†Œæ¡ä»¶æ—¶ï¼Œè¯¥ç»„ä»¶æ‰å…·æœ‰æ³¨å†Œèµ„æ ¼â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªæ³¨è§£åŠ¨æ€çš„å†³å®šéœ€è¦åŠ è½½çš„Beanã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬æƒ³è¦æ ¹æ®ä¸åŒçš„ç¯å¢ƒåŠ è½½ä¸åŒçš„ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>spring.profiles.active=dev</code>æŒ‡å®šå½“å‰ç¯å¢ƒï¼Œåˆ›å»ºç±»çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Profile</span>(<span class="string">"dev"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> PropConfig <span class="title">devDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Profile</span>(<span class="string">"pre"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> PropConfig <span class="title">preDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Profile</span>(<span class="string">"prd"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> PropConfig <span class="title">prdDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™é‡Œç”¨åˆ°äº†@Profileæ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£æ˜¯spring3.1ä¹‹åç‰ˆæœ¬ä¸­æä¾›çš„ï¼Œä»æ³¨è§£çš„å®šä¹‰ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä¹Ÿæ˜¯ä¸€ä¸ªConditionalï¼Œå¯ä»¥é€šè¿‡<code>ConfigurableEnvironment#setActiveProfiles</code>æ–¹æ³•å’Œ<code>spring.profiles.active</code>é…ç½®å®Œæˆè®¾ç½®ï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–æ–¹æ³•ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€å†™å‡ºäº†ï¼Œè¯¦æƒ…å¯ä»¥æŸ¥çœ‹ç±»<code>org.springframework.core.env.AbstractEnvironment</code>ã€‚</p><p>åœ¨ä¸šåŠ¡å¤æ‚çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨@Conditionalæ³¨è§£æ¥æä¾›æ›´åŠ çµæ´»çš„æ¡ä»¶åˆ¤æ–­ï¼Œåœ¨SpringBootä¸­çš„çš„å¾ˆå¤šCccConfigurationç±»ä¸Šéƒ½è®¾ç½®äº†å¾ˆå¤šçš„Conditionalï¼Œæ•´ç†åå‘ç°å¤§è‡´æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><ol><li><code>@ConditionalOnClass</code>ï¼šå½“classpathä¸‹å­˜åœ¨æŒ‡å®šçš„ç±»æ—¶ï¼ŒåŠ è½½è¢«æ³¨è§£çš„ç±»ï¼Œä½¿ç”¨æ–¹æ³•<code>@ConditionalOnClass({A.class, B.class, C.class})</code></li><li><code>@ConditionalOnBean</code>ï¼šå½“Springå®¹å™¨ä¸­å­˜åœ¨æŒ‡å®šçš„Beanå®ä¾‹æ—¶ï¼ŒåŠ è½½è¢«æ³¨è§£çš„ç±»ï¼Œä½¿ç”¨æ–¹æ³•<code>@ConditionalOnBean({A.class, B.class})</code></li><li><code>@ConditionalOnMissingBean</code>ï¼šå½“Springå®¹å™¨ä¸­ä¸å­˜åœ¨æŒ‡å®šçš„Beanå®ä¾‹æ—¶ï¼ŒåŠ è½½è¢«æ³¨è§£çš„ç±»ï¼Œä½¿ç”¨æ–¹æ³•<code>@ConditionalOnMissingBean({A.class, B.class, C.class})</code></li><li><code>@ConditionalOnMissingClass</code>ï¼šå½“classpathä¸‹ä¸å­˜åœ¨æŒ‡å®šçš„ç±»æ—¶ï¼ŒåŠ è½½è¢«æ³¨è§£çš„ç±»ï¼Œä½¿ç”¨æ–¹æ³•<code>@ConditionalOnMissingClass({&quot;cc.lu.A&quot;, &quot;cc.lu.B&quot;})</code></li><li><code>@ConditionalOnProperty</code>ï¼šæ§åˆ¶æŸä¸ªconfigurationæ˜¯å¦ç”Ÿæ•ˆã€‚å…·ä½“æ“ä½œæ˜¯é€šè¿‡å…¶ä¸¤ä¸ªå±æ€§nameä»¥åŠhavingValueæ¥å®ç°çš„ï¼Œå…¶ä¸­nameç”¨æ¥ä»application.propertiesä¸­è¯»å–æŸä¸ªå±æ€§å€¼ï¼Œå¦‚æœè¯¥å€¼ä¸ºç©ºï¼Œåˆ™è¿”å›false;å¦‚æœå€¼ä¸ä¸ºç©ºï¼Œåˆ™å°†è¯¥å€¼ä¸havingValueæŒ‡å®šçš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸€æ ·åˆ™è¿”å›true;å¦åˆ™è¿”å›falseã€‚å¦‚æœè¿”å›å€¼ä¸ºfalseï¼Œåˆ™è¯¥configurationä¸ç”Ÿæ•ˆï¼›ä¸ºtrueåˆ™ç”Ÿæ•ˆï¼Œä½¿ç”¨æ–¹æ³•<code>@ConditionalOnProperty(prefix=&quot;cc.lu.config&quot;, name=&quot;enable&quot;, havingValue=&quot;true&quot;)</code>ï¼Œä¸Šé¢çš„<code>@Profile(&quot;dev&quot;)</code>å¯¹ç­‰äº<code>@ConditionalOnProperty(name=&quot;spring.profiles.active&quot;, havingValue=&quot;dev&quot;)</code></li></ol><p>è¿˜æœ‰å¾ˆå¤šå¸¸ç”¨åˆ°çš„æ³¨è§£ï¼Œå¯ä»¥åˆ°<code>org.springframework.autoconfigure.condition</code>åŒ…å†…äº†è§£ä¸€ä¸‹ï¼Œæ¯ä¸€ä¸ªæ³¨è§£å•ç‹¬æ‹¿å‡ºæ¥éƒ½å¯ä»¥è®¨è®ºåŠå¤©ã€‚ä¸‹é¢æˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šå½“classpathè·¯å¾„ä¸­å­˜åœ¨<code>cc.lu.A</code>ç±»ã€å®¹å™¨ä¸­ä¸å­˜åœ¨<code>cc.lu.B</code>ç±»ä¸”å­˜åœ¨é…ç½®<code>cc.lu.config.auto=true</code>æ—¶åŠ è½½<code>cc.lu.Cc</code>ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.lu;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(A.class)</span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(B.class)</span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix=<span class="string">"cc.lu.config"</span>, name=<span class="string">"auto"</span>, havingValue=<span class="string">"true"</span>, matchIfMissing=<span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cc</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Cc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åœ¨æ„é€ å™¨ä¸­æ‰“å°ä¸€å¥è¯æ¥æ ¡éªŒæ„é€ å™¨æ˜¯å¦è¢«è°ƒç”¨</span></span><br><span class="line">    System.out.println(<span class="string">"Cc init......"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="äºŒ-cccautoconfigurationåˆ†æ"><a class="markdownIt-Anchor" href="#äºŒ-cccautoconfigurationåˆ†æ"></a> äºŒã€CccAutoConfigurationåˆ†æ</h4><p>ä¸Šé¢äº†è§£äº†<code>@Conditional</code>æ³¨è§£çš„æœºåˆ¶ï¼Œä¹Ÿå†™äº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œçµçš„åŒå­¦åº”è¯¥å·²ç»èƒ½çŒœåˆ°SpringBootæ˜¯å¦‚ä½•æ¥å®ç°è‡ªåŠ¨é…ç½®çš„äº†ï¼Œæˆ‘ä»¬ç°åœ¨åŸºäº2.2.6ç‰ˆæœ¬çš„æºç æ¥ç²—ç•¥çš„çœ‹ä¸€ä¸‹ã€‚</p><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªSpringBootå·¥ç¨‹ï¼Œideaå¯ä»¥é€šè¿‡Spring Initializræ¥å¿«é€Ÿçš„åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç„¶åæˆ‘ä»¬çœ‹æ•´ä¸ªå·¥ç¨‹çš„å…¥å£ï¼Œä¹Ÿå°±æ˜¯Application.java(æ–°åˆ›å»ºçš„SpringBootåº”ç”¨ä¸€èˆ¬åªæœ‰ä¸€ä¸ªå¯åŠ¨ç±»)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CcApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(CcApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶è¿‡ç¨‹åªæœ‰è¿™ä¹ˆä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆå…³é”®ç‚¹å°±æ˜¯<code>@SpringBootApplication</code>å’Œ<code>SpringApplication#run</code>äº†ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ³¨è§£<code>@SpringBootApplication</code>ï¼Œè¿™ç©æ„å„¿æ”¾åœ¨å¯åŠ¨ç±»ä¸Šæ˜¯æƒ³è¦å¹²å•¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(excludeFilters = &#123; <span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="line"><span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°è¿™ä¸ªæ³¨è§£ä¸Šæœ‰ä¸€ä¸ª<code>@EnableAutoConfiguration</code>ï¼Œè¿™ä¸ªæ³¨è§£çš„ç›®çš„æ˜¯å¯ç”¨Springåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„è‡ªåŠ¨é…ç½®ï¼Œå°è¯•çŒœæµ‹å’Œé…ç½®å¯èƒ½éœ€è¦çš„beanã€‚å†æ¥çœä¸€çœ¼è¿™ä¸ªæ³¨è§£çš„å®šä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import</span>(AutoConfigurationImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line">String ENABLED_OVERRIDE_PROPERTY = <span class="string">"spring.boot.enableautoconfiguration"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å“ï¼Œè¿™ä¸ª<code>@Import</code>æ³¨è§£æŠŠ<code>AutoConfigurationImportSelector</code>è¿™ä¸ªç±»å¯¼å…¥äº†è¿›æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä½¿ç”¨<code>@EnableAutoConfiguration</code>çš„æ—¶å€™ï¼Œ<code>AutoConfigurationImportSelector</code>ç±»ä¼šè‡ªåŠ¨è¢«åŠ è½½ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯æ ¸å¿ƒä»£ç å°±æ˜¯åœ¨è¿™ä¸ªç±»ä¸­äº†ï¼Ÿ(è¿™æ ·å†™è²Œä¼¼æœ‰ç‚¹å°¬ï¼)</p><p><code>AutoConfigurationImportSelector</code>å®ç°äº<code>ImportSelector</code>ï¼Œå…³é”®æ–¹æ³•å°±æ˜¯<code>ImportSelector#selectImports</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">    <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åŠ è½½META-INF/additional-spring-configuration-metadata.jsonæ–‡ä»¶ï¼Œå°†é…ç½®ä¿¡æ¯åŠ è½½åˆ°ç¯å¢ƒä¸­ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆé…ç½®æœ‰é»˜è®¤å€¼çš„å…³é”®ï¼Œå¯ç”¨åˆ°jaråŒ…é‡Œé¢æŸ¥çœ‹ä¸€ä¸‹</span></span><br><span class="line">  AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">    .loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">  <span class="comment">// åŠ è½½META-INF/spring.factoriesæ–‡ä»¶ï¼Œå¹¶å°†org.springframework.boot.autoconfigure.EnableAutoConfigurationçš„å€¼ä»¥åˆ—è¡¨çš„å½¢å¼è¿”å›</span></span><br><span class="line">  AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(autoConfigurationMetadata,annotationMetadata);</span><br><span class="line">  <span class="comment">// å°†éœ€è¦åŠ è½½çš„AutoConfigurationè¿”å›</span></span><br><span class="line">  <span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¡éªŒæ˜¯å¦å¼€å¯äº†è‡ªåŠ¨é…ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (getClass() == AutoConfigurationImportSelector.class) &#123;</span><br><span class="line">    <span class="keyword">return</span> getEnvironment().getProperty(EnableAutoConfiguration.ENABLED_OVERRIDE_PROPERTY, Boolean.class, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»<code>selectImports</code>çš„æºç å¯ä»¥çœ‹åˆ°å®ƒåªåšäº†ä¸¤ä»¶äº‹ï¼šåŠ è½½é»˜è®¤çš„é…ç½®å±æ€§å’Œè¿”å›æ‰€æœ‰çš„AutoConfigurationçš„ç±»ä¿¡æ¯ï¼Œé€šè¿‡æ–¹æ³•è°ƒç”¨é“¾æ‰¾åˆ°æœ€ç»ˆåŠ è½½çš„æ–¹æ³•æ˜¯<code>SpringFactoriesLoader#loadSpringFactories</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(<span class="meta">@Nullable</span> ClassLoader classLoader) &#123;</span><br><span class="line">  MultiValueMap&lt;String, String&gt; result = cache.get(classLoader);</span><br><span class="line">  <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–classpathä¸‹æ‰€æœ‰çš„META-INF/spring.factoriesæ–‡ä»¶</span></span><br><span class="line">    Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ?classLoader.getResources(FACTORIES_RESOURCE_LOCATION):ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">    result = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">      URL url = urls.nextElement();</span><br><span class="line">      UrlResource resource = <span class="keyword">new</span> UrlResource(url);</span><br><span class="line">      <span class="comment">// åŠ è½½æ–‡ä»¶å†…å®¹</span></span><br><span class="line">      Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">      <span class="comment">// å°†æ–‡ä»¶å†…å®¹å­˜åœ¨åˆ°Mapä¸­</span></span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">        String factoryTypeName = ((String) entry.getKey()).trim();</span><br><span class="line">        <span class="comment">// valueæ˜¯ä½¿ç”¨é€—å·åˆ†éš”çš„ï¼Œæ‰€ä»¥è¿™é‡Œè½¬æ¢æˆæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸€ç¢—ç±³é¥­åˆ†æˆä¸€ç²’ç²’çš„</span></span><br><span class="line">        <span class="keyword">for</span> (String factoryImplementationName : StringUtils.commaDelimitedListToStringArray((String) entry.getValue())) &#123;</span><br><span class="line">          result.add(factoryTypeName, factoryImplementationName.trim());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cache.put(classLoader, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SpringBootä¸ºæˆ‘ä»¬æä¾›çš„é…ç½®ç±»æœ‰ä¸€äºŒç™¾ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¯èƒ½æ¯ä¸ªå·¥ç¨‹éƒ½æŠŠå®ƒä»¬å…¨éƒ¨å¼•å…¥ã€‚æ‰€ä»¥åœ¨è‡ªåŠ¨è£…é…çš„æ—¶å€™ï¼Œä¼šå»classpathä¸‹é¢å¯»æ‰¾ï¼Œæ˜¯å¦æœ‰å¯¹åº”çš„é…ç½®ç±»ã€‚å¦‚æœæœ‰é…ç½®ç±»ï¼Œåˆ™æŒ‰æ¡ä»¶æ³¨è§£ @Conditionalæˆ–è€…@ConditionalOnPropertyç­‰ç›¸å…³æ³¨è§£è¿›è¡Œåˆ¤æ–­ï¼Œå†³å®šæ˜¯å¦éœ€è¦è£…é…ã€‚å¦‚æœclasspathä¸‹é¢æ²¡æœ‰å¯¹åº”çš„å­—èŠ‚ç ï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•å¤„ç†ã€‚</p><p>æˆ‘ä»¬åˆ°spring.factoriesæ–‡ä»¶ä¸­éšä¾¿æ‰¾ä¸€ä¸ªAutoConfigurationç±»ï¼Œæ¯”å¦‚<code>org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(RedisOperations.class)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(RedisProperties.class)</span><br><span class="line"><span class="meta">@Import</span>(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"><span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> StringRedisTemplate <span class="title">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate();</span><br><span class="line">template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"><span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç±»è¢«<code>@ConditionalOnClass</code>å’Œ<code>@EnableConfigurationProperties</code>ä¸¤ä¸ªæ³¨è§£ä¿®é¥°ã€‚</p><ul><li><code>@ConditionalOnClass(RedisOperations.class)</code>çš„æ„æ€æ˜¯å½“classpathè·¯å¾„ä¸‹å­˜åœ¨<code>RedisOperations</code>è¿™ä¸ªç±»çš„æ—¶å€™åŠ è½½<code>RedisAutoConfiguration</code>ï¼Œç±»<code>RedisOperations</code>åœ¨spring-data-redis.jaråŒ…ä¸­ï¼Œè¿™ä¸ªåŒ…é€šè¿‡<code>spring-boot-starter-data-redis</code>çš„starterå¼•å…¥ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬å¼•å…¥è¿™ä¸ªstarterçš„æ—¶å€™å°±è‡ªåŠ¨å»åŠ è½½äº†RedisAutoConfigurationï¼Œç„¶åå†ç±»ä¸­åˆåˆ›å»ºäº†ä¸¤ä¸ªBeanï¼Œåˆ›å»ºçš„å‰ææ˜¯å®¹å™¨ä¸­ä¸å­˜åœ¨è¿™ä¸¤ä¸ªç±»çš„å®ä¾‹ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªRedisTemplateçš„å®ä¾‹ï¼ŒRedisAutoConfiguration#redisTemplateæ–¹æ³•å°±ä¼šå¤±æ•ˆã€‚</li><li><code>@EnableConfigurationProperties(RedisProperties.class)</code>ï¼šåœ¨åŠ è½½RedisAutoConfigurationçš„æ—¶å€™åŒæ­¥åŠ è½½RedisPropertiesï¼ŒRedisPropertiesä¸­é€šè¿‡æ³¨è§£<code>@ConfigurationProperties(prefix = &quot;spring.redis&quot;)</code>æŒ‡å®šå…³è”çš„é…ç½®ä¿¡æ¯ï¼Œè‹¥æ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨ç±»ä¸­å±æ€§çš„é»˜è®¤å€¼ã€‚</li></ul><p>è‡³æ­¤ï¼Œå®¹å™¨ä¸­æœ‰äº†RedisTemplateçš„å®ä¾‹å’ŒStringRedisTemplateçš„å®ä¾‹ï¼Œå¹¶ä¸”è¿˜ä½¿ç”¨äº†é…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬è®¾ç½®çš„Redisç›¸å…³é…ç½®ã€‚</p><h3 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h3><p>æ•´ä¸ªSpringBootä¸­ï¼Œéƒ½æ˜¯é€šè¿‡@Conditionalæ³¨è§£çš„å„ç§æ‰©å±•æ¥å®ç°è‡ªåŠ¨é…ç½®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®Œå…¨åˆ©ç”¨è¿™äº›æ³¨è§£å»å®ç°æˆ‘ä»¬è‡ªå·±çš„starterã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Spring Bootæ˜¯Springå®¶æ—ä¸­çš„æ–°å® ï¼Œå®ƒä¸ä»…ç»§æ‰¿äº†Springæ¡†æ¶åŸæœ‰çš„ä¼˜ç§€ç‰¹æ€§ï¼Œè¿˜é€šè¿‡ç®€åŒ–é…ç½®æ¥è¿›ä¸€æ­¥ç®€åŒ–Springåº”ç”¨ç¨‹åºçš„åˆ›å»ºå’Œå¼€å‘è¿‡ç¨‹ã€‚SpringBootæ¡†æ¶ä¸­æœ‰ä¸¤ä¸ªæœ€ä¸»è¦çš„ç­–ç•¥ï¼šå¼€ç®±å³ç”¨å’Œçº¦å®šä¼˜äºé…ç½®ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¼€ç®±å³ç”¨ï¼šåœ¨å¼€å‘è¿‡
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="http://luxiaowan.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>æœåŠ¡ç›‘æ§ä¹‹SpringBoot Admin</title>
    <link href="http://luxiaowan.github.io/2020/04/21/%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E4%B9%8BSpringBoot-Admin/"/>
    <id>http://luxiaowan.github.io/2020/04/21/æœåŠ¡ç›‘æ§ä¹‹SpringBoot-Admin/</id>
    <published>2020-04-21T07:28:00.000Z</published>
    <updated>2020-04-21T09:16:12.509Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h3><p>Spring Boot Adminæ˜¯ä¸€ä¸ªç®¡ç†å’Œå¥åº·SpringBootåº”ç”¨çš„åº”ç”¨ï¼Œæœ‰ç‚¹ç»•å£ï¼Œå…¶å®å°±æ˜¯ç”¨æ¥ç›‘æ§SpringBootåº”ç”¨çš„ï¼Œè¿™äº›åº”ç”¨å¯ä»¥é€šè¿‡Spring Boot Admin Clientæˆ–Spring Cloudè‡ªåŠ¨å‘ç°çš„æ–¹å¼æ³¨å†Œåˆ°Admin Serverã€‚</p><h3 id="ä¸€-admin-clientæ–¹å¼æ³¨å†Œ"><a class="markdownIt-Anchor" href="#ä¸€-admin-clientæ–¹å¼æ³¨å†Œ"></a> ä¸€ã€Admin Clientæ–¹å¼æ³¨å†Œ</h3><h4 id="admin-serveræ­å»º"><a class="markdownIt-Anchor" href="#admin-serveræ­å»º"></a> Admin Serveræ­å»º</h4><ul><li><p>å¼•å…¥serverä¾èµ–çš„åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-starter-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ç±»åŠ ä¸Š<code>@EnableAdminServer</code>æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> de.codecentric.boot.admin.server.config.EnableAdminServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAdminServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootAdminApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootAdminApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å¯åŠ¨é¡¹ç›®ï¼Œç„¶åè®¿é—®<code>http://localhost:8080/</code>ï¼Œåˆ°æ­¤Admin Serverå°±æ­å»ºå¥½äº†ï¼Œè·ŸEureka Serverä¼¼çš„ï¼Œä¸€åŒ…ä¸€æ³¨é‡Šï¼Œä»—åŠ¿èµ°å¤©æ¶¯ã€‚</p><p><img src="/images/image-20200421161507822.png" alt="image-20200421161507822"></p><h4 id="admin-clientæ³¨å†Œ"><a class="markdownIt-Anchor" href="#admin-clientæ³¨å†Œ"></a> Admin Clientæ³¨å†Œ</h4><ul><li><p>å¼•å…¥clientä¾èµ–åŒ…</p><p>Spring Boot Adminæ˜¯ä½¿ç”¨actuatorå®ç°çš„æœåŠ¡ç›‘æ§ï¼Œæ‰€ä»¥åœ¨clientåº”ç”¨ä¸­éœ€è¦å¼•å…¥actuatorçš„åŒ…ï¼Œå¹¶å¼€æ”¾ç›¸å…³çš„æ¥å£ï¼Œå¦åˆ™ç›‘æ§çš„ä¿¡æ¯ä¸å®Œæ•´ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-starter-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8888</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">boot-log</span></span><br><span class="line"><span class="attr">  boot:</span></span><br><span class="line"><span class="attr">    admin:</span></span><br><span class="line"><span class="attr">      client:</span></span><br><span class="line"><span class="attr">        url:</span> <span class="attr">http://127.0.0.1:8080</span> <span class="comment"># æŒ‡å®šadmin-serveræ³¨å†Œåœ°å€ï¼Œå’ŒEurekaæ›´åƒäº†</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">"*"</span> <span class="comment"># æš´éœ²actuatoræ‰€æœ‰æ¥å£</span></span><br></pre></td></tr></table></figure></li></ul><p>è‡³æ­¤å°±å®Œæˆäº†Admin Clientç«¯çš„é…ç½®ï¼Œå¯ä»¥å¯åŠ¨æœåŠ¡äº†ï¼ŒæŸ¥çœ‹adminé¡µé¢</p><p><img src="/images/image-20200421163624584.png" alt="image-20200421163624584"></p><h3 id="äºŒ-eurekaæ³¨å†Œä¸­å¿ƒè‡ªåŠ¨å‘ç°"><a class="markdownIt-Anchor" href="#äºŒ-eurekaæ³¨å†Œä¸­å¿ƒè‡ªåŠ¨å‘ç°"></a> äºŒã€Eurekaæ³¨å†Œä¸­å¿ƒè‡ªåŠ¨å‘ç°</h3><p>ä½¿ç”¨Eurekaå¯ä»¥è§£æ”¾Clientç«¯çš„é…ç½®ï¼Œä¸å†éœ€è¦ç»™Clientç«¯é…ç½®ä»»ä½•ä¸œè¥¿(é™¤actuatoræš´éœ²æ¥å£åˆ—è¡¨)</p><h4 id="eureka-serveræ­å»º"><a class="markdownIt-Anchor" href="#eureka-serveræ­å»º"></a> Eureka Serveræ­å»º</h4><p>æ­å»ºEureka Serverå°±ä¸åšç‰¹æ®Šè§£é‡Šäº†ï¼Œç›´æ¥è´´é…ç½®ä»£ç ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9001</span> <span class="comment">#æœåŠ¡ç«¯å£</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#æ˜¯å¦å°†eurekaè‡ªèº«ä½œä¸ºåº”ç”¨æ³¨å†Œåˆ°eurekaæ³¨å†Œä¸­å¿ƒ</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span> <span class="comment">#ä¸ºtrueæ—¶ï¼Œå¯ä»¥å¯åŠ¨ï¼Œä½†æŠ¥å¼‚å¸¸ï¼šCannot execute request on any known server</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:9001/eureka/</span></span><br><span class="line"><span class="attr">  server:</span></span><br><span class="line"><span class="attr">    enable-self-preservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudEurekaApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringCloudEurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ä¹‹åè®¿é—®<code>http://127.0.0.1:9001/</code>è¿›å…¥Eurekaæ§åˆ¶å°</p><h4 id="admin-serveræ­å»º-2"><a class="markdownIt-Anchor" href="#admin-serveræ­å»º-2"></a> Admin Serveræ­å»º</h4><p>Admin Serverçš„æ­å»ºæ–¹å¼å’Œç¬¬ä¸€ç§ç›¸å·®æ— å‡ ï¼Œå”¯ä¸€çš„å·®åˆ«å°±æ˜¯éœ€è¦æŠŠServeråº”ç”¨æ³¨å†Œåˆ°Eurekaä¸­</p><ul><li>åœ¨å¯åŠ¨ç±»åŠ ä¸Š<code>@EnableEurekaClient</code>æ³¨è§£</li><li>åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Š<code>eureka.client.service-url.defaultZone=http://127.0.0.1:9001/eureka</code>é…ç½®</li></ul><h4 id="admin-clientæ­å»º"><a class="markdownIt-Anchor" href="#admin-clientæ­å»º"></a> Admin Clientæ­å»º</h4><p>Admin Clientæ­£å¸¸é…ç½®æ³¨å†Œåˆ°Eurekaï¼Œç„¶åæš´éœ²actuatorçš„ç›¸å…³æ¥å£<code>management.endpoints.web.exposure.include=*</code>ã€‚</p><p>å¯åŠ¨clientï¼ŒæŸ¥çœ‹Eurekaå’ŒAdminæ§åˆ¶å°</p><ul><li><p>Eureka Server</p><p><img src="/images/image-20200421171038407.png" alt="image-20200421171038407"></p></li><li><p>Admin Server</p><p><img src="/images/image-20200421171100096.png" alt="image-20200421171100096"></p></li></ul><h3 id="ä¸‰-spring-boot-adminæä¾›äº†å“ªäº›åŠŸèƒ½"><a class="markdownIt-Anchor" href="#ä¸‰-spring-boot-adminæä¾›äº†å“ªäº›åŠŸèƒ½"></a> ä¸‰ã€Spring Boot Adminæä¾›äº†å“ªäº›åŠŸèƒ½</h3><p><img src="/images/image-20200421171313326.png" alt="image-20200421171313326"></p><p>å°±ä¸ä¸€ä¸€èµ˜è¿°äº†ï¼Œæ­å»ºäº†ç©ç©å°±éƒ½æ˜ç™½äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç®€ä»‹&quot;&gt;&lt;/a&gt; ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;Spring Boot Adminæ˜¯ä¸€ä¸ªç®¡ç†å’Œå¥åº·SpringBootåº”ç”¨çš„åº”ç”¨ï¼Œæœ‰ç‚¹ç»•å£ï¼Œå…¶å®å°±æ˜¯ç”¨æ¥ç›‘æ§SpringBootåº”ç”¨çš„ï¼Œè¿™äº›åº”ç”¨
      
    
    </summary>
    
    
      <category term="åˆ†å¸ƒå¼" scheme="http://luxiaowan.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
  </entry>
  
  <entry>
    <title>ç®€å•çš„çœ‹ä¸€ä¸‹æœåŠ¡æ²»ç†æ˜¯ä»€ä¹ˆ</title>
    <link href="http://luxiaowan.github.io/2020/04/20/%E7%AE%80%E5%8D%95%E7%9A%84%E7%9C%8B%E4%B8%80%E4%B8%8B%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%98%AF%E4%BB%80%E4%B9%88/"/>
    <id>http://luxiaowan.github.io/2020/04/20/ç®€å•çš„çœ‹ä¸€ä¸‹æœåŠ¡æ²»ç†æ˜¯ä»€ä¹ˆ/</id>
    <published>2020-04-20T14:35:00.000Z</published>
    <updated>2020-04-21T07:22:59.739Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¼•æ–‡"><a class="markdownIt-Anchor" href="#å¼•æ–‡"></a> å¼•æ–‡</h3><p>å¼€å§‹çœ‹æ–‡ç« ä¹‹å‰ä¸å¦¨å…ˆæ€è€ƒå‡ ä¸ªé—®é¢˜ï¼šæœåŠ¡æ²»ç†æ˜¯ä»€ä¹ˆï¼Œä»€ä¹ˆæ ·å­çš„æœåŠ¡éœ€è¦æ²»ç†ï¼Œä¸ºä»€ä¹ˆéœ€è¦æ²»ç†æœåŠ¡ï¼Œåº”è¯¥æ€æ ·æ²»ç†æœåŠ¡ï¼Œæ²»ç†æœåŠ¡çš„å“ªäº›æ–¹é¢ï¼Œä¸æ²»ç†çš„è¯æœåŠ¡ä¼šæ€æ ·ï¼Ÿè¿™äº›é—®é¢˜åŸºæœ¬å°±æ˜¯æœåŠ¡æ²»ç†çš„å…³é”®æ€æƒ³äº†ï¼Œææ‡‚è¿™äº›é—®é¢˜ï¼Œå°±ç›¸å½“äºæ˜¯æŒæ¡äº†æœåŠ¡æ²»ç†çš„åŸºæœ¬æ¦‚å¿µã€‚</p><h3 id="æœåŠ¡æ¼”å˜è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#æœåŠ¡æ¼”å˜è¿‡ç¨‹"></a> æœåŠ¡æ¼”å˜è¿‡ç¨‹</h3><p>æˆ‘ä»¬åœ¨è§£å†³ä¸Šè¿°é—®é¢˜ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹æœåŠ¡æ¶æ„çš„å‘å±•è¿‡ç¨‹ã€‚</p><h4 id="å•ä½“æœåŠ¡"><a class="markdownIt-Anchor" href="#å•ä½“æœåŠ¡"></a> å•ä½“æœåŠ¡</h4><p>å¯¹äºå•ä½“æœåŠ¡æ¥è¯´ï¼Œåº”ç”¨ç»“æ„ä¸€èˆ¬æ¯”è¾ƒç®€å•ï¼Œä¸€èˆ¬ä¸éœ€è¦ç‰¹åˆ«çš„æœåŠ¡æ²»ç†æ‰‹æ®µï¼Œä½†éšç€æœåŠ¡æ‰¿è½½çš„ä¸šåŠ¡è¶Šæ¥è¶Šåºå¤§ï¼ŒæœåŠ¡å†…éƒ¨é€»è¾‘å˜å¾—å¤æ‚èµ·æ¥ï¼Œæ‰©å±•æ€§ä¹Ÿè¶Šæ¥è¶Šå·®ï¼Œè¿™æ—¶æœ€å¥½çš„æ²»ç†åŠæ³•å°±æ˜¯å°†å…¶è¿›è¡Œæ‹†åˆ†ï¼Œé™¤æ­¤ä¹‹å¤–çš„æ²»ç†æ‰‹æ®µéƒ½æ˜¯å¾’åŠ³ï¼Œåè€Œä¼šè®©åº”ç”¨å˜å¾—è¶Šæ¥è¶Šè‡ƒè‚¿ã€‚</p><h4 id="é›†ç¾¤æœåŠ¡"><a class="markdownIt-Anchor" href="#é›†ç¾¤æœåŠ¡"></a> é›†ç¾¤æœåŠ¡</h4><p>å•ä½“æ¶æ„åœ¨æµé‡è¾ƒå°‘æ—¶èƒ½å¤Ÿæ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œéšç€ä¸šåŠ¡çš„å‘å±•ï¼Œäº§å“æµé‡è¶Šæ¥è¶Šå¤šï¼Œä¸€ç§’é’Ÿçš„æœåŠ¡å®•æœºéƒ½å¯èƒ½é€ æˆå¾ˆå¤§çš„æŸå¤±ï¼ŒåŸºäºæ­¤ï¼Œå°†ç”±å•ä½“æ¶æ„å»¶ä¼¸åˆ°é›†ç¾¤æ¶æ„ã€‚é›†ç¾¤ä¸­æ¯å°æœåŠ¡å™¨éƒ½æä¾›ç›¸åŒçš„æœåŠ¡ï¼Œä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨æ¥å®ç°æ¯å°æœåŠ¡å™¨çš„è´Ÿè½½åˆ†é…ï¼Œè¿™å…¶å®ä¹Ÿèƒ½ç®—æ˜¯ä¸€ç§æ²»ç†ï¼Œåœ¨åˆ†é…è¯·æ±‚æ—¶éœ€è¦é€‰æ‹©å‡ºæœ€é€‚åˆçš„å¥åº·çš„æœåŠ¡å™¨ï¼Œå°†è¯·æ±‚å‘é€è¿‡å»ï¼Œå¹¶ä¸”è¦æ—¶åˆ»çš„æ£€æŸ¥é›†ç¾¤ä¸­èŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ï¼ŒåŠæ—¶å°†æ•…éšœèŠ‚ç‚¹ä»å¥åº·æœåŠ¡åˆ—è¡¨ä¸­å‰”é™¤ã€‚</p><h4 id="åˆ†å¸ƒå¼æœåŠ¡"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼æœåŠ¡"></a> åˆ†å¸ƒå¼æœåŠ¡</h4><p>å½“å•ä½“åº”ç”¨å˜å¾—è‡ƒè‚¿ä¹‹åï¼Œæ•´ä¸ªå›¢é˜Ÿç»´æŠ¤åŒä¸€å¥—ä»£ç ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡éƒ½é›†ä¸­åœ¨ä¸€ä¸ªåº”ç”¨ä¸­ï¼ŒæœåŠ¡çš„å¥å£®æ€§ä¼šéšç€ä¸šåŠ¡çš„å‘å±•å˜å¾—è¶Šæ¥è¶Šè„†å¼±ï¼Œå½“ç»´æŠ¤ä¸€ä¸ªæœåŠ¡å˜å¾—å›°éš¾çš„æ—¶å€™ï¼Œå°±éœ€è¦è€ƒè™‘å°†æ­¤æœåŠ¡æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°è€Œç¾çš„æœåŠ¡äº†ï¼Œå³å¾®æœåŠ¡åŒ–ï¼Œå°†å•ä¸€æœåŠ¡æ¶æ„å‘å¾®æœåŠ¡æ¶æ„æ¼”è¿›ã€‚</p><p>å½“æœåŠ¡æ¼”è¿›åˆ°å¾®æœåŠ¡æ¶æ„ä¹‹åï¼Œä¼šå‡ºç°æ–°çš„é—®é¢˜ï¼Œæ¯”å¦‚ä¹‹å‰æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘éƒ½åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ‰§è¡Œï¼Œæ—¥å¿—æŸ¥çœ‹ã€é—®é¢˜æ’æŸ¥ç­‰éƒ½å¾ˆæ–¹ä¾¿ï¼Œä¹Ÿä¸å­˜åœ¨è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œæ›´ä¸å­˜åœ¨ä¾èµ–æœåŠ¡çŠ¶æ€çš„ç›‘æ§ç­‰æƒ…å†µã€‚é‚£ä¹ˆæ—¢ç„¶æ‹†åˆ†æˆå¾®æœåŠ¡ä¹‹åä¼šé‡åˆ°è¿™ä¹ˆå¤šé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æ‹†å‘¢ï¼Ÿå…¶å®å¤§éƒ¨åˆ†ç”±å•ä½“æœåŠ¡æ‹†åˆ†æˆå¾®æœåŠ¡çš„åˆè¡·éƒ½æ˜¯æƒ³åˆ†è€Œæ²»ä¹‹ï¼Œä¹Ÿå°±æ˜¯å•ä¸€èŒè´£çš„æœåŠ¡æ›´æ–¹ä¾¿ä¼˜åŒ–å’Œç»´æŠ¤ã€‚</p><ul><li><p>æœåŠ¡å®šä¹‰ï¼šæœåŠ¡æ‹†åˆ†è¦æ ¹æ®ä¸€å®šçš„è§„åˆ™è¿›è¡Œï¼Œå®šä¹‰æ‹†åˆ†åæ¯ä¸ªæœåŠ¡çš„ä¸šåŠ¡èŒƒå›´å’Œè¾¹ç•Œï¼Œä¸èƒ½ä¸ºäº†æ‹†è€Œæ‹†ï¼Œå¾®æœåŠ¡çš„æå‡ºè€…Matin Fowleråœ¨é¦–æå¾®æœåŠ¡çš„æ—¶å€™æ˜¯ä»¥ä¸šåŠ¡ä¸ºæ‹†åˆ†åŸºå‡†ï¼Œåç»­å‘å±•è¿‡ç¨‹ä¸­ï¼Œè¶Šæ¥è¶Šå¤šçš„æ¡ä»¶éƒ½å¯ä»¥ä½œä¸ºæ‹†åˆ†çš„ç†ç”±äº†ï¼Œæ¯”å¦‚ä¸šåŠ¡ã€æµé‡å¤§å°ç­‰ã€‚</p></li><li><p>æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼šå¾®æœåŠ¡æ¶æ„ä½“ç³»ä¸­ï¼Œå¿…å®šä¼šå‡ºç°æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ä¾èµ–ï¼Œè¿™å°±éœ€è¦è°ƒç”¨æ–¹çŸ¥é“ç›®æ ‡æœåŠ¡çš„åœ°å€ï¼Œä»è€Œå‘èµ·è¯·æ±‚ã€‚å¦‚æœå°†æœåŠ¡ç«¯çš„åœ°å€é¢„å…ˆå‘ŠçŸ¥è°ƒç”¨æ–¹ï¼Œå…¶å®ä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œç¼ºé™·å°±æ˜¯å½“æœåŠ¡è¶Šæ¥è¶Šå¤šæ—¶ï¼ŒæœåŠ¡URLçš„é…ç½®ç®¡ç†å˜å¾—éå¸¸å›°éš¾ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€ä¸ªä¸­ä»‹æ¥æä¾›ä¸€ä¸ªæ¥å£è®©æˆ‘ä»¬å¯ä»¥éšæ—¶è·å–å¥åº·çš„æœåŠ¡åˆ—è¡¨ï¼Œæ‰€ä»¥æœåŠ¡æ³¨å†Œä¸­å¿ƒåº”è¿è€Œç”Ÿ(Zookeeperã€Etcdã€Consulã€Eurekaã€Dubboç­‰)ï¼Œå®ƒçš„ç†å¿µæ˜¯ç”±æœåŠ¡ç«¯å°†å¯æä¾›çš„æœåŠ¡æ³¨å†Œåˆ°æœåŠ¡ä¸­å¿ƒï¼Œå¹¶ç”±æœåŠ¡ä¸­å¿ƒæ¥ç»´æŠ¤æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ï¼Œå®¢æˆ·ç«¯ä»æœåŠ¡ä¸­å¿ƒè·å–å¥åº·çš„æœåŠ¡åˆ—è¡¨ç”¨äºå‘é€è¯·æ±‚ã€‚</p></li><li><p>æ¥å£è°ƒç”¨é“¾ç›‘æ§ï¼šå¾®æœåŠ¡æ¶æ„ä½“ç³»ä¸­ä»¥æœåŠ¡å¤šè‘—ç§°ï¼ŒæœåŠ¡éƒ½å…·æœ‰å•ä¸€èŒè´£ï¼ŒæœåŠ¡ä¹‹é—´éœ€è¦äº’ç›¸è°ƒç”¨æ‰èƒ½å®Œæˆä¸€æ¬¡è¯·æ±‚çš„å¤„ç†ã€‚åœ¨å•ä½“åº”ç”¨æ¶æ„ä¸­ï¼Œè°ƒç”¨é“¾éƒ½æ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œåªè¦é€šè¿‡çº¿ç¨‹IDæˆ–è€…MDCå³å¯æŸ¥è¯¢åˆ°è¯·æ±‚çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œå®šä½å¾ˆè½»æ¾ï¼›ä½†æ˜¯åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼Œæƒ³è¦è·Ÿè¸ªä¸€æ¬¡è¯·æ±‚çš„æ•´ä¸ªè°ƒç”¨é“¾å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œä¸€èˆ¬éœ€è¦é€šè¿‡ç¬¬ä¸‰æ–¹ç»„ä»¶æ¥å®Œæˆï¼Œæ¯”å¦‚Twitterçš„Zipkinã€‚</p></li><li><p>åº”ç”¨æœåŠ¡ç›‘æ§ï¼šSpringBootAdminæä¾›äº†ä¸€å¥—å¼€ç®±å³ç”¨çš„ç›‘æ§å·¥å…·ç®±ï¼Œå¯ä»¥çœ‹åˆ°ç›‘æ§çš„æ¯ä¸ªå¾®æœåŠ¡å®ä¾‹çš„è¿è¡Œæƒ…å†µï¼Œå…·ä½“æ“ä½œç¨åå†å—·å—·</p></li><li><p>è´Ÿè½½å‡è¡¡ï¼šåœ¨æœåŠ¡æ‹†åˆ†è®¾è®¡è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½éœ€è¦ä¿è¯æ˜¯é«˜å¯ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªå¾®æœåŠ¡åˆéƒ½æ˜¯é«˜å¯ç”¨çš„ã€‚</p></li><li><p>æœåŠ¡é™çº§ç†”æ–­ï¼šå•ä½“æœåŠ¡æ‹†åˆ†åå¯¼è‡´æœåŠ¡å˜å¤šäº†ï¼Œè°ƒç”¨é“¾å‡ºæ•…éšœçš„æ¦‚ç‡å°±æ›´å¤§äº†ï¼Œæˆ‘ä»¬åœ¨ä¿è¯äº†æœåŠ¡çš„é«˜å¯ç”¨çš„åŒæ—¶ï¼Œä»ç„¶éœ€è¦ä¿è¯æ¥å£çš„å¯ç”¨æ€§ï¼Œå¦‚æœæ¥å£å‡ºç°æ•…éšœï¼Œè¦èƒ½å¤Ÿå°†æ•…éšœå¿«é€Ÿè½¬ç§»å¹¶å“åº”è°ƒç”¨ç«¯ï¼Œå¦åˆ™å¯èƒ½ä¼šé€ æˆå¤§é‡çš„è¯·æ±‚ç§¯å‹ï¼Œè¿›è€Œæ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æ–­è·¯å™¨å’ŒæœåŠ¡é™çº§ä¸ºæ¥å£çš„å¿«é€Ÿæ•…éšœè½¬ç§»æä¾›äº†ä¿éšœã€‚</p></li><li><p>æœåŠ¡è°ƒç”¨ï¼šåœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´å¯ä»¥é€šè¿‡httpã€rpcç­‰æ–¹å¼äº’ç›¸è°ƒç”¨ï¼Œæ¯”å¦‚Feignæ˜¯ä¸€ç§httpæ–¹å¼çš„å£°æ˜å¼è°ƒç”¨ï¼Œåœ¨SpringCloudä¸­æœ‰å¹¿æ³›çš„ä½¿ç”¨ã€‚</p></li><li><p>æœåŠ¡å®‰å…¨ï¼šæœåŠ¡è‡ªèº«éœ€è¦ä¿è¯æ¥å£ã€æ•°æ®å’ŒæœåŠ¡çš„å®‰å…¨æ€§ï¼Œä¸èƒ½å‡ºç°è¢«éšæ„è°ƒç”¨çš„ç°è±¡ã€‚</p></li><li><p>æœåŠ¡ç‰ˆæœ¬ï¼šæœåŠ¡åœ¨å‡çº§è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è€ƒè™‘åˆ°å¯¹è€ç‰ˆæœ¬çš„å…¼å®¹æ€§ï¼Œé¿å…é€ æˆå› å‡çº§å¸¦æ¥çš„ç³»ç»Ÿæ•…éšœã€‚</p></li></ul><h3 id="å›çœ‹"><a class="markdownIt-Anchor" href="#å›çœ‹"></a> å›çœ‹</h3><p>ç®€å•çš„æè¿°äº†ä¸€ä¸‹æœåŠ¡æ¶æ„çš„æ¼”è¿›è·¯çº¿ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å‰é¢è¯´çš„å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li><p>æœåŠ¡æ²»ç†æ˜¯ä»€ä¹ˆ</p><blockquote><p>æœåŠ¡æ²»ç†æ˜¯é€šè¿‡ä¸€ç³»åˆ—æ‰‹æ®µæ¥æ›´å¥½çš„ç®¡ç†æœåŠ¡ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿé¡ºåˆ©ã€å®‰å…¨ã€ç¨³å®šçš„è¿è¡Œã€‚</p></blockquote></li><li><p>ä»€ä¹ˆæ ·å­çš„æœåŠ¡éœ€è¦æ²»ç†</p><blockquote><p>ä»»ä½•æœåŠ¡éƒ½éœ€è¦æ²»ç†</p></blockquote></li><li><p>ä¸ºä»€ä¹ˆéœ€è¦æ²»ç†æœåŠ¡</p><blockquote><ol><li>ä¸ºäº†æå‡ç³»ç»Ÿçš„ç¨³å®šæ€§</li><li>ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§</li></ol></blockquote></li><li><p>åº”è¯¥æ€æ ·æ²»ç†æœåŠ¡</p><blockquote><ol><li>å»ºç«‹æˆæƒçš„è´£ä»»é“¾</li><li>è¯„ä¼°æœåŠ¡çš„æœ‰æ•ˆæ€§</li><li>æœåŠ¡ç›‘æ§å‘Šè­¦</li><li>æ•…éšœè½¬ç§»</li></ol></blockquote></li><li><p>æ²»ç†æœåŠ¡çš„å“ªäº›æ–¹é¢</p><blockquote><ol><li>æœåŠ¡å®šä¹‰</li><li>æœåŠ¡æ³¨å†Œä¸å‘ç°</li><li>æ¥å£è°ƒç”¨é“¾</li><li>åº”ç”¨æœåŠ¡ç›‘æ§</li><li>è´Ÿè½½å‡è¡¡</li><li>æœåŠ¡é™çº§ç†”æ–­</li><li>æœåŠ¡è°ƒç”¨åè®®</li><li>æœåŠ¡å®‰å…¨</li><li>æœåŠ¡ç‰ˆæœ¬</li></ol></blockquote></li><li><p>ä¸æ²»ç†çš„è¯æœåŠ¡ä¼šæ€æ ·</p><blockquote><p>åœºæ™¯ä¸€ï¼šå‘¨æœ«ä½ æ­£åœ¨é€›è¡—ï¼Œç„¶åè€æ¿åœ¨ç¾¤é‡Œè‰¾ç‰¹ä½ ï¼Œè¯´ç³»ç»ŸæœåŠ¡å™¨å®•æœºäº†ã€æœºæˆ¿åœç”µäº†ã€å…‰ç¼†è¢«æ–½å·¥é˜ŸæŒ–æ–­äº†ï¼Œç³»ç»Ÿæ²¡åŠæ³•ä½¿ç”¨äº†ã€‚è¿™ä¸ªæ—¶å€™ä½ æ˜¯ä¸æ˜¯éœ€è¦ç«‹åˆ»èµ¶åˆ°å…¬å¸å»æ¬ç –ï¼Œç›´åˆ°ç³»ç»Ÿæ¢å¤æ­£å¸¸ã€‚</p><p>åœºæ™¯äºŒï¼šæ­£åœ¨ä¸å‘¨å…¬ä¸‹æ£‹ï¼Œç„¶åä¸€é˜µæ»´æ»´å£°ï¼Œå‘ç°æŸä¸ªæœåŠ¡èŠ‚ç‚¹çš„æ•…éšœå‘Šè­¦é‚®ä»¶å¿«æ’‘çˆ†æ”¶ä»¶ç®±äº†ï¼Œå¹¶ä¸”è¿˜ä¸æ–­çš„æœ‰æµé‡æ‰“åˆ°è¿™ä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰æ²»ç†çš„è¯ï¼Œä½ è¦ç«‹åˆ»èµ·åºŠæ‰“å¼€ç”µè„‘å°½å¿«æ¢å¤è¿™ä¸ªèŠ‚ç‚¹ã€‚æœ‰äº†æœåŠ¡æ²»ç†ï¼Œä½ æ‰“å¼€æœåŠ¡ç®¡ç†å™¨ï¼Œä¸€é”®ç†”æ–­é™çº§ï¼Œæå®šã€‚ç„¶åå¯ä»¥èµ·åºŠåƒä¸ªæ—©é¥­å†æ¥ä¿®å¤äº†(å‘¸~å½“ç„¶ç«‹åˆ»ä¿®å¤ï¼Œå“ªè¿˜æœ‰å¿ƒæ€åƒæ—©é¥­)ã€‚</p></blockquote></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å¼•æ–‡&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å¼•æ–‡&quot;&gt;&lt;/a&gt; å¼•æ–‡&lt;/h3&gt;
&lt;p&gt;å¼€å§‹çœ‹æ–‡ç« ä¹‹å‰ä¸å¦¨å…ˆæ€è€ƒå‡ ä¸ªé—®é¢˜ï¼šæœåŠ¡æ²»ç†æ˜¯ä»€ä¹ˆï¼Œä»€ä¹ˆæ ·å­çš„æœåŠ¡éœ€è¦æ²»ç†ï¼Œä¸ºä»€ä¹ˆéœ€è¦æ²»ç†æœåŠ¡ï¼Œåº”è¯¥æ€æ ·æ²»ç†æœåŠ¡ï¼Œæ²»ç†æœåŠ¡çš„å“ªäº›æ–¹é¢ï¼Œä¸æ²»ç†çš„è¯æœ
      
    
    </summary>
    
    
      <category term="åˆ†å¸ƒå¼" scheme="http://luxiaowan.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
  </entry>
  
  <entry>
    <title>èŠä¸€èŠè´Ÿè½½å‡è¡¡</title>
    <link href="http://luxiaowan.github.io/2020/04/20/%E8%81%8A%E4%B8%80%E8%81%8A%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <id>http://luxiaowan.github.io/2020/04/20/èŠä¸€èŠè´Ÿè½½å‡è¡¡/</id>
    <published>2020-04-20T03:53:00.000Z</published>
    <updated>2020-04-20T10:58:55.067Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>è´Ÿè½½å‡è¡¡æ˜¯å®ç°æœåŠ¡é«˜å¯ç”¨çš„ä¸€ä¸ªå…³é”®æ€§æŠ€æœ¯ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸­ï¼Œå¸¸å¸¸ä¼šå°†ä¸€ä¸ªåº”ç”¨éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸ŠåŒæ—¶æä¾›æœåŠ¡ï¼Œè´Ÿè½½å‡è¡¡å°†ä»»åŠ¡å‡è¡¡çš„åˆ†é…ç»™ä¸åŒçš„æœåŠ¡å™¨ï¼Œå‡å°‘å•ä¸€æœåŠ¡å™¨çš„è´Ÿè½½ï¼Œè¾¾åˆ°æ°´å¹³æ‰©å®¹çš„ç›®çš„ï¼Œå†è€…å¦‚æœé›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹çš„æœåŠ¡å®•æœºäº†ï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šåŠæ—¶å‘ç°ä¸å¯ç”¨çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶ä»é›†ç¾¤æœåŠ¡èŠ‚ç‚¹ä¸­é€»è¾‘ç§»é™¤ï¼Œæ­¤åçš„æµé‡ä¸ä¼šå†è½¬å‘åˆ°è¿™å°æœåŠ¡å™¨ä¸Šã€‚</p><h3 id="å•ç‚¹æœåŠ¡"><a class="markdownIt-Anchor" href="#å•ç‚¹æœåŠ¡"></a> å•ç‚¹æœåŠ¡</h3><p>æ²¡æœ‰ä½¿ç”¨è´Ÿè½½å‡è¡¡çš„æœåŠ¡æ¶æ„ä¸€èˆ¬å¦‚å›¾ï¼š</p><img src="/images/image-20200420122319035.png" alt="image-20200420122319035" style="zoom:60%;"><p>å¦‚æœServerå‡ºç°æ•…éšœå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªç³»ç»Ÿéƒ½ä¼šæ— æ³•ä½¿ç”¨ï¼Œè¿™ç§æ•…éšœçš„å±å®³å¯¹äºä¸€ä¸ªäº§å“è€Œè¨€æ˜¯éå¸¸å·¨å¤§çš„ã€‚åœ¨å¾®æœåŠ¡æµè¡Œä¹‹å‰ï¼Œä¸€äº›ä¸­å°å‹å…¬å¸å’Œä¼ ç»ŸITå…¬å¸å¤§å¤šé‡‡ç”¨å•ç‚¹éƒ¨ç½²æ–¹æ¡ˆã€‚</p><p>æ—¢ç„¶å•ç‚¹æœåŠ¡æ— æ³•ä¿è¯æ•…éšœçš„è‡ªåŠ¨åˆ‡æ¢ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…å•èŠ‚ç‚¹æ•…éšœè€Œå¯¼è‡´çš„æœåŠ¡ä¸å¯ç”¨ï¼Œå°±éœ€è¦å°†æœåŠ¡å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ŒæœåŠ¡ä¹‹é—´ä»¥ä¸»å¤‡çš„æ–¹å¼æä¾›æœåŠ¡ï¼Œè¿™å°±å»¶ä¼¸åˆ°äº†å¦å¤–ä¸€ä¸ªæ–¹æ¡ˆï¼šå¤šèŠ‚ç‚¹ä¸»å¤‡æœåŠ¡ã€‚</p><h3 id="å¤šèŠ‚ç‚¹ä¸»å¤‡"><a class="markdownIt-Anchor" href="#å¤šèŠ‚ç‚¹ä¸»å¤‡"></a> å¤šèŠ‚ç‚¹ä¸»å¤‡</h3><p>å¤šèŠ‚ç‚¹ä¸»å¤‡ä¸ç®—æ˜¯è´Ÿè½½å‡è¡¡çš„ä¸€ç§å®ç°ï¼Œè¿™ç§æ–¹æ¡ˆåªæ˜¯ä¸ºæœåŠ¡æä¾›äº†ä¸€ä¸ªå¤‡ä»½ï¼Œè™½ç„¶æœåŠ¡éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼Œä½†åŒæ—¶åªæœ‰ä¸€å°æœåŠ¡å™¨æä¾›æœåŠ¡ï¼Œå½“æ­£åœ¨æä¾›æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨å°†è¯·æ±‚åˆ‡æ¢åˆ°å¤‡ä»½çš„æœåŠ¡å™¨ä¸Šã€‚</p><img src="/images/image-20200420144949473.png" alt="image-20200420144949473" style="zoom:60%;"><p>å¤šèŠ‚ç‚¹ä¸»å¤‡æ–¹æ¡ˆä¿è¯äº†æœåŠ¡çš„é«˜å¯ç”¨ï¼Œä½†å¹¶æ²¡æœ‰ä¿è¯è´Ÿè½½çš„å‡è¡¡åˆ†é…ï¼Œç”±äºåŒä¸€æ—¶é—´åªæœ‰ä¸€å°æœºå™¨æä¾›æœåŠ¡ï¼Œæ‰€æœ‰çš„æµé‡å…¨éƒ¨éƒ½ä¼šé€ä¼ åˆ°è¿™ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå½“æµé‡æ¿€å¢çš„æ—¶å€™å¯èƒ½ä¼šå¾ˆå¿«çš„å‹å®è¿™å°æœåŠ¡å™¨ï¼Œç„¶åä¸æ–­çš„åœ¨ä¸»å¤‡æœºå™¨ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å‹å®ä¸€å°æœåŠ¡å™¨ã€‚</p><p>æˆ‘ä»¬é€šå¸¸è§£å†³è¿™ç§æƒ…å†µçš„åŠæ³•å°±æ˜¯å¢åŠ æ¯å°æœåŠ¡å™¨çš„é…ç½®ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºF5è´Ÿè½½å‡è¡¡ï¼ˆå‹ç¼©æ•°æ®ã€è¿æ¥èšåˆã€é¡µé¢ç¼“å­˜ã€æµè§ˆå™¨ç¼“å­˜ï¼‰ï¼Œä½†æ˜¯è¿™ç§æ–¹æ¡ˆçš„æˆæœ¬éå¸¸é«˜ï¼Œä¸€èˆ¬çš„ä¸­å°ä¼ä¸šéƒ½éš¾ä»¥æ‰¿æ‹…è¿™ä¸ªè´¹ç”¨ã€‚æ‰€ä»¥æ™ºè€…åˆæå‡ºèƒ½å¦è®©å¤šå°æœåŠ¡å™¨åŒæ—¶å¯¹å¤–æä¾›æœåŠ¡ï¼Œç„¶åæ ¹æ®ä¸€å®šçš„è§„åˆ™å°†æµé‡åˆ†é…åˆ°æ¯ä¸€å°æœºå™¨ä¸Šï¼Œè¿™æ ·æ—¢èƒ½ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ï¼Œä¹Ÿèƒ½ç¼“è§£æ¯å°æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå› æ­¤Nginxè¿™ç±»è´Ÿè½½å‡è¡¡ç»„ä»¶åº”è¿è€Œç”Ÿã€‚</p><h3 id="è´Ÿè½½å‡è¡¡ç­–ç•¥"><a class="markdownIt-Anchor" href="#è´Ÿè½½å‡è¡¡ç­–ç•¥"></a> è´Ÿè½½å‡è¡¡ç­–ç•¥</h3><p>æ—¢ç„¶å¤šå°æœåŠ¡å™¨å¯ä»¥åŒæ—¶æä¾›ç›¸åŒçš„æœåŠ¡ï¼Œé‚£ä¹ˆå°±éœ€è¦æŒ‡å®šå“åº”çš„è§„åˆ™è¿›è¡Œæµé‡åˆ†é…ï¼Œå¹¶ä¸”è¦ç¡®ä¿æœåŠ¡æ˜¯å¯ç”¨çš„ï¼Œä¸ç„¶è¯·æ±‚è¿‡æ¥ä¹‹åä¸çŸ¥é“è¯¥å¾€å“ªè½¬å‘ï¼Œæ‰€ä»¥åœ¨åšè´Ÿè½½å‡è¡¡æœåŠ¡é…ç½®ä¹‹å‰éœ€è¦å…ˆç¡®å®šå‡è¡¡ç­–ç•¥ã€‚</p><img src="/images/image-20200420151415778.png" alt="image-20200420151415778" style="zoom:50%;"><ul><li>è½®è¯¢ç­–ç•¥ï¼šè½®è¯¢ä¹Ÿå°±æ„å‘³ç€æœåŠ¡å™¨ä¼šè¢«æŒ‰é¡ºåºçš„é€‰æ‹©ï¼Œä»1åˆ°Nç„¶åé‡æ–°å¼€å§‹ï¼Œæ¯”å¦‚ç”±ä¸¤å°æœåŠ¡å™¨ï¼Œè¯·æ±‚1åˆ†é…ç»™Server1ï¼Œè¯·æ±‚2åˆ†é…ç»™Server2ï¼Œè¯·æ±‚3åˆ†é…ç»™Server1â€¦ï¼Œæ‰€æœ‰çš„æœåŠ¡å™¨éƒ½ä¼šè¢«åˆ†é…æ•°é‡ç›¸åŒçš„æµé‡ã€‚è¿™ç§ç­–ç•¥é€‚åˆç”¨äºå„æœåŠ¡å™¨å¤„ç†èƒ½åŠ›ç›¸åŒå¹¶ä¸”æ¯ä¸ªä¸šåŠ¡å¤„ç†é‡å·®ä¸å¤šçš„æƒ…å†µã€‚</li><li>éšæœºç­–ç•¥ï¼šè¯·æ±‚éšæœºå‘é€åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œæ¯å°æœåŠ¡å™¨å¤„ç†çš„è¯·æ±‚æ•°é‡å¯èƒ½ä¼šæœ‰å¾ˆå¤§çš„å·®å¼‚ã€‚ä¸€èˆ¬ä¸ä½¿ç”¨éšæœºç­–ç•¥ã€‚</li><li>æœ€å°‘è¿æ¥ç­–ç•¥ï¼šå®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚æ‰€æ¶ˆè€—çš„æ—¶é•¿å¯èƒ½ä¼šæœ‰å¾ˆå¤§å·®å¼‚ï¼Œæ¯å°æœåŠ¡å™¨ä¸Šçš„è¿æ¥çº¿ç¨‹å¯èƒ½ä¼šå› æ­¤äº§ç”Ÿè¾ƒå¤§çš„ä¸åŒï¼Œé•¿æ­¤ä»¥å¾€å¹¶ä¸èƒ½è¾¾åˆ°çœŸæ­£çš„è´Ÿè½½å‡è¡¡ã€‚æœ€å°‘è¿æ¥ç­–ç•¥æ˜¯è®©è´Ÿè½½å‡è¡¡å™¨è®°å½•æ¯å°æœåŠ¡å™¨æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°ï¼Œæ–°çš„è¯·æ±‚æ‰“è¿‡æ¥ä¹‹åä¼šåˆ†é…ç»™å½“å‰æ­£åœ¨å¤„ç†è¯·æ±‚æ•°æœ€å°‘çš„é‚£å°æœºå™¨ï¼Œä½¿æ¯å°æœåŠ¡å™¨å¤„ç†çš„è¯·æ±‚æ•°æ›´åŠ å‡è¡¡ã€‚è¿™ç§ç­–ç•¥é€‚åˆé•¿æ—¶å¤„ç†çš„è¯·æ±‚æœåŠ¡ã€‚</li><li>æƒé‡ç­–ç•¥ï¼šäº‹å…ˆä¸ºæ¯å°æœåŠ¡å™¨åˆ†é…ä¸åŒçš„æƒé‡ï¼Œæ¯”å¦‚Server1å’ŒServer2åˆ†åˆ«è®¾ç½®ä¸º3å’Œ7ï¼Œä¹Ÿå°±æ„å‘³ç€Server2å°†æ‰¿æ‹…70%çš„è¯·æ±‚ï¼ŒServer1åˆ™æ‰¿æ‹…30%çš„è¯·æ±‚ï¼Œä¿è¯æ€§èƒ½æ›´ä¼˜çš„æœåŠ¡å™¨èƒ½å¤Ÿæ‰¿æ‹…æ›´å¤šçš„è¯·æ±‚å¤„ç†ä»»åŠ¡ã€‚æƒé‡ç­–ç•¥é€‚ç”¨äºæœåŠ¡å™¨æ€§èƒ½ä¸åŒçš„æƒ…å†µã€‚</li><li>IP-Hashç­–ç•¥ï¼šè´Ÿè½½å‡è¡¡å™¨æ ¹æ®è¯·æ±‚æ¥æºçš„IPè®¡ç®—Hashå€¼ï¼Œç„¶åå†³å®šåˆ†é…ç»™å“ªä¸€å°æœåŠ¡å™¨ï¼Œå½“ç”¨æˆ·IPå’ŒHashè®¡ç®—æ–¹å¼ä¸å‘ç”Ÿå˜åŒ–çš„æƒ…å†µä¸‹ï¼Œä»–å‘å‡ºçš„æ‰€æœ‰è¯·æ±‚æœ€ç»ˆéƒ½ä¼šè½åœ¨ä¸€å°æœºå™¨ä¸Šã€‚è¯¥ç­–ç•¥é€‚ç”¨äºæƒ³ç®€å•è§£å†³sessioné—®é¢˜çš„æƒ…å†µã€‚</li></ul><h3 id="å¥åº·æ£€æŸ¥"><a class="markdownIt-Anchor" href="#å¥åº·æ£€æŸ¥"></a> å¥åº·æ£€æŸ¥</h3><p>ä½¿ç”¨è´Ÿè½½å‡è¡¡çš„ç›®çš„æ—¢ç„¶æ˜¯æå‡æœåŠ¡çš„é«˜å¯ç”¨ï¼Œé‚£ä¹ˆå‰æè‡ªç„¶æ˜¯è¦ç¡®ä¿é›†ç¾¤ä¸­çš„æ¯ä¸ªæœåŠ¡éƒ½æ˜¯å¥åº·å¯ç”¨çš„ï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šé€šè¿‡å¥åº·æ£€æŸ¥çš„æ–¹å¼æ¥è¯†åˆ«æœåŠ¡æ˜¯å¦å¯ç”¨ã€‚</p><p>å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡å™¨åŸºæœ¬å±Nginxè«å±äº†ï¼Œä½¿ç”¨Nginxçš„å¥½å¤„æ˜¯å®ƒè‡ªå¸¦å¥åº·æ£€æŸ¥æ¨¡å—<code>ngx_http_upstream_module</code>ï¼Œå¯ç”¨åšåˆ°æœ€åŸºæœ¬çš„å¥åº·æ£€æŸ¥ã€‚ä½†æ˜¯Nginxæ˜¯è¢«åŠ¨çš„è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯å¥åº·æ£€æŸ¥æ˜¯ä¾èµ–äºè¯·æ±‚çš„ï¼Œå¦‚æœæœåŠ¡1å‡ºç°å¼‚å¸¸ï¼Œåˆ™éœ€è¦å†å°†è¯·æ±‚è½¬å‘ç»™æœåŠ¡2ï¼Œç›´åˆ°é‡åˆ°èƒ½å¤ŸæˆåŠŸè¿”å›çš„æ¥å£ï¼Œæ¯ä¸€æ¬¡çš„å¤±è´¥è¯·æ±‚éƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œè‹¥å¤±è´¥èŠ‚ç‚¹è¾¾åˆ°äº†é¢„è®¾çš„æœ€å¤§æ¬¡æ•°ï¼Œåˆ™å°†å…¶ä»å¥åº·æœåŠ¡åˆ—è¡¨ä¸­ç§»é™¤ï¼Œæ•ˆç‡ä¸é«˜ã€‚</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backend&#123;</span><br><span class="line">  <span class="comment"># max_failsè¡¨ç¤ºå¤±è´¥æ¬¡æ•°ï¼Œæ•´ä½“çš„æ„æ€æ˜¯åœ¨fail_timeoutæ—¶é—´å†…è‹¥å¤±è´¥æ¬¡æ•°è¾¾åˆ°äº†max_failsï¼Œåˆ™è®¤ä¸ºè¯¥èŠ‚ç‚¹çš„æœåŠ¡å¼‚å¸¸ï¼Œç§»é™¤å¥åº·æœåŠ¡åˆ—è¡¨</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>  max_fails=<span class="number">1</span> fail_timeout=<span class="number">40s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8090</span>  max_fails=<span class="number">1</span> fail_timeout=<span class="number">40s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> d.kv.cc; </span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">proxy_pass</span>http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è´Ÿè½½å‡è¡¡sessionå…±äº«é—®é¢˜"><a class="markdownIt-Anchor" href="#è´Ÿè½½å‡è¡¡sessionå…±äº«é—®é¢˜"></a> è´Ÿè½½å‡è¡¡sessionå…±äº«é—®é¢˜</h3><p>åœ¨ä½¿ç”¨IP-Hashåšè´Ÿè½½å‡è¡¡ç­–ç•¥æ—¶ï¼Œå› ä¸ºåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚éƒ½ä¼šè½¬å‘åˆ°å›ºå®šçš„ä¸€å°æœºå™¨ä¸Šï¼Œæ‰€ä»¥åœ¨æœåŠ¡ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œä¸ç”¨è€ƒè™‘sessionå…±äº«çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸ºäº†é˜²æ­¢æœåŠ¡å™¨çªç„¶å®•æœºè€Œå¼•èµ·çš„è¯·æ±‚è¢«è½¬å‘åˆ°å…¶ä»–æœºå™¨é€ æˆçš„sessionä¸¢å¤±çš„æƒ…å†µå‡ºç°ï¼Œæ‰€ä»¥ä¸ç®¡å“ªä¸€ç§ç­–ç•¥ï¼Œæœ€å¥½éƒ½åšå¥½sessionå…±äº«çš„è§£å†³æ–¹æ¡ˆã€‚</p><ol><li>Redisï¼šå¯ä»¥ä½¿ç”¨spring-session+Redisæ¥å®ç°sessionå…±äº«ï¼Œå¾ˆç®€å•ï¼Œè¯·çœ‹<a href="https://luxiaowan.github.io/2019/10/24/Spring-Session%E5%92%8CRedis%E5%AE%9E%E7%8E%B0Session%E5%85%B1%E4%BA%AB/">Spring-Sessionå’ŒRediså®ç°Sessionå…±äº«</a></li><li>åŸºäºtokenè®¤è¯ï¼šJWTè®¤è¯</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å‰è¨€&quot;&gt;&lt;/a&gt; å‰è¨€&lt;/h3&gt;
&lt;p&gt;è´Ÿè½½å‡è¡¡æ˜¯å®ç°æœåŠ¡é«˜å¯ç”¨çš„ä¸€ä¸ªå…³é”®æ€§æŠ€æœ¯ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸­ï¼Œå¸¸å¸¸ä¼šå°†ä¸€ä¸ªåº”ç”¨éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸ŠåŒæ—¶æä¾›æœåŠ¡ï¼Œè´Ÿè½½å‡è¡¡å°†ä»»åŠ¡å‡è¡¡çš„åˆ†é…ç»™ä¸åŒçš„æœåŠ¡å™¨ï¼Œ
      
    
    </summary>
    
    
      <category term="åˆ†å¸ƒå¼" scheme="http://luxiaowan.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
  </entry>
  
  <entry>
    <title>è½¯ä»¶å¼€å‘ä¸­çš„å¹‚ç­‰æ˜¯ä»€ä¹ˆ</title>
    <link href="http://luxiaowan.github.io/2020/04/20/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E5%B9%82%E7%AD%89%E6%98%AF%E4%BB%80%E4%B9%88/"/>
    <id>http://luxiaowan.github.io/2020/04/20/è½¯ä»¶å¼€å‘ä¸­çš„å¹‚ç­‰æ˜¯ä»€ä¹ˆ/</id>
    <published>2020-04-19T22:06:00.000Z</published>
    <updated>2020-04-19T23:31:00.914Z</updated>
    
    <content type="html"><![CDATA[<p>å·¥ä½œä¸­ç»å¸¸ä¼šé‡åˆ°ä¸€ä¸ªäº‹åŠ¡å‹æ¥å£æˆ–è€…ä¸€ä¸ªäº‹åŠ¡å‹æ–¹æ³•è¢«è°ƒç”¨æ–¹é‡å¤è°ƒç”¨ï¼Œå®é™…ä¸Šæ¯æ¬¡è°ƒç”¨çš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„ï¼Œæœ‰å¯èƒ½æ˜¯å› ä¸ºç½‘ç»œå»¶è¿Ÿï¼Œå®¢æˆ·ç«¯ç‚¹å‡»äº†å¤šæ¬¡ï¼Œä¹Ÿå¯èƒ½æ˜¯è°ƒç”¨æ–¹æ•…æ„è€Œä¸ºä¹‹ï¼Œä¸è®ºæ˜¯å“ªç§æƒ…å†µï¼Œæˆ‘ä»¬éƒ½ä¸èƒ½è®©è¿™ç§é‡å¤çš„æ“ä½œå¯¹æˆ‘ä»¬è‡ªå·±çš„ç³»ç»Ÿé€ æˆä¸å¿…è¦çš„å½±å“ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¯¹äºæ¥å£å’Œæ–¹æ³•åšå¹‚ç­‰æ ¡éªŒã€‚å…¶å®å¹‚ç­‰è¿‡æ»¤ä¸€ç›´éƒ½è´¯ç©¿ITè¡Œä¸šï¼Œåªä¸è¿‡ç°åœ¨éšç€äº’è”ç½‘è¡Œä¸šçš„å‘å±•ï¼Œè¡Œä¸šå†…çš„é€ è¯èƒ½åŠ›å’Œè¯è¯­å¼•ç”¨èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œå¹‚ç­‰è¢«è®¡ç®—æœºè¡Œä¸šæ­£å¼å¼•ç”¨ã€‚</p><h3 id="å¹‚ç­‰æ€§"><a class="markdownIt-Anchor" href="#å¹‚ç­‰æ€§"></a> å¹‚ç­‰æ€§</h3><p>åœ¨æ•°å­¦æ¦‚å¿µé‡Œï¼Œå¹‚ç­‰æ˜¯æŒ‡ä¸€æ¬¡å˜æ¢å’ŒNæ¬¡å˜æ¢çš„ç»“æœéƒ½ç›¸åŒã€‚è€Œåœ¨è®¡ç®—æœºæ¦‚å¿µä¸­ï¼Œå¹‚ç­‰æ˜¯æŒ‡æŸä¸€æ“ä½œæ‰§è¡Œnæ¬¡å’Œæ‰§è¡Œä¸€æ¬¡æ‰€äº§ç”Ÿçš„å½±å“æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯é‡å¤æ‰§è¡Œè¿™é¡¹æ“ä½œä¹Ÿä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆæ”¹å˜ï¼Œæ¯”å¦‚æŠ¢ä¼˜æƒ åˆ¸ï¼Œæ¯äººé™åˆ¶æŠ¢ä¸€å¼ ä¼˜æƒ åˆ¸ï¼Œå¯ä»¥ä½¿ç”¨ç”¨æˆ·ID+ä¼˜æƒ åˆ¸IDåšå¹‚ç­‰æ¡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ¯ä¸ªç”¨æˆ·åªèƒ½æŠ¢ä¸€å¼ æ­¤ä¼˜æƒ åˆ¸ã€‚</p><h3 id="restfulå¹‚ç­‰"><a class="markdownIt-Anchor" href="#restfulå¹‚ç­‰"></a> RESTFulå¹‚ç­‰</h3><ul><li>GETè¯·æ±‚ï¼šGETè¯·æ±‚å±äºæ˜¯éäº‹åŠ¡å‹è¯·æ±‚ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆä»»ä½•å½±å“ï¼Œæ‰€ä»¥è¿™ç±»æ¥å£æœ¬èº«å°±ç¬¦åˆäº†å¹‚ç­‰æ€§ï¼ˆè¿™é‡Œè¯´çš„æ˜¯å¯¹ç³»ç»Ÿé€ æˆå½±å“ï¼Œè€Œä¸æ˜¯è¯´æ¯æ¬¡è°ƒç”¨è·å–åˆ°çš„æ•°æ®ç›¸åŒï¼Œå¹‚ç­‰æ˜¯é’ˆå¯¹äºç³»ç»Ÿè€Œéæ¥å£ï¼‰</li><li>DELETEè¯·æ±‚ï¼šDELETEè¯·æ±‚æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„äº‹åŠ¡å‹è¯·æ±‚ï¼Œåœ¨è°ƒç”¨ç¬¬ä¸€æ¬¡çš„æ—¶å€™å°±å·²ç»æŠŠæ•°æ®åˆ é™¤äº†ï¼Œæ‰€ä»¥ä¸è®ºåç»­å†æ¬¡è°ƒç”¨å¤šå°‘æ¬¡ï¼Œå¯¹ç³»ç»Ÿäº§ç”Ÿçš„å½±å“éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥DELETEç±»å‹çš„è¯·æ±‚æœ¬èº«ä¹Ÿæ˜¯ç¬¦åˆå¹‚ç­‰æ€§çš„</li><li>PUTè¯·æ±‚ï¼šPUTè¯·æ±‚æ˜¯å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œç†è®ºä¸Šå¯¹åŒä¸€URIè¿›è¡Œå¤šæ¬¡PUTæ“ä½œå¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“å’Œä¸€æ¬¡PUTæ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯è¿™è¦ç»“åˆæ¥å£å…·ä½“ä»£ç å®ç°æ¥è€ƒé‡<ul><li>ç›´æ¥å°†PUTçš„æ•°å€¼æ›¿æ¢æ‰åŸæœ‰æ•°æ®ï¼šå¹‚ç­‰</li><li>æ¯æ¬¡è°ƒç”¨éƒ½å¯¹æŸä¸ªæ•°æ®é€’å¢ï¼šéå¹‚ç­‰ï¼Œéœ€è¦æ‰‹åŠ¨å¹‚ç­‰</li></ul></li><li>POSTè¯·æ±‚ï¼šPOSTæ˜¯åˆ›å»ºèµ„æºçš„äº‹åŠ¡å‹è¯·æ±‚ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä»½èµ„æºï¼Œæ‰€ä»¥å¤šæ¬¡è°ƒç”¨å¯¹æ•´ä¸ªç³»ç»Ÿäº§ç”Ÿçš„å½±å“æ˜¯ä¸åŒçš„ï¼Œè¯¥ç±»å‹çš„è¯·æ±‚æ˜¯éå¹‚ç­‰çš„</li></ul><h3 id="å¸¸ç”¨å¹‚ç­‰æ–¹æ³•"><a class="markdownIt-Anchor" href="#å¸¸ç”¨å¹‚ç­‰æ–¹æ³•"></a> å¸¸ç”¨å¹‚ç­‰æ–¹æ³•</h3><ul><li><p>æ•°æ®åº“å”¯ä¸€ç´¢å¼•å»é‡</p><p>åˆ©ç”¨æ•°æ®åº“å”¯ä¸€ç´¢å¼•çš„ç‰¹æ€§è¾¾åˆ°å¹‚ç­‰çš„æ•ˆæœï¼Œä¸ä¼šå¾€æ•°æ®è¡¨ä¸­æ’å…¥ä¸¤æ¡å¹‚ç­‰å­—æ®µç›¸åŒçš„æ•°æ®ã€‚ä¾‹å¦‚æ–‡ç« ç‚¹èµåŠŸèƒ½ï¼Œä¸ºäº†é˜²æ­¢ç”¨æˆ·é‡å¤ç‚¹èµï¼Œå¯ä»¥åœ¨ç‚¹èµè¡¨ä¸­ä»¥ç”¨æˆ·ID+æ–‡ç« IDä¸ºå”¯ä¸€ç´¢å¼•ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢ç”¨æˆ·ç»™ä¸€ç¯‡æ–‡ç« é‡å¤ç‚¹èµï¼Œæœ€ç»ˆè¾¾åˆ°å¹‚ç­‰æ“ä½œçš„æ•ˆæœã€‚</p></li><li><p>ç‰ˆæœ¬é”æ§åˆ¶</p><p>ç‰ˆæœ¬é”å±äºæ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°ï¼ŒMySQLä¸­çš„MVCCå°±æ˜¯ç‰ˆæœ¬é”çš„ä¸€ç§åº”ç”¨æ–¹å¼ï¼Œé€šè¿‡æ¯æ¬¡æ›´æ–°éƒ½é€šè¿‡ç‰ˆæœ¬å·æ§åˆ¶æƒé™æ¥è¾¾åˆ°å¹‚ç­‰æ“ä½œçš„æ•ˆæœ</p></li><li><p>tokenç¼“å­˜æœºåˆ¶</p><p>tokenç¼“å­˜æœºåˆ¶æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„å¹‚ç­‰å¤„ç†æ–¹å¼ï¼Œåº”ç”¨èŒƒå›´è¾ƒå¹¿ï¼Œä¸é™å®šåœºæ™¯å’Œè¯­è¨€ã€‚æ ¸å¿ƒæ€æƒ³å°±æ˜¯ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€æ ‡è¯†(token)ï¼Œä¸€ä¸ªtokenåœ¨ä¸€æ¡ä¸šåŠ¡çº¿çš„æ¯ä¸ªé˜¶æ®µåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œä¹‹åå°†è¿™ä¸ªé˜¶æ®µçš„ç»“æœç¼“å­˜èµ·æ¥ï¼Œæ¯æ¬¡æ‰§è¡Œå‰å…ˆæ ¡éªŒæ˜¯å¦å·²æœ‰ç¼“å­˜ï¼Œæ²¡æœ‰ç¼“å­˜åˆ™æ‰§è¡Œæµç¨‹ï¼Œå·²æœ‰ç¼“å­˜åˆ™ç›´æ¥è¿”å›ç»“æœã€‚</p></li></ul><h3 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h3><p>ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ä¼šé¢ä¸´ä¸åŒçš„å¹‚ç­‰è¦æ±‚ï¼Œä¹Ÿå°±ä¼šæœ‰ä¸åŒçš„è§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥å¹‚ç­‰çš„å®ç°éš¾åº¦æ˜¯ä¸åŒçš„ã€‚åœ¨åšç³»ç»Ÿè®¾è®¡æ—¶ï¼Œä¸€å®šè¦å°†å¹‚ç­‰æ€§è€ƒè™‘å‘¨å…¨ï¼Œå¦åˆ™å¯èƒ½ä¼šç»™ç³»ç»Ÿå¸¦æ¥ä¸å¿…è¦çš„æ½œåœ¨éšæ‚£ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å·¥ä½œä¸­ç»å¸¸ä¼šé‡åˆ°ä¸€ä¸ªäº‹åŠ¡å‹æ¥å£æˆ–è€…ä¸€ä¸ªäº‹åŠ¡å‹æ–¹æ³•è¢«è°ƒç”¨æ–¹é‡å¤è°ƒç”¨ï¼Œå®é™…ä¸Šæ¯æ¬¡è°ƒç”¨çš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„ï¼Œæœ‰å¯èƒ½æ˜¯å› ä¸ºç½‘ç»œå»¶è¿Ÿï¼Œå®¢æˆ·ç«¯ç‚¹å‡»äº†å¤šæ¬¡ï¼Œä¹Ÿå¯èƒ½æ˜¯è°ƒç”¨æ–¹æ•…æ„è€Œä¸ºä¹‹ï¼Œä¸è®ºæ˜¯å“ªç§æƒ…å†µï¼Œæˆ‘ä»¬éƒ½ä¸èƒ½è®©è¿™ç§é‡å¤çš„æ“ä½œå¯¹æˆ‘ä»¬è‡ªå·±çš„ç³»ç»Ÿé€ æˆä¸å¿…è¦çš„å½±å“ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¯¹äºæ¥å£å’Œæ–¹æ³•åšå¹‚ç­‰
      
    
    </summary>
    
    
      <category term="åˆ†å¸ƒå¼" scheme="http://luxiaowan.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
  </entry>
  
  <entry>
    <title>Gitåˆ†æ”¯ç®¡ç†</title>
    <link href="http://luxiaowan.github.io/2020/04/20/Git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86/"/>
    <id>http://luxiaowan.github.io/2020/04/20/Gitåˆ†æ”¯ç®¡ç†/</id>
    <published>2020-04-19T18:18:00.000Z</published>
    <updated>2020-04-19T18:53:22.831Z</updated>
    
    <content type="html"><![CDATA[<p>ç›®å‰æœ€æµè¡Œçš„Gitåˆ†æ”¯ç®¡ç†è§„èŒƒåº”è¯¥å±git-flowè«å±äº†ï¼Œå®ƒçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ç‰ˆæœ¬å‘å¸ƒï¼Œé€‚ç”¨äºé¡¹ç›®çš„æŒç»­é›†æˆå’Œé¢‘ç¹å‘å¸ƒï¼Œè¿™ä¹Ÿæ˜¯è¿‘äº›å¹´ä½¿ç”¨Gitçš„è¿‡ç¨‹ä¸­ä¸€ç›´ä½¿ç”¨çš„è§„èŒƒã€‚</p><p>git-flowæµç¨‹ä¸­æœ‰5ç±»åˆ†æ”¯ï¼Œåˆ†åˆ«æ˜¯masterã€developã€relaese(å‘å¸ƒç‰ˆæœ¬)ã€feature(æ–°åŠŸèƒ½åˆ†æ”¯)ã€hotfix(ä¿®å¤bugç‰ˆæœ¬)ï¼Œè¿™äº›åˆ†æ”¯éƒ½æœ‰å„è‡ªçš„ä½œç”¨å’Œç”Ÿå‘½å‘¨æœŸï¼Œmasteræ˜¯æœ€ç¨³å®šçš„åˆ†æ”¯ï¼Œdevelopæ˜¯ä¸€ä¸ªæ–°ä»£ç é›†æˆåˆ†æ”¯ï¼Œæ‰€æœ‰å‘å¸ƒåçš„ä»£ç éƒ½åˆå¹¶åˆ°developï¼Œç„¶åç”±developåˆå¹¶åˆ°masterï¼Œå¼€å‘å®Œæˆååœ¨å‘å¸ƒçš„æ—¶å€™åˆ›å»ºreleaseåˆ†æ”¯è¿›è¡Œå‘å¸ƒï¼Œåœ¨å¼€å‘æ–°åŠŸèƒ½çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªfeatureåˆ†æ”¯ï¼Œç”Ÿäº§ä¸Šé‡åˆ°éœ€è¦ä¿®å¤çš„ç´§æ€¥bugæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªhotfixåˆ†æ”¯ã€‚</p><p>åˆ†æ”¯åç§°è§„åˆ™ï¼š<code>release/feature/hotfix-åˆ†æ”¯åˆ›å»ºæ—¥æœŸ-åˆ†æ”¯ç‰ˆæœ¬å·</code></p><table><thead><tr><th style="text-align:left">åˆ†æ”¯ç±»å‹</th><th style="text-align:left">å‘½åè§„èŒƒ</th><th style="text-align:left">åˆ›å»ºè‡ª</th><th style="text-align:left">åˆå¹¶åˆ°</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left">feature</td><td style="text-align:left">feature/*</td><td style="text-align:left">develop</td><td style="text-align:left">develop</td><td style="text-align:left">æ–°åŠŸèƒ½</td></tr><tr><td style="text-align:left">release</td><td style="text-align:left">release/*</td><td style="text-align:left">develop</td><td style="text-align:left">develop å’Œ master</td><td style="text-align:left">ä¸€æ¬¡æ–°ç‰ˆæœ¬çš„å‘å¸ƒ</td></tr><tr><td style="text-align:left">hotfix</td><td style="text-align:left">hotfix/*</td><td style="text-align:left">master</td><td style="text-align:left">develop å’Œ master</td><td style="text-align:left">ç”Ÿäº§ç¯å¢ƒä¸­å‘ç°çš„ç´§æ€¥ bug çš„ä¿®å¤</td></tr></tbody></table><blockquote><p>Gitåˆ†æ”¯å…³ç³»å›¾</p></blockquote><img src="/images/git-model.png" alt="img" style="zoom: 67%;"><ul><li><p>å¯¹äºä¸åŒçš„å¼€å‘ä»»åŠ¡ï¼Œéœ€è¦åœ¨ä¸åŒçš„åˆ†æ”¯ä¸Šå®Œæˆå¼€å‘ï¼Œå¼€å‘å®Œæˆååˆå¹¶åˆ°developåˆ†æ”¯è¿›è¡Œæµ‹è¯•ï¼ŒåŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>ä»developåˆ†æ”¯åˆ›å»ºä¸€ä¸ªfeatureåˆ†æ”¯ï¼šfeature/cc-20200420-v1.0.1</p></li><li><p>åœ¨feature/ccåˆ†æ”¯ä¸Šè¿›è¡Œå¼€å‘</p></li><li><p>å¼€å‘å®Œæˆåå°†feature/ccåˆå¹¶åˆ°developåˆ†æ”¯</p></li></ol></li><li><p>åœ¨è¿›è¡Œç‰ˆæœ¬å‘å¸ƒæ—¶çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ä»developåˆ›å»ºreleaseåˆ†æ”¯ï¼šrelease/cc-20200420-v1.0.1</li><li>å°†release/ccåˆ†æ”¯å‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒè¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•ä¸­å‡ºç°çš„bugç›´æ¥åœ¨release/ccåˆ†æ”¯ä¸Šä¿®æ”¹å¹¶æäº¤</li><li>æµ‹è¯•å®Œæˆååˆå¹¶åˆ°developå’Œmasterï¼Œå¹¶åœ¨masterä¸Šæ‰“ä¸€ä¸ªTag</li></ol></li><li><p>åœ¨è¿›è¡Œç”Ÿäº§bugç´§æ€¥ä¿®å¤æ—¶çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ä»masteråˆ›å»ºhotfixåˆ†æ”¯ï¼šhotfix/cc-20200420-v1.0.1</li><li>éªŒè¯å®Œæˆåå°†hotfix/ccåˆ†æ”¯åˆå¹¶åˆ°developå’Œmasterï¼Œå¹¶åœ¨masterä¸Šæ‰“ä¸€ä¸ªTag</li></ol></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ç›®å‰æœ€æµè¡Œçš„Gitåˆ†æ”¯ç®¡ç†è§„èŒƒåº”è¯¥å±git-flowè«å±äº†ï¼Œå®ƒçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ç‰ˆæœ¬å‘å¸ƒï¼Œé€‚ç”¨äºé¡¹ç›®çš„æŒç»­é›†æˆå’Œé¢‘ç¹å‘å¸ƒï¼Œè¿™ä¹Ÿæ˜¯è¿‘äº›å¹´ä½¿ç”¨Gitçš„è¿‡ç¨‹ä¸­ä¸€ç›´ä½¿ç”¨çš„è§„èŒƒã€‚&lt;/p&gt;
&lt;p&gt;git-flowæµç¨‹ä¸­æœ‰5ç±»åˆ†æ”¯ï¼Œåˆ†åˆ«æ˜¯masterã€developã€relaese(å‘å¸ƒç‰ˆæœ¬)
      
    
    </summary>
    
    
      <category term="Git" scheme="http://luxiaowan.github.io/categories/Git/"/>
    
    
  </entry>
  
  <entry>
    <title>Gitæœ¬åœ°ä»“åº“å…³è”è¿œç¨‹ä»“åº“</title>
    <link href="http://luxiaowan.github.io/2020/04/20/Git%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93%E5%85%B3%E8%81%94%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/"/>
    <id>http://luxiaowan.github.io/2020/04/20/Gitæœ¬åœ°ä»“åº“å…³è”è¿œç¨‹ä»“åº“/</id>
    <published>2020-04-19T17:39:00.000Z</published>
    <updated>2020-04-19T18:11:05.431Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æƒ…æ™¯"><a class="markdownIt-Anchor" href="#æƒ…æ™¯"></a> æƒ…æ™¯</h3><p>æœ¬åœ°åˆ›å»ºäº†ä¸€ä¸ªå·¥ç¨‹ï¼Œå¼€å‘å®Œæˆåæƒ³è¦æäº¤åˆ°github/gitlabä¸Š</p><ul><li>æœ¬åœ°</li></ul><p><img src="/images/image-20200420014905633.png" alt="image-20200420014905633"></p><ul><li>è¿œç¨‹</li></ul><p><img src="/images/image-20200420014219180.png" alt="image-20200420014219180"></p><h3 id="æ­¥éª¤"><a class="markdownIt-Anchor" href="#æ­¥éª¤"></a> æ­¥éª¤</h3><ol><li><p>è¿›å…¥åˆ°å·¥ç¨‹ç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd git-demo</span><br></pre></td></tr></table></figure></li><li><p>åˆå§‹åŒ–æœ¬åœ°ä»“åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–ä¹‹åï¼Œå¯ä»¥é€šè¿‡<code>ls -al</code>æŸ¥çœ‹æœ¬åœ°ä»“åº“æ–‡ä»¶ï¼Œå‘ç°æ­¤æ—¶å·¥ç¨‹å†…å¤šå‡ºäº†ä¸€ä¸ª<code>.git</code>ç›®å½•</p><p><img src="/images/image-20200420015451562.png" alt="image-20200420015451562"></p></li><li><p>è®¾ç½®å…³è”è¿œç¨‹ä»“åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin http://gitlab.xxx.cc/utils/demo.git</span><br></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡Œä¹‹åï¼Œå¯ä»¥é€šè¿‡<code>git remote -v</code>æŸ¥çœ‹æ˜¯å¦å…³è”æˆåŠŸï¼Œfetchæ˜¯ä»è¿œç¨‹ä»“åº“åŒæ­¥ï¼Œpushæ˜¯æ¨é€åˆ°è¿œç¨‹ä»“åº“</p><p><img src="/images/image-20200420015810083.png" alt="image-20200420015810083"></p></li><li><p>å°†æœ¬åœ°æ–‡ä»¶addä¹‹åcommit</p><p>åœ¨æ‰§è¡Œaddå‘½ä»¤ä¹‹å‰ï¼Œä½¿ç”¨<code>git branch</code>æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯ä¼šå‘ç°æœ¬åœ°å½“å‰å°šæ— åˆ†æ”¯ï¼Œåœ¨addå’Œcommitä¹‹å‰ï¼Œå…ˆç¡®å®šä¸€ä¸‹æœ¬åœ°ä»“åº“çš„è´¦å·æ˜¯å¦å¯ä»¥è¿é€šè¿œç¨‹ä»“åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹ä»“åº“æ‰€æœ‰é…ç½®</span></span><br><span class="line">git config -l</span><br></pre></td></tr></table></figure><p><img src="/images/image-20200420020611199.png" alt="image-20200420020611199"></p><p>å¦‚æœè´¦å·ä¸å¯¹ï¼Œåˆ™å¯ä»¥é€šè¿‡<code>git config user.name</code>ç­‰å‘½ä»¤ä¿®æ”¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add . &amp;&amp; git commit -m "åˆå§‹åŒ–"</span><br></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡Œå®Œåå†ä½¿ç”¨<code>git branch</code>ä¼šçœ‹åˆ°æœ¬åœ°å·²ç»æœ‰äº†masteråˆ†æ”¯</p><p><img src="/images/image-20200420020224634.png" alt="image-20200420020224634"></p></li><li><p>å°†æœ¬åœ°ä»“åº“çš„æ–‡ä»¶æ¨é€åˆ°è¿œç¨‹ä»“åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin master</span><br></pre></td></tr></table></figure><p>æ¨é€ä¹‹åæŸ¥çœ‹è¿œç¨‹ä»“åº“ï¼Œä¼šå‘ç°è¿œç¨‹ä»“åº“å·²ç»åˆå§‹åŒ–å¥½äº†</p><p><img src="/images/image-20200420020848287.png" alt="image-20200420020848287"></p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;æƒ…æ™¯&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#æƒ…æ™¯&quot;&gt;&lt;/a&gt; æƒ…æ™¯&lt;/h3&gt;
&lt;p&gt;æœ¬åœ°åˆ›å»ºäº†ä¸€ä¸ªå·¥ç¨‹ï¼Œå¼€å‘å®Œæˆåæƒ³è¦æäº¤åˆ°github/gitlabä¸Š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœ¬åœ°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img sr
      
    
    </summary>
    
    
      <category term="Git" scheme="http://luxiaowan.github.io/categories/Git/"/>
    
    
  </entry>
  
  <entry>
    <title>Kafkaåœ¨æ•°æ®ä¼ é€’ä¸Šçš„åœºæ™¯åˆ†æ</title>
    <link href="http://luxiaowan.github.io/2020/04/19/Kafka%E5%9C%A8%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92%E4%B8%8A%E7%9A%84%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90/"/>
    <id>http://luxiaowan.github.io/2020/04/19/Kafkaåœ¨æ•°æ®ä¼ é€’ä¸Šçš„åœºæ™¯åˆ†æ/</id>
    <published>2020-04-19T14:38:00.000Z</published>
    <updated>2020-04-19T17:00:39.827Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åœºæ™¯"><a class="markdownIt-Anchor" href="#åœºæ™¯"></a> åœºæ™¯</h3><p>å‰æ®µæ—¶é—´é‡åˆ°ä¸€ä¸ªåœºæ™¯ï¼Œæœ‰ä¸€ä¸ªç”¨æˆ·ç¤¾åŒºæ¨¡å—ï¼Œç”¨æˆ·å¯ä»¥åœ¨ç¤¾åŒºçš„å¸–å­ä¸“åŒºå‘å¸ƒå¸–å­ï¼Œæˆ–è¯„è®ºå¸–å­ï¼Œå¸–å­å’Œè¯„è®ºä¿¡æ¯éœ€è¦ä¾æ®äº§ç”Ÿæ—¶é—´ä¾æ¬¡å‘é€ç»™ç¬¬ä¸‰æ–¹ï¼Œæ¶ˆæ¯å†…å®¹ä¸ºå¸–å­å’Œå¸–å­è¯„è®ºï¼Œæ¥æ”¶æ–¹å¿…é¡»å…ˆæ¥æ”¶å¸–å­å†æ¥æ”¶å¸–å­è¯„è®ºï¼Œä¸”éœ€è¦æŒ‰ç…§å‘ç”Ÿæ—¶é—´é¡ºåºä¾æ¬¡æ¥æ”¶ã€‚ç¬¬ä¸‰æ¥æ”¶æ–¹éšæ—¶å¯èƒ½æ–°å¢æˆ–å‡å°‘ï¼Œæ–°å¢çš„æ¥æ”¶æ–¹éœ€è¦è·å–åŠ å…¥æ—¶é—´å‰30å¤©ä¹‹å†…çš„å†å²æ•°æ®ã€‚</p><h3 id="æ¶ˆæ¯ä¸­é—´ä»¶é€‰æ‹©"><a class="markdownIt-Anchor" href="#æ¶ˆæ¯ä¸­é—´ä»¶é€‰æ‹©"></a> æ¶ˆæ¯ä¸­é—´ä»¶é€‰æ‹©</h3><p>è¿™æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æ¶ˆæ¯ä¼ é€’åŠŸèƒ½ï¼Œä¸æ¶‰åŠæ•°æ®çš„æ•´åˆå’Œæµå¤„ç†ï¼Œä½†æ˜¯å› ä¸ºæ–°å¢çš„æ¶ˆè´¹è€…(ç¬¬ä¸‰æ–¹)è¦èƒ½è·å–åˆ°å‰30å¤©ä¹‹å†…çš„å†å²æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿå°†æ¶ˆæ¯æŒä¹…åŒ–çš„æ¶ˆæ¯ç»„ä»¶ï¼Œå¹¶ä¸”è¦èƒ½è‡ªåŠ¨æ¸…ç†30å¤©ä¹‹å‰çš„å†å²æ¶ˆæ¯æ•°æ®ï¼Œé€‰æ¥é€‰å–ï¼Œç›®å‰æœ€æ–¹ä¾¿çš„å°±æ˜¯kafkaäº†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹kafkaçš„ç‰¹æ€§ï¼š</p><ul><li>æŒä¹…åŒ–ï¼škafkaé»˜è®¤å°±æ”¯æŒå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œè¢«æ¶ˆè´¹çš„æ¶ˆæ¯ä¸ä¼šè¢«åˆ é™¤</li><li>å†å²æ•°æ®ï¼škafkaå¯ä»¥é€šè¿‡<code>log.retention.hours=720</code>æŒ‡å®šåªä¿å­˜30å¤©çš„æ•°æ®</li><li>å¸–å­é¡ºåºå‘é€ï¼škafkaçš„partitionæ˜¯æœ‰åºçš„</li><li>æ•ˆç‡ï¼škafkaçš„topicå¯ä»¥é€šè¿‡å¤šåˆ†åŒºæå‡æ•ˆç‡ï¼Œä¸ºåˆ†åŒºè®¾ç½®å‰¯æœ¬æå‡é«˜å¯ç”¨</li></ul><h3 id="å…·ä½“å®ç°"><a class="markdownIt-Anchor" href="#å…·ä½“å®ç°"></a> å…·ä½“å®ç°</h3><blockquote><p>Kafkaé…ç½®</p></blockquote><p>è®¾ç½®kafkaæŒä¹…åŒ–æ—¥å¿—è¿‡æœŸæ—¶é—´ï¼š<code>log.retention.hours=720</code></p><blockquote><p>Topicåˆ†åŒºæ•°é‡</p></blockquote><p>ä¾æ®å¸–å­å’Œè¯„è®ºçš„æ•°é‡ä¼°ç®—Topicçš„åˆ†åŒºæ•°é‡</p><blockquote><p>ä¼ªä»£ç </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line">  queryPostFromDB();</span><br><span class="line">  queryTopicPartitionSize();</span><br><span class="line">  calcPartitionForPostByPostId();</span><br><span class="line">  sendMessageToPartition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å…ˆä»DBä¸­æŸ¥è¯¢å¸–å­å’Œå¸–å­è¯„è®º</li><li>æŸ¥è¯¢topicåœ¨kafkaä¸­çš„åˆ†åŒºæ•°</li><li>æ ¹æ®å¸–å­IDå’Œåˆ†åŒºæ•°å–æ¨¡ï¼Œå°†å¸–å­å’Œè¯„è®ºå‡è¡¡åˆ†é…åˆ°å„ä¸ªåˆ†åŒºä¸­</li><li>å°†æ¶ˆæ¯å‘é€ç»™å¯¹åº”åˆ†åŒºï¼Œå¸–å­å’Œå¯¹åº”è¯„è®ºéœ€è¦å‘é€åˆ°åŒä¸€åˆ†åŒºï¼Œå¹¶ä¸”è¦æŒ‰ç…§æ—¶é—´å‘é€ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åŒä¸€ä¸ªå¸–å­çš„å‘é€é¡ºåº</li></ol><blockquote><p>æ¶ˆè´¹è€…</p></blockquote><p>æ¯ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æ¶ˆè´¹è€…éƒ½å½’å±äºå”¯ä¸€çš„æ¶ˆè´¹è€…ç»„ï¼Œä¸”å¿…é¡»ç»™æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½è®¾ç½®ä¸€ä¸ªæ¶ˆè´¹è€…ç»„</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;åœºæ™¯&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#åœºæ™¯&quot;&gt;&lt;/a&gt; åœºæ™¯&lt;/h3&gt;
&lt;p&gt;å‰æ®µæ—¶é—´é‡åˆ°ä¸€ä¸ªåœºæ™¯ï¼Œæœ‰ä¸€ä¸ªç”¨æˆ·ç¤¾åŒºæ¨¡å—ï¼Œç”¨æˆ·å¯ä»¥åœ¨ç¤¾åŒºçš„å¸–å­ä¸“åŒºå‘å¸ƒå¸–å­ï¼Œæˆ–è¯„è®ºå¸–å­ï¼Œå¸–å­å’Œè¯„è®ºä¿¡æ¯éœ€è¦ä¾æ®äº§ç”Ÿæ—¶é—´ä¾æ¬¡å‘é€ç»™ç¬¬ä¸‰æ–¹ï¼Œæ¶ˆæ¯å†…å®¹
      
    
    </summary>
    
    
      <category term="Kafka" scheme="http://luxiaowan.github.io/categories/Kafka/"/>
    
    
  </entry>
  
  <entry>
    <title>Kafkaåº”ç”¨åœºæ™¯</title>
    <link href="http://luxiaowan.github.io/2020/04/18/Kafka%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/"/>
    <id>http://luxiaowan.github.io/2020/04/18/Kafkaåº”ç”¨åœºæ™¯/</id>
    <published>2020-04-18T15:35:00.000Z</published>
    <updated>2020-04-19T11:34:27.904Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åº"><a class="markdownIt-Anchor" href="#åº"></a> åº</h3><p>åœ¨å­¦ä¹ ä¸€é—¨æ–°æŠ€æœ¯ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå»äº†è§£ä¸€ä¸‹è¿™é—¨æŠ€æœ¯çš„å…·ä½“åº”ç”¨åœºæ™¯ï¼Œä½¿ç”¨å®ƒèƒ½å¤Ÿåšä»€ä¹ˆï¼Œèƒ½å¤Ÿè¾¾åˆ°ä»€ä¹ˆç›®çš„ï¼Œå­¦ä¹ kafkaçš„åˆè¡·æ˜¯ç”¨ä½œæ¶ˆæ¯é˜Ÿåˆ—ï¼›ä½†æ˜¯è¿˜å¯ä»¥ä½¿ç”¨Kafka Streamè¿›è¡Œä¸€äº›å®æ—¶çš„æµè®¡ç®—ï¼Œå¤šç”¨äºå¤§æ•°æ®å¤„ç†ï¼›ä¹Ÿå¯ä»¥åšæ—¥å¿—æ”¶é›†æ±‡æ€»ã€ç½‘ç«™æ´»åŠ¨è·Ÿè¸ªç­‰ä»»åŠ¡ã€‚</p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—"></a> æ¶ˆæ¯é˜Ÿåˆ—</h3><p>kafkaå¯ä»¥å¾ˆå¥½çš„æ›¿ä»£ä¸€äº›ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿï¼Œkafkaå…·æœ‰æ›´å¥½çš„ååé‡ï¼Œå†…ç½®çš„åˆ†åŒºä½¿kafkaå…·æœ‰æ›´å¥½çš„å®¹é”™å’Œä¼¸ç¼©æ€§ï¼Œè¿™äº›ç‰¹æ€§ä½¿å®ƒå¯ä»¥æ›¿ä»£ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿï¼Œæˆä¸ºå¤§å‹æ¶ˆæ¯å¤„ç†åº”ç”¨çš„é¦–é€‰æ–¹æ¡ˆã€‚</p><blockquote><p>åœºæ™¯ï¼šå¼‚æ­¥ã€è§£è€¦ã€å‰Šå³°å¡«è°·</p><ol><li>ç”Ÿæˆè®¢å•ï¼šç»™ä¸åŒçš„äº§å“ä¸šåŠ¡çº¿åˆ†é…åŒä¸€ä¸ªtopicçš„ä¸åŒpartitionï¼Œç”¨æˆ·ä¸‹å•åæ ¹æ®è®¢å•ç±»å‹å‘é€åˆ°å¯¹åº”çš„partition</li><li>æ¶ˆæ¯é€šçŸ¥ï¼šç”¨æˆ·ç™»å½•åè®¡ç®—ç§¯åˆ†</li></ol></blockquote><ul><li><p>æ¶ˆæ¯ç”Ÿäº§è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  Properties prop = <span class="keyword">new</span> Properties();</span><br><span class="line">  prop.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"127.0.0.1:9092"</span>);</span><br><span class="line">  prop.put(<span class="string">"acks"</span>, <span class="string">"all"</span>);</span><br><span class="line">  prop.put(<span class="string">"retries"</span>, <span class="string">"0"</span>);</span><br><span class="line">  <span class="comment">// ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">  prop.put(<span class="string">"batch.size"</span>, <span class="string">"10"</span>);</span><br><span class="line">  prop.put(<span class="string">"key.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">  prop.put(<span class="string">"value.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">  KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(prop);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">101</span>; i++) &#123;</span><br><span class="line">    ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"my_topics"</span>, <span class="string">"value_"</span> + i);</span><br><span class="line">    <span class="comment">// é˜»å¡åˆ°æ¶ˆæ¯å‘é€å®Œæˆ</span></span><br><span class="line">    producer.send(record).get();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ·æ–°ç¼“å†²åŒºï¼Œå‘é€åˆ°åˆ†åŒºï¼Œå¹¶æ¸…ç©ºç¼“å†²åŒº</span></span><br><span class="line">  <span class="comment">// producer.flush();</span></span><br><span class="line">  <span class="comment">// å…³é—­ç”Ÿäº§è€…ï¼Œä¼šé˜»å¡åˆ°ç¼“å†²åŒºå†…çš„æ•°æ®å‘é€å®Œ</span></span><br><span class="line">  producer.close();</span><br><span class="line">  <span class="comment">// producer.close(Duration.ofMillis(1000));</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ˜¯å…ˆå°†æ¶ˆæ¯æ”¾åˆ°ç¼“å†²åŒºï¼Œå½“ç¼“å†²åŒºå­˜æ»¡ä¹‹åä¼šè‡ªåŠ¨flushï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨flush()æ–¹æ³•</p></li><li><p>æ¶ˆæ¯æ¶ˆè´¹è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">  properties.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"127.0.0.1:9092"</span>);</span><br><span class="line">  properties.put(<span class="string">"group.id"</span>, <span class="string">"cc_consumer"</span>);</span><br><span class="line">  properties.put(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">  properties.put(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">  KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(properties);</span><br><span class="line">  <span class="comment">// æŒ‡å®štopic</span></span><br><span class="line">  consumer.subscribe(Arrays.asList(<span class="string">"my_topics"</span>));</span><br><span class="line">  <span class="comment">// æŒ‡å®štopicçš„partition</span></span><br><span class="line">  <span class="comment">// TopicPartition partition0 = new TopicPartition("my_topics", 10);</span></span><br><span class="line">  <span class="comment">// consumer.assign(Arrays.asList(partition0));</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="number">1000</span>));</span><br><span class="line">      <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">        System.out.println(record.toString());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    consumer.close(Duration.ofMillis(<span class="number">2000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="æµè®¡ç®—"><a class="markdownIt-Anchor" href="#æµè®¡ç®—"></a> æµè®¡ç®—</h3><p>â€‹<em><font color="gray">[todo]</font></em></p><h3 id="æ—¥å¿—æ”¶é›†"><a class="markdownIt-Anchor" href="#æ—¥å¿—æ”¶é›†"></a> æ—¥å¿—æ”¶é›†</h3><p>åº”ç”¨ç¨‹åºçš„æ—¥å¿—å¯ä»¥é€šè¿‡log4jæ”¶é›†æ—¥å¿—ä¿¡æ¯ï¼Œå¹¶å°†æ—¥å¿—ç›´æ¥æ‰“åˆ°kafkaä¸­ï¼šå®¢æˆ·ç«¯â€”&gt;åº”ç”¨â€”&gt;kafka</p><p>SpringBootä¸­é»˜è®¤ä½¿ç”¨çš„æ˜¯logbackï¼Œæ‰€ä»¥è¦åœ¨å¼•å…¥SpringBootçš„jaråŒ…æ—¶æ’é™¤æ‰logbackçš„jaråŒ…</p><blockquote><p>æ—¥å¿—æ¶ˆæ¯å‘é€æœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ï¼Œç”±KafkaAppenderä¸­çš„<code>syncSend</code>å±æ€§å†³å®šï¼Œé»˜è®¤ä¸ºtrue(åŒæ­¥)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="tag">&lt;<span class="name">Kafka</span> <span class="attr">name</span>=<span class="string">"KAFKA-LOGGER"</span> <span class="attr">topic</span>=<span class="string">"cc_log_test"</span> <span class="attr">syncSend</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><ul><li>pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- springboot 1.3.xä¹‹å‰ç‰ˆæœ¬æ˜¯log4jï¼Œä¹‹åç‰ˆæœ¬éƒ½æ˜¯log4j2 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>log4j2.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"off"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %p %c&#123;1.&#125; %t %m%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--kafka topic--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Kafka</span> <span class="attr">name</span>=<span class="string">"KAFKA-LOGGER"</span> <span class="attr">topic</span>=<span class="string">"my_topics"</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--JsonLayoutï¼šæ—¥å¿—æ ¼å¼ä¸ºjson,æ–¹ä¾¿åœ¨ESä¸­å¤„ç†--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">JsonLayout</span>/&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--kafka serverçš„ip:port--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"bootstrap.servers"</span>&gt;</span>127.0.0.1:9092<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"retries"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"linger.ms"</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"buffer.memory"</span>&gt;</span>10485760<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Kafka</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Async</span> <span class="attr">name</span>=<span class="string">"ASYNC-KAFKA-LOGGER"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"KAFKA-LOGGER"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">LinkedTransferQueue</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Async</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--æ—¥å¿—çº§åˆ«å¤§äºinfoéƒ½ä¼šè¢«è®°å½•åˆ°Kafka--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">"cc.kevinlu.springbootkafka.controller.MessageController"</span> <span class="attr">level</span>=<span class="string">"info"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"KAFKA-LOGGER"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Rootè¡¨ç¤ºæ‰€æœ‰Loggerç”¨Rootä¸­çš„Appenderæ‰“å°æ—¥å¿—  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>code</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/log"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sendLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    log.info(<span class="string">"kafka log i = "</span> + i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>consumerè§†å›¾</li></ul><img src="/images/image-20200419032218971.png" alt="image-20200419032218971" style="zoom: 50%;"><h3 id="ç½‘ç«™æ´»åŠ¨è·Ÿè¸ª"><a class="markdownIt-Anchor" href="#ç½‘ç«™æ´»åŠ¨è·Ÿè¸ª"></a> ç½‘ç«™æ´»åŠ¨è·Ÿè¸ª</h3><ol><li><p>å‰ç«¯Nodejsæ§åˆ¶</p><p>Nodeæ¥å…¥kafkaéœ€è¦ä½¿ç”¨kafka-nodeåº“ï¼Œä¸‹é¢æ˜¯ç½‘ä¸Šçš„ä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> kafka = <span class="built_in">require</span>(<span class="string">'kafka-node'</span>),</span><br><span class="line">    Producer = kafka.Producer,</span><br><span class="line">    client = <span class="keyword">new</span> kafka.KafkaClient(&#123;<span class="attr">kafkaHost</span>: <span class="string">'localhost:9092'</span>&#125;);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šä¹‰ç”Ÿäº§ç±»</span></span><br><span class="line"><span class="comment"> * partitionerType å®šä¹‰</span></span><br><span class="line"><span class="comment"> * 0:é»˜è®¤æ¨¡å¼ åªäº§ç”Ÿæ•°æ®åœ¨ç¬¬ä¸€ä¸ªåˆ†åŒº</span></span><br><span class="line"><span class="comment"> * 1:éšæœºåˆ†é…ï¼Œåœ¨åˆ†åŒºä¸ªæ•°å†…ï¼Œéšæœºäº§ç”Ÿæ¶ˆæ¯åˆ°å„åˆ†åŒº</span></span><br><span class="line"><span class="comment"> * 2:å¾ªç¯åˆ†é…ï¼Œåœ¨åˆ†åŒºä¸ªæ•°å†…ï¼ŒæŒ‰é¡ºåºå¾ªç¯äº§ç”Ÿæ¶ˆæ¯åˆ°å„åˆ†åŒº</span></span><br><span class="line"><span class="comment">*/</span>   </span><br><span class="line"><span class="keyword">var</span> producerOption = &#123;</span><br><span class="line">    requireAcks: <span class="number">1</span>,</span><br><span class="line">    ackTimeoutMs: <span class="number">100</span>,</span><br><span class="line">    partitionerType: <span class="number">0</span> <span class="comment">//é»˜è®¤ä¸ºç¬¬ä¸€ä¸ªåˆ†åŒº</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> producer = <span class="keyword">new</span> Producer(client,producerOption);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TOPICçš„åˆ›å»ºéœ€è¦åœ¨å‘½ä»¤è¡Œè¿›è¡Œåˆ›å»ºï¼Œä»¥ä¾¿æŒ‡å®šåˆ†åŒºä¸ªæ•°ä»¥åŠå¤‡ä»½ä¸ªæ•°</span></span><br><span class="line"><span class="comment"> * PSï¼škafka-nodeçš„åˆ›å»ºtopicä¸è¡Œï¼Œä¸èƒ½åˆ›å»ºåˆ†åŒº</span></span><br><span class="line"><span class="comment"> * äº§ç”Ÿæ¶ˆæ¯,å¦‚æœä¸æŒ‡å®špartition</span></span><br><span class="line"><span class="comment"> * åˆ™æ ¹æ® partitionerType çš„å€¼æ¥æŒ‡å®šå‘é€æ•°æ®åˆ°å“ªä¸ªåˆ†åŒº</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬åˆ›å»ºçš„topic-test-oneåªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œæ‰€ä»¥åªèƒ½äº§ç”Ÿæ•°æ®åˆ°ç¬¬1ä¸ªåˆ†åŒºï¼ˆä¸‹æ ‡0ï¼‰ï¼Œå¦åˆ™ä¸ä¼šç”Ÿäº§æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPayloads</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        &#123;<span class="attr">topic</span>:<span class="string">"topic-test-one"</span>,<span class="attr">messages</span>:<span class="built_in">JSON</span>.stringify(&#123;<span class="string">"name"</span>:<span class="string">"jack"</span>,<span class="string">"age"</span>:<span class="string">"120"</span>&#125;),<span class="attr">partition</span>:<span class="number">0</span>&#125;</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">producer.on(<span class="string">"ready"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        producer.send(getPayloads(),<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"send message complete!data:"</span>+<span class="built_in">JSON</span>.stringify(data),<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">     &#125;,<span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">producer.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;<span class="built_in">console</span>.log(<span class="string">"send message error!\r\n"</span>+err);&#125;)</span><br></pre></td></tr></table></figure></li><li><p>åç«¯æ—¥å¿—æ§åˆ¶</p><p>åç«¯ä¹Ÿå¯ä»¥ä½¿ç”¨log4jçš„æ—¥å¿—ç³»ç»Ÿæ¥å®Œæˆï¼Œæ‹¦æˆªæ‰€æœ‰éœ€è¦ç›‘æ§çš„apiè¯·æ±‚ï¼Œä½¿ç”¨log4jè¾“å‡ºæ—¥å¿—åˆ°kafkaé˜Ÿåˆ—ä¸­ï¼Œå’Œä¸Šè¿°æ—¥å¿—æ”¶é›†æ–¹æ³•ç›¸åŒã€‚è‹¥åŒä¸€ä¸ªåº”ç”¨ä¸­éœ€è¦é€šè¿‡æ—¥å¿—è¾“å‡ºåˆ°kafkaçš„å¤šä¸ªtopicä¸­ï¼Œå¯ä»¥ä½¿ç”¨log4jçš„Markeræ ‡è®°æ¥åŒºåˆ†ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"off"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %p %c&#123;1.&#125; %t %m%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- æ—¥å¿—æ”¶é›† --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Kafka</span> <span class="attr">name</span>=<span class="string">"KAFKA-LOGGER"</span> <span class="attr">topic</span>=<span class="string">"cc_log_test"</span> <span class="attr">syncSend</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">JsonLayout</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"bootstrap.servers"</span>&gt;</span>127.0.0.1:9092<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"retries"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"linger.ms"</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"buffer.memory"</span>&gt;</span>10485760<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- é€šè¿‡Markerè¿‡æ»¤æ¶ˆæ¯ --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">MarkerFilter</span> <span class="attr">marker</span>=<span class="string">"Kafka"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Kafka</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- è½¨è¿¹è·Ÿè¸ª --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Kafka</span> <span class="attr">name</span>=<span class="string">"KAFKA-TRACK-LOGGER"</span> <span class="attr">topic</span>=<span class="string">"cc_test1"</span> <span class="attr">syncSend</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">JsonLayout</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"bootstrap.servers"</span>&gt;</span>127.0.0.1:9092<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"retries"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"linger.ms"</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">"buffer.memory"</span>&gt;</span>10485760<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- é€šè¿‡Markerè¿‡æ»¤æ¶ˆæ¯ --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">MarkerFilter</span> <span class="attr">marker</span>=<span class="string">"Track"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Kafka</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Async</span> <span class="attr">name</span>=<span class="string">"ASYNC-KAFKA-LOGGER"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"KAFKA-LOGGER"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"KAFKA-TRACK-LOGGER"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">LinkedTransferQueue</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Async</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">"cc.kevinlu.springbootkafka.controller"</span> <span class="attr">level</span>=<span class="string">"info"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"KAFKA-LOGGER"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"KAFKA-TRACK-LOGGER"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Marker KAFKA_MARKER       = MarkerManager.getMarker(<span class="string">"Kafka"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Marker KAFKA_TRACK_MARKER = MarkerManager.getMarker(<span class="string">"Track"</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/log"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sendLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è½¨è¿¹è·Ÿè¸ª</span></span><br><span class="line">  log.info(KAFKA_TRACK_MARKER, <span class="string">"send async message!"</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// æ—¥å¿—æ”¶é›†</span></span><br><span class="line">    log.info(KAFKA_MARKER, <span class="string">"kafka log i = &#123;&#125;"</span>, i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å‰ç«¯+åç«¯ç»„åˆ</p><p>åç«¯æä¾›APIä¾›å‰ç«¯ä¼ é€’è½¨è¿¹ï¼Œåç«¯æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åå°†æ¶ˆæ¯åŒæ­¥åˆ°kafkaä¸­ã€‚</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;åº&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#åº&quot;&gt;&lt;/a&gt; åº&lt;/h3&gt;
&lt;p&gt;åœ¨å­¦ä¹ ä¸€é—¨æ–°æŠ€æœ¯ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå»äº†è§£ä¸€ä¸‹è¿™é—¨æŠ€æœ¯çš„å…·ä½“åº”ç”¨åœºæ™¯ï¼Œä½¿ç”¨å®ƒèƒ½å¤Ÿåšä»€ä¹ˆï¼Œèƒ½å¤Ÿè¾¾åˆ°ä»€ä¹ˆç›®çš„ï¼Œå­¦ä¹ kafkaçš„åˆè¡·æ˜¯ç”¨ä½œæ¶ˆæ¯é˜Ÿåˆ—ï¼›ä½†æ˜¯è¿˜å¯ä»¥ä½¿
      
    
    </summary>
    
    
      <category term="Kafka" scheme="http://luxiaowan.github.io/categories/Kafka/"/>
    
    
  </entry>
  
  <entry>
    <title>Kafkaæ¶ˆè´¹è€…</title>
    <link href="http://luxiaowan.github.io/2020/04/17/Kafka%E6%B6%88%E8%B4%B9%E8%80%85/"/>
    <id>http://luxiaowan.github.io/2020/04/17/Kafkaæ¶ˆè´¹è€…/</id>
    <published>2020-04-17T06:46:00.000Z</published>
    <updated>2020-04-17T14:40:13.306Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç®€"><a class="markdownIt-Anchor" href="#ç®€"></a> ç®€</h3><p>æ¶ˆæ¯ç”±ç”Ÿäº§è€…äº§å‡ºï¼Œäº§å‡ºåpushåˆ°partitionä¸­ï¼Œä½†æ˜¯æ—¢ç„¶æœ‰ç”Ÿäº§äº†ï¼Œé‚£è‚¯å®šå°±è¦æœ‰æ¶ˆè´¹ï¼Œä¸ç„¶æˆ‘ä»¬ç”Ÿäº§å‡ºæ¥çš„æ¶ˆæ¯å²‚ä¸æˆäº†åƒåœ¾æ•°æ®ï¼Œæ‰€ä»¥åœ¨kafkaä¸­æœ‰ä¸€ä¸ªä¸ç”Ÿäº§è€…å¯¹åº”çš„ç©æ„å„¿ï¼šæ¶ˆè´¹è€…ã€‚ç”Ÿäº§è€…æ˜¯å¾€partitionä¸­pushæ•°æ®ï¼Œè€Œæ¶ˆè´¹è€…æ˜¯ä»partitionä¸­pullæ¶ˆæ¯ï¼Œæœ‰äº›MQä¸­æ˜¯ç”±æœåŠ¡ç«¯pushæ¶ˆæ¯ç»™æ¶ˆè´¹è€…ï¼Œå¹¶ä¸”æ˜¯é˜…åå³ç„šçš„æ¨¡å¼ï¼Œä½†æ˜¯kafkaæ˜¯æ”¯æŒå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œå¹¶ä¸”å¹¶ä¸ä¼šå› ä¸ºæ¶ˆæ¯è¢«æ¶ˆè´¹äº†è€Œåˆ é™¤ï¼Œæ¯ä¸€ä¸ªæ¶ˆè´¹è€…éƒ½å¯ä»¥è‡ªç”±çš„æ¶ˆè´¹partitionä¸­çš„å†å²æ¶ˆæ¯ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªæ–°åŠ å…¥çš„Consumerï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šoffsetå°†partitionä¸­æ‰€æœ‰çš„å†å²æ¶ˆæ¯éƒ½ä»å¤´æ¶ˆè´¹ä¸€æ¬¡ï¼Œè€ŒæœåŠ¡ç«¯åªè´Ÿè´£ä¸ºæ¶ˆæ¯è®¾å®šoffsetï¼ŒConsumerä»å“ªä¸€æ¡æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹å®Œå…¨ç”±è‡ªå·±å†³å®šï¼Œæ¯ä¸€ä¸ªConsumeréƒ½ä¼šåœ¨æœ¬åœ°ç»´æŠ¤è‡ªå·±çš„offsetï¼ŒConsumerä¹‹é—´çš„offsetäº’ä¸å¹²æ‰°ã€‚</p><p>æ¯ä¸€ä¸ªæ¶ˆè´¹è€…éƒ½å½’å±äºä¸€ä¸ªæ¶ˆè´¹è€…ç¾¤ç»„ï¼Œä¸€ä¸ªpartitionåªèƒ½è¢«åŒä¸€ä¸ªæ¶ˆè´¹è€…ç¾¤ç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹æ¶ˆè´¹ï¼Œä½†å¯ä»¥è¢«ä¸åŒæ¶ˆè´¹è€…ç¾¤ç»„åŒæ—¶æ¶ˆè´¹ï¼Œæ¯ä¸ªç¾¤ç»„å†…çš„æ‰€æœ‰æ¶ˆè´¹è€…è®¢é˜…çš„éƒ½æ˜¯åŒä¸€ä¸ªtopicï¼Œæ¯ä¸ªæ¶ˆè´¹è€…æ¥æ”¶ä¸€ä¸ªtopicä¸­ä¸€éƒ¨åˆ†partitionçš„æ¶ˆæ¯ï¼Œè‹¥æ¶ˆè´¹è€…æ•°é‡å¤šäºpartitionçš„æ•°é‡ï¼Œåˆ™ä¼šå‡ºç°é—²ç½®çš„æ¶ˆè´¹è€…ï¼Œè€Œè‹¥æ¶ˆè´¹è€…æ•°é‡å°äºpartitionçš„æ•°é‡ï¼Œåˆ™ä¼šå‡ºç°æŸä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹å¤šä¸ªpartitionä¸­çš„æ•°æ®ã€‚</p><h3 id="æ¶ˆè´¹è€…ç¾¤ç»„consumer-group"><a class="markdownIt-Anchor" href="#æ¶ˆè´¹è€…ç¾¤ç»„consumer-group"></a> æ¶ˆè´¹è€…ç¾¤ç»„(Consumer Group)</h3><p>æ¶ˆè´¹è€…ç¾¤ç»„æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹ç»„æˆçš„ç¾¤ç»„ï¼Œå…·æœ‰å¯æ‰©å±•æ€§å’Œå®¹é”™æ€§ã€‚æ¯ä¸€ä¸ªæ¶ˆè´¹è€…ç¾¤ç»„éƒ½æ‹¥æœ‰å…¨å±€å”¯ä¸€çš„group_idï¼Œç¾¤ç»„å†…çš„æ‰€æœ‰çš„æ¶ˆè´¹è€…å®ä¾‹å…±äº«è¿™ä¸ªgroup_idï¼Œç¾¤ç»„å†…çš„æ‰€æœ‰æ¶ˆè´¹è€…è®¢é˜…åŒä¸€ä¸ªtopicï¼Œç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹åªèƒ½æ¶ˆè´¹topicä¸­çš„ä¸€ä¸ªPartitionçš„æ¶ˆæ¯ã€‚</p><p>æ¶ˆè´¹ç±»å‹ï¼š</p><ol><li>ç‚¹å¯¹ç‚¹ï¼šä¸€ä¸ªtopicå¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…ç¾¤ç»„</li><li>å¹¿æ’­ï¼ˆå‘å¸ƒ-è®¢é˜…ï¼‰ï¼šä¸€ä¸ªtopicå¯¹åº”å¤šä¸ªæ¶ˆè´¹è€…ç¾¤ç»„</li></ol><h3 id="æ¶ˆè´¹è€…å’Œåˆ†åŒº"><a class="markdownIt-Anchor" href="#æ¶ˆè´¹è€…å’Œåˆ†åŒº"></a> æ¶ˆè´¹è€…å’Œåˆ†åŒº</h3><ol><li><p>Consumeræ•°é‡ &lt; Partitionæ•°é‡</p><p>å½“Partitionçš„æ•°é‡å¤šäºConsumerçš„æ—¶å€™ï¼Œä¸€ä¸ªConsumerä¼šæ¶ˆè´¹æ¥è‡ªå¤šä¸ªPartitionçš„æ¶ˆæ¯ï¼Œæ­¤ç§æƒ…å½¢ä¸‹ä¼šåŠ å¤§Consumerçš„å‹åŠ›ï¼Œå•Consumerå®ä¾‹çš„ååé‡å†³å®šäº†æ¶ˆæ¯æ¶ˆè´¹çš„æ•ˆç‡ï¼Œå½“æ¶ˆæ¯äº•å–·çš„æ—¶å€™ï¼Œä¼šé€ æˆå¤§å¤šæ•°æ¶ˆæ¯éƒ½ç§¯å‹åœ¨Partitionä¸­ï¼Œä¸¥é‡çš„æ—¶å€™ä¼šå½±å“æœåŠ¡æ€§èƒ½ã€‚è‹¥æƒ³æå‡æ¶ˆæ¯æ¶ˆè´¹æ•ˆç‡ï¼Œå¯ä»¥é€šè¿‡å¢åŠ Consumerå®ä¾‹è§£å†³ã€‚</p><img src="/images/image-20200417151054543.png" alt="image-20200417151054543" style="zoom:50%;"></li><li><p>Consumeræ•°é‡ = Partitionæ•°é‡</p><p>å½“Partitionå’ŒConsumeræ•°é‡ç›¸ç­‰çš„æ—¶å€™å±äºæ˜¯æœ€å¹³è¡¡çš„çŠ¶æ€ï¼Œä¸€ä¸ªPartitionå¯¹åº”ä¸€ä¸ªConsumerï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹æ•ˆç‡å®Œå…¨å–å†³äºConsumerå®ä¾‹çš„ååé‡</p><img src="/images/image-20200417151007055.png" alt="image-20200417151007055" style="zoom:50%;"></li><li><p>Consumeræ•°é‡ &gt; Partitionæ•°é‡</p><p>å› ä¸ºä¸€ä¸ªPartitionåªèƒ½è¢«åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…çš„ä¸€ä¸ªConsumerå®ä¾‹æ¶ˆè´¹ï¼Œæ‰€ä»¥å½“Consumerçš„æ•°é‡å¤§äºPartitionçš„æ•°é‡æ—¶ï¼Œå°†ä¼šæœ‰å¤šä¸ªConsumerå®ä¾‹ç©ºé—²ç€ï¼Œæ— æ¶ˆæ¯å¯æ¶ˆè´¹ã€‚æ¯”å¦‚ä¸‹å›¾ä¸­ï¼ŒTopic0æœ‰4ä¸ªPartitionï¼Œè€ŒConsumer Groupä¸­æœ‰5ä¸ªæ¶ˆè´¹è€…å®ä¾‹ï¼Œç”±æ¶ˆè´¹å…³ç³»æ¥çœ‹ï¼ŒConsumer4è¿™ä¸ªå®ä¾‹ä¼šä¸€ç›´ç©ºé—²ç€ã€‚</p><img src="/images/image-20200417150940246.png" alt="image-20200417150940246" style="zoom: 50%;"></li><li><p>å¤šå…ƒåŒ–æ¶ˆè´¹æ¶ˆæ¯</p><p>ä¸€ä¸ªPartitionåªèƒ½è¢«åŒä¸€ä¸ªæ¶ˆè´¹è€…ç¾¤ç»„å†…çš„ä¸€ä¸ªConsumerå®ä¾‹æ¶ˆè´¹ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…ç”Ÿäº§ä¸­å¯èƒ½ä¼šé‡åˆ°éœ€è¦å°†ä¸€æ¡æ¶ˆæ¯å‘é€ç»™å¤šç«¯çš„æƒ…å†µï¼Œæ¯”å¦‚è®¢å•ç”Ÿæˆä½£é‡‘çš„æ—¶å€™ï¼Œä¸åŒçš„é¡¹ç›®ç»„éƒ½æœ‰å„è‡ªçš„ä½£é‡‘ç­–ç•¥ï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç»™æ¯ä¸€ä¸ªé¡¹ç›®ç»„åˆ†é…ä¸€ä¸ªgroupçš„å½¢å¼è®©æ‰€æœ‰çš„é¡¹ç›®ç»„å…±äº«æ¶ˆæ¯</p><img src="/images/image-20200417165151251.png" alt="image-20200417165151251" style="zoom:50%;"></li></ol><h3 id="æ¶ˆè´¹è€…é‡å¹³è¡¡rebalance"><a class="markdownIt-Anchor" href="#æ¶ˆè´¹è€…é‡å¹³è¡¡rebalance"></a> æ¶ˆè´¹è€…é‡å¹³è¡¡(ReBalance)</h3><p>å½“æ¶ˆè´¹è€…ç¾¤ç»„å†…çš„æ¶ˆè´¹è€…å®ä¾‹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹æƒ…å†µä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿç”¨æˆ·ç¾¤ç»„åˆå§‹æœ‰ä¸¤ä¸ªConsumerå®ä¾‹ï¼Œæ¯ä¸€ä¸ªéƒ½è¦è´Ÿè´£æ¶ˆè´¹ä¸¤ä¸ªPartitionçš„æ¶ˆæ¯ï¼Œç„¶åç¾¤ç»„å†…æ–°å¢äº†ä¸¤ä¸ªConsumerå®ä¾‹ï¼Œè¿™æ ·Consumerå’ŒPartitionçš„æ•°é‡ä¸€è‡´äº†ï¼Œæ–°å¢åŠ çš„æ¶ˆè´¹è€…ä¼šå‡è¡¡çš„æ›¿åŸæœ‰æ¶ˆè´¹è€…åˆ†æ‘Šå¤„ç†Partitionçš„æ¶ˆæ¯ï¼Œæœ€ç»ˆè¾¾åˆ°ä¸€å¯¹ä¸€çš„å¹³è¡¡çŠ¶æ€ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«ä½œReBalanceã€‚</p><p><img src="/images/image-20200417172313104.png" alt="image-20200417172313104"></p><p>kafkaé€šè¿‡æ¶ˆè´¹è€…ç¾¤ç»„çš„ReBalanceå®ç°é«˜å¯ç”¨å’Œä¼¸ç¼©æ€§ï¼Œåœ¨ç¾¤ç»„åšReBalanceæœŸé—´ï¼Œæ•´ä¸ªç¾¤ç»„çš„æ¶ˆè´¹è€…éƒ½æ— æ³•æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ä¼šé¢„å…ˆä¼°ç®—å¥½æ¶ˆè´¹è€…ç¾¤ç»„å†…çš„æ¶ˆè´¹è€…æ•°é‡ï¼Œä¼°ç®—çš„ä¾æ®æ˜¯æ¶ˆæ¯é‡å’Œtopicä¸‹çš„Partitionæ•°ã€‚ä¸”å½“ä¸€ä¸ªPartitioné‡æ–°åˆ†é…ç»™å¦ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹æ—¶ï¼Œä¼šé€ æˆå½“å‰æ­£åœ¨æ¶ˆè´¹çš„æ¶ˆæ¯çŠ¶æ€ä¸¢å¤±ã€‚</p><p>æ¶ˆè´¹è€…ç¾¤ç»„å†…çš„æ¶ˆè´¹è€…å®ä¾‹éœ€è¦å®šæœŸå‘brokerå‘é€å¿ƒè·³æ¥ç»´æŠ¤è‡ªå·±åœ¨ç¾¤ç»„å†…çš„åœ°ä½ï¼Œæ¯”å¦‚æ¶ˆè´¹è€…è¿›è¡Œpollå’Œcommitçš„åŒæ—¶ï¼Œä¼šå‘é€ä¸€æ¬¡å¿ƒè·³ã€‚å¦‚æœbrokeré•¿æ—¶é—´æœªæ¥æ”¶åˆ°æ¥è‡ªConsumerçš„å¿ƒè·³è¯·æ±‚ï¼Œåˆ™è®¤ä¸ºè¯¥Consumerå®ä¾‹å·²å®•æœºï¼Œè‡ªåŠ¨å°†å…¶ä»ç¾¤ç»„ä¸­ç§»é™¤ï¼Œå¹¶åšä¸€æ¬¡ReBalanceï¼ŒConsumerä¹‹å‰å¯¹åº”çš„Partitionçš„æ¶ˆæ¯ä¼šæš‚æ—¶ä¸å†è¢«æ¶ˆè´¹ã€‚</p><h3 id="åç§»é‡"><a class="markdownIt-Anchor" href="#åç§»é‡"></a> åç§»é‡</h3><p>åç§»é‡å¯ä»¥åˆ†ä¸ºç”Ÿäº§è€…åç§»é‡å’Œæ¶ˆè´¹è€…åç§»é‡ï¼Œç”Ÿäº§è€…åç§»é‡å®é™…ä¸Šå°±æ˜¯æ¯ä¸€ä¸ªPartitionçš„åç§»é‡ï¼ŒPartitionä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºPartitionä¸­çš„æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¸€ä¸ªoffsetå±æ€§ï¼Œæ¯ä¸€ä¸ªProduceré’ˆå¯¹topic-Partitionéƒ½åœ¨è‡ªèº«ç»´æŠ¤ä¸€ä¸ªoffsetï¼›åŒæ—¶ä¹Ÿå¯ä»¥ç†è§£ä¸ºç”Ÿäº§è€…åç§»é‡åªæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„offsetï¼Œå®é™…ä¸Šå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„sizeã€‚æ¶ˆè´¹è€…åç§»é‡æ˜¯åˆ‡åˆ‡å®å®å’Œæ¶ˆè´¹è€…ç›¸å…³çš„ä¸€ä¸ªæœ€é‡è¦çš„å…ƒç´ ï¼Œä½¿ç”¨åç§»é‡ï¼ŒConsumeræ‰èƒ½çŸ¥é“è¦ä»å“ªæ¡æ¶ˆæ¯å¼€å§‹è¯»å–ï¼Œåç§»é‡ä¸»è¦å’Œtopicçš„Partitionç›¸å…³ï¼Œå°¤å…¶æ˜¯åœ¨æ¶ˆè´¹è€…ç¾¤ç»„å‘ç”ŸReBalanceçš„æ—¶å€™ï¼Œè°ƒæ•´åçš„Consumerä»æ–°çš„Partitionæ¥æ”¶æ¶ˆæ¯ä¹‹å‰éœ€è¦çŸ¥é“è¿™ä¸ªPartitionæœ‰å¤šå°‘æ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹äº†ï¼Œå½“å‰çš„æ¶ˆè´¹è€…è¦ä»å“ªä¸€æ¡æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼Œå¦åˆ™å°±ä¼šå‡ºç°é‡å¤æ¶ˆè´¹æˆ–è€…é—æ¼æ¶ˆæ¯çš„æƒ…å†µã€‚</p><p>kafkaä¸­é»˜è®¤ä¸€ä¸ªtopicï¼š<code>__consumer_offsets</code>ï¼Œæ¶ˆè´¹è€…æ¯æ¶ˆè´¹ä¸€æ¬¡å°±ä¼šåƒè¯¥topicå‘é€ä¸€æ¬¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­åŒ…å«æ¯ä¸€ä¸ªTopic-Partitionçš„offsetï¼Œåœ¨å‘ç”ŸReBalanceä¹‹åï¼Œæ¶ˆè´¹è€…å¼€å§‹è´Ÿè´£å¦å¤–ä¸€ä¸ªPartitionçš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå‘<code>__consumer_offsets</code>è·å–è¯¥Partitionæœ€åä¸€æ¬¡è¢«æ¶ˆè´¹çš„åç§»é‡ï¼Œç„¶åä»è¯¥åç§»é‡å¼€å§‹ç»§ç»­æ¶ˆè´¹æ•°æ®ã€‚</p><p>é€šè¿‡topicã€partitionã€offsetä¸‰ä¸ªå…ƒç´ å¯ä»¥å®šä½ä¸€æ¡æ¶ˆæ¯ã€‚</p><p>æ¶ˆè´¹è€…åœ¨è·å–ä¸€æ‰¹æ¶ˆæ¯ä¹‹åï¼Œéœ€è¦å°†æœ€åä¸€æ¡æ¶ˆæ¯çš„åç§»é‡æäº¤ç»™æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯å°†åç§»é‡commitç»™topic<code>__consumer_offsets</code>ï¼Œæäº¤æ–¹å¼æœ‰è‡ªåŠ¨æäº¤å’Œæ‰‹åŠ¨æäº¤ä¸¤ç§ï¼Œé€šè¿‡å‚æ•°<code>enable.auto.commit</code>æ¥æ§åˆ¶ï¼Œé»˜è®¤å€¼ä¸ºtrueï¼Œä¹Ÿå°±æ˜¯é»˜è®¤è‡ªåŠ¨æäº¤ï¼›è€Œå°†å‚æ•°å€¼æ”¹ä¸ºfalseï¼Œå°±æ˜¯æ‰‹åŠ¨æäº¤ã€‚</p><ul><li>è‡ªåŠ¨æäº¤<ol><li><code>enable.auto.commit=true</code>ï¼Œè®¾ç½®ä¸ºè‡ªåŠ¨æäº¤</li><li><code>auto.commit.interval.ms=3000</code>ï¼Œè®¾ç½®è‡ªåŠ¨æäº¤æ—¶é—´é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ï¼Œé»˜è®¤5ç§’</li></ol></li><li>æ‰‹åŠ¨æäº¤<ol><li><code>enable.auto.commit=false</code>ï¼Œè®¾ç½®ä¸ºæ‰‹åŠ¨æäº¤</li><li>åŒæ­¥æäº¤ï¼š<code>consumer.commitSync()</code></li><li>å¼‚æ­¥æäº¤ï¼š<code>consumer.commitAsync()</code></li></ol></li></ul><h3 id="é…ç½®"><a class="markdownIt-Anchor" href="#é…ç½®"></a> é…ç½®</h3><ul><li><code>fetch.min.bytes</code>ï¼šæŒ‡å®šæ¶ˆè´¹è€…æ¯æ¬¡è·å–è®°å½•çš„æœ€å°å­—èŠ‚æ•°ï¼Œé»˜è®¤ä¸º1å­—èŠ‚ï¼Œè‹¥æœ¬æ¬¡pollæ—¶æ•°æ®é‡å¤§å°ä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™ä¼šç­‰åˆ°æœ‰è¶³å¤Ÿçš„æ•°æ®æ—¶å†æ‹‰å–ã€‚å½“æ¶ˆæ¯ä¸ç”¨éå¸¸å®æ—¶çš„æ—¶å€™ï¼Œå¯ä»¥å°†æ¶ˆè´¹è€…çš„æ­¤å€¼è®¾ç½®ç•¥å¤§ä¸€äº›ï¼Œä»¥æ­¤é™ä½æ¶ˆè´¹è€…å’Œbrokerçš„å·¥ä½œè´Ÿè½½ã€‚</li><li><code>fetch.max.bytes</code>ï¼šæŒ‡å®šæ¶ˆè´¹è€…æ¯æ¬¡è·å–è®°å½•çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œé»˜è®¤ä¸º50M</li><li><code>max.partition.fetch.bytes</code>ï¼šæŒ‡å®šæ¯ä¸ªåˆ†åŒºæ¯æ¬¡æ‹‰å–æ¶ˆæ¯çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œé»˜è®¤ä¸º1M</li><li><code>auto.offset.reset</code>ï¼šæŒ‡å®šæ¶ˆè´¹è€…åœ¨è¯»å–ä¸€ä¸ªæ²¡æœ‰åç§»é‡çš„åˆ†åŒºæˆ–è€…åç§»é‡æ— æ•ˆçš„æƒ…å†µä¸‹çš„å¤„ç†æ–¹å¼ï¼Œé»˜è®¤å€¼æ˜¯latestï¼Œä¹Ÿå°±æ˜¯ä»æœ€æ–°çš„è®°å½•å¼€å§‹è¯»å–ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸ºearliestï¼Œè®©æ¶ˆè´¹è€…ä»ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¯»å–</li><li><code>enable.auto.commit</code>ï¼šè®¾ç½®æ¶ˆè´¹è€…æ˜¯å¦è‡ªåŠ¨æäº¤åç§»é‡ï¼Œé»˜è®¤ä¸ºtrue</li><li><code>heartbeat.interval.ms</code>ï¼šæ¶ˆè´¹è€…æ¯æ¬¡å¿ƒè·³é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ï¼Œé»˜è®¤ä¸º3s</li><li><code>bootstrap.servers</code>ï¼šæŒ‡å®šæ¶ˆè´¹è€…è¿æ¥çš„kafkaé›†ç¾¤åœ°å€ï¼Œé€šè¿‡é€—å·åˆ†éš”ï¼Œæ ¼å¼ï¼š<code>host1:port1,host2:port2,...</code></li><li><code>group.id</code>ï¼šæ¶ˆè´¹è€…æ‰€å±ç¾¤ç»„idï¼Œé»˜è®¤ä¸ºé»˜è®¤åˆ†ç»„</li><li><code>key.deserializer</code>ï¼škeyååºåˆ—åŒ–æ–¹å¼</li><li><code>value.deserializer</code>ï¼švalueååºåˆ—åŒ–æ–¹å¼</li></ul><h3 id="æ¡ˆä¾‹"><a class="markdownIt-Anchor" href="#æ¡ˆä¾‹"></a> æ¡ˆä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">  <span class="comment">// kafkaé›†ç¾¤åœ°å€</span></span><br><span class="line">  properties.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"127.0.0.1:9092"</span>);</span><br><span class="line">  <span class="comment">// æ¶ˆè´¹è€…ç¾¤ç»„id</span></span><br><span class="line">  properties.put(<span class="string">"group.id"</span>, <span class="string">"cc_consumer"</span>);</span><br><span class="line">  <span class="comment">// keyååºåˆ—åŒ–</span></span><br><span class="line">  properties.put(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">  <span class="comment">// valueååºåˆ—åŒ–</span></span><br><span class="line">  properties.put(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">  <span class="comment">// åˆ›å»ºæ¶ˆè´¹è€…</span></span><br><span class="line">  KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(properties);</span><br><span class="line">  <span class="comment">// æŒ‡å®šæ¶ˆè´¹è€…ç›‘å¬çš„topic</span></span><br><span class="line">  consumer.subscribe(Arrays.asList(<span class="string">"my_topics"</span>));</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="comment">// æ‹‰å–topic</span></span><br><span class="line">      ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="number">1000</span>));</span><br><span class="line">      <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">        System.out.println(record.toString());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    consumer.close(Duration.ofMillis(<span class="number">2000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ç®€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç®€&quot;&gt;&lt;/a&gt; ç®€&lt;/h3&gt;
&lt;p&gt;æ¶ˆæ¯ç”±ç”Ÿäº§è€…äº§å‡ºï¼Œäº§å‡ºåpushåˆ°partitionä¸­ï¼Œä½†æ˜¯æ—¢ç„¶æœ‰ç”Ÿäº§äº†ï¼Œé‚£è‚¯å®šå°±è¦æœ‰æ¶ˆè´¹ï¼Œä¸ç„¶æˆ‘ä»¬ç”Ÿäº§å‡ºæ¥çš„æ¶ˆæ¯å²‚ä¸æˆäº†åƒåœ¾æ•°æ®ï¼Œæ‰€ä»¥åœ¨kafkaä¸­
      
    
    </summary>
    
    
      <category term="Kafka" scheme="http://luxiaowan.github.io/categories/Kafka/"/>
    
    
  </entry>
  
  <entry>
    <title>Kafkaç”Ÿäº§è€…</title>
    <link href="http://luxiaowan.github.io/2020/04/17/Kafka%E7%94%9F%E4%BA%A7%E8%80%85/"/>
    <id>http://luxiaowan.github.io/2020/04/17/Kafkaç”Ÿäº§è€…/</id>
    <published>2020-04-16T16:46:00.000Z</published>
    <updated>2020-04-17T05:06:52.429Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç®€"><a class="markdownIt-Anchor" href="#ç®€"></a> ç®€</h3><p>åœ¨kafkaä¸­æŠŠäº§ç”Ÿæ¶ˆæ¯çš„ä¸€æ–¹ç§°ä¸ºç”Ÿäº§è€…ï¼ˆProducerï¼‰ï¼Œå°½ç®¡æ¶ˆæ¯çš„äº§ç”Ÿéå¸¸ç®€å•ï¼Œä½†æ˜¯æ¶ˆæ¯çš„å‘é€è¿‡ç¨‹æ¯”è¾ƒå¤æ‚</p><p><img src="/images/kafka-p-send.png" alt="img"></p><p>å‘é€æ¶ˆæ¯ä»åˆ›å»ºä¸€ä¸ªProducerRecordå¯¹è±¡å¼€å§‹ï¼Œæ­¤ç±»æ˜¯kafkaä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç±»ï¼Œè¡¨ç¤ºkafkaéœ€è¦å‘é€çš„K-Vé”®å€¼å¯¹ï¼Œè®°å½•äº†è¦å‘é€çš„topicã€partitionã€keyã€valueã€timestampç­‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerRecord</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer partition;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Headers headers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> V value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long timestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‘é€ProducerRecordçš„æ—¶å€™éœ€è¦å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œä¾¿äºåœ¨ç½‘ç»œä¸Šä¼ è¾“ï¼Œä¹‹åæ¶ˆæ¯è¾¾åˆ°åˆ†åŒºå™¨ï¼Œè‹¥å‘é€è¿‡ç¨‹ä¸­æŒ‡å®šäº†åˆ†åŒºå·ï¼Œä¹Ÿå°±æ˜¯partitionï¼Œåˆ™åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™å°†ä½¿ç”¨æŒ‡å®šçš„åˆ†åŒºï¼Œè‹¥å‘é€è¿‡ç¨‹ä¸­æœªåˆ¶å®šåˆ†åŒºï¼Œåˆ™æ ¹æ®topicå’Œclusterä¸­çš„partitionæ•°é‡é¡ºåºé€‰æ‹©ä¸€ä¸ªåˆ†åŒºè¿›è¡Œå‘é€ï¼Œåˆ†åŒºé€‰æ‹©å™¨ç”±æ¥æ¥å£<code>org.apache.kafka.clients.producer.Partitioner</code>çš„å®ç°ç±»æŒ‡å®šã€‚</p><blockquote><p>org.apache.kafka.clients.producer.KafkaProducer</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(ProducerRecord&lt;K, V&gt; record, <span class="keyword">byte</span>[] serializedKey, <span class="keyword">byte</span>[] serializedValue, Cluster cluster)</span> </span>&#123;</span><br><span class="line">  Integer partition = record.partition();</span><br><span class="line">  <span class="keyword">return</span> partition != <span class="keyword">null</span> ?</span><br><span class="line">    partition :</span><br><span class="line">  partitioner.partition(</span><br><span class="line">    record.topic(), record.key(), serializedKey, record.value(), serializedValue, cluster);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>org.apache.kafka.clients.producer.internals.DefaultPartitioner</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€‰å–åˆ†åŒº</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">  List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line">  <span class="keyword">int</span> numPartitions = partitions.size();</span><br><span class="line">  <span class="keyword">if</span> (keyBytes == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// é¡ºåºindex</span></span><br><span class="line">    <span class="keyword">int</span> nextValue = nextValue(topic);</span><br><span class="line">    List&lt;PartitionInfo&gt; availablePartitions = cluster.availablePartitionsForTopic(topic);</span><br><span class="line">    <span class="keyword">if</span> (availablePartitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// å–æ¨¡</span></span><br><span class="line">      <span class="keyword">int</span> part = Utils.toPositive(nextValue) % availablePartitions.size();</span><br><span class="line">      <span class="keyword">return</span> availablePartitions.get(part).partition();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// no partitions are available, give a non-available partition</span></span><br><span class="line">      <span class="keyword">return</span> Utils.toPositive(nextValue) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// hash the keyBytes to choose a partition</span></span><br><span class="line">    <span class="keyword">return</span> Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProducerRecordå†…å…³è”çš„æ—¶é—´æˆ³timestampï¼Œå¦‚æœç”¨æˆ·æœªæŒ‡å®šï¼Œåˆ™ä½¿ç”¨KafkaProducerå†…çš„timeçš„æ—¶é—´ä½œä¸ºæ—¶é—´æˆ³ï¼Œä½†æ˜¯kafkaæœ€ç»ˆä½¿ç”¨çš„æ—¶é—´æˆ³å–å†³äºtopicé…ç½®çš„æ—¶é—´æˆ³ç±»å‹ï¼š</p><ul><li>topicä¸ºCreateTimeï¼Œåˆ™æ¶ˆæ¯è®°å½•ä¸­çš„æ—¶é—´æˆ³ç”±brokerä½¿ç”¨</li><li>topicä¸ºLogAppendTimeï¼Œåˆ™æ¶ˆæ¯è®°å½•ä¸­çš„æ—¶é—´æˆ³ä¼šåœ¨è¿½åŠ åˆ°æ—¥å¿—ä¸­æ—¶ç”±brokeré‡å†™</li></ul><p><img src="/images/kafka_log.png" alt="img"></p><p>æ¶ˆæ¯è¢«æ”¾åœ¨ä¸€ä¸ªè®°å½•æ‰¹æ¬¡é‡Œ<code>ProducerBatch</code>ï¼Œè¿™ä¸ªæ‰¹æ¬¡çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«å‘é€åˆ°ç›¸åŒçš„topicå’Œpartitionä¸Šï¼Œç”±ä¸€ä¸ªFutureRecordMetadataè´Ÿè´£å‘é€ã€‚</p><p>brokeræ”¶åˆ°æ¶ˆæ¯åä¼šè¿”å›ä¸€ä¸ªå“åº”ï¼Œå¦‚æœå‘é€æ­£å¸¸çš„è¯ï¼Œä¼šè¿”å›ä¸€ä¸ª<code>RecordAppendResult</code>å¯¹è±¡ï¼ŒåŒ…å«äº†topicã€partitionã€offsetã€æ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå‘é€å¤±è´¥åˆ™ä¼šå°†å¤±è´¥çš„æ¶ˆæ¯è®°å½•ä¸‹æ¥ï¼Œç„¶ååç»­é‡è¯•å‘é€ã€‚</p><blockquote><p>org.apache.kafka.clients.producer.KafkaProducer</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Future&lt;RecordMetadata&gt; <span class="title">doSend</span><span class="params">(ProducerRecord&lt;K, V&gt; record, Callback callback)</span> </span>&#123;</span><br><span class="line">  TopicPartition tp = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    throwIfProducerClosed();</span><br><span class="line">    <span class="comment">// first make sure the metadata for the topic is available</span></span><br><span class="line">    ClusterAndWaitTime clusterAndWaitTime;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      clusterAndWaitTime = waitOnMetadata(record.topic(), record.partition(), maxBlockTimeMs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (KafkaException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (metadata.isClosed())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> KafkaException(<span class="string">"Producer closed while send in progress"</span>, e);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> remainingWaitMs = Math.max(<span class="number">0</span>, maxBlockTimeMs - clusterAndWaitTime.waitedOnMetadataMs);</span><br><span class="line">    Cluster cluster = clusterAndWaitTime.cluster;</span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–key</span></span><br><span class="line">    <span class="keyword">byte</span>[] serializedKey;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      serializedKey = keySerializer.serialize(record.topic(), record.headers(), record.key());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException cce) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Can't convert key of class "</span> + record.key().getClass().getName() +</span><br><span class="line">                                       <span class="string">" to class "</span> + producerConfig.getClass(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG).getName() +</span><br><span class="line">                                       <span class="string">" specified in key.serializer"</span>, cce);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–value</span></span><br><span class="line">    <span class="keyword">byte</span>[] serializedValue;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      serializedValue = valueSerializer.serialize(record.topic(), record.headers(), record.value());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException cce) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Can't convert value of class "</span> + record.value().getClass().getName() +</span><br><span class="line">                                       <span class="string">" to class "</span> + producerConfig.getClass(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG).getName() +</span><br><span class="line">                                       <span class="string">" specified in value.serializer"</span>, cce);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†³å®šè¦å‘é€çš„partition</span></span><br><span class="line">    <span class="keyword">int</span> partition = partition(record, serializedKey, serializedValue, cluster);</span><br><span class="line">    tp = <span class="keyword">new</span> TopicPartition(record.topic(), partition);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®header</span></span><br><span class="line">    setReadOnly(record.headers());</span><br><span class="line">    Header[] headers = record.headers().toArray();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> serializedSize = AbstractRecords.estimateSizeInBytesUpperBound(apiVersions.maxUsableProduceMagic(),</span><br><span class="line">                                                                       compressionType, serializedKey, serializedValue, headers);</span><br><span class="line">    ensureValidRecordSize(serializedSize);</span><br><span class="line">    <span class="comment">// è®¾ç½®æ¶ˆæ¯æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">long</span> timestamp = record.timestamp() == <span class="keyword">null</span> ? time.milliseconds() : record.timestamp();</span><br><span class="line">    log.trace(<span class="string">"Sending record &#123;&#125; with callback &#123;&#125; to topic &#123;&#125; partition &#123;&#125;"</span>, record, callback, record.topic(), partition);</span><br><span class="line">    <span class="comment">// producer callback will make sure to call both 'callback' and interceptor callback</span></span><br><span class="line">    Callback interceptCallback = <span class="keyword">new</span> InterceptorCallback&lt;&gt;(callback, <span class="keyword">this</span>.interceptors, tp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (transactionManager != <span class="keyword">null</span> &amp;&amp; transactionManager.isTransactional())</span><br><span class="line">      transactionManager.maybeAddPartitionToTransaction(tp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯ï¼Œè§ä¸‹æ–¹ä»£ç </span></span><br><span class="line">    RecordAccumulator.RecordAppendResult result = accumulator.append(tp, timestamp, serializedKey,</span><br><span class="line">                                                                     serializedValue, headers, interceptCallback, remainingWaitMs);</span><br><span class="line">    <span class="keyword">if</span> (result.batchIsFull || result.newBatchCreated) &#123;</span><br><span class="line">      log.trace(<span class="string">"Waking up the sender since topic &#123;&#125; partition &#123;&#125; is either full or getting a new batch"</span>, record.topic(), partition);</span><br><span class="line">      <span class="keyword">this</span>.sender.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result.future;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ApiException e) &#123;</span><br><span class="line">    log.debug(<span class="string">"Exception occurred during message send:"</span>, e);</span><br><span class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>)</span><br><span class="line">      callback.onCompletion(<span class="keyword">null</span>, e);</span><br><span class="line">    <span class="comment">// è®°å½•é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">this</span>.errors.record();</span><br><span class="line">    <span class="keyword">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FutureFailure(e);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">this</span>.errors.record();</span><br><span class="line">    <span class="keyword">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InterruptException(e);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (BufferExhaustedException e) &#123;</span><br><span class="line">    <span class="keyword">this</span>.errors.record();</span><br><span class="line">    <span class="keyword">this</span>.metrics.sensor(<span class="string">"buffer-exhausted-records"</span>).record();</span><br><span class="line">    <span class="keyword">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (KafkaException e) &#123;</span><br><span class="line">    <span class="keyword">this</span>.errors.record();</span><br><span class="line">    <span class="keyword">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>org.apache.kafka.clients.producer.internals.RecordAccumulator</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RecordAppendResult <span class="title">append</span><span class="params">(TopicPartition tp,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">long</span> timestamp,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">byte</span>[] key,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">byte</span>[] value,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     Header[] headers,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     Callback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">long</span> maxTimeToBlock)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  appendsInProgress.incrementAndGet();</span><br><span class="line">  ByteBuffer buffer = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (headers == <span class="keyword">null</span>) headers = Record.EMPTY_HEADERS;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Deque&lt;ProducerBatch&gt; dq = getOrCreateDeque(tp);</span><br><span class="line">    <span class="keyword">synchronized</span> (dq) &#123;</span><br><span class="line">      <span class="keyword">if</span> (closed)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> KafkaException(<span class="string">"Producer closed while send in progress"</span>);</span><br><span class="line">      RecordAppendResult appendResult = tryAppend(timestamp, key, value, headers, callback, dq);</span><br><span class="line">      <span class="keyword">if</span> (appendResult != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> appendResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span> maxUsableMagic = apiVersions.maxUsableProduceMagic();</span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="keyword">this</span>.batchSize, AbstractRecords.estimateSizeInBytesUpperBound(maxUsableMagic, compression, key, value, headers));</span><br><span class="line">    log.trace(<span class="string">"Allocating a new &#123;&#125; byte message buffer for topic &#123;&#125; partition &#123;&#125;"</span>, size, tp.topic(), tp.partition());</span><br><span class="line">    <span class="comment">// ç”³è¯·ä¸€ä¸ªç¼“å†²åŒºï¼Œå°†æ¶ˆæ¯æ•°æ®å†™å…¥åˆ°ç¼“å†²åŒºä¸­</span></span><br><span class="line">    buffer = free.allocate(size, maxTimeToBlock);</span><br><span class="line">    <span class="keyword">synchronized</span> (dq) &#123;</span><br><span class="line">      <span class="keyword">if</span> (closed)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> KafkaException(<span class="string">"Producer closed while send in progress"</span>);</span><br><span class="line"></span><br><span class="line">      RecordAppendResult appendResult = tryAppend(timestamp, key, value, headers, callback, dq);</span><br><span class="line">      <span class="keyword">if</span> (appendResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> appendResult;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      MemoryRecordsBuilder recordsBuilder = recordsBuilder(buffer, maxUsableMagic);</span><br><span class="line">      <span class="comment">// å°†æ¶ˆæ¯åˆ†æ‰¹å¤„ç†</span></span><br><span class="line">      ProducerBatch batch = <span class="keyword">new</span> ProducerBatch(tp, recordsBuilder, time.milliseconds());</span><br><span class="line">      FutureRecordMetadata future = Utils.notNull(batch.tryAppend(timestamp, key, value, headers, callback, time.milliseconds()));</span><br><span class="line"></span><br><span class="line">      dq.addLast(batch);</span><br><span class="line">      incomplete.add(batch);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¸…ç©ºç¼“å†²åŒº</span></span><br><span class="line">      buffer = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> RecordAppendResult(future, dq.size() &gt; <span class="number">1</span> || batch.isFull(), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (buffer != <span class="keyword">null</span>)</span><br><span class="line">      free.deallocate(buffer);</span><br><span class="line">    appendsInProgress.decrementAndGet();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆæ¯å‘é€ç±»å‹"><a class="markdownIt-Anchor" href="#æ¶ˆæ¯å‘é€ç±»å‹"></a> æ¶ˆæ¯å‘é€ç±»å‹</h3><ol><li><p>ç®€å•å‘é€</p><p>kafkaæœ€ç®€å•çš„æ¶ˆæ¯å‘é€æ˜¯åªæŒ‡å®štopicå’ŒkeyåŠvalueï¼Œåˆ†åŒºåŠæ—¶é—´æˆ³å‡ä½¿ç”¨é»˜è®¤å€¼ï¼Œsend()æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª<code>Future&lt;RecordMetadata&gt;</code>å¯¹è±¡ï¼Œå¦‚æœä¸éœ€è¦å…³å¿ƒè¿”å›å€¼ï¼Œåˆ™å¯ä»¥å¿½ç•¥è¿™ä¸ªè¿”å›å€¼ï¼Œå¦åˆ™å¿…é¡»å…³æ³¨æ­¤å€¼ï¼Œæ–¹æ³•è¿”å›çš„å¼‚å¸¸ä¿¡æ¯å¯èƒ½æœ‰<code>InterruptedException(å‘é€çº¿ç¨‹ä¸­æ–­å¼‚å¸¸)</code>ï¼Œ<code>BufferExhaustedException(ç¼“å†²åŒºå·²æ»¡)</code>ï¼Œ<code>SerializationException(åºåˆ—åŒ–å¼‚å¸¸)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ProducerRecord&lt;String,String&gt; record =</span><br><span class="line">                <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"cc_test"</span>,<span class="string">"cc"</span>,<span class="string">"chuanchuan"</span>);</span><br><span class="line">producer.send(record);</span><br></pre></td></tr></table></figure></li><li><p>åŒæ­¥å‘é€</p><p>ç¬¬ä¸€ç§ç®€å•å‘é€æ–¹å¼çš„å‰ææ˜¯æˆ‘ä»¬ä¸åœ¨æ„å‘é€çš„ç»“æœï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨æ­£å¸¸çš„æƒ…å†µä¸‹éƒ½ä¼šç­‰å¾…brokerçš„åé¦ˆã€‚æˆ‘ä»¬ä»å‘é€çš„æºç ä¸­çœ‹åˆ°send()æ–¹æ³•è¿”å›çš„<code>Future&lt;RecordMetadata&gt;</code>å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨Futureçš„get()æ–¹æ³•é˜»å¡ä¸»çº¿ç¨‹ç­‰å¾…brokerçš„å“åº”ï¼Œå¦‚æœè¿”å›é”™è¯¯ï¼Œåˆ™æˆ‘ä»¬è°ƒç”¨get()æ–¹æ³•çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœæ²¡å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™é¡ºåˆ©è·å–åˆ°<code>RecordMetadata</code>å¯¹è±¡ï¼Œä½¿ç”¨è¯¥å¯¹è±¡æŸ¥çœ‹æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ï¼štopicã€keyå’Œvalueçš„åºåˆ—åŒ–åçš„å¤§å°ã€offsetã€partitionã€‚</p><p>ç”Ÿäº§è€…å‘é€è¿‡ç¨‹ä¸­ä¸€èˆ¬ä¼šå‡ºç°ä¸¤ç±»é”™è¯¯ï¼šä¸€ç±»å¯ä»¥é€šè¿‡é‡è¯•è§£å†³ï¼Œä¸€ç±»æ— æ³•é€šè¿‡é‡è¯•è§£å†³ã€‚æ¯”å¦‚è¿æ¥é”™è¯¯ã€æ— Leaderé”™è¯¯ç­‰éƒ½å¯ä»¥é€šè¿‡é‡è¯•æ¥å®ç°ï¼Œè€Œæ¶ˆæ¯è¿‡å¤§è¿™ç±»é”™è¯¯KafkaProducerä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šé‡è¯•ï¼Œå› ä¸ºä¸ç®¡é‡è¯•å¤šå°‘æ¬¡éƒ½æ˜¯æ¶ˆæ¯è¿‡å¤§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"cc_test"</span>, <span class="string">"cc"</span>, <span class="string">"chuanchuan"</span>);</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  RecordMetadata rm = producer.send(record).get();</span><br><span class="line">  System.out.println(rm.offset());</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">  log.error(<span class="string">"occur error"</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¼‚æ­¥å‘é€</p><p>æ¶ˆæ¯åŒæ­¥å‘é€ä¼šé€ æˆåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€æ¡æ¶ˆæ¯åœ¨å‘é€ä¸­ï¼Œåœ¨å…¶æœ‰è¿”å›ä¹‹å‰ï¼Œå…¶ä»–çš„æ¶ˆæ¯éƒ½éœ€è¦ä¸€ç›´ç­‰å¾…ï¼Œè¿™æ ·ä¼šé€ æˆæ¶ˆæ¯å µå¡æ»åï¼Œæ— æ³•è®©kafkaå‘æŒ¥æ›´å¤§çš„æ•ˆç›Šï¼Œè‹¥ä¸€ä¸ªæ¶ˆæ¯å‘é€éœ€è¦20msï¼Œå‘é€äº”åæ¡æ¶ˆæ¯å°±éœ€è¦1sï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥è¿™ç§æ–¹å¼ï¼Œé‚£ä¹ˆå‘é€äº”åæ¡å¯èƒ½åªéœ€è¦30msï¼Œç”šè‡³æ›´å°‘ã€‚å¼‚æ­¥å‘é€çš„åŸç†æ˜¯åœ¨æˆ‘ä»¬è°ƒç”¨send()æ–¹æ³•æ—¶ä¼ å…¥ä¸€ä¸ªæ¥å£<code>org.apache.kafka.clients.producer.Callback</code>çš„å®ç°ç±»çš„å¯¹è±¡ï¼Œç”±ProducerBatchçš„ç§æœ‰æ–¹æ³•<code>completeFutureAndFireCallbacks</code>å®Œæˆå›è°ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"cc_test"</span>, <span class="string">"cc"</span>, <span class="string">"chuanchuan"</span>);</span><br><span class="line">producer.send(record, );</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CcProducerCallback</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(RecordMetadata metadata,Exception exception)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(exception != <span class="keyword">null</span>)&#123;</span><br><span class="line">      exception.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>org.apache.kafka.clients.producer.internals.ProducerBatch</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">completeFutureAndFireCallbacks</span><span class="params">(<span class="keyword">long</span> baseOffset, <span class="keyword">long</span> logAppendTime, RuntimeException exception)</span> </span>&#123;</span><br><span class="line">  produceFuture.set(baseOffset, logAppendTime, exception);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// execute callbacks</span></span><br><span class="line">  <span class="keyword">for</span> (Thunk thunk : thunks) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">if</span> (exception == <span class="keyword">null</span>) &#123;</span><br><span class="line">        RecordMetadata metadata = thunk.future.value();</span><br><span class="line">        <span class="keyword">if</span> (thunk.callback != <span class="keyword">null</span>)</span><br><span class="line">          thunk.callback.onCompletion(metadata, <span class="keyword">null</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ­£å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (thunk.callback != <span class="keyword">null</span>)</span><br><span class="line">          thunk.callback.onCompletion(<span class="keyword">null</span>, exception);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">"Error executing user-provided callback on message for topic-partition '&#123;&#125;'"</span>, topicPartition, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  produceFuture.done();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="åˆ†åŒºæœºåˆ¶"><a class="markdownIt-Anchor" href="#åˆ†åŒºæœºåˆ¶"></a> åˆ†åŒºæœºåˆ¶</h3><p>kafkaå¯¹äºæ•°æ®çš„è¯»å†™æ˜¯ä»¥partitionä¸ºç²’åº¦çš„ï¼Œpartitionå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„brokerä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥ç‹¬ç«‹çš„å®ç°æ¶ˆæ¯çš„è¯»å†™ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡æ–°å¢æ–°çš„brokeræ¥æå‡kafkaé›†ç¾¤çš„ååé‡ï¼Œpartitionéƒ¨ç½²åœ¨å¤šä¸ªbrokeræ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚</p><p>kafkaçš„åˆ†åŒºç­–ç•¥å…¶å®æŒ‡çš„å°±æ˜¯Producerå°†æ¶ˆæ¯å‘é€åˆ°å“ªä¸ªåˆ†åŒºçš„ç®—æ³•ï¼Œkafkaæä¾›äº†é»˜è®¤çš„åˆ†åŒºç­–ç•¥ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒæˆ‘ä»¬è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼Œæ‰€æœ‰çš„ç­–ç•¥éƒ½å®ç°äºæ¥å£<code>org.apache.kafka.clients.producer.Partitioner</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Partitioner</span> <span class="keyword">extends</span> <span class="title">Configurable</span>, <span class="title">Closeable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æä¾›æ¶ˆæ¯ä¿¡æ¯è®¡ç®—partition</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic topicåç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key keyåç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyBytes keyåºåˆ—åŒ–å­—èŠ‚æ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value valueå€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> valueBytes valueåºåˆ—åŒ–å­—èŠ‚æ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cluster é›†ç¾¤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³é—­partitioner</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆæ¯å‘é€åˆ°å“ªä¸€ä¸ªpartitionä¸Šæ¶‰åŠåˆ°åˆ†åŒºé€‰æ‹©æœºåˆ¶ï¼Œä¸»è¦æœ‰é¡ºåºã€éšæœºã€æŒ‰keyåˆ†é…ã€è‡ªå®šä¹‰åˆ†é…ç­‰æ–¹å¼ï¼Œå…·ä½“çš„å®ç°æ–¹æ³•å°±æ˜¯<code>public int partition()</code>ã€‚</p><ol><li><p>é¡ºåºè½®è¯¢</p><p>é¡ºåºåˆ†é…å°±æ˜¯æ¶ˆæ¯å‡åŒ€çš„å‘é€ç»™æ¯ä¸€ä¸ªpartitionï¼Œæ¯ä¸ªpartitionå­˜å‚¨ä¸€æ¬¡æ¶ˆæ¯ï¼Œkafkaçš„é»˜è®¤ç­–ç•¥ã€‚</p><img src="/images/image-20200417033430230.png" alt="image-20200417033430230" style="zoom: 67%;"></li><li><p>éšæœºç­–ç•¥</p><p>éšæœºç­–ç•¥å¯ä»¥å…ˆè®¡ç®—å‡ºtopicçš„æ€»çš„partitionæ•°ï¼Œç„¶åä½¿ç”¨<code>ThreadLocalRandom.current().nextInt()</code>æ–¹æ³•æ¥è·å–ä¸€ä¸ªå°äºåˆ†åŒºæ€»æ•°çš„éšæœºå€¼ï¼Œéšæœºç­–ç•¥ä¼šå¯¼è‡´æ¶ˆæ¯åˆ†å¸ƒä¸å‡åŒ€ã€‚è™½ç„¶æ˜¯éšæœºçš„ï¼Œä½†æ˜¯å•ä¸ªåˆ†åŒºå†…ä¹Ÿæ˜¯æœ‰åºçš„ã€‚</p><img src="/images/image-20200417035130292.png" alt="image-20200417035130292" style="zoom:67%;"><blockquote><p>ç­–ç•¥ä»£ç </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line"><span class="keyword">return</span> ThreadLocalRandom.current().nextInt(partitions.size());</span><br></pre></td></tr></table></figure></li><li><p>keyåˆ†é…ç­–ç•¥</p><p>è¿™ä¸ªç­–ç•¥ä¹Ÿå«åš key-orderingç­–ç•¥ï¼Œkafkaä¸­æ¯æ¡æ¶ˆæ¯éƒ½ä¼šæœ‰è‡ªå·±çš„keyï¼Œä¸€æ—¦æ¶ˆæ¯è¢«å®šä¹‰äº† keyï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥ä¿è¯åŒä¸€ä¸ªkeyçš„æ‰€æœ‰æ¶ˆæ¯éƒ½è¿›å…¥åˆ°ç›¸åŒçš„partitioné‡Œé¢ï¼Œå› ä¸ºæ¯ä¸ªpartitionä¸‹çš„æ¶ˆæ¯å¤„ç†éƒ½æ˜¯æœ‰é¡ºåºçš„ï¼Œæ‰€ä»¥è¿™ä¸ªç­–ç•¥ä¹Ÿè¢«ç§°ä¸ºæŒ‰æ¶ˆæ¯é”®ä¿åºç­–ç•¥</p><img src="/images/image-20200417035625713.png" alt="image-20200417035625713" style="zoom:60%;"><blockquote><p>ç­–ç•¥ä»£ç </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line"><span class="comment">// Math.abs()çš„åŸå› æ˜¯hashCodeå¯èƒ½æ˜¯è´Ÿæ•°</span></span><br><span class="line"><span class="keyword">return</span> Math.abs(key.hashCode()) % partitions.size();</span><br></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰åˆ†é…ç­–ç•¥</p><p>è‡ªç”±å‘æŒ¥å§ï¼Œåªè¦å®ç°Partitioneræ¥å£å°±æˆäº†</p><blockquote><p>application.properties</p></blockquote><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># org.apache.kafka.clients.producer.ProducerConfigç±»ä¸­å®šä¹‰äº†å„ç±»å‚æ•°é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="meta">spring.kafka.properties.partitioner.class</span>=<span class="string">cc.kevinlu.springboot.kafka.partitioners.CcPartitioner</span></span><br></pre></td></tr></table></figure><blockquote><p>CcPartitioner</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.kevinlu.springboot.kafka.partitioners;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Partitioner;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.Cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CcPartitioner</span> <span class="keyword">implements</span> <span class="title">Partitioner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"&#123;&#125;------------&#123;&#125;"</span>, topic, cluster.availablePartitionsForTopic(topic).size());</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// æ°¸è¿œéƒ½æ‰“åˆ°partition 0ä¸Š</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="producer-property"><a class="markdownIt-Anchor" href="#producer-property"></a> Producer Property</h3><ol><li>retriesï¼šæ¶ˆæ¯é‡è¯•æ¬¡æ•°ï¼Œè‹¥æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œä½†æ˜¯å¯é€šè¿‡é‡æ–°å‘é€æ¥å¼¥è¡¥é”™è¯¯ï¼Œæ¯”å¦‚Leaderç¼ºå¤±ï¼Œåˆ™ç”Ÿäº§è€…ä¼šä¸æ–­çš„é‡å‘æ¶ˆæ¯ï¼Œç›´åˆ°é‡å‘æ¬¡æ•°è¾¾åˆ°æ­¤å‚æ•°æŒ‡å®šçš„å€¼åæ”¾å¼ƒé‡è¯•å¹¶è¿”å›é”™è¯¯ï¼Œé»˜è®¤æƒ…å†µä¸‹æ¯æ¬¡é‡è¯•é—´éš”100msï¼Œé€šè¿‡å‚æ•°<code>retry.backoff.ms</code>æŒ‡å®š</li><li>acksï¼šæŒ‡å®šè¦æœ‰å¤šå°‘ä¸ªpartitionå‰¯æœ¬æ¥æ”¶æ¶ˆæ¯ï¼Œç”Ÿäº§è€…æ‰è®¤ä¸ºæ¶ˆæ¯æ˜¯æˆåŠŸå†™å…¥ï¼Œacksèƒ½å¤Ÿæ§åˆ¶æ¶ˆæ¯ä¸¢å¤±æ¦‚ç‡ã€‚<ul><li>acks=0ï¼šè¡¨ç¤ºç”Ÿäº§è€…åªç®¡å‘ä¸ç®¡æœåŠ¡å™¨æ˜¯å¦æ¥æ”¶äº†ï¼Œéå¸¸å®¹æ˜“ä¸¢æ¶ˆæ¯</li><li>acks=1ï¼šåªè¦é›†ç¾¤çš„Leaderæ”¶åˆ°äº†æ¶ˆæ¯å°±ç«‹åˆ»åé¦ˆç»™ç”Ÿäº§è€…ï¼Œæ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±</li><li>acks=allï¼šåªæœ‰å½“æ‰€æœ‰çš„å‚ä¸å¤åˆ¶çš„èŠ‚ç‚¹éƒ½æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œbrokeræ‰ä¼šåé¦ˆç»™ç”Ÿäº§è€…ï¼Œèƒ½å¤Ÿä¿è¯æ¶ˆæ¯ç»ä¸ä¸¢å¤±ï¼Œä½†æ˜¯å»¶è¿Ÿæ›´é«˜</li></ul></li><li>key.serializerï¼škeyçš„åºåˆ—åŒ–ç±»ï¼Œéœ€æ˜¯æ¥å£<code>org.apache.kafka.common.serialization.Serializer</code>çš„å®ç°ç±»</li><li>value.serializerï¼švalueçš„åºåˆ—åŒ–ç±»ï¼Œéœ€æ˜¯æ¥å£<code>org.apache.kafka.common.serialization.Serializer</code>çš„å®ç°ç±»</li><li>compression.typeï¼šæ¶ˆæ¯å‹ç¼©ç±»å‹ï¼Œé»˜è®¤ä¸ºnone, å¯é€‰å€¼æœ‰noneã€gzipã€snappyã€lz4ã€zstd</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ç®€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç®€&quot;&gt;&lt;/a&gt; ç®€&lt;/h3&gt;
&lt;p&gt;åœ¨kafkaä¸­æŠŠäº§ç”Ÿæ¶ˆæ¯çš„ä¸€æ–¹ç§°ä¸ºç”Ÿäº§è€…ï¼ˆProducerï¼‰ï¼Œå°½ç®¡æ¶ˆæ¯çš„äº§ç”Ÿéå¸¸ç®€å•ï¼Œä½†æ˜¯æ¶ˆæ¯çš„å‘é€è¿‡ç¨‹æ¯”è¾ƒå¤æ‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/
      
    
    </summary>
    
    
      <category term="Kafka" scheme="http://luxiaowan.github.io/categories/Kafka/"/>
    
    
  </entry>
  
  <entry>
    <title>Gitåˆ‡æ¢å›æŸä¸ªcommit</title>
    <link href="http://luxiaowan.github.io/2020/04/16/Git%E5%88%87%E6%8D%A2%E5%9B%9E%E6%9F%90%E4%B8%AAcommit/"/>
    <id>http://luxiaowan.github.io/2020/04/16/Gitåˆ‡æ¢å›æŸä¸ªcommit/</id>
    <published>2020-04-16T15:45:00.000Z</published>
    <updated>2020-04-16T16:00:43.558Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åŸç”±"><a class="markdownIt-Anchor" href="#åŸç”±"></a> åŸç”±</h3><p>commitä¹‹åå¿˜äº†pushï¼Œç„¶åå°±revert HEADäº†ï¼Œå¯¼è‡´æœ¬åœ°çš„ä»£ç ä¸¢å¤±äº†åˆšä¿®æ”¹çš„å†…å®¹</p><h3 id="ç¬¬ä¸€æ­¥"><a class="markdownIt-Anchor" href="#ç¬¬ä¸€æ­¥"></a> ç¬¬ä¸€æ­¥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¯¥å‘½ä»¤æŸ¥çœ‹commitè®°å½•</p><img src="/images/image-20200416235542502.png" alt="git commit log" style="zoom:50%;"><p>æ ¼å¼<code>commit commit_id</code>ï¼Œæ¯”å¦‚<code>commit bc208f03c3bb341dfc56533d9ea196b6d347ff34</code>ä¸­ï¼Œbc208f03c3bb341dfc56533d9ea196b6d347ff34å°±æ˜¯commit_idï¼Œæ¯ä¸€æ¬¡commitçš„idéƒ½æ˜¯å…¨å±€å”¯ä¸€çš„</p><h3 id="ç¬¬äºŒæ­¥"><a class="markdownIt-Anchor" href="#ç¬¬äºŒæ­¥"></a> ç¬¬äºŒæ­¥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard $&#123;commit_id&#125;</span><br></pre></td></tr></table></figure><p>è‹¥æƒ³åˆ‡æ¢å›jmmè¿™æ¬¡çš„commitï¼Œåˆ™è¯­å¥ä¸º<code>git reset --hard 81fc9404e8186d132c799ffaf62e652a4c8c98f0</code></p><h3 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h3><p>gitæ“ä½œè¦æ…é‡ï¼Œä¸è¿‡å³ä½¿å‡ºäº†é—®é¢˜ä¹Ÿæœ‰æ¢å¤çš„å°æŠ€å·§</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;åŸç”±&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#åŸç”±&quot;&gt;&lt;/a&gt; åŸç”±&lt;/h3&gt;
&lt;p&gt;commitä¹‹åå¿˜äº†pushï¼Œç„¶åå°±revert HEADäº†ï¼Œå¯¼è‡´æœ¬åœ°çš„ä»£ç ä¸¢å¤±äº†åˆšä¿®æ”¹çš„å†…å®¹&lt;/p&gt;
&lt;h3 id=&quot;ç¬¬ä¸€æ­¥&quot;&gt;&lt;a clas
      
    
    </summary>
    
    
      <category term="Git" scheme="http://luxiaowan.github.io/categories/Git/"/>
    
    
  </entry>
  
  <entry>
    <title>Kafkaåˆæ¢</title>
    <link href="http://luxiaowan.github.io/2020/04/16/Kafka%E5%88%9D%E6%8E%A2/"/>
    <id>http://luxiaowan.github.io/2020/04/16/Kafkaåˆæ¢/</id>
    <published>2020-04-15T18:51:00.000Z</published>
    <updated>2020-04-16T16:00:26.695Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åŸºæœ¬åè¯"><a class="markdownIt-Anchor" href="#åŸºæœ¬åè¯"></a> åŸºæœ¬åè¯</h3><ul><li>æ¶ˆæ¯ï¼škafkaä¸­çš„æ•°æ®å•å…ƒç§°ä¸ºæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥å«è®°å½•ï¼Œç›¸å½“äºMySQLè¡¨ä¸­çš„ä¸€æ¡è®°å½•</li><li>æ‰¹æ¬¡ï¼šä¸ºäº†æé«˜æ•ˆç‡ï¼Œkafkaå¯ä»¥ä¸€æ¬¡æ€§å†™å…¥ä¸€æ‰¹æ•°æ®(æ¶ˆæ¯)ï¼Œæ‰¹æ¬¡æŒ‡çš„å°±æ˜¯ä¸€ç»„æ¶ˆæ¯</li><li>ä¸»é¢˜ï¼šç›¸å½“äºMySQLçš„è¡¨ï¼Œä¸€ä¸ªä¸»é¢˜(Topic)ä»£è¡¨ç€ä¸€ç±»æ¶ˆæ¯ï¼Œkafkaä½¿ç”¨ä¸»é¢˜å¯¹æ¶ˆæ¯åˆ†ç±»</li><li>åˆ†åŒºï¼šåˆ†åŒº(partition)å½’å±äºä¸»é¢˜ï¼Œä¸€ä¸ªä¸»é¢˜å¯ä»¥åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªåˆ†åŒºï¼Œåˆ†åŒºå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„brokerä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨åŒä¸€ä¸ªbrokerä¸Šï¼Œä½¿ç”¨åˆ†åŒºæ¥å®ç°kafkaçš„ä¼¸ç¼©æ€§ã€‚ä¸»é¢˜çš„å•ä¸ªåˆ†åŒºä¸Šçš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ï¼Œä½†æ˜¯ä¸åŒåˆ†åŒºä¸Šçš„æ¶ˆæ¯æ— æ³•ä¿è¯æœ‰åºã€‚</li><li>ç”Ÿäº§è€…ï¼šå‘ä¸»é¢˜å‘å¸ƒæ¶ˆæ¯çš„å®¢æˆ·ç«¯ç§°ä¸ºç”Ÿäº§è€…ï¼Œç”Ÿäº§è€…ç”¨äºä¸æ–­çš„å‘ä¸»é¢˜å‘é€æ¶ˆæ¯</li><li>æ¶ˆè´¹è€…ï¼šè®¢é˜…ä¸»é¢˜æ¶ˆæ¯çš„å®¢æˆ·ç«¯ç§°ä¸ºæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…ç”¨äºå¤„ç†ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯</li><li>æ¶ˆè´¹è€…ç¾¤ç»„ï¼šç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…çš„å…³ç³»æ˜¯ä¸€å¯¹å¤šï¼Œæ¯”å¦‚ä¸€ä¸ªå®¢æœå¯¹åº”å¤šä¸ªå’¨è¯¢è€…ï¼Œæ¶ˆè´¹è€…ç¾¤ç»„å°±æ˜¯ç”±ä¸€æ‰¹æ¶ˆè´¹è€…ç»„æˆçš„</li><li>åç§»é‡ï¼šåç§»é‡(Consumer Offset)æ˜¯ä¸€ç§æºæ•°æ®ï¼Œæ˜¯ä¸€ä¸ªå•å‘é€’å¢çš„æ•´æ•°æ ‡è¯†ï¼Œç”¨äºè®°å½•æ¶ˆè´¹è€…å‘ç”Ÿé‡å¹³è¡¡æ—¶çš„ä½ç½®ï¼Œä»¥ä¾¿ç”¨æ¥æ¢å¤æ•°æ®</li><li>brokerï¼šä¸€ä¸ªç‹¬ç«‹çš„æœåŠ¡å™¨è¢«ç§°ä¸ºbrokerï¼Œbrokeræ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œå¹¶ä¸ºæ¶ˆæ¯è®¾ç½®åç§»é‡ï¼Œå¹¶æäº¤æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜</li><li>brokeré›†ç¾¤ï¼šå¤šä¸ªbrokerç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œä¿è¯kafkaçš„é«˜å¯ç”¨ï¼Œæ¯ä¸ªé›†ç¾¤ä¸­éƒ½æœ‰ä¸€ä¸ªbrokerå……å½“é›†ç¾¤Leaderçš„è§’è‰²</li><li>å‰¯æœ¬ï¼škafkaä¸­æ¶ˆæ¯çš„å¤‡ä»½åˆç§°ä¸ºå‰¯æœ¬(Replica)ï¼Œå‰¯æœ¬çš„æ•°é‡æ˜¯å¯é…ç½®çš„ï¼Œç±»å‹æœ‰Leaderå’ŒFollowerä¸¤ç§ï¼ŒLeaderå¯¹å¤–æä¾›æœåŠ¡ï¼ŒFollowerè¾…åŠ©</li><li>é‡(chong)å¹³è¡¡(ReBalance)ï¼šè‹¥æ¶ˆè´¹è€…ç»„å†…æŸä¸ªæ¶ˆè´¹è€…å®•äº†ï¼Œå…¶ä»–å­˜æ´»çš„æ¶ˆè´¹è€…è‡ªåŠ¨é‡æ–°åˆ†é…è®¢é˜…ä¸»é¢˜åˆ†åŒºï¼Œkafkaé«˜å¯ç”¨çš„å¿…å¤‡èƒ½åŠ›</li></ul><h3 id="å…³ç³»ä»‹ç»"><a class="markdownIt-Anchor" href="#å…³ç³»ä»‹ç»"></a> å…³ç³»ä»‹ç»</h3><ul><li><p>Topic&amp;Partition</p><ol><li><p>Topicæ˜¯kafkaä¸­ç»™æ¶ˆæ¯åˆ†ç±»çš„æ ‡è®°ï¼Œä¸€ä¸ªæ¶ˆæ¯å¿…å®šå±äºä¸€ä¸ªTopicï¼Œä¸€ä¸ªTopicå¯ä»¥åŒ…æ‹¬ä¸€ä¸ªæˆ–å¤šä¸ªPartitionï¼ŒPartitionåˆå¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œå‰¯æœ¬åˆå¯ä»¥åˆ†é…åœ¨ä¸åŒçš„brokerä¸Šã€‚</p></li><li><p>Partitionå†…éƒ¨æ˜¯æœ‰åºçš„ï¼ŒPartitionä¹‹é—´æ˜¯æ— åºçš„</p><img src="/images/log_anatomy.png" alt="img" style="zoom: 130%;"></li><li><p>å†…éƒ¨å­˜å‚¨æ˜¯ä»¥append-logçš„æ–¹å¼ä¸æ–­è¿›è¡Œlogæ–‡ä»¶å°¾éƒ¨è¿½åŠ ï¼Œæ–‡ä»¶è¯»å†™æ˜¯åœ¨ç£ç›˜ä¸Šæ˜¯é¡ºåºçš„ï¼Œæ•ˆç‡æé«˜ï¼Œåª²ç¾å†…å­˜æ“ä½œï¼Œæ¯ä¸€æ¡logå¯¹åº”ä¸€ä¸ªoffsetï¼Œå¯ä»¥æŠŠoffsetç†è§£ä¸ºä¸€ä¸ªæ•°ç»„çš„ä¸‹æ ‡ï¼Œé€šè¿‡è¿™ä¸ªä¸‹æ ‡å°±å¯ä»¥è¯»å–å¯¹åº”çš„æ¶ˆæ¯æ•°æ®ï¼ŒPartitionåªè´Ÿè´£ä¸ºæ¶ˆæ¯åˆ†é…offsetï¼Œæ¶ˆè´¹è€…å…·ä½“ç”±å“ªä¸ªoffsetå¼€å§‹æ¶ˆè´¹æ¶ˆæ¯å®Œå…¨ç”±æ¶ˆè´¹è€…è‡ªå·±æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯kafkaæœåŠ¡ç«¯åªè´Ÿè´£æä¾›æ•°æ®ï¼Œæ¶ˆè´¹è€…è‡ªå·±æ§åˆ¶æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦ã€‚</p><img src="/images/log_consumer.png" alt="img" style="zoom: 25%;"></li><li><p>kafkaè™½ç„¶æ˜¯å¯ä»¥æŒä¹…åŒ–æ¶ˆæ¯ï¼Œå¹¶ä¸”ä¸åˆ é™¤å·²ç»è¢«æ¶ˆè´¹è¿‡çš„æ¶ˆæ¯ï¼Œä½†æ¶ˆæ¯ä¹Ÿä¸æ˜¯è¢«æ°¸ä¹…å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„ï¼Œä¸ºäº†é˜²æ­¢ç£ç›˜é•¿æœŸè¢«æ¶ˆæ¯å†™å…¥æ•°æ®æ—¥ç§¯æœˆç´¯ï¼Œkafkaæä¾›ä¸¤ç§æ—§æ•°æ®æ·˜æ±°ç­–ç•¥ï¼š</p></li></ol><ul><li><p>å¼€å¯æ•°æ®æ¸…ç†ï¼š<code>log.cleaner.enable=true</code>ï¼Œé»˜è®¤å…³é—­çŠ¶æ€</p></li><li><p>åŸºäºæ—¶é—´ï¼š<code>log.retention.hours=168</code>ï¼Œå•ä½ï¼šå°æ—¶ï¼›<code>log.retention.ms=100</code>ï¼Œå•ä½ï¼šæ¯«ç§’ï¼›<code>log.retention.minutes</code>ï¼Œå•ä½ï¼šåˆ†é’Ÿ</p></li><li><p>åŸºäºæ–‡ä»¶å¤§å°ï¼š<code>log.retention.bytes=1073741824</code>ï¼Œå•ä½ï¼šå­—èŠ‚</p></li></ul></li><li><p>Consumer&amp;Consumer Group</p><ol><li><p>ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…ç»„åˆè€Œæˆï¼Œæ¯ä¸€æ¡æ¶ˆæ¯åªä¼šè¢«åŒä¸€ä¸ªgroupä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä½†æ˜¯ä¸åŒgroupä¸­çš„æ¶ˆè´¹è€…å¯ä»¥åŒæ—¶æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ï¼Œä¿è¯äº† æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡ï¼›kafkaæ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™é‡Œè®¢é˜…çš„æ˜¯æ¶ˆè´¹è€…ç»„ï¼Œè€Œä¸æ˜¯ç‰¹å®šçš„ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚</p><p><img src="/images/consumer-groups.png" alt="img"></p><p>kafkaæ”¯æŒç¦»çº¿å¤„ç†å’Œå®æ—¶å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Hadoopè¿›è¡Œç¦»çº¿å¤„ç†ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Stormè¿™ç§å®æ—¶æµå¤„ç†ç³»ç»Ÿè¿›è¡Œå®æ—¶å¤„ç†ï¼Œè¿˜å¯ä»¥å°†æ•°æ®å®æ—¶çš„åŒæ­¥åˆ°å…¶ä»–çš„æ•°æ®ä¸­å¿ƒï¼Œå‰ææ˜¯è¿™äº›æ¶ˆè´¹è€…å¤„äºä¸åŒçš„æ¶ˆè´¹è€…ç»„ã€‚</p><p>å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. åˆ›å»ºä¸€ä¸ªtopic</span></span><br><span class="line">kafka-topics --create --zookeeper localhost:2181 --replication-factor 3 --partition 1 --topic cc_topic</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. å¯åŠ¨ä¸€ä¸ªProducer</span></span><br><span class="line">kafka-console-producer --broker-list localhost:9092 --topic cc_topic</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. å¯åŠ¨äº”ä¸ªConsumerï¼Œ1~3å·æ”¾cc_group_1ï¼Œ4~5æ”¾cc_group_2</span></span><br><span class="line">kafka-console-consumer --bootstrap-server localhost:9092 --group cc_group_1 --from-beginning --topic cc_topic</span><br><span class="line"></span><br><span class="line">kafka-console-consumer --bootstrap-server localhost:9092 --group cc_group_1 --from-beginning --topic cc_topic</span><br><span class="line"></span><br><span class="line">kafka-console-consumer --bootstrap-server localhost:9092 --group cc_group_1 --from-beginning --topic cc_topic</span><br><span class="line"></span><br><span class="line">kafka-console-consumer --bootstrap-server localhost:9092 --group cc_group_2 --from-beginning --topic cc_topic</span><br><span class="line"></span><br><span class="line">kafka-console-consumer --bootstrap-server localhost:9092 --group cc_group_2 --from-beginning --topic cc_topic</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. å‘é€ä¸€æ¡æ¶ˆæ¯</span></span><br><span class="line">123</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. æŸ¥çœ‹æ¶ˆè´¹è€…</span></span><br><span class="line">cc_group_1å’Œcc_group_2å„è‡ªæ”¶åˆ°123è¿™æ¡æ¶ˆæ¯ä¸€æ¬¡</span><br></pre></td></tr></table></figure></li></ol></li><li><p>Consumer ReBalance</p><p>Consumer ReBalanceæ˜¯é€šè¿‡Zookeeperå®ç°ï¼Œkafkaä¿è¯äº†åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹æŸæ¡æ¶ˆæ¯ï¼Œå…¶å®kafkaä¿è¯çš„æ˜¯åœ¨ç¨³å®šçŠ¶æ€ä¸‹æ¯ä¸€ä¸ªæ¶ˆè´¹è€…éƒ½åªä¼šæ¶ˆè´¹ä¸€ä¸ªæˆ–å¤šä¸ªPartitionçš„æ¶ˆæ¯ï¼Œè€ŒæŸä¸€Partitionçš„æ¶ˆæ¯ä»…ä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œè¿™æ ·è®¾è®¡çš„ä¼˜åŠ¿æ˜¯æ¯ä¸ªæ¶ˆè´¹è€…ä¸ç”¨è·Ÿæ‰€æœ‰çš„brokerè¿›è¡Œé€šä¿¡ï¼Œå‡å°‘äº†é€šä¿¡å¼€é”€ï¼ŒåŠ£åŠ¿æ˜¯åŒä¸€ä¸ªæ¶ˆè´¹ç»„å†…çš„æ¶ˆè´¹è€…ä¸èƒ½å‡åŒ€æ¶ˆè´¹ï¼Œè€Œä¸”å•ä¸ªPartitionå†…éƒ¨çš„æ•°æ®æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥å¯¹äºå•ä¸ªæ¶ˆè´¹è€…æ¥è¯´ï¼Œå…¶æ¶ˆè´¹çš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ã€‚</p><ol><li>Consumer &lt; Partitionï¼šä¼šå‡ºç°æŸäº›Consumeræ¶ˆè´¹å¤šä¸ªPartitionçš„æ•°æ®</li><li>Consumer &gt; Partitionï¼šä¼šå‡ºç°æŸäº›Consumeræ²¡æœ‰å¯æ¶ˆè´¹çš„Partition</li><li>Consumer = Partitionï¼šä¸€ä¸ªConsumeræ¶ˆè´¹ä¸€ä¸ªPartitionï¼Œå‡åŒ€</li></ol></li></ul><h3 id="ç‰¹æ€§"><a class="markdownIt-Anchor" href="#ç‰¹æ€§"></a> ç‰¹æ€§</h3><ul><li>é«˜ååã€ä½å»¶è¿Ÿï¼škafkaå¤„ç†æ¶ˆæ¯çš„é€Ÿåº¦éå¸¸å¿«ï¼Œæ¯ç§’å‡ ä¹å¯ä»¥å¤„ç†å‡ åä¸‡æ¡æ¶ˆæ¯ï¼Œå¹¶ä¸”æœ€ä½å»¶è¿Ÿåªæœ‰å‡ æ¯«ç§’</li><li>é«˜ä¼¸ç¼©æ€§ï¼šæ¯ä¸ªtopicéƒ½èƒ½æœ‰å¤šä¸ªpartitionï¼Œæ¯ä¸ªpartitionåˆå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„brokerä¸Š</li><li>é«˜å¹¶å‘ï¼šèƒ½å¤ŸåŒæ—¶æ”¯æŒæ•°åƒä¸ªå®¢æˆ·ç«¯è¿›è¡Œè¯»å†™</li><li>å®¹é”™æ€§ï¼šå…è®¸é›†ç¾¤ä¸­çš„æŸäº›èŠ‚ç‚¹å¤±è´¥ï¼ŒæŸä¸ªèŠ‚ç‚¹å®•æœºï¼Œkafkaä»ç„¶å¯ç”¨ç»§ç»­æä¾›æœåŠ¡</li><li>æŒä¹…æ€§ã€å¯é æ€§ï¼škafkaçš„æ¶ˆæ¯å­˜å‚¨æ˜¯åŸºäºZookeeperçš„ï¼ŒZookeeperæ˜¯å¯ä»¥å°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œå¹¶ä¸”æ”¯æŒæ•°æ®å¤‡ä»½ï¼Œæ‰€ä»¥kafkaæ˜¯ä¸€ä¸ªéå¸¸å¯é çš„å¯æŒä¹…åŒ–æ¶ˆæ¯ä¸­é—´ä»¶</li><li>é€Ÿåº¦å¿«ï¼škafkaé‡‡ç”¨é›¶æ‹·è´çš„æ¨¡å¼å®ç°æ•°æ®çš„å¿«é€Ÿç§»åŠ¨ï¼Œé¿å…äº†å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„é¢‘ç¹åˆ‡æ¢ï¼Œkafkaå¯ä»¥æ‰¹é‡å‘é€æ•°æ®ï¼Œä»ç”Ÿäº§è€…åˆ°æ–‡ä»¶ç³»ç»Ÿåˆ°æ¶ˆè´¹è€…ï¼›æ•°æ®å‹ç¼©å¯ä»¥é€šè¿‡æœ‰æ•ˆçš„æ•°æ®å‹ç¼©å‡å°‘IOæ¬¡æ•°ï¼Œå¹¶ä¸”é‡‡ç”¨é¡ºåºè¯»å†™çš„æ–¹å¼é¿å…å¯»å€é€ æˆçš„æ¶ˆè€—ã€‚æ€»ç»“èµ·æ¥å°±æ˜¯é›¶æ‹·è´ã€é¡ºåºè¯»å†™ã€æ•°æ®å‹ç¼©ã€åˆ†æ‰¹å‘é€ã€‚</li></ul><h3 id="æ¶ˆæ¯é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—"></a> æ¶ˆæ¯é˜Ÿåˆ—</h3><ul><li><p>ç‚¹å¯¹ç‚¹ï¼ˆä¸€å¯¹ä¸€ï¼‰ï¼šä¸€ä¸ªç”Ÿäº§è€…æ‰€ç”Ÿäº§çš„æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ï¼Œä¸ä¼šåŒæ—¶è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</p><img src="/images/image-20200416173858298.png" alt="image-20200416173858298" style="zoom:50%;"></li><li><p>å‘å¸ƒè®¢é˜…ï¼ˆä¸€å¯¹å¤šã€å¤šå¯¹å¤šï¼‰ï¼šä¸€ä¸ªæˆ–å¤šä¸ªç”Ÿäº§è€…æ‰€ç”Ÿäº§çš„æ¶ˆæ¯ä¼šè¢«å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹</p><img src="/images/image-20200416173919621.png" alt="image-20200416173919621" style="zoom:50%;"></li></ul><h3 id="æ¶æ„ä½“ç³»"><a class="markdownIt-Anchor" href="#æ¶æ„ä½“ç³»"></a> æ¶æ„ä½“ç³»</h3><img src="/images/image-20200416220029587.png" alt="image-20200416220029587" style="zoom:45%;"><p>ä¸€ä¸ªkafkaé›†ç¾¤åŒ…å«è‹¥å¹²ä¸ªProducerã€è‹¥å¹²Consumer groupã€è‹¥å¹²brokerå’ŒZookeeperé›†ç¾¤ç»„æˆï¼Œkafkaé€šè¿‡Zookeeperç®¡ç†Partitionï¼Œé€‰ä¸¾Leaderï¼Œä»¥åŠåœ¨Consumerå‘ç”Ÿå˜åŒ–æ—¶é€šè¿‡Zookeeperè¿›è¡ŒReBalanceã€‚Producerå°†æ¶ˆæ¯pushåˆ°Partitionï¼ŒConsumeré€šè¿‡pullå°†æ¶ˆæ¯ä»Partitionæ‹‰å–åˆ°æœ¬åœ°ã€‚</p><h3 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h3><p>kafkaç›®å‰æä¾›äº”ç±»å¸¸ç”¨çš„APIï¼Œä¸»è¦æœ‰Producerã€Consumerã€Streamã€Connectã€Admin APIï¼š</p><ul><li>Producer APIï¼šå…è®¸Appä½œä¸ºProducerå°†æ¶ˆæ¯å‘é€åˆ°kafkaé›†ç¾¤çš„ä¸€ä¸ªæˆ–å¤šä¸ªtopicä¸Š</li><li>Consumer APIï¼šå…è®¸Appä½œä¸ºConsumerä»kafkaé›†ç¾¤ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªtopicæ‹‰å–æ¶ˆæ¯</li><li>Stream APIï¼šå…è®¸Appä½œä¸ºæµå¤„ç†å™¨ï¼Œä»ä¸€ä¸ªæˆ–å¤šä¸ªtopicä¸­æ¶ˆè´¹è¾“å…¥æµå¹¶è½¬åŒ–ä¸ºè¾“å‡ºæµ</li><li>Connector APIï¼šå…è®¸å°†ç°æœ‰çš„åº”ç”¨ç¨‹åºæˆ–å­˜å‚¨ç³»ç»Ÿè¿æ¥åˆ°kafkaçš„topicï¼Œå……å½“Produceræˆ–Consumer</li><li>Admin APIï¼šå…è®¸ç®¡ç†å’Œæ£€æŸ¥topicã€brokerå’Œkafkaçš„å…¶ä»–å†…å®¹</li></ul><img src="/images/kafka-apis.png" alt="img" style="zoom:50%;"><h3 id="é‡è¦é…ç½®å‚æ•°"><a class="markdownIt-Anchor" href="#é‡è¦é…ç½®å‚æ•°"></a> é‡è¦é…ç½®å‚æ•°</h3><p>kafkaçš„å‚æ•°é…ç½®æ–‡ä»¶æ˜¯server.properties</p><ul><li><a href="http://broker.id" target="_blank" rel="noopener">broker.id</a>ï¼šæ¯ä¸ªbrokeréƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œå°±åƒæ˜¯MySQLè¡¨ä¸­çš„ä¸»é”®IDï¼Œé»˜è®¤å€¼æ˜¯0ï¼Œè¿™ä¸ªå€¼åœ¨kafkaé›†ç¾¤ä¸­å¿…é¡»æ˜¯å”¯ä¸€ä¸å¯é‡å¤çš„ï¼Œå€¼éšæ„è®¾ç½®ã€‚</li><li>portï¼škafka brokerçš„é»˜è®¤ç«¯å£æ˜¯9092ï¼Œè‹¥æœªæŒ‡å®športå‚æ•°ï¼Œåˆ™å°±æ˜¯9092ï¼Œä¿®æ”¹portå‚æ•°å¯ä»¥æ˜¯ä»»æ„ç«¯å£ï¼Œä½†æ˜¯æœ€å¥½ä¸è¦ä½äº1024ï¼Œä¸ç„¶å°±éœ€è¦ç®¡ç†å‘˜æƒé™å¯åŠ¨äº†</li><li>zookeeper.connectï¼šè®¾ç½®brokeræºæ•°æ®çš„Zookeeperåœ°å€ï¼Œå‚æ•°çš„å€¼å¯ä»¥è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œå¤šä¸ªzké€šè¿‡é€—å·åˆ†éš”ï¼Œæ¯”å¦‚<code>zk1:port,zk2:port,zk3:port</code>ï¼Œä¸åŒçš„kafkaé›†ç¾¤å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªzké›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šzkçš„å…·ä½“pathæ¥åŒºåˆ†æ¯ä¸ªkafkaçš„ä½¿ç”¨ï¼Œæ¯”å¦‚kafka cluster1ä½¿ç”¨<code>zk:port/path1</code>ï¼Œkafka cluster2ä½¿ç”¨<code>zk:port/path2</code>ã€‚</li><li><a href="http://zookeeper.connection.timeout.ms" target="_blank" rel="noopener">zookeeper.connection.timeout.ms</a>ï¼šè®¾ç½®brokerè¿æ¥Zookeeperçš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</li><li>log.dirsï¼škafkaæŠŠæ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¿å­˜åœ¨æœ¬åœ°ç£ç›˜ä¸Šï¼Œä¿å­˜çš„æ—¥å¿—åœ°å€é€šè¿‡è¯¥å‚æ•°æŒ‡å®šï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªå­˜å‚¨ç›®å½•ï¼Œé€šè¿‡é€—å·åˆ†éš”ï¼Œä¾‹å¦‚<code>/home/kafka/1,/home/kafka/2,/home/kafka/3</code></li><li>auto.create.topic.enableï¼šé»˜è®¤ä¸ºtrueï¼Œå…è®¸éšæ„çš„åˆ›å»ºtopicï¼Œå‚æ•°ä¸ºtrueæ—¶ï¼Œä½¿ç”¨Producerå¾€ä¸€ä¸ªä¸å­˜åœ¨çš„topicå‘é€æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºtopicã€ä½¿ç”¨Consumerä»ä¸€ä¸ªä¸å­˜åœ¨çš„topicæ‹‰å–æ¶ˆæ¯æ—¶è‡ªåŠ¨åˆ›å»ºtopicã€ä¸»åŠ¨åˆ›å»ºtopicã€å½“ä»»æ„ä¸€ä¸ªå®¢æˆ·ç«¯å‘topicå‘é€å…ƒæ•°æ®è¯·æ±‚æ—¶ã€‚æ­¤å€¼å»ºè®®åœ¨ç”Ÿäº§ä¸Šè®¾ç½®ä¸ºfalseï¼Œtopicç”±äººå·¥è¿›è¡Œåˆ†é…ï¼Œé˜²æ­¢ç”Ÿäº§ç¯å¢ƒå‡ºç°å„ç§ä¹±ä¸ƒå…«ç³Ÿçš„topicã€‚</li><li>topicç›¸å…³å‚æ•°<ul><li>num.partitionsï¼šä¸»é¢˜æ‹¥æœ‰çš„Partitionæ•°é‡ï¼Œè‹¥åœ¨åˆ›å»ºtopicçš„æ—¶å€™æœªæŒ‡å®šåˆ†åŒºæ•°é‡ï¼Œåˆ™ä½¿ç”¨è¯¥å‚æ•°çš„å€¼ï¼Œé»˜è®¤ä¸º1ã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆ†åŒºæ•°é‡å¯ä»¥å¢åŠ ä¸èƒ½å‡å°‘ï¼Œåœ¨åˆ›å»ºæ—¶å¯ä»¥é€šè¿‡<code>--partition</code>æŒ‡å®šä¸ªæ•°</li><li>default.replication.factorï¼škafkaæ¶ˆæ¯çš„é»˜è®¤å‰¯æœ¬æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œåªæœ‰åœ¨è‡ªåŠ¨åˆ›å»ºtopicçš„æ—¶å€™æ‰æœ‰æ•ˆï¼Œåœ¨åˆ›å»ºæ—¶å¯ä»¥é€šè¿‡<code>--replication-factor</code>æŒ‡å®š</li><li>log.cleaner.enableï¼šæ˜¯å¦å¼€å¯æ—¥å¿—æ¸…ç†åŠŸèƒ½ï¼Œé»˜è®¤ä¸ºtrueï¼Œæ¸…ç†æ–¹å¼æœ‰æ—¶é—´å’Œæ—¥å¿—æ–‡ä»¶å¤§å°ä¸¤ç§æ–¹å¼</li><li>log.retention.hoursï¼šè®¾ç½®kafkaæ¶ˆæ¯ä¿å­˜çš„æ—¶é—´ï¼Œé»˜è®¤ä¸º168ä¸ªå°æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡<code>log.retention.ms</code>å’Œ<code>log.retention.minutes</code>æ¥è®¾ç½®æ¸…ç†æ—¶é—´çš„æ¯«ç§’å’Œåˆ†é’Ÿæ—¶é—´</li><li>log.retention.bytesï¼šè®¾ç½®topicçš„æ¯ä¸ªPartitionæ‰€èƒ½ä¿å­˜çš„æ•°æ®é‡ï¼Œæ¯”å¦‚è‹¥ä¸€ä¸ªtopicæœ‰10ä¸ªPartitionï¼Œæ­¤å‚æ•°çš„å€¼ä¸º1Gï¼Œé‚£ä¹ˆè¯¥topicçš„æœ€å¤§å­˜å‚¨å®¹é‡ä¸º8Gï¼Œtopicçš„å®¹é‡éšç€Partitionçš„å¢åŠ è€Œå¢åŠ ã€‚</li><li>log.segment.bytesï¼šè®¾ç½®æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§çš„å®¹é‡å¤§å°ã€‚å½“æ¶ˆæ¯åˆ°è¾¾brokeræ—¶ï¼Œä¼šè¢«è¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯å¦‚æœæ—¥å¿—ç‰‡æ®µçš„å½“å‰å¤§å°åŠ ä¸Šæ–°æ¥æ”¶æ¶ˆæ¯çš„æ‰“å°åè¶…è¿‡äº†è¯¥å‚æ•°è®¾ç½®çš„å€¼ï¼Œåˆ™å°†æ–°æ¶ˆæ¯å’Œåç»­çš„æ¶ˆæ¯å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚è¯¥å‚æ•°çš„å€¼è¶Šå°ï¼Œåˆ†å‰²çš„æ–‡ä»¶å°±è¶Šå¤šï¼Œç£ç›˜çš„å†™å…¥æ•ˆç‡å°±è¶Šä½ã€‚</li><li><a href="http://log.segment.ms" target="_blank" rel="noopener">log.segment.ms</a>ï¼šé™¤äº†å¾…æ—¥å¿—æ–‡ä»¶å¤§å°è¶…å€¼åé‡æ–°åˆ†é…æ–°æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡æ—¥å¿—åˆ›å»ºæ—¶é—´æ¥æ§åˆ¶æ¶ˆæ¯æ—¥å¿—æ–‡ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥å’Œ<code>log.segment.bytes</code>åŒæ—¶è®¾ç½®ï¼Œå“ªä¸€ä¸ªå…ˆè¾¾æ ‡ä½¿ç”¨å“ªä¸€ä¸ªç­–ç•¥ï¼Œæ¯”å¦‚bytesè®¾ç½®ä¸º1Gï¼Œmsè®¾ç½®ä¸º1å°æ—¶ï¼Œè‹¥30åˆ†é’Ÿå†…æ–‡ä»¶å®¹é‡å·²è¾¾1Gï¼Œåˆ™åç»­æ¶ˆæ¯å†™å…¥åˆ°æ–°çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè‹¥1å°æ—¶å†…æ—¥å¿—æ–‡ä»¶å°šæœªè¾¾åˆ°1Gï¼Œåˆ™ä¹Ÿåˆ†é…æ–°çš„æ—¥å¿—æ–‡ä»¶è®°å½•åç»­çš„æ¶ˆæ¯ã€‚</li><li><a href="http://log.retention.check.interval.ms" target="_blank" rel="noopener">log.retention.check.interval.ms</a>ï¼šæ£€æŸ¥æ—¥å¿—æ®µä»¥æŸ¥çœ‹æ˜¯å¦å¯ä»¥æ ¹æ®ä¿ç•™ç­–ç•¥åˆ é™¤å®ƒä»¬çš„æ—¶é—´é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’</li><li>message.max.bytesï¼šè¯¥å‚æ•°é™å®šbrokerå¯æ¥æ”¶çš„å•ä¸ªæ¶ˆæ¯çš„å¤§å°ï¼Œé»˜è®¤æ˜¯1MBï¼Œå¦‚æœProducerå‘é€çš„æ¶ˆæ¯å¤§äºæ­¤å€¼ï¼Œåˆ™brokerä¼šç›´æ¥æ‹’ç»å¹¶è¿”å›é”™è¯¯ã€‚è¯¥å‚æ•°æŒ‡å®šçš„æ˜¯å‹ç¼©åçš„æ¶ˆæ¯å¤§å°ï¼Œæ¶ˆæ¯çš„å®é™…å¤§å°å¯èƒ½å¤§äºæ­¤å€¼ã€‚</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;åŸºæœ¬åè¯&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#åŸºæœ¬åè¯&quot;&gt;&lt;/a&gt; åŸºæœ¬åè¯&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;æ¶ˆæ¯ï¼škafkaä¸­çš„æ•°æ®å•å…ƒç§°ä¸ºæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥å«è®°å½•ï¼Œç›¸å½“äºMySQLè¡¨ä¸­çš„ä¸€æ¡è®°å½•&lt;/li&gt;
&lt;li&gt;æ‰¹æ¬¡ï¼šä¸ºäº†æé«˜æ•ˆç‡
      
    
    </summary>
    
    
      <category term="Kafka" scheme="http://luxiaowan.github.io/categories/Kafka/"/>
    
    
  </entry>
  
</feed>
