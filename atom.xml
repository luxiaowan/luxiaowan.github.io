<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ä¸²ä¸€ä¸²</title>
  
  <subtitle>æ–­èˆç¦»</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://luxiaowan.github.io/"/>
  <updated>2020-05-28T09:38:56.730Z</updated>
  <id>http://luxiaowan.github.io/</id>
  
  <author>
    <name>cc</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>çº¿ç¨‹æ± ä¸­è¿è¡Œçš„çº¿ç¨‹ï¼Œå½“ç­‰å¾…é˜Ÿåˆ—æœªæ»¡çš„æƒ…å†µä¸‹ï¼Œä¸€å®šä¸å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°å—</title>
    <link href="http://luxiaowan.github.io/2020/05/28/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BA%BF%E7%A8%8B%EF%BC%8C%E5%BD%93%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97%E6%9C%AA%E6%BB%A1%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%B8%80%E5%AE%9A%E4%B8%8D%E5%A4%A7%E4%BA%8E%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E6%95%B0%E5%90%97/"/>
    <id>http://luxiaowan.github.io/2020/05/28/çº¿ç¨‹æ± ä¸­è¿è¡Œçš„çº¿ç¨‹ï¼Œå½“ç­‰å¾…é˜Ÿåˆ—æœªæ»¡çš„æƒ…å†µä¸‹ï¼Œä¸€å®šä¸å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°å—/</id>
    <published>2020-05-28T03:17:00.000Z</published>
    <updated>2020-05-28T09:38:56.730Z</updated>
    
    <content type="html"><![CDATA[<p>é€šè¿‡<a href="https://luxiaowan.github.io/2020/05/27/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%86%85%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%8A%9B%E5%BC%82%E5%B8%B8%EF%BC%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BC%9A%E6%80%8E%E4%B9%88%E5%8A%9E/">ã€Šçº¿ç¨‹æ± å†…è¿è¡Œçš„çº¿ç¨‹æŠ›å¼‚å¸¸ï¼Œçº¿ç¨‹æ± ä¼šæ€ä¹ˆåŠã€‹</a>äº†è§£åˆ°å½“çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œä¼šå°†å½“å‰çº¿ç¨‹ç§»å‡ºçº¿ç¨‹æ± ï¼Œå¹¶æ–°å¢ä¸€ä¸ªçº¿ç¨‹åˆ°çº¿ç¨‹æ± ä¸­ï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹çº¿ç¨‹æ± çš„è¿è¡ŒåŸç†ï¼š</p><img src="/images/tpe-process.png" alt="tpe-process" style="zoom:50%;"><p>ä»åŸç†å›¾ä¸­å¯ä»¥çœ‹åˆ°åªæœ‰å½“é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œæ‰ä¼šå»åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œæ–°åŠ å…¥çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆåˆ°åº•æœ‰æ²¡æœ‰å¯èƒ½å‡ºç°é˜Ÿåˆ—æœªæ»¡ï¼Œ ä½†æ˜¯è¿è¡Œä¸­çš„çº¿ç¨‹ä¸ªæ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Ÿ</p><p>ç†è®ºä¸Šåº”è¯¥æ˜¯ä¸å¯èƒ½å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰æ„å¤–å‘¢ï¼Ÿç­”æ¡ˆæš‚æ—¶ä¸æ­æ™“ï¼Œæˆ‘ä»¬å…ˆå¾€ä¸‹çœ‹ï¼Œå†™å‡ ä¸ªdemoæµ‹è¯•ä¸€ä¸‹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">30</span>), r -&gt; &#123;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line">t.setUncaughtExceptionHandler((t1, e) -&gt; System.out.println(t1.hashCode() + <span class="string">", "</span> + t1.getName() + <span class="string">" "</span> + <span class="string">"å‘ç”Ÿäº†å¼‚å¸¸"</span>));</span><br><span class="line"><span class="keyword">return</span> t;</span><br><span class="line">&#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> finalI = i;</span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      System.out.println(Thread.currentThread().hashCode() + <span class="string">": "</span> + pool.getQueue().size() + <span class="string">", "</span> + (<span class="number">10</span> / finalI));</span><br><span class="line">    &#125;);</span><br><span class="line">    pool.execute(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿è¡Œç»“æœ</p><p>â€‹ç¬¬ä¸€åˆ—ä¸ºçº¿ç¨‹hashcodeï¼Œç¬¬äºŒåˆ—ä¸ºé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸ªæ•°ï¼Œç¬¬ä¸‰åˆ—ä¸ºè®¡ç®—æ•°å­—</p></blockquote><img src="/images/image-20200528132623899.png" alt="image-20200528132623899" style="zoom:50%;"><p>ä»æ§åˆ¶å°çš„è¾“å‡ºèƒ½çœ‹åˆ°ä¸€å…±å‡ºç°äº†4ä¸ªä¸åŒçš„hashcodeï¼Œä¹Ÿå°±è¡¨ç¤ºåˆ›å»ºè¿‡4ä¸ªçº¿ç¨‹ï¼Œç„¶åçº¿ç¨‹1869318657æ‰§è¡Œä»»åŠ¡æ—¶å‡ºç°äº†å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯é™¤0å¼‚å¸¸ï¼Œç„¶åå°†å…¶ä»çº¿ç¨‹æ± ä¸­ç§»å‡ºï¼Œåç»­ä¸å†è¿›è¡Œä»»åŠ¡å¤„ç†ã€‚ä»ä¹‹å‰çš„æ–‡ç« ä¸­æˆ‘ä»¬çŸ¥é“å°†å¼‚å¸¸çš„çº¿ç¨‹ç§»é™¤ä¹‹åä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­ï¼Œé‚£ä¹ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± ç§»é™¤ä¸€ä¸ªå†åŠ å…¥ä¸€ä¸ªï¼Œæ•°é‡åº”è¯¥ä¸å˜ï¼Œä½†æ˜¯ä»ä¸‹é¢çš„è¾“å‡ºçœ‹åˆ°è¿™æ—¶åŒæ—¶æœ‰3ä¸ªçº¿ç¨‹åœ¨å¤„ç†ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯2ï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°3ï¼Ÿ</p><p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹ä»»åŠ¡å‘ç”Ÿå¼‚å¸¸æ—¶çš„åç»­å¤„ç†ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä»runWorkeræ–¹æ³•ä¸­ä¼ è¿‡æ¥çš„æ˜¯trueï¼Œæ‰€ä»¥è¿™å¥ç›®å‰ç‰ˆæœ¬ä¸­å¿…å®šä¼šè¢«æ‰§è¡Œåˆ°</span></span><br><span class="line">  <span class="comment">// ä½œç”¨æ˜¯å°†å½“å‰çº¿ç¨‹æ± ä¸­çš„æœ‰æ•ˆçº¿ç¨‹æ•°-1ï¼Œæ„æ€ä¹Ÿå°±æ˜¯å‡ºç°å¼‚å¸¸çš„çº¿ç¨‹ä¼šè¢«ä»çº¿ç¨‹æ± ä¸­æ‹¿æ‰</span></span><br><span class="line">  <span class="comment">// ä¸ºä»€ä¹ˆè¯´æ˜¯å‡ºç°å¼‚å¸¸çš„çº¿ç¨‹ä¼šè¢«æ‹¿æ‰å‘¢ï¼Ÿå› ä¸ºåœ¨tryå†…éƒ¨æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œé™¤éå…³é—­æ ¸å¿ƒçº¿ç¨‹æˆ–è¿è¡Œä¸­çº¿ç¨‹å‡ºç°å¼‚å¸¸ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (completedAbruptly)</span><br><span class="line">    decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">  mainLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ›´æ–°å®Œæˆçš„ä»»åŠ¡æ•°ï¼Œåªè¦æ˜¯è¢«çº¿ç¨‹æ± çº¿ç¨‹æ‰§è¡Œè¿‡çš„ï¼Œä¸ç®¡æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œéƒ½è¢«è®¤ä¸ºæ˜¯æ‰§è¡ŒæˆåŠŸçš„ä»»åŠ¡</span></span><br><span class="line">    completedTaskCount += w.completedTasks;</span><br><span class="line">    <span class="comment">// å°†å½“å‰Workerçº¿ç¨‹ä»çº¿ç¨‹æ± ä¸­ç§»é™¤é”€æ¯</span></span><br><span class="line">    workers.remove(w);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    mainLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tryTerminate();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€ç³»åˆ—åˆ¤æ–­ï¼Œä¸»è¦æ˜¯åˆ¤æ–­æ˜¯å¦ç¬¦åˆç»™çº¿ç¨‹æ± åˆ›å»ºæ–°çš„çº¿ç¨‹</span></span><br><span class="line">  <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">  <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ ¸å¿ƒçº¿ç¨‹å…è®¸è¶…æ—¶å›æ”¶ï¼Œåˆ™ä¸å»åˆ›å»ºçº¿ç¨‹ï¼Œå› ä¸ºæœ‰æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">      <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">      <span class="comment">// å¦‚æœæ ¸å¿ƒçº¿ç¨‹å¯ä»¥è¢«å›æ”¶ï¼Œä½†æ˜¯å½“å‰é˜»å¡é˜Ÿåˆ—ä¸­ä¸ä¸ºç©ºæ—¶ï¼Œåˆ›å»º1ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">      <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">        min = <span class="number">1</span>;</span><br><span class="line">      <span class="comment">// æ ¡éªŒå½“å‰è¿è¡Œçš„çº¿ç¨‹æ˜¯å¦å¤§äºå…è®¸è¿è¡Œçš„çº¿ç¨‹æ•°ï¼Œæ¯”å¦‚æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘ ...</span></span><br><span class="line">    <span class="comment">// ç»™çº¿ç¨‹æ± åˆ›å»ºæ–°çš„çº¿ç¨‹</span></span><br><span class="line">    addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°åœ¨åˆ›å»ºæ–°çº¿ç¨‹æ—¶ï¼Œä¼šè¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­ï¼Œè‹¥åˆ¤æ–­å…¨éƒ¨é€šè¿‡ï¼Œå°±ä¼šå»ç»™çº¿ç¨‹æ± çš„æ± å­ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™é‡Œä¼ å…¥çš„coreå‚æ•°æ˜¯falseï¼Œä¹Ÿå°±æ˜¯å½“æˆéæ ¸å¿ƒçº¿ç¨‹æ¥åˆ›å»ºï¼Œéš¾é“é—®é¢˜å‡ºåœ¨è¿™é‡Œï¼Ÿå¦‚æœæˆ‘æ­¤æ—¶è¿è¡Œçš„çº¿ç¨‹æ•°å°äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå†åŠ è¿›æ¥ä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹addWorker()æ–¹æ³•çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// gotoè¯­æ³•</span></span><br><span class="line">  retry:</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">    <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">        ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">           firstTask == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">           ! workQueue.isEmpty()))</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">      <span class="comment">// åˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹ä¸ªæ•°æ˜¯å¦è¶…è¿‡äº†æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">          wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">        <span class="keyword">break</span> retry;</span><br><span class="line">      c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">      <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">        <span class="keyword">continue</span> retry;</span><br><span class="line">      <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...åˆ›å»ºçº¿ç¨‹...</span></span><br><span class="line">  <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æ–¹æ³•addWorker()çš„æºç ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬å‚æ•°coreä¼ ä¸€ä¸ªfalseè¿›æ¥æ—¶ï¼Œä¼šå»æ ¡éªŒå½“å‰å·¥ä½œä¸­çš„çº¿ç¨‹ä¸ªæ•°æ˜¯å¦è¶…è¿‡äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡çš„è¯åˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™é‡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><p>åœ¨æ–¹æ³•processWorkerExit()ä¸­ï¼Œæˆ‘ä»¬å¯¹æ ¸å¿ƒçº¿ç¨‹æ•°è¿›è¡Œçš„æ¯”è¾ƒï¼Œä½†æ˜¯å¦‚æœåœ¨â‘ å¤„æœ‰æ–°çš„ä»»åŠ¡è°ƒç”¨execute()è¿›æ¥ï¼Œåˆ™å‘ç°å·¥ä½œçº¿ç¨‹æœªè¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå»åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œåˆ›å»ºä¹‹åï¼Œçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹å°±æœ‰2ä¸ªäº†ï¼Œç„¶åæˆ‘ä»¬ä»processWorkerExit()ä¸­ä¼ è¿‡æ¥çš„è¯·æ±‚ä¼šå»æ ¡éªŒå·¥ä½œçº¿ç¨‹ä¸ªæ•°æ˜¯å¦è¶…è¿‡äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œåœ¨æˆ‘ä»¬çš„demoä»£ç ä¸­æ˜¯è‚¯å®šä¸ä¼šè¶…è¿‡çš„ï¼Œé‚£ä¹ˆå°±åˆä¼šå»åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ”¾åˆ°çº¿ç¨‹æ± ä¸­ï¼Œè¿™æ ·çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹å°±æœ‰3ä¸ªäº†ï¼Œå…·ä½“æµç¨‹å›¾å¦‚ä¸‹</p><table><thead><tr><th>æ­£å¸¸æµç¨‹</th><th>å¼‚å¸¸æµç¨‹</th><th>å·¥ä½œçº¿ç¨‹æ•°</th></tr></thead><tbody><tr><td>execute()</td><td></td><td>0</td></tr><tr><td>â€”addWorker()</td><td></td><td>1</td></tr><tr><td>execute()</td><td></td><td>1</td></tr><tr><td>â€”addWorker()</td><td></td><td>2</td></tr><tr><td></td><td>processWorkerExit()</td><td>2</td></tr><tr><td></td><td>â€”remove()</td><td>1</td></tr><tr><td>execute()</td><td></td><td>1</td></tr><tr><td>â€”addWorker()</td><td></td><td>2</td></tr><tr><td></td><td>â€”addWorker()</td><td>3</td></tr></tbody></table><blockquote><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯2ï¼Œä½†æ˜¯æœ€ç»ˆè¿è¡Œä¸­çš„çº¿ç¨‹ä¸ªæ•°æ˜¯3çš„åŸå› </p></blockquote><hr><h4 id="åœºæ™¯"><a class="markdownIt-Anchor" href="#åœºæ™¯"></a> ğŸŒ°åœºæ™¯</h4><ol><li><p>ä»»åŠ¡å°šæœªå…¨éƒ¨è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—æœªæ»¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">30</span>), r -&gt; &#123;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line">t.setUncaughtExceptionHandler((t1, e) -&gt; System.out.println(t1.hashCode() + <span class="string">", "</span> + t1.getName() + <span class="string">" "</span> + <span class="string">"å‘ç”Ÿäº†å¼‚å¸¸"</span>));</span><br><span class="line"><span class="keyword">return</span> t;</span><br><span class="line">&#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> finalI = i;</span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      System.out.println(Thread.currentThread().hashCode() + <span class="string">": "</span> + pool.getQueue().size() + <span class="string">", "</span> + (<span class="number">10</span> / finalI));</span><br><span class="line">    &#125;);</span><br><span class="line">    pool.execute(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/images/image-20200528132623899.png" alt="image-20200528132623899" style="zoom:50%;"><p>è¿™ä¸ªä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è·‘çš„demoï¼Œå·¥ä½œçº¿ç¨‹ä¸ªæ•°è¶…å‡ºäº†æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚</p></li><li><p>ä»»åŠ¡å·²ç»å…¨éƒ¨è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">30</span>), r -&gt; &#123;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line">t.setUncaughtExceptionHandler((t1, e) -&gt; System.out.println(t1.hashCode() + <span class="string">", "</span> + t1.getName() + <span class="string">" "</span> + <span class="string">"å‘ç”Ÿäº†å¼‚å¸¸"</span>));</span><br><span class="line"><span class="keyword">return</span> t;</span><br><span class="line">&#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> finalI = i;</span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (finalI &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// å‰ä¸¤ä¸ªçº¿ç¨‹ç­‰å¾…500æ¯«ç§’ï¼Œä¿è¯æ‰€æœ‰çš„ä»»åŠ¡éƒ½è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">          Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(</span><br><span class="line">        Thread.currentThread().hashCode() + <span class="string">": "</span> + pool.getQueue().size() + <span class="string">", "</span> + (<span class="number">10</span> / (finalI - <span class="number">4</span>)));</span><br><span class="line">    &#125;);</span><br><span class="line">    pool.execute(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/images/image-20200528170037838.png" alt="image-20200528170037838" style="zoom:50%;"><p>æˆ‘ä»¬çœ‹åˆ°å½“çº¿ç¨‹æ± å¼€å§‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå·²ç»æŠŠå‰©ä½™çš„28ä¸ªä»»åŠ¡éƒ½æ”¾åˆ°é˜Ÿåˆ—ä¸­äº†ï¼Œçº¢è‰²å’Œè“è‰²ä¸‹åˆ’çº¿çš„çº¿ç¨‹æ˜¯åˆå§‹çº¿ç¨‹ï¼Œå½“873å‡ºç°å¼‚å¸¸åï¼Œå°†å…¶ç§»å‡ºçº¿ç¨‹æ± ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å‰©ä½™ä»»åŠ¡ï¼Œå› ä¸ºè¿™æ—¶æ‰€æœ‰çš„ä»»åŠ¡éƒ½åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«æ‰§è¡Œï¼Œexecute()æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ï¼Œæ‰€ä»¥è¿™ç§åœºæ™¯ä¸‹ï¼Œå·¥ä½œä¸­çš„çº¿ç¨‹ä¸ªæ•°ä¸ä¼šè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚</p></li><li><p>ä»»åŠ¡å°šæœªå…¨éƒ¨è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—å·²æ»¡ï¼Œæœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">30</span>), r -&gt; &#123;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line">t.setUncaughtExceptionHandler((t1, e) -&gt; System.out.println(t1.hashCode() + <span class="string">", "</span> + t1.getName() + <span class="string">" "</span> + <span class="string">"å‘ç”Ÿäº†å¼‚å¸¸"</span>));</span><br><span class="line"><span class="keyword">return</span> t;</span><br><span class="line">&#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">34</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> finalI = i;</span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (finalI &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// ç­‰å¾…ä»»åŠ¡å…¨éƒ¨è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¸”åˆ›å»ºå®Œé¢å¤–çº¿ç¨‹æ¥æ”¶å¤šå‡ºæ¥çš„ä¸¤ä¸ªä»»åŠ¡</span></span><br><span class="line">          Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(Thread.currentThread().hashCode() + <span class="string">": "</span> + pool.getQueue().size() + <span class="string">", "</span></span><br><span class="line">                         + pool.getActiveCount() + <span class="string">", "</span> + (<span class="number">10</span> / (finalI - <span class="number">33</span>)));</span><br><span class="line">    &#125;);</span><br><span class="line">    pool.execute(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿è¡Œç»“æœ</p><p>â€‹ç¬¬ä¸€åˆ—ä¸ºçº¿ç¨‹hashcodeï¼Œç¬¬äºŒåˆ—ä¸ºé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸ªæ•°ï¼Œç¬¬ä¸‰åˆ—ä¸ºå½“å‰çš„å·¥ä½œçº¿ç¨‹ä¸ªæ•°ï¼Œç¬¬å››åˆ—ä¸ºè®¡ç®—æ•°å­—</p></blockquote><img src="/images/image-20200528173106691.png" alt="image-20200528173106691" style="zoom:67%;"><p>ä»ç»“æœä¸­æˆ‘ä»¬çœ‹åˆ°åˆ›å»ºäº†4ä¸ªå·¥ä½œçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œå½“çº¿ç¨‹230æ‰§è¡Œå¼‚å¸¸ä¹‹åï¼Œåˆ›å»ºäº†çº¿ç¨‹734ç»§ç»­æ‰§è¡Œï¼Œçº¿ç¨‹ä¸ªæ•°æœªè¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°</p></li><li><p>ä»»åŠ¡å°šæœªå…¨éƒ¨è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—å·²æ»¡ï¼Œè¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°</p><p>è¿™ç§æƒ…å†µå°±ä¼šä¾æ®æ‹’ç»ç­–ç•¥æ‰§è¡Œç›¸å…³çš„ä»£ç é€»è¾‘ï¼Œçº¿ç¨‹æ•°ä¸ä¼šè¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°</p></li></ol><hr><h4 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h4><p>ä»ä»¥ä¸Šåˆ†ææˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œåªæœ‰åœ¨ï¼šä»»åŠ¡å°šæœªå…¨éƒ¨è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ä¸”é˜Ÿåˆ—æœªæ»¡çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šå‡ºç°å·¥ä½œçº¿ç¨‹ä¸ªæ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­ï¼Œå¾…æ‰§è¡Œçš„ä»»åŠ¡å°½é‡æ•è·æ‰€æœ‰çš„å¼‚å¸¸æƒ…å†µï¼Œä¸è¦å°†å…¶æŠ›å‡ºåˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹é‡Œã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;é€šè¿‡&lt;a href=&quot;https://luxiaowan.github.io/2020/05/27/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%86%85%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%8A
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹æ± å†…è¿è¡Œçš„çº¿ç¨‹æŠ›å¼‚å¸¸ï¼Œçº¿ç¨‹æ± ä¼šæ€ä¹ˆåŠ</title>
    <link href="http://luxiaowan.github.io/2020/05/27/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%86%85%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%8A%9B%E5%BC%82%E5%B8%B8%EF%BC%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BC%9A%E6%80%8E%E4%B9%88%E5%8A%9E/"/>
    <id>http://luxiaowan.github.io/2020/05/27/çº¿ç¨‹æ± å†…è¿è¡Œçš„çº¿ç¨‹æŠ›å¼‚å¸¸ï¼Œçº¿ç¨‹æ± ä¼šæ€ä¹ˆåŠ/</id>
    <published>2020-05-27T04:56:00.000Z</published>
    <updated>2020-05-28T09:38:46.197Z</updated>
    
    <content type="html"><![CDATA[<p>é€šè¿‡æ–‡ç« <a href="https://luxiaowan.github.io/2020/03/28/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%92%8C%E9%98%9F%E5%88%97%E4%B8%AD%E7%AD%89%E5%BE%85%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%98%AF%E5%90%8C%E4%B8%80%E4%B8%AA%E5%90%97/">ã€Šçº¿ç¨‹æ± è¿è¡Œçš„çº¿ç¨‹å’Œé˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹æ˜¯åŒä¸€ä¸ªå—ã€‹</a>æˆ‘ä»¬äº†è§£åˆ°çº¿ç¨‹æ± ä¸­å®é™…è¿è¡Œçš„æ˜¯çº¿ç¨‹æ± è‡ªèº«çš„çº¿ç¨‹ï¼Œåªæ˜¯åœ¨runWorkeræ–¹æ³•ä¸­è°ƒç”¨äº†æˆ‘ä»¬ä¼ é€’è¿›å…¥Runnableå¯¹è±¡çš„run()æ–¹æ³•ï¼Œé‚£ä¹ˆå¦‚æœrun()æ–¹æ³•ä¸­å‡ºç°å¼‚å¸¸äº†ï¼Œé‚£ä¹ˆè¦æ€ä¹ˆå¤„ç†ï¼Ÿä¼šä¸ä¼šå°†æˆ‘ä»¬çš„çº¿ç¨‹æ± åœæ‰ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹runWorker()æ–¹æ³•çš„å…·ä½“é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">  Thread wt = Thread.currentThread();</span><br><span class="line">  Runnable task = w.firstTask;</span><br><span class="line">  w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">  w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">  <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      w.lock();</span><br><span class="line">      <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">           (Thread.interrupted() &amp;&amp;</span><br><span class="line">            runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">          !wt.isInterrupted())</span><br><span class="line">        wt.interrupt();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        beforeExecute(wt, task);</span><br><span class="line">        Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          task.run();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">          thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">          thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">          thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          afterExecute(task, thrown);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        task = <span class="keyword">null</span>;</span><br><span class="line">        w.completedTasks++;</span><br><span class="line">        w.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    processWorkerExit(w, completedAbruptly);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨ç”¨æˆ·Runnableå®ä¾‹æ–¹æ³•run()çš„æ—¶å€™ï¼Œè¿›è¡Œäº†tryâ€¦catchâ€¦finallyï¼Œä½†æ˜¯åœ¨catch()ä¸­æ˜¯ç›´æ¥å°†å¼‚å¸¸æŠ›å‡ºäº†ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¶æœªåœ¨whileå¾ªç¯å†…æ¶ˆåŒ–æ‰ï¼Œè€Œæ˜¯æŠ›å‡ºç»™å¤–å±‚ï¼Œè¿™æ—¶ä¼šå°†whileå¾ªç¯ç»ˆæ­¢æ‰ï¼Œç„¶ååœ¨å¤–å±‚çš„tryâ€¦finallyä¸­å¹¶æœªæ•è·å†…éƒ¨ä¼ å‡ºçš„å¼‚å¸¸ï¼Œæ‰€ä»¥å¼‚å¸¸ä¿¡æ¯ä¼šç»§ç»­å¾€ä¸ŠæŠ›å‡ºï¼Œæˆ‘ä»¬æ¥å…³æ³¨ä¸€ä¸‹è¿™ä¸¤å±‚tryçš„finallyä»£ç å—ï¼Œå†…éƒ¨çš„finallyä¸­æ‰§è¡Œäº†ä¸€ä¸ªç©ºçš„æ–¹æ³•afterExecute()ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç•™ç»™æˆ‘ä»¬è‡ªå®šä¹‰çº¿ç¨‹æ± æ—¶ä½¿ç”¨çš„ï¼Œå’ŒbeforeExecute()æ–¹æ³•ä¸€æ ·ï¼Œæ—¢ç„¶æ˜¯ç©ºæ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±å…ˆä¸ç”¨å»çœ‹å®ƒäº†ï¼Œæ¥çœ‹ä¸‹å¤–å±‚çš„finallyä»£ç å—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä»runWorkeræ–¹æ³•ä¸­ä¼ è¿‡æ¥çš„æ˜¯trueï¼Œæ‰€ä»¥è¿™å¥ç›®å‰ç‰ˆæœ¬ä¸­å¿…å®šä¼šè¢«æ‰§è¡Œåˆ°</span></span><br><span class="line">  <span class="comment">// ä½œç”¨æ˜¯å°†å½“å‰çº¿ç¨‹æ± ä¸­çš„æœ‰æ•ˆçº¿ç¨‹æ•°-1ï¼Œæ„æ€ä¹Ÿå°±æ˜¯å‡ºç°å¼‚å¸¸çš„çº¿ç¨‹ä¼šè¢«ä»çº¿ç¨‹æ± ä¸­æ‹¿æ‰</span></span><br><span class="line">  <span class="comment">// ä¸ºä»€ä¹ˆè¯´æ˜¯å‡ºç°å¼‚å¸¸çš„çº¿ç¨‹ä¼šè¢«æ‹¿æ‰å‘¢ï¼Ÿå› ä¸ºåœ¨tryå†…éƒ¨æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œé™¤éå…³é—­æ ¸å¿ƒçº¿ç¨‹æˆ–è¿è¡Œä¸­çº¿ç¨‹å‡ºç°å¼‚å¸¸ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (completedAbruptly)</span><br><span class="line">    decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">  mainLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ›´æ–°å®Œæˆçš„ä»»åŠ¡æ•°ï¼Œåªè¦æ˜¯è¢«çº¿ç¨‹æ± çº¿ç¨‹æ‰§è¡Œè¿‡çš„ï¼Œä¸ç®¡æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œéƒ½è¢«è®¤ä¸ºæ˜¯æ‰§è¡ŒæˆåŠŸçš„ä»»åŠ¡</span></span><br><span class="line">    completedTaskCount += w.completedTasks;</span><br><span class="line">    <span class="comment">// å°†å½“å‰Workerçº¿ç¨‹ä»çº¿ç¨‹æ± ä¸­ç§»é™¤é”€æ¯</span></span><br><span class="line">    workers.remove(w);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    mainLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tryTerminate();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€ç³»åˆ—åˆ¤æ–­ï¼Œä¸»è¦æ˜¯åˆ¤æ–­æ˜¯å¦ç¬¦åˆç»™çº¿ç¨‹æ± åˆ›å»ºæ–°çš„çº¿ç¨‹</span></span><br><span class="line">  <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">  <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">      <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">      <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">        min = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»™çº¿ç¨‹æ± åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œcoreä¹‹æ‰€ä»¥ä¼ é€’falseï¼Œæ˜¯å› ä¸ºè¿™é‡Œè¦é˜²æ­¢åˆ›å»ºå¤±è´¥</span></span><br><span class="line">    addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æºç æˆ‘ä»¬çœ‹åˆ°åœ¨å¤„ç†ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœçº¿ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†è¯¥çº¿ç¨‹ä»çº¿ç¨‹æ± ä¸­ç§»é™¤é”€æ¯ï¼Œç„¶åå†æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä»»åŠ¡å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šç»ˆç»“æ‰è¿è¡Œå®ƒçš„çº¿ç¨‹ã€‚</p><blockquote><p>æˆ‘ä»¬ä»æºç ä¸­å¾—åˆ°çš„ä¿¡æ¯ï¼Œç°åœ¨æ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬çš„åˆ†æ</p></blockquote><p>éªŒè¯ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">30</span>));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> finalI = i;</span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      System.out.println(<span class="number">10</span> / finalI - <span class="number">5</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    pool.execute(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><img src="/images/image-20200527152919795.png" alt="image-20200527152919795" style="zoom:70%;"><p>æŠ›å¼‚å¸¸äº†ï¼Œä½†æ˜¯å¹¶æœªå½±å“çº¿ç¨‹æ± ä¸­çš„å…¶ä»–ä»»åŠ¡ï¼Œæˆ‘ä»¬æ‰“æ–­ç‚¹åœ¨processWorkerExit()æ–¹æ³•ä¸­ï¼Œçœ‹ä¸‹workerså˜é‡çš„æ•°æ®</p><ul><li><p>å¼‚å¸¸å‘ç”Ÿä¹‹å‰</p><p><img src="/images/image-20200527154429404.png" alt="image-20200527154429404"></p></li><li><p>å¼‚å¸¸å‘ç”Ÿä¹‹å</p><p><img src="/images/image-20200527154504520.png" alt="image-20200527154504520"></p></li></ul><p>çœ‹åˆ°åœ¨å¼‚å¸¸å‰åï¼Œçº¿ç¨‹<code>1f36e637</code>è¢«ç§»é™¤äº†ï¼Œè½¬è€Œåˆ›å»ºäº†ä¸€ä¸ª<code>7073cb62</code>æ”¾åˆ°äº†çº¿ç¨‹æ± ä¸­ï¼Œè€Œæœªå‘ç”Ÿå¼‚å¸¸çš„çº¿ç¨‹<code>578486a3</code>ä¾ç„¶å­˜åœ¨äºçº¿ç¨‹æ± ä¸­ã€‚</p><hr><blockquote><p>å°ç»“</p></blockquote><p>é€šè¿‡ç¤ºä¾‹æˆ‘ä»¬éªŒè¯äº†ä¸€ç‚¹ï¼šå½“ä»»åŠ¡å‡ºç°æœªè¢«æ•è·åˆ°çš„å¼‚å¸¸æ—¶ï¼Œä¼šå°†æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä»çº¿ç¨‹æ± ç§»é™¤å¹¶ç»“æŸæ‰ï¼Œç„¶åç§»é™¤ä¹‹ååˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ”¾å›åˆ°çº¿ç¨‹æ± ä¸­ã€‚</p><hr><p>ä¸Šé¢æˆ‘ä»¬çŸ¥é“äº†å½“çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡å‘ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶ï¼Œä¼šå°†å¼‚å¸¸ä¸€ç›´å¾€ä¸ŠæŠ›å‡ºï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½å¦åœ¨ä¸»çº¿ç¨‹ä¸­æ•è·å®ƒè¿›è¡Œå¤„ç†å‘¢ï¼Ÿæˆ‘ä»¬æ¥è¯•ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">30</span>));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> finalI = i;</span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      System.out.println(<span class="number">10</span> / finalI - <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      pool.execute(t);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      System.out.println(<span class="string">"å‘ç”Ÿäº†å¼‚å¸¸"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="/images/image-20200527165519282.png" alt="image-20200527165519282"></p><p>ç”±è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºæˆ‘ä»¬å¹¶æœªæ•è·åˆ°çº¿ç¨‹æ± ä¸­çº¿ç¨‹æŠ›å‡ºçš„å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯å¼‚å¸¸å¹¶æœªè¢«æŠ›å‡ºåˆ°ä¸»çº¿ç¨‹ä¸­ï¼Œè¿™å°±å°´å°¬äº†ï¼Œæ¯•ç«Ÿè¿™äº›å¼‚å¸¸æ˜¯å’Œä¸šåŠ¡ç›¸å…³è”çš„ï¼Œæˆ‘ä»¬å´æ— æ³•æ•è·å’Œå¤„ç†ï¼Œè¿™å’‹æ•´å‘¢ï¼Ÿ</p><p>å¿½çš„ä¸€ä¸‹ï¼Œæƒ³åˆ°äº†çº¿ç¨‹æ± çš„æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªå‚æ•°ï¼šThreadFactoryæ¥å£ï¼Œè¿™ä¸ªæ¥å£çš„ä½œç”¨æ˜¯æŒ‰éœ€åˆ›å»ºæ–°çº¿ç¨‹çš„ï¼Œä½¿ç”¨çº¿ç¨‹å·¥å‚æ¶ˆé™¤äº†å¯¹Thread#Thread(Runnable) new Threadçš„å¼ºä¾èµ–ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿä½¿ç”¨ç‰¹æ®Šçš„Threadå­ç±»ã€ä¼˜å…ˆçº§ç­‰ã€‚å¤§ç™½è¯å°±æ˜¯è®©çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹ï¼Œè¿™ä¸ªè‡ªå®šä¹‰å¯ä¸æ˜¯æˆ‘ä»¬é€šè¿‡execute()æˆ–submit()ä¼ è¿›æ¥çš„è‡ªå®šä¹‰çº¿ç¨‹ï¼Œè€Œæ˜¯Workerç±»ä¸­çš„threadå˜é‡ï¼Œä¹Ÿå°±æ˜¯å®é™…è¿è¡Œçš„çº¿ç¨‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Workerç±»çš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Worker(Runnable firstTask) &#123;</span><br><span class="line">  setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">  <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ThreadFactoryçš„newThreadæ–¹æ³•åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">  <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨çº¿ç¨‹å·¥å‚çš„newThread()æ–¹æ³•åˆ›å»ºè¿è¡Œçº¿ç¨‹ï¼Œæˆ‘ä»¬ä¸Šé¢é€šè¿‡ThreadPoolExecutorçš„æ„é€ æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± æ—¶å¹¶æœªä¼ å…¥ThreadFactoryå‚æ•°ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨é»˜è®¤çš„<code>Executors.defaultThreadFactory()</code>æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå®ƒçš„å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">  Thread t = <span class="keyword">new</span> Thread(group, r, namePrefix + threadNumber.getAndIncrement(), <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (t.isDaemon())</span><br><span class="line">    t.setDaemon(<span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)</span><br><span class="line">    t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">  <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬è¦æ˜¯æƒ³è‡ªå®šä¹‰Worker#threadçš„å€¼çš„è¯ï¼Œå°±è‡ªå®šä¹‰ä¸€ä¸ªThreadFactoryå®ç°ç±»å³å¯ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥æŠŠçº¿ç¨‹æ± åˆ›å»ºè¯­å¥å‡çº§ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">30</span>), r -&gt; &#123;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line">t.setUncaughtExceptionHandler((t1, e) -&gt; System.out.println(<span class="string">"å‘ç”Ÿäº†å¼‚å¸¸"</span>));</span><br><span class="line"><span class="keyword">return</span> t;</span><br><span class="line">&#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> finalI = i;</span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">      System.out.println(<span class="number">10</span> / finalI - <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    pool.execute(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨lambdaè¡¨è¾¾å¼æ¥åˆ›å»ºï¼Œä½¿ç”¨Thread#setUncaughtExceptionHandler()æ–¹æ³•æ¥è·å–çº¿ç¨‹å†…æœªè¢«æ•è·çš„å¼‚å¸¸ï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸‹çœ‹çœ‹ç»“æœï¼š</p><p><img src="/images/image-20200527175844897.png" alt="image-20200527175844897"></p><p>æˆåŠŸæ•è·äº†çº¿ç¨‹å†…éƒ¨å‡ºç°çš„å¼‚å¸¸ã€‚</p><hr><p>é‚£ä¹ˆç°åœ¨å°±åˆæœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼šå¦‚æœæˆ‘ä»¬ä¸»åŠ¨æ•è·å¹¶å¤„ç†çº¿ç¨‹å†…æŠ›å‡ºçš„å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹è¿˜ä¼šä»çº¿ç¨‹æ± ä¸­ç§»é™¤é”€æ¯å—ï¼Ÿ</p><p>æˆ‘ä»¬æ¥è¯•ä¸‹ï¼Œè¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„é‚£æ®µä»£ç ï¼Œç„¶åæ–­ç‚¹æ‰“åœ¨processWorkerExit()æ–¹æ³•ä¸­ï¼Œçœ‹ä¸‹æ‰§è¡Œç»“æœ</p><ul><li><p>å¼‚å¸¸ä¹‹å‰</p><p><img src="/images/image-20200527180523846.png" alt="image-20200527180523846"></p></li><li><p>å¼‚å¸¸ä¹‹å</p><p><img src="/images/image-20200527180634454.png" alt="image-20200527180634454"></p></li></ul><p>ä»æ‰§è¡Œç»“æœæ¥çœ‹ï¼Œå‘ç”Ÿå¼‚å¸¸çš„çº¿ç¨‹æ˜¯<code>35d176f7</code>ï¼Œåœ¨å¼‚å¸¸å‘ç”Ÿä¹‹ååŒæ ·ä»çº¿ç¨‹æ± ä¸­è¢«ç§»é™¤äº†ã€‚</p><hr><blockquote><p>æ€»ç»“</p></blockquote><p>å½“çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œä»»åŠ¡å‡ºç°æœªè¢«æ•è·çš„å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± ä¼šå°†å…è®¸è¯¥ä»»åŠ¡çš„çº¿ç¨‹ä»æ± ä¸­ç§»é™¤å¹¶é”€æ¯ï¼Œä¸”åŒæ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­ï¼›å¯ä»¥é€šè¿‡ThreadFactoryè‡ªå®šä¹‰çº¿ç¨‹å¹¶æ•è·çº¿ç¨‹å†…æŠ›å‡ºçš„å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´ç”­ç®¡æˆ‘ä»¬æ˜¯å¦å»æ•è·å’Œå¤„ç†çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹æŠ›å‡ºçš„å¼‚å¸¸ï¼Œè¿™ä¸ªçº¿ç¨‹éƒ½ä¼šä»çº¿ç¨‹æ± ä¸­è¢«ç§»é™¤ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;é€šè¿‡æ–‡ç« &lt;a href=&quot;https://luxiaowan.github.io/2020/03/28/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%92%8C%E9%
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>Nginxé…ç½®RabbitMQé¡µé¢bug</title>
    <link href="http://luxiaowan.github.io/2020/05/26/Nginx%E9%85%8D%E7%BD%AERabbitMQ%E9%A1%B5%E9%9D%A2bug/"/>
    <id>http://luxiaowan.github.io/2020/05/26/Nginxé…ç½®RabbitMQé¡µé¢bug/</id>
    <published>2020-05-25T19:10:00.000Z</published>
    <updated>2020-05-25T19:15:24.686Z</updated>
    
    <content type="html"><![CDATA[<p>å½“ä½¿ç”¨Nginxæ¥é…ç½®RabbitMQçš„Webé¡µé¢æ—¶ï¼ŒæŸ¥çœ‹Exchangeã€Queueå’ŒChannelsæ—¶ï¼Œé‡åˆ°äº†<code>the object you clicked on was not found it may have been deleted on the server.</code>ï¼Œç™¾æ€ä¸å¾—å…¶è§£ï¼Œæ•´ä¸ªä»£ç†éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  rabbitmq.xxx.com;</span><br><span class="line">    client_max_body_size   5m;</span><br><span class="line">    access_log acces.log;</span><br><span class="line">    error_log error.log;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-Ip $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        client_max_body_size   20m;</span><br><span class="line">        proxy_pass http://ip:port/;</span><br><span class="line"></span><br><span class="line">        port_in_redirect on;</span><br><span class="line">proxy_redirect  off;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®å¥½åƒæ²¡é—®é¢˜ï¼Œé¡µé¢ä¹Ÿå¯ä»¥æ­£å¸¸è®¿é—®ï¼Œå”¯ç‹¬æŸ¥çœ‹ä¸äº†æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯</p><h3 id="è§£æ³•"><a class="markdownIt-Anchor" href="#è§£æ³•"></a> è§£æ³•</h3><hr><p>æœ€ç»ˆçæ£é¼“ï¼Œå‘ç°è¿˜æ˜¯é…ç½®çš„é—®é¢˜ï¼ŒæŠŠproxy_passä¿®æ”¹ä¸º<code>proxy_pass http://ip:port</code>ï¼ŒæŠŠæœ€åçš„<code>/</code>å»æ‰å³å¯</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å½“ä½¿ç”¨Nginxæ¥é…ç½®RabbitMQçš„Webé¡µé¢æ—¶ï¼ŒæŸ¥çœ‹Exchangeã€Queueå’ŒChannelsæ—¶ï¼Œé‡åˆ°äº†&lt;code&gt;the object you clicked on was not found it may have been deleted on the se
      
    
    </summary>
    
    
      <category term="RabbitMQ" scheme="http://luxiaowan.github.io/categories/RabbitMQ/"/>
    
    
      <category term="Bug" scheme="http://luxiaowan.github.io/tags/Bug/"/>
    
  </entry>
  
  <entry>
    <title>Dockerå®¹å™¨æ— æ³•åœæ­¢å’Œåˆ é™¤</title>
    <link href="http://luxiaowan.github.io/2020/05/26/Docker%E5%AE%B9%E5%99%A8%E6%97%A0%E6%B3%95%E5%81%9C%E6%AD%A2%E5%92%8C%E5%88%A0%E9%99%A4/"/>
    <id>http://luxiaowan.github.io/2020/05/26/Dockerå®¹å™¨æ— æ³•åœæ­¢å’Œåˆ é™¤/</id>
    <published>2020-05-25T17:38:00.000Z</published>
    <updated>2020-05-25T17:41:50.885Z</updated>
    
    <content type="html"><![CDATA[<p>1.åœæ­¢å®¹å™¨</p><p>docker stop xxx-name</p><p>2.å¼ºåˆ¶ç§»é™¤æ­¤å®¹å™¨</p><p>docker rm -f xxx-name</p><blockquote><p>å¦‚æœå‡ºç°Device or resource busyï¼Œåˆ™é€šè¿‡ps -ef | grep portæŸ¥æ‰¾å®¹å™¨è¿›ç¨‹pidï¼Œç„¶åä½¿ç”¨kill -9 pidåœæ­¢è¿›ç¨‹</p></blockquote><p>3.æ¸…ç†æ­¤å®¹å™¨çš„ç½‘ç»œå ç”¨</p><p>æ ¼å¼ï¼šdocker network disconnect --force ç½‘ç»œæ¨¡å¼ å®¹å™¨åç§°</p><p>ç¤ºä¾‹ï¼šdocker network disconnect --force bridge xxx-name</p><p>4.ç®€æŸ¥æ˜¯å¦è¿˜æœ‰åŒåå®¹å™¨å ç”¨</p><p>æ ¼å¼ï¼šdocker network inspect ç½‘ç»œæ¨¡å¼<br>ç¤ºä¾‹ï¼šdocker network inspect bridge</p><p>5.é‡æ–°æ„å»ºå®¹å™¨</p><p>docker run xxx</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;1.åœæ­¢å®¹å™¨&lt;/p&gt;
&lt;p&gt;docker stop xxx-name&lt;/p&gt;
&lt;p&gt;2.å¼ºåˆ¶ç§»é™¤æ­¤å®¹å™¨&lt;/p&gt;
&lt;p&gt;docker rm -f xxx-name&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚æœå‡ºç°Device or resource busyï¼Œåˆ™é€šè¿‡ps -e
      
    
    </summary>
    
    
      <category term="Docker" scheme="http://luxiaowan.github.io/categories/Docker/"/>
    
    
  </entry>
  
  <entry>
    <title>Jenkinsä¸­åˆ›å»ºé¡¹ç›®æ—¶æ²¡æœ‰Mavené¡¹ç›®</title>
    <link href="http://luxiaowan.github.io/2020/05/26/Jenkins%E4%B8%AD%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E6%97%B6%E6%B2%A1%E6%9C%89Maven%E9%A1%B9%E7%9B%AE/"/>
    <id>http://luxiaowan.github.io/2020/05/26/Jenkinsä¸­åˆ›å»ºé¡¹ç›®æ—¶æ²¡æœ‰Mavené¡¹ç›®/</id>
    <published>2020-05-25T17:36:00.000Z</published>
    <updated>2020-05-25T17:38:10.178Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚æœåœ¨åˆ›å»ºé¡¹ç›®æ—¶å€™ï¼Œæ²¡æœ‰â€œåˆ›å»ºä¸€ä¸ªMaven é¡¹ç›®â€çš„é€‰é¡¹ï¼Œåˆ™éœ€è¦å®‰è£…Mavené¡¹ç›®æ’ä»¶ï¼šMaven Integration plugin</p><p><img src="/images/image-20200526013750453.png" alt="image-20200526013750453"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å¦‚æœåœ¨åˆ›å»ºé¡¹ç›®æ—¶å€™ï¼Œæ²¡æœ‰â€œåˆ›å»ºä¸€ä¸ªMaven é¡¹ç›®â€çš„é€‰é¡¹ï¼Œåˆ™éœ€è¦å®‰è£…Mavené¡¹ç›®æ’ä»¶ï¼šMaven Integration plugin&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/image-20200526013750453.png&quot; alt=&quot;image-20
      
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://luxiaowan.github.io/categories/Jenkins/"/>
    
    
  </entry>
  
  <entry>
    <title>Dockerå®¹å™¨ä¸­å®‰è£…vim</title>
    <link href="http://luxiaowan.github.io/2020/05/26/docker%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%AE%89%E8%A3%85vim/"/>
    <id>http://luxiaowan.github.io/2020/05/26/dockerå®¹å™¨ä¸­å®‰è£…vim/</id>
    <published>2020-05-25T17:35:00.000Z</published>
    <updated>2020-05-25T17:35:56.177Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨dockerå®¹å™¨æ—¶ï¼Œæœ‰æ—¶å€™é‡Œè¾¹æ²¡æœ‰å®‰è£…vimï¼Œæ•²vimå‘½ä»¤æ—¶æç¤ºè¯´ï¼švim: command not foundï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å®‰è£…vimï¼Œå¯æ˜¯å½“ä½ æ•²apt-get install vimå‘½ä»¤æ—¶ï¼Œæç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">E: Unable to locate package vim</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™éœ€è¦æ•²ï¼šapt-get updateï¼Œè¿™ä¸ªå‘½ä»¤çš„ä½œç”¨æ˜¯ï¼šåŒæ­¥ /etc/apt/sources.list å’Œ /etc/apt/sources.list.d ä¸­åˆ—å‡ºçš„æºçš„ç´¢å¼•ï¼Œè¿™æ ·æ‰èƒ½è·å–åˆ°æœ€æ–°çš„è½¯ä»¶åŒ…ã€‚</p><p>ç­‰æ›´æ–°å®Œæ¯•ä»¥åå†æ•²å‘½ä»¤ï¼šapt-get install vimå‘½ä»¤å³å¯ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ä½¿ç”¨dockerå®¹å™¨æ—¶ï¼Œæœ‰æ—¶å€™é‡Œè¾¹æ²¡æœ‰å®‰è£…vimï¼Œæ•²vimå‘½ä»¤æ—¶æç¤ºè¯´ï¼švim: command not foundï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å®‰è£…vimï¼Œå¯æ˜¯å½“ä½ æ•²apt-get install vimå‘½ä»¤æ—¶ï¼Œæç¤ºï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight she
      
    
    </summary>
    
    
      <category term="Docker" scheme="http://luxiaowan.github.io/categories/Docker/"/>
    
    
  </entry>
  
  <entry>
    <title>Jekinså¿˜è®°adminå¯†ç </title>
    <link href="http://luxiaowan.github.io/2020/05/25/Jekins%E5%BF%98%E8%AE%B0admin%E5%AF%86%E7%A0%81/"/>
    <id>http://luxiaowan.github.io/2020/05/25/Jekinså¿˜è®°adminå¯†ç /</id>
    <published>2020-05-25T15:59:00.000Z</published>
    <updated>2020-05-25T16:08:15.021Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-æœªä¿®æ”¹adminçš„å¯†ç "><a class="markdownIt-Anchor" href="#ä¸€-æœªä¿®æ”¹adminçš„å¯†ç "></a> ä¸€ã€æœªä¿®æ”¹adminçš„å¯†ç </h3><p>è‹¥æœªä¿®æ”¹è¿‡adminçš„å¯†ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹<code>/var/jenkins_home/secrets/initialAdminPassword</code>æ–‡ä»¶æ¥è·å–adminçš„åˆå§‹å¯†ç </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; cat <span class="regexp">/var/</span>jenkins_home<span class="regexp">/secrets/i</span>nitialAdminPassword</span><br></pre></td></tr></table></figure><h3 id="äºŒ-ä¿®æ”¹è¿‡adminçš„å¯†ç "><a class="markdownIt-Anchor" href="#äºŒ-ä¿®æ”¹è¿‡adminçš„å¯†ç "></a> äºŒã€ä¿®æ”¹è¿‡adminçš„å¯†ç </h3><p>å¦‚æœä¿®æ”¹è¿‡adminçš„å¯†ç ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä½¿ç”¨åˆå§‹å¯†ç æ¥è§£å†³äº†ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li><p>åˆ é™¤Jenkinsç›®å½•ä¸‹config.xmlæ–‡ä»¶ä¸­ä¸‹é¢ä»£ç </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">useSecurity</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useSecurity</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">authorizationStrategy</span> <span class="attr">class</span>=<span class="string">"hudson.security.FullControlOnceLoggedInAuthorizationStrategy"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">denyAnonymousReadAccess</span>&gt;</span>true<span class="tag">&lt;/<span class="name">denyAnonymousReadAccess</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorizationStrategy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">securityRealm</span> <span class="attr">class</span>=<span class="string">"hudson.security.HudsonPrivateSecurityRealm"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">disableSignup</span>&gt;</span>true<span class="tag">&lt;/<span class="name">disableSignup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">enableCaptcha</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enableCaptcha</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">securityRealm</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯Jenkins</p></li><li><p>é‡æ–°è¿›å…¥Jenkinsï¼Œç„¶åè¿›å…¥åˆ°<code>ç³»ç»Ÿç®¡ç†</code>-&gt;<code>å…¨å±€å®‰å…¨é…ç½®(configure global security)</code></p><img src="/images/image-20200526000447792.png" alt="image-20200526000447792" style="zoom:50%;"></li><li><p>å‹¾é€‰<code>Jenkinsä¸“æœ‰ç”¨æˆ·æ•°æ®åº“</code></p><img src="/images/image-20200526000537282.png" alt="image-20200526000537282" style="zoom:50%;"></li><li><p>å›åˆ°<code>ç³»ç»Ÿç®¡ç†</code>é¡µé¢ï¼Œé€‰æ‹©<code>ç®¡ç†ç”¨æˆ·</code></p><img src="/images/image-20200526000628607.png" alt="image-20200526000628607" style="zoom: 50%;"></li><li><p>é€‰æ‹©ç”¨æˆ·è®¾ç½®</p><img src="/images/image-20200526000726021.png" alt="image-20200526000726021" style="zoom:50%;"></li><li><p>é‡ç½®å¯†ç </p><img src="/images/image-20200526000747350.png" alt="image-20200526000747350" style="zoom:50%;"></li><li><p>é‡å¯JenkinsæœåŠ¡</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¸€-æœªä¿®æ”¹adminçš„å¯†ç &quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ä¸€-æœªä¿®æ”¹adminçš„å¯†ç &quot;&gt;&lt;/a&gt; ä¸€ã€æœªä¿®æ”¹adminçš„å¯†ç &lt;/h3&gt;
&lt;p&gt;è‹¥æœªä¿®æ”¹è¿‡adminçš„å¯†ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹&lt;code&gt;/var/jenk
      
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://luxiaowan.github.io/categories/Jenkins/"/>
    
    
  </entry>
  
  <entry>
    <title>ååºåˆ—åŒ–æŠ¥é”™ï¼šCannot Deserialize From Object Value (No Delegate- or Property-Based Creator)</title>
    <link href="http://luxiaowan.github.io/2020/05/22/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%8A%A5%E9%94%99%EF%BC%9Acannot-deserialize-from-Object-value-(no-delegate--or-property-based-Creator)/"/>
    <id>http://luxiaowan.github.io/2020/05/22/ååºåˆ—åŒ–æŠ¥é”™ï¼šcannot-deserialize-from-Object-value-(no-delegate--or-property-based-Creator)/</id>
    <published>2020-05-22T15:50:00.000Z</published>
    <updated>2020-05-22T15:51:32.514Z</updated>
    
    <content type="html"><![CDATA[<p>ååºåˆ—åŒ–æŠ¥é”™ï¼šcannot deserialize from Object value (no delegate- or property-based Creator)</p><p>è¿™ä¸ªåŸå› æœ€æ ¹æœ¬çš„æ˜¯æ²¡æœ‰æ‰¾åˆ°æ— å‚æ„é€ æ–¹æ³•ï¼Œè§£å†³åŠæ³•æ˜¯ç»™ç±»åŠ ä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ååºåˆ—åŒ–æŠ¥é”™ï¼šcannot deserialize from Object value (no delegate- or property-based Creator)&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªåŸå› æœ€æ ¹æœ¬çš„æ˜¯æ²¡æœ‰æ‰¾åˆ°æ— å‚æ„é€ æ–¹æ³•ï¼Œè§£å†³åŠæ³•æ˜¯ç»™ç±»åŠ ä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="http://luxiaowan.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>Cannot Determine Value Type From String &#39;Xxxxxx&#39;</title>
    <link href="http://luxiaowan.github.io/2020/05/21/Cannot-determine-value-type-from-string-xxxxxx/"/>
    <id>http://luxiaowan.github.io/2020/05/21/Cannot-determine-value-type-from-string-xxxxxx/</id>
    <published>2020-05-21T11:40:00.000Z</published>
    <updated>2020-05-21T12:11:07.814Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨MyBatisçš„æ—¶å€™ï¼Œè‹¥å®ä½“ç±»ä¸Šä½¿ç”¨äº†lombokçš„@Builderæ³¨è§£ï¼Œé‚£ä¹ˆåœ¨æŸ¥è¯¢æ•°æ®åšæ˜ å°„çš„æ—¶å€™ä¼šå‡ºç°<code>Cannot determine value type from string 'xxxxxx'</code>é”™è¯¯ï¼Œäº§ç”Ÿè¿™ä¸ªé”™è¯¯çš„åŸå› æ˜¯å½“ä½¿ç”¨äº†@Builderæ³¨è§£ä¹‹åä¼šé»˜è®¤æŠŠæ— å‚æ„é€ æ–¹æ³•å¿½ç•¥æ‰ï¼Œåˆ›å»ºä¸€ä¸ªå…¨å‚çš„æ„é€ æ–¹æ³•ï¼Œæ¯”å¦‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBean</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long   id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¢«ç¼–è¯‘ä¹‹åå†åç¼–è¯‘ï¼Œå˜æˆäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBean</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    DemoBean(Long id, String name) &#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DemoBean.<span class="function">DemoBeanBuilder <span class="title">builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DemoBean.DemoBeanBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...å¿½ç•¥setterã€getteræ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBeanBuilder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Long id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        DemoBeanBuilder() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DemoBean.<span class="function">DemoBeanBuilder <span class="title">id</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DemoBean.<span class="function">DemoBeanBuilder <span class="title">name</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> DemoBean <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DemoBean(<span class="keyword">this</span>.id, <span class="keyword">this</span>.name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"DemoBean.DemoBeanBuilder(id="</span> + <span class="keyword">this</span>.id + <span class="string">", name="</span> + <span class="keyword">this</span>.name + <span class="string">")"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç çœ‹åˆ°æ˜¯æ²¡æœ‰é»˜è®¤æ„é€ æ–¹æ³•ï¼Œè€ŒMyBatisè¿›è¡Œæ˜ å°„çš„æ—¶å€™ä¼šéœ€è¦æ— å‚æ„é€ æ–¹æ³•å®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å†ä½¿ç”¨@Builderçš„æ—¶å€™ï¼Œå³ä½¿ä½¿ç”¨@NoArgsConstructoræ³¨è§£ä¹Ÿæ— æµäºäº‹ï¼Œé‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼Ÿ</p><hr><p>åœ¨lombokä¸­æœ‰ä¸€ä¸ª@Tolerateæ³¨è§£ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒçš„å®šä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Put on any method or constructor to make lombok pretend it doesn't exist,</span></span><br><span class="line"><span class="comment"> * i.e., to generate a method which would otherwise be skipped due to possible conflicts.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.CONSTRUCTOR&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Tolerate &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨é‡Šä¸Šçš„æ„æ€å°±æ˜¯è®©lombokåœ¨æ‰«æçš„æ—¶å€™å‡è£…è¢«@Tolerateä¿®é¥°çš„æ–¹æ³•ä¸å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯ä¼šåŸå°ä¸åŠ¨çš„è¢«ç¼–è¯‘åˆ°å­—èŠ‚ç ä¸­ï¼Œä¸ä¼šè¦†ç›–å®ƒï¼Œé‚£ä¹ˆè¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œéªšæ“ä½œäº†ï¼Œä¿®æ”¹åŸä»£ç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBean</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long   id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Tolerate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ä½¿ç”¨MyBatisçš„æ—¶å€™ï¼Œè‹¥å®ä½“ç±»ä¸Šä½¿ç”¨äº†lombokçš„@Builderæ³¨è§£ï¼Œé‚£ä¹ˆåœ¨æŸ¥è¯¢æ•°æ®åšæ˜ å°„çš„æ—¶å€™ä¼šå‡ºç°&lt;code&gt;Cannot determine value type from string &#39;xxxxxx&#39;&lt;/code&gt;é”™è¯¯ï¼Œäº§ç”Ÿè¿™ä¸ªé”™è¯¯çš„åŸå› æ˜¯å½“ä½¿ç”¨äº†@Bu
      
    
    </summary>
    
    
      <category term="BUG" scheme="http://luxiaowan.github.io/categories/BUG/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringCloudå¯åŠ¨æŠ¥é”™ï¼Œæç¤ºThe Following Method Did Not exist:CompositeHealthIndicator</title>
    <link href="http://luxiaowan.github.io/2020/05/21/SpringCloud%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99%EF%BC%8C%E6%8F%90%E7%A4%BAThe-following-method-did-not-existCompositeHealthIndicator/"/>
    <id>http://luxiaowan.github.io/2020/05/21/SpringCloudå¯åŠ¨æŠ¥é”™ï¼Œæç¤ºThe-following-method-did-not-existCompositeHealthIndicator/</id>
    <published>2020-05-21T04:02:00.000Z</published>
    <updated>2020-05-21T15:26:49.989Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©å‡çº§SpringBootçš„ç‰ˆæœ¬ï¼Œç„¶åå¯åŠ¨çš„æ—¶å€™æ‡µé€¼äº†ï¼ŒæŠ¥äº†ä¸ªé”™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> Error starting Tomcat context. Exception: org.springframework.beans.factory.BeanCreationException. Message: Error creating bean with name 'servletEndpointRegistrar' defined in class path resource [org/springframework/boot/actuate/autoconfigure/endpoint/web</span><br><span class="line"> </span><br><span class="line"> The web application [ROOT] appears to have started a thread named [spring.cloud.inetutils] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Error starting ApplicationContext. To display the conditions report re-run your application with <span class="string">'debug'</span> enabled.</span><br><span class="line"></span><br><span class="line">**An attempt was made to call a method that does not exist. The attempt was made from the following location:</span><br><span class="line"></span><br><span class="line">    org.springframework.cloud.client.discovery.health.DiscoveryCompositeHealthIndicator.&lt;init&gt;(DiscoveryCompositeHealthIndicator.java:<span class="number">42</span>)</span><br><span class="line"></span><br><span class="line">The following method did not exist:</span><br><span class="line"></span><br><span class="line">    org.springframework.boot.actuate.health.CompositeHealthIndicator.&lt;init&gt;(Lorg/springframework/boot/actuate/health/HealthAggregator;)V**</span><br></pre></td></tr></table></figure><p>ç¿»äº†ä¸€ä¸‹èµ„æ–™åï¼Œå‘ç°æ˜¯SpringBootå’ŒSpringCloudçš„ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œä¿®æ”¹æˆä¸€è‡´çš„å°±è¡Œäº†</p><table><thead><tr><th style="text-align:left">Release Train</th><th style="text-align:left">Boot Version</th></tr></thead><tbody><tr><td style="text-align:left">Hoxton</td><td style="text-align:left">2.2.x</td></tr><tr><td style="text-align:left">Greenwich</td><td style="text-align:left">2.1.x</td></tr><tr><td style="text-align:left">Finchley</td><td style="text-align:left">2.0.x</td></tr><tr><td style="text-align:left">Edgware</td><td style="text-align:left">1.5.x</td></tr><tr><td style="text-align:left">Dalston</td><td style="text-align:left">1.5.x</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä»Šå¤©å‡çº§SpringBootçš„ç‰ˆæœ¬ï¼Œç„¶åå¯åŠ¨çš„æ—¶å€™æ‡µé€¼äº†ï¼ŒæŠ¥äº†ä¸ªé”™ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="http://luxiaowan.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>MySQLè‡ªå¢ä¸»é”®ç”¨å®Œäº†å’‹æ•´ï¼Ÿ</title>
    <link href="http://luxiaowan.github.io/2020/05/19/MySQL%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%E7%94%A8%E5%AE%8C%E4%BA%86%E5%92%8B%E6%95%B4/"/>
    <id>http://luxiaowan.github.io/2020/05/19/MySQLè‡ªå¢ä¸»é”®ç”¨å®Œäº†å’‹æ•´/</id>
    <published>2020-05-18T16:15:00.000Z</published>
    <updated>2020-05-18T16:31:42.594Z</updated>
    
    <content type="html"><![CDATA[<p>MySQLè‡ªå¢ä¸»é”®ä¼šç”¨å®Œå—ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹åœ¨MySQLä¸­ï¼Œintå’Œbigintä¸¤ç§ç±»å‹çš„å€¼åŸŸæ˜¯å¤šå°‘ï¼Œ</p><table><thead><tr><th>ç±»å‹</th><th>æœ€å°å€¼</th><th>æœ€å¤§å€¼</th><th>æ‰€å å­—èŠ‚</th></tr></thead><tbody><tr><td>int(æœ‰ç¬¦å·)</td><td>-2^31</td><td>2^31</td><td>4</td></tr><tr><td>int(æ— ç¬¦å·)</td><td>0</td><td>2^32</td><td>4</td></tr><tr><td>bigint(æœ‰ç¬¦å·)</td><td>-2^63</td><td>2^63</td><td>8</td></tr><tr><td>bigint(æ— ç¬¦å·)</td><td>0</td><td>2^64</td><td>8</td></tr></tbody></table><p>å½“æˆ‘ä»¬ä½¿ç”¨int(æœ‰ç¬¦å·)ç±»å‹çš„æ—¶å€™ï¼Œåˆ›å»ºä¸€å¼ è¡¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create table test_ai (</span><br><span class="line">id int(10) auto_increment primary key,</span><br><span class="line">name varchar(11) not null</span><br><span class="line">) engine=InnoDB;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸¤æ¡SQLè¯­å¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert test_ai(id, name) values(2147483646, &apos;cc1&apos;);</span><br><span class="line">insert test_ai(name) values(&apos;cc2&apos;);</span><br><span class="line">insert test_ai(name) values(&apos;cc3&apos;);</span><br></pre></td></tr></table></figure><p>å½“æ‰§è¡Œåˆ°ç¬¬ä¸‰å¥SQLçš„æ—¶å€™å°±ä¼šæŠ¥é”™<code>Duplicate entry '2147483647' for key 'PRIMARY'</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬çš„è‡ªå¢ä¸»é”®ç”¨å®Œä¹‹åï¼Œå°±æ— æ³•ç»§ç»­å¾€è¡¨ä¸­æ–°å¢æ•°æ®äº†</p><h4 id="è§£å†³åŠæ³•"><a class="markdownIt-Anchor" href="#è§£å†³åŠæ³•"></a> è§£å†³åŠæ³•</h4><hr><p>æˆ‘ä»¬åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸ä¼šè®©å•è¡¨å­˜å‚¨é‚£ä¹ˆå¤§çš„æ•°æ®é‡ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœçœŸçš„è„‘æŠ½æŠ½çš„åœ¨ä¸€å¼ è¡¨ä¸­å­˜å‚¨é‚£ä¹ˆå¤šæ•°æ®ï¼Œæˆ–è€…å½“æ•°æ®è¿ç§»çš„æ—¶å€™é€ æˆäº†è‡ªå¢ä¸»é”®æ··ä¹±ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨bigint(æ— ç¬¦å·)ç±»å‹ä½œä¸ºè‡ªå¢ä¸»é”®ã€‚</p><p>ä½¿ç”¨bigint(æ— ç¬¦å·)ç±»å‹æ—¶ï¼Œå¦‚æœæˆ‘ä»¬æ¯ç§’æ’å…¥1Wæ¡æ•°æ®ï¼Œä¸é—´æ–­çš„è·‘100å¹´ï¼Œå•è¡¨çš„æ•°æ®é‡ä¸ºï¼š10000 * 3600 * 24 * 365 * 100 = 31536000000000ï¼Œè¿˜è¿œè¿œå°äº2^64ï¼Œå®Œå…¨ä¸ä¼šè¢«ç”¨å®Œï¼Œå¦‚æœæ“ä½œæ­£ç¡®çš„è¯ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;MySQLè‡ªå¢ä¸»é”®ä¼šç”¨å®Œå—ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹åœ¨MySQLä¸­ï¼Œintå’Œbigintä¸¤ç§ç±»å‹çš„å€¼åŸŸæ˜¯å¤šå°‘ï¼Œ&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;æœ€å°å€¼&lt;/th&gt;
&lt;th&gt;æœ€å¤§å€¼&lt;/th&gt;
&lt;th&gt;æ‰€å å­—èŠ‚&lt;/th&gt;
&lt;/tr&gt;
&lt;/th
      
    
    </summary>
    
    
      <category term="MySQL" scheme="http://luxiaowan.github.io/categories/MySQL/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBootå†…ç½®Tomcatå¯åŠ¨æ—¶é—´</title>
    <link href="http://luxiaowan.github.io/2020/05/15/SpringBoot%E5%86%85%E7%BD%AETomcat%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%B4/"/>
    <id>http://luxiaowan.github.io/2020/05/15/SpringBootå†…ç½®Tomcatå¯åŠ¨æ—¶é—´/</id>
    <published>2020-05-15T10:22:00.000Z</published>
    <updated>2020-05-15T17:58:50.202Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ç–‘æƒ‘"><a class="markdownIt-Anchor" href="#ç–‘æƒ‘"></a> ç–‘æƒ‘</h4><p>SpringBootä¸­å†…ç½®äº†Tomcatå®¹å™¨ï¼Œé‚£ä¹ˆTomcatæ˜¯åœ¨ä»€ä¹ˆæ—¶é—´ç‚¹å¯åŠ¨çš„ï¼Ÿæ˜¯å…ˆæ‰«æåŒ…åŠ è½½ç±»å†å¯åŠ¨Tomcatï¼Ÿï¼Œè¿˜æ˜¯å…ˆå¯åŠ¨Tomcatå†æ‰«æåŒ…åŠ è½½ç±»ï¼Ÿ</p><p>æˆ‘ä»¬åšä¸€ä¸‹å‡è®¾ï¼š</p><ol><li>å…ˆå¯åŠ¨Tomcatï¼Œå†æ‰«æåŒ…åŠ è½½ç±»</li><li>å…ˆæ‰«æåŒ…åŠ è½½ç±»ï¼Œå†å¯åŠ¨Tomcat</li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬åšä¸€ä¸‹éªŒè¯ã€‚</p><h4 id="éªŒè¯"><a class="markdownIt-Anchor" href="#éªŒè¯"></a> éªŒè¯</h4><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„SpringBootå·¥ç¨‹ï¼Œç„¶åå¯åŠ¨å®ƒï¼ŒæŸ¥çœ‹ä¸€ä¸‹æ§åˆ¶å°çš„è¾“å‡ºæ—¥å¿—ï¼š</p><img src="/images/image-20200515183550832.png" alt="image-20200515183550832" style="zoom:50%;"><p>ä»è¾“å‡ºçš„æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°â‘¡ä¸­æ˜¾ç¤ºTomcatè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”æ­£åœ¨å¯åŠ¨ä¸­ï¼Œç„¶åâ‘¢ä¸­è¿›è¡Œåˆå§‹åŒ–<code>WebApplicationContext</code>ï¼Œç´§æ¥ç€å°±æ˜¯åˆå§‹åŒ–<code>WebApplicationContext</code>å®Œæˆï¼Œç„¶åæ˜¯åœ¨â‘£ä¸­æŠ¥å‘Šæˆ‘ä»¬Tomcatå¯åŠ¨å®Œæˆã€‚</p><p>ä»æ—¥å¿—ä¸Šçœ‹ï¼Œå¥½åƒæ˜¯å…ˆå¯åŠ¨Tomcatå†å»æ‰«æåŒ…çš„ï¼Œå…·ä½“æ˜¯æ€ä¹ˆå›äº‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æºç ï¼Œæš‚æ—¶å…ˆä¸æ­æ™“ã€‚</p><ul><li><p>ä»å¯åŠ¨ç±»ä¸­è¿›å…¥åˆ°<code>SpringApplication.run()</code>æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºå¯åŠ¨ç›‘æ§ç±»ï¼Œç›‘æ§å¯åŠ¨è¿‡ç¨‹ç”¨äº†å¤šä¹…ï¼Œä½†æ˜¯ms</span></span><br><span class="line">  StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">  <span class="comment">// å¼€å§‹è®¡æ—¶ï¼Œè®¾ç½®å¼€å§‹æ—¶é—´</span></span><br><span class="line">  stopWatch.start();</span><br><span class="line">  <span class="comment">// ä¸Šä¸‹æ–‡å®ä¾‹</span></span><br><span class="line">  ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// å¯åŠ¨å¼‚å¸¸é”™è¯¯æŠ¥å‘Š</span></span><br><span class="line">  Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="comment">// å¯ç”¨headlessæ¨¡å¼ï¼ˆheadlessæ¨¡å¼æ˜¯åœ¨ç³»ç»Ÿç¼ºå°‘éƒ¨åˆ†ç¡¬ä»¶æ”¯æŒçš„æ—¶å€™è®©æœåŠ¡è‡ªåŠ›æ›´ç”Ÿï¼‰</span></span><br><span class="line">  configureHeadlessProperty();</span><br><span class="line">  <span class="comment">// è·å–spring.factoriesæ–‡ä»¶ä¸­é…ç½®çš„org.springframework.boot.SpringApplicationRunListeneråˆ—è¡¨ï¼ŒåŸç†æ˜¯Springçš„äº‹ä»¶æœºåˆ¶ï¼Œæ‰€æœ‰çš„ç±»éƒ½å®ç°è‡ªApplicationEventï¼Œå¯ä»¥ç›‘å¬å¯åŠ¨è¿‡ç¨‹ä¸­çš„ä»»æ„é˜¶æ®µ</span></span><br><span class="line">  SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">  <span class="comment">// è¿›å…¥ç›‘å¬å¯åŠ¨é˜¶æ®µ</span></span><br><span class="line">  listeners.starting();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–JVMè¿è¡Œå‚æ•°ï¼Œä¹Ÿå°±æ˜¯åœ¨ä½¿ç”¨java -jar xxx.jarå‘½ä»¤å¯åŠ¨æ—¶æŒ‡å®šçš„å…¶ä»–å‚æ•°</span></span><br><span class="line">    ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line">    <span class="comment">// å‡†å¤‡è¿è¡Œç¯å¢ƒï¼Œä¼ å…¥ç›‘å¬å™¨å’Œè¿è¡Œå‚æ•°ï¼Œè·å–ç¯å¢ƒå˜é‡ï¼Œç»‘å®šåˆ°ç¯å¢ƒä¸­</span></span><br><span class="line">    ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">    <span class="comment">// é…ç½®spring.beaninfo.ignoreå±æ€§ï¼ŒSpringBootä¸­é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    configureIgnoreBeanInfo(environment);</span><br><span class="line">    <span class="comment">// è¾“å‡ºBannerä¿¡æ¯ï¼Œbannerçš„è¾“å‡ºæ–¹å¼æœ‰ä¸‰ç§ï¼šnone/console/logï¼Œé»˜è®¤ä¸ºconsoleï¼Œé€šè¿‡é…ç½®å‚æ•°spring.main.banner-modeæŒ‡å®š</span></span><br><span class="line">    Banner printedBanner = printBanner(environment);</span><br><span class="line">    <span class="comment">// â˜†åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å®ä¾‹ï¼Œæ¯”è¾ƒé‡ç‚¹çš„åœ°æ–¹â˜†</span></span><br><span class="line">    context = createApplicationContext();</span><br><span class="line">    <span class="comment">// è·å–spring.factoriesæ–‡ä»¶ä¸­å£°æ˜çš„SpringBootExceptionReporter</span></span><br><span class="line">    exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,</span><br><span class="line">                                                     <span class="keyword">new</span> Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡å’Œèµ„æºåŠ è½½å™¨ï¼Œåˆ›å»ºbeanï¼ŒåŠ è½½åˆ°æ‰€æœ‰çš„listenerä¸­</span></span><br><span class="line">    prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">    <span class="comment">// è°ƒç”¨springçš„refreshæ–¹æ³•ï¼Œå¹¶æ³¨å†Œä¸€ä¸ªShutdownHookï¼ˆåº”ç”¨å…³é—­æ—¶çš„åŠ¨ä½œï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿AbstractApplicationContextå®ç°è‡ªå®šä¹‰ï¼‰</span></span><br><span class="line">    refreshContext(context);</span><br><span class="line">    <span class="comment">// ç©ºæ–¹æ³•</span></span><br><span class="line">    afterRefresh(context, applicationArguments);</span><br><span class="line">    <span class="comment">// å¯åŠ¨å®Œæˆï¼Œåœæ­¢è®¡æ—¶</span></span><br><span class="line">    stopWatch.stop();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">      <span class="comment">// è¾“å‡ºå¯åŠ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬è®¡æ—¶</span></span><br><span class="line">      <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿›å…¥ç›‘å¬å™¨çš„å¯åŠ¨å®Œæˆäº‹ä»¶</span></span><br><span class="line">    listeners.started(context);</span><br><span class="line">    callRunners(context, applicationArguments);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¿›å…¥ç›‘å¬å™¨çš„è¿è¡Œä¸­äº‹ä»¶</span></span><br><span class="line">    listeners.running(context);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    handleRunFailure(context, ex, exceptionReporters, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç ä¸­å¹¶æœªçœ‹åˆ°æ˜¯åœ¨å“ªé‡Œå¯åŠ¨äº†Tomcatå®¹å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±çœ‹ä¸€ä¸‹åˆ›å»ºSpringä¸Šä¸‹æ–‡çš„æ–¹æ³•ä¸­æ˜¯å¦æœ‰å…³é”®å­—</p></li><li><p>createApplicationContext()æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title">createApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; contextClass = <span class="keyword">this</span>.applicationContextClass;</span><br><span class="line">  <span class="keyword">if</span> (contextClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">this</span>.webApplicationType) &#123;</span><br><span class="line">        <span class="keyword">case</span> SERVLET:</span><br><span class="line">          <span class="comment">// org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext</span></span><br><span class="line">          contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> REACTIVE:</span><br><span class="line">          <span class="comment">// org.springframework.boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext</span></span><br><span class="line">          contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="comment">// org.springframework.context.annotation.AnnotationConfigApplicationContext</span></span><br><span class="line">          contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">        <span class="string">"Unable create a default ApplicationContext, please specify an ApplicationContextClass"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªåˆ›å»º<code>ApplicationContext</code>å®ä¾‹çš„æ–¹æ³•ï¼Œæˆ‘ä»¬åªçœ‹Tomcatçš„<code>AnnotationConfigServletWebServerApplicationContext</code>ï¼Œä»–çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹</p><p><img src="/images/AnnotationConfigServletWebServerApplicationContext.png" alt="AnnotationConfigServletWebServerApplicationContext"></p><p>ä»¥ä¸Šç±»ä¸­å¹¶æ²¡æœ‰åœ¨é™æ€ä»£ç å—ä¸­å¯åŠ¨Tomcatï¼Œåˆ™è¯´æ˜ä¸æ˜¯åœ¨è¿™é‡Œå¯åŠ¨çš„ï¼Œè¿™é‡Œåªæ˜¯åˆ›å»ºä¸€ä¸ª<code>ApplicationContext</code>ä¸Šä¸‹æ–‡å®ä¾‹</p></li><li><p>prepareContext()æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(ConfigurableApplicationContext context, ConfigurableEnvironment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                            SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">  context.setEnvironment(environment);</span><br><span class="line">  <span class="comment">// å¤„ç†ä¸Šä¸‹æ–‡</span></span><br><span class="line">  postProcessApplicationContext(context);</span><br><span class="line">  <span class="comment">// åšrefreshå‰çš„åˆå§‹åŒ–å‡†å¤‡</span></span><br><span class="line">  applyInitializers(context);</span><br><span class="line">  <span class="comment">// è¿›å…¥åˆ°ç›‘å¬å™¨çš„ä¸Šä¸‹æ–‡å‡†å¤‡é˜¶æ®µ</span></span><br><span class="line">  listeners.contextPrepared(context);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">    logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">    logStartupProfileInfo(context);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ›å»ºç‰¹æ®Šçš„å¼•å¯¼ç±»å®ä¾‹ï¼Œå•ä¾‹çš„</span></span><br><span class="line">  ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br><span class="line">  beanFactory.registerSingleton(<span class="string">"springApplicationArguments"</span>, applicationArguments);</span><br><span class="line">  <span class="keyword">if</span> (printedBanner != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºBannerç±»å®ä¾‹ï¼Œå•ä¾‹çš„</span></span><br><span class="line">    beanFactory.registerSingleton(<span class="string">"springBootBanner"</span>, printedBanner);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) &#123;</span><br><span class="line">    ((DefaultListableBeanFactory) beanFactory)</span><br><span class="line">    .setAllowBeanDefinitionOverriding(<span class="keyword">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.lazyInitialization) &#123;</span><br><span class="line">    context.addBeanFactoryPostProcessor(<span class="keyword">new</span> LazyInitializationBeanFactoryPostProcessor());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Load the sources</span></span><br><span class="line">  Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">  Assert.notEmpty(sources, <span class="string">"Sources must not be empty"</span>);</span><br><span class="line">  load(context, sources.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]));</span><br><span class="line">  listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•é‡Œæ•´ä¸ªè¿‡ç¨‹éƒ½åœ¨åˆ›å»ºå„ç§ç±»çš„å®ä¾‹ï¼Œå¹¶æœªå‡ºç°å¯¹Tomcatçš„å¯åŠ¨æ“ä½œï¼Œçœ‹æ¥ä¹Ÿä¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œé‚£ä¹ˆå°±ç»§ç»­å¾€ä¸‹çœ‹</p></li><li><p>refreshContext()æ–¹æ³•</p><p>è¿™ä¸ªæ–¹æ³•æœ€ç»ˆæ˜¯è°ƒç”¨åˆ°<code>AbstractApplicationContext#refresh()</code>ä¸­ï¼Œè¿™å°±åˆ°äº†SpringåŸºç¡€æ¡†æ¶ä¸­ã€‚æˆ‘ä»¬åœ¨åˆ†æcreateApplicationContext()æ–¹æ³•çš„æ—¶å€™ï¼ŒçŸ¥é“Tomcatä½¿ç”¨çš„æ˜¯<code>org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext</code>ç±»ï¼Œè¿™ä¸ªç±»ç»§æ‰¿è‡ª<code>org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext</code>ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ï¼Œé‡å†™äº†çˆ¶ç±»<code>AbstractApplicationContext</code>ä¸­çš„refresh()ã€onRefresh()å’ŒfinishRefresh()æ–¹æ³•ï¼Œè€Œåœ¨<code>AbstractApplicationContext#refresh()</code>æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†onRefresh()å’ŒfinishRefresh()è¿™ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">    <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">    <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">    <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">      <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">      <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">      <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">      <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">      onRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">      <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">      finishRefresh();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è°ƒç”¨çš„onRefresh()å’ŒfinishRefresh()å®é™…ä¸Šæ˜¯è°ƒç”¨äº†<code>ServletWebServerApplicationContext</code>ä¸­çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹ä¸‹è¿™ä¸ªç±»ä¸­çš„è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åšäº†ä»€ä¹ˆ</p><ul><li>onRefresh()æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è°ƒç”¨çˆ¶ç±»çš„onRefresh()æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">super</span>.onRefresh();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºWebServer</span></span><br><span class="line">    createWebServer();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start web server"</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createWebServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  WebServer webServer = <span class="keyword">this</span>.webServer;</span><br><span class="line">  ServletContext servletContext = getServletContext();</span><br><span class="line">  <span class="keyword">if</span> (webServer == <span class="keyword">null</span> &amp;&amp; servletContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è·å–ServletWebServerFactoryçš„å®ä¾‹ï¼Œä½¿ç”¨Tomcatçš„è¯ä¼šè·å–åˆ°tomcatServletWebServerFactory</span></span><br><span class="line">    ServletWebServerFactory factory = getWebServerFactory();</span><br><span class="line">    <span class="comment">// è·å–WebServerå®ä¾‹ï¼Œæ–¹æ³•å†…åˆ›å»ºTomcatå¹¶å‡†å¤‡Tomcatå¯åŠ¨æ‰€éœ€ç¯å¢ƒå˜é‡</span></span><br><span class="line">    <span class="keyword">this</span>.webServer = factory.getWebServer(getSelfInitializer());</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (servletContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      getSelfInitializer().onStartup(servletContext);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–è‡ªå®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œæ¶‰åŠåˆ°servletContextInitParamså’ŒservletConfigInitParams</span></span><br><span class="line">  initPropertySources();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ServletWebServerFactory <span class="title">getWebServerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨beanåç§°ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šè€ƒè™‘å±‚æ¬¡ç»“æ„</span></span><br><span class="line">  String[] beanNames = getBeanFactory().getBeanNamesForType(ServletWebServerFactory.class);</span><br><span class="line">  <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">""</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">""</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å–Beanå®ä¾‹ï¼Œè¿™é‡Œè·å–åˆ°çš„å°±æ˜¯TomcatServletWebServerFactoryç±»çš„å®ä¾‹</span></span><br><span class="line">  <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], ServletWebServerFactory.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»£ç æˆ‘ä»¬çŸ¥é“åœ¨onRefresh()æ–¹æ³•ä¸­ä¸»è¦æ˜¯åˆ›å»ºTomcatå®ä¾‹ï¼Œå‡†å¤‡Tomcatå¯åŠ¨æ‰€éœ€å‚æ•°å’Œé…ç½®ä¿¡æ¯ï¼Œå¹¶æœªå¯åŠ¨Tomcat</p><ul><li>finishRefresh()æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>.finishRefresh();</span><br><span class="line">  <span class="comment">// å¯åŠ¨WebServerï¼Œéš¾é“æ˜¯è¿™é‡Œå¯åŠ¨çš„Tomcatï¼Ÿ</span></span><br><span class="line">  WebServer webServer = startWebServer();</span><br><span class="line">  <span class="keyword">if</span> (webServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    publishEvent(<span class="keyword">new</span> ServletWebServerInitializedEvent(webServer, <span class="keyword">this</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> WebServer <span class="title">startWebServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  WebServer webServer = <span class="keyword">this</span>.webServer;</span><br><span class="line">  <span class="keyword">if</span> (webServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¯åŠ¨WebServerï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯TomcatWebServer#start()æ–¹æ³•</span></span><br><span class="line">    webServer.start();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> webServer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TomcatWebServer#start()æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> WebServerException </span>&#123;</span><br><span class="line">  <span class="comment">// åŠ é”é˜²å¹¶å‘</span></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.monitor) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.started) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      addPreviouslyRemovedConnectors();</span><br><span class="line">      <span class="comment">// è·å–Tomcatçš„Connector</span></span><br><span class="line">      Connector connector = <span class="keyword">this</span>.tomcat.getConnector();</span><br><span class="line">      <span class="keyword">if</span> (connector != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.autoStart) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœconnectorä¸ä¸ºnullï¼Œå¹¶ä¸”è‡ªåŠ¨å¯åŠ¨ï¼Œåˆ™å¯åŠ¨æ—¶æ‰§è¡Œå»¶è¿ŸåŠ è½½</span></span><br><span class="line">        <span class="comment">// å½“ç«¯å£å¤§äº0çš„æ—¶å€™ï¼ŒautoStartå°±ä¸ºtrue</span></span><br><span class="line">        performDeferredLoadOnStartup();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ£€æŸ¥Connectoræ˜¯å¦å·²å¯åŠ¨ï¼Œè‹¥æœ‰æœªå¯åŠ¨çš„Connectoråˆ™æŠ›å¼‚å¸¸</span></span><br><span class="line">      checkThatConnectorsHaveStarted();</span><br><span class="line">      <span class="comment">// ä¿®æ”¹è¿è¡Œæ ‡è¯†å±æ€§</span></span><br><span class="line">      <span class="keyword">this</span>.started = <span class="keyword">true</span>;</span><br><span class="line">      <span class="comment">// è¾“å‡ºTomcatå¯åŠ¨æˆåŠŸæ—¥å¿—</span></span><br><span class="line">      logger.info(<span class="string">"Tomcat started on port(s): "</span> + getPortsDescription(<span class="keyword">true</span>) + <span class="string">" with context path '"</span></span><br><span class="line">                  + getContextPath() + <span class="string">"'"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ConnectorStartFailedException ex) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¥½åƒä¹Ÿä»…ä»…å°±æ˜¯æ£€æµ‹TomcatæœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸäº†ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œå¯åŠ¨è¿™ä¸ªæ“ä½œï¼Œçœ‹æ¥ä¹Ÿä¸åœ¨è¿™é‡Œã€‚</p><p>è¿™å°±å¥‡æ€ªäº†ï¼Œæˆ‘ä»¬å‡ ä¹ç¿»éäº†æ•´ä¸ªå¯åŠ¨ç±»çš„ä»£ç ï¼Œéƒ½æ²¡æœ‰Tomcatå¯åŠ¨çš„ä»£ç ï¼Œé‚£ä¹ˆTomcatæ˜¯æ€ä¹ˆå¯åŠ¨çš„å‘¢ï¼Ÿæ˜¯ä¸æ˜¯æˆ‘ä»¬é—æ¼äº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ä¸Šé¢çš„åˆ†æï¼ŒTomcatWebServerå®ä¾‹çš„è·å–çš„åœ°æ–¹<code>ServletWebServerFactory#getWebServer()</code>æ–¹æ³•å†…æˆ‘ä»¬å¥½åƒæ²¡æœ‰çœ‹ï¼Œæ˜¯ä¸æ˜¯åœ¨åˆ›å»ºTomcatWebServerå®ä¾‹çš„æ—¶å€™ç›´æ¥å°±å¯åŠ¨äº†ï¼Œç„¶ååœ¨<code>TomcatWebServer#start()</code>æ–¹æ³•ä¸­åªæ˜¯å»æ£€æµ‹å¯åŠ¨çš„çŠ¶æ€ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹<code>ServletWebServerFactory#getWebServer()</code>çš„æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> WebServer <span class="title">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.disableMBeanRegistry) &#123;</span><br><span class="line">    Registry.disableRegistry();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç®€å•ç•¥è¿‡</span></span><br><span class="line">  Tomcat tomcat = <span class="keyword">new</span> Tomcat();</span><br><span class="line">  File baseDir = (<span class="keyword">this</span>.baseDirectory != <span class="keyword">null</span>) ? <span class="keyword">this</span>.baseDirectory : createTempDir(<span class="string">"tomcat"</span>);</span><br><span class="line">  tomcat.setBaseDir(baseDir.getAbsolutePath());</span><br><span class="line">  Connector connector = <span class="keyword">new</span> Connector(<span class="keyword">this</span>.protocol);</span><br><span class="line">  connector.setThrowOnFailure(<span class="keyword">true</span>);</span><br><span class="line">  tomcat.getService().addConnector(connector);</span><br><span class="line">  customizeConnector(connector);</span><br><span class="line">  tomcat.setConnector(connector);</span><br><span class="line">  tomcat.getHost().setAutoDeploy(<span class="keyword">false</span>);</span><br><span class="line">  configureEngine(tomcat.getEngine());</span><br><span class="line">  <span class="keyword">for</span> (Connector additionalConnector : <span class="keyword">this</span>.additionalTomcatConnectors) &#123;</span><br><span class="line">    tomcat.getService().addConnector(additionalConnector);</span><br><span class="line">  &#125;</span><br><span class="line">  prepareContext(tomcat.getHost(), initializers);</span><br><span class="line">  <span class="comment">// è·å–TomcatWebServerå®ä¾‹</span></span><br><span class="line">  <span class="keyword">return</span> getTomcatWebServer(tomcat);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸é‡è¦</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> TomcatWebServer <span class="title">getTomcatWebServer</span><span class="params">(Tomcat tomcat)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// autoStart = getPort() &gt;= 0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> TomcatWebServer(tomcat, getPort() &gt;= <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TomcatWebServer</span><span class="params">(Tomcat tomcat, <span class="keyword">boolean</span> autoStart)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(tomcat, <span class="string">"Tomcat Server must not be null"</span>);</span><br><span class="line">  <span class="keyword">this</span>.tomcat = tomcat;</span><br><span class="line">  <span class="keyword">this</span>.autoStart = autoStart;</span><br><span class="line">  <span class="comment">// æœ€é‡è¦çš„æ–¹æ³•</span></span><br><span class="line">  initialize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>initialize()æ–¹æ³•æºç </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> WebServerException </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.monitor) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¯åŠ¨æœåŠ¡å™¨ä»¥è§¦å‘åˆå§‹åŒ–ä¾¦å¬å™¨</span></span><br><span class="line">      <span class="keyword">this</span>.tomcat.start();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ‰€æœ‰Tomcatçº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤è¿›ç¨‹çº¿ç¨‹ã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé˜»å¡éå®ˆæŠ¤è¿›ç¨‹æ¥åœæ­¢ç«‹å³å…³é—­</span></span><br><span class="line">      startDaemonAwaitThread();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      stopSilently();</span><br><span class="line">      destroySilently();</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WebServerException(<span class="string">"Unable to start embedded Tomcat"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»ˆäºæ‰¾åˆ°äº†ï¼Œè¯­å¥<code>this.tomcat.start()</code>å°±æ˜¯å¯åŠ¨Tomcatå®¹å™¨çš„å…³ç›‘è¯­å¥ã€‚</p></li></ul><h4 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h4><p>é€šè¿‡å¯¹SpringApplication.run()æ–¹æ³•æ‰§è¡Œé¡ºåºçš„åˆ†ææ¥çœ‹ï¼Œå…ˆæ„å»ºSpringä¸Šä¸‹æ–‡åŠ è½½Beanï¼Œä¹Ÿå°±æ˜¯æ‰«æåŒ…ï¼Œç„¶åå†åœ¨refreshContext()æ–¹æ³•ä¸­åˆ›å»ºTomcatå®¹å™¨å¹¶å¯åŠ¨å®¹å™¨ã€‚</p><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥éªŒè¯å‡ºå‡è®¾2æ˜¯æ­£ç¡®çš„</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ç–‘æƒ‘&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç–‘æƒ‘&quot;&gt;&lt;/a&gt; ç–‘æƒ‘&lt;/h4&gt;
&lt;p&gt;SpringBootä¸­å†…ç½®äº†Tomcatå®¹å™¨ï¼Œé‚£ä¹ˆTomcatæ˜¯åœ¨ä»€ä¹ˆæ—¶é—´ç‚¹å¯åŠ¨çš„ï¼Ÿæ˜¯å…ˆæ‰«æåŒ…åŠ è½½ç±»å†å¯åŠ¨Tomcatï¼Ÿï¼Œè¿˜æ˜¯å…ˆå¯åŠ¨Tomcat
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="http://luxiaowan.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>JVMæŒ‡é’ˆç¢°æ’å’Œç©ºé—²åˆ—è¡¨</title>
    <link href="http://luxiaowan.github.io/2020/05/12/JVM%E6%8C%87%E9%92%88%E7%A2%B0%E6%92%9E%E5%92%8C%E7%A9%BA%E9%97%B2%E5%88%97%E8%A1%A8/"/>
    <id>http://luxiaowan.github.io/2020/05/12/JVMæŒ‡é’ˆç¢°æ’å’Œç©ºé—²åˆ—è¡¨/</id>
    <published>2020-05-12T02:40:00.000Z</published>
    <updated>2020-05-12T03:17:43.831Z</updated>
    
    <content type="html"><![CDATA[<p>Javaå †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œä¸»è¦ç”¨äºå­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œåœ¨å †ä¸Šä¸ºå¯¹è±¡åˆ†é…å†…å­˜å°±æ˜¯æŠŠä¸€å—å¤§å°ç¡®å®šçš„å†…å­˜ä»å †å†…å­˜ä¸­åˆ’åˆ†å‡ºæ¥ï¼Œå°†å¯¹è±¡æ”¾è¿›å»ã€‚å¸¸ç”¨çš„åˆ†é…æ–¹æ³•æœ‰æŒ‡é’ˆç¢°æ’å’Œç©ºé—²åˆ—è¡¨ä¸¤ç§å®ç°æ–¹å¼ã€‚</p><h4 id="æŒ‡é’ˆç¢°æ’"><a class="markdownIt-Anchor" href="#æŒ‡é’ˆç¢°æ’"></a> æŒ‡é’ˆç¢°æ’</h4><p>é€‚ç”¨äºå †å†…å­˜å®Œæ•´çš„æƒ…å†µï¼Œå·²åˆ†é…çš„å†…å­˜å’Œç©ºé—²å†…å­˜åˆ†è¡¨åœ¨ä¸åŒçš„ä¸€ä¾§ï¼Œé€šè¿‡ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘åˆ†ç•Œç‚¹ï¼Œå½“éœ€è¦åˆ†é…å†…å­˜æ—¶ï¼ŒæŠŠæŒ‡é’ˆå¾€ç©ºé—²çš„ä¸€ç«¯ç§»åŠ¨ä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»å³å¯ï¼Œç”¨äºSerialå’ŒParNewç­‰ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡çš„åƒåœ¾æ”¶é›†å™¨ã€‚</p><img src="/images/image-20200512111153143.png" alt="image-20200512111153143" style="zoom:50%;"><h4 id="ç©ºé—²åˆ—è¡¨"><a class="markdownIt-Anchor" href="#ç©ºé—²åˆ—è¡¨"></a> ç©ºé—²åˆ—è¡¨</h4><p>é€‚ç”¨äºå †å†…å­˜ä¸å®Œæ•´çš„æƒ…å†µï¼Œå·²åˆ†é…çš„å†…å­˜å’Œç©ºé—²å†…å­˜ç›¸äº’äº¤é”™ï¼ŒJVMé€šè¿‡ç»´æŠ¤ä¸€å¼ å†…å­˜åˆ—è¡¨è®°å½•å¯ç”¨çš„å†…å­˜å—ä¿¡æ¯ï¼Œå½“åˆ†é…å†…å­˜æ—¶ï¼Œä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å†…å­˜å—åˆ†é…ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„è®°å½•ï¼Œæœ€å¸¸è§çš„ä½¿ç”¨æ­¤æ–¹æ¡ˆçš„åƒåœ¾æ”¶é›†å™¨å°±æ˜¯CMSã€‚</p><img src="/images/image-20200512111650404.png" alt="image-20200512111650404" style="zoom:50%;">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Javaå †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œä¸»è¦ç”¨äºå­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œåœ¨å †ä¸Šä¸ºå¯¹è±¡åˆ†é…å†…å­˜å°±æ˜¯æŠŠä¸€å—å¤§å°ç¡®å®šçš„å†…å­˜ä»å †å†…å­˜ä¸­åˆ’åˆ†å‡ºæ¥ï¼Œå°†å¯¹è±¡æ”¾è¿›å»ã€‚å¸¸ç”¨çš„åˆ†é…æ–¹æ³•æœ‰æŒ‡é’ˆç¢°æ’å’Œç©ºé—²åˆ—è¡¨ä¸¤ç§å®ç°æ–¹å¼ã€‚&lt;/p&gt;
&lt;h4 id=&quot;æŒ‡é’ˆç¢°æ’&quot;&gt;&lt;a class=&quot;markdownIt-An
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>ç›‘å¬Redisä¸­keyè¿‡æœŸäº‹ä»¶</title>
    <link href="http://luxiaowan.github.io/2020/05/11/%E7%9B%91%E5%90%ACRedis%E4%B8%ADkey%E8%BF%87%E6%9C%9F%E4%BA%8B%E4%BB%B6/"/>
    <id>http://luxiaowan.github.io/2020/05/11/ç›‘å¬Redisä¸­keyè¿‡æœŸäº‹ä»¶/</id>
    <published>2020-05-11T15:20:00.000Z</published>
    <updated>2020-05-11T17:11:16.136Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å·¥ä½œä¸­å¶å°”ä¼šé‡åˆ°è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šç”¨æˆ·ä¸‹å•ä¹‹åï¼Œè‹¥30åˆ†é’Ÿå†…æœªå®Œæˆæ”¯ä»˜ï¼Œåˆ™å–æ¶ˆè®¢å•ã€‚</p><p>åšè¿‡ç”µå•†ä¸šåŠ¡çš„åŒå­¦ï¼Œå°¤å…¶æ˜¯åšç»Ÿä¸€ä¸‹å•ä¸šåŠ¡çš„åŒå­¦ä¸€èˆ¬éƒ½ä¼šæ¥è§¦è¿‡è¿™ä¸ªåœºæ™¯çš„éœ€æ±‚ï¼Œä¸€èˆ¬çš„å¤„ç†æ–¹å¼æ˜¯å°†è®¢å•æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼ˆMySQLä¹‹ç±»çš„ï¼‰ï¼Œç„¶åç”±ä¸€ä¸ªå®šæ—¶Jobä¸æ–­çš„å»æ‰«æç¬¦åˆæ¡ä»¶çš„è®¢å•ï¼Œä¿®æ”¹è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆã€‚å½“ç„¶è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªå¤„ç†åŠæ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨åˆ°å»¶æ—¶é˜Ÿåˆ—æ¥å¤„ç†ã€‚</p><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ä½¿ç”¨Redisæ˜¯å¦å¯ä»¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Ÿæˆ‘ä»¬çŸ¥é“åœ¨ä½¿ç”¨Redisçš„è¿‡ç¨‹ä¸­ï¼Œå¤§å¤šæ˜¯ç”±å®¢æˆ·ç«¯ä¸»åŠ¨çš„å»æ“ä½œæœåŠ¡ç«¯ï¼Œæ¯”å¦‚setã€delã€getã€expireç­‰æ“ä½œã€‚è€Œå½“ä¸€ä¸ªkeyè¿‡æœŸè¢«åˆ é™¤çš„æ—¶å€™ï¼Œç”±æœåŠ¡ç«¯ä¸»åŠ¨çš„å»é€šçŸ¥å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªè¦æ€ä¹ˆåšï¼Ÿ</p><p>ä¹‹å‰åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œæ˜¯è‡ªå·±å†™äº†ä¸€ä¸ªå®šæ—¶Jobä¸æ–­æ˜¯å»è½®è¯¢è¦ç›‘å¬çš„æŸäº›keyï¼Œç„¶åå¦‚æœå‘ç°Redisä¸­ä¸å­˜åœ¨è¦getçš„keyï¼Œåˆ™æ‰§è¡Œä¸€æ®µä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬çš„æ‰«æé¢‘ç‡å–å†³äºJobçš„æ‰§è¡Œé¢‘ç‡ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ä¿è¯keyåœ¨è¿‡æœŸæ—¶è¢«ç«‹å³ç›‘å¬åˆ°ï¼Œå¦‚æœnç§’æ‰§è¡Œä¸€æ¬¡ï¼Œåˆ™keyæœ€å¤§å¯èƒ½ä¼šåœ¨2n-1ç§’ä¹‹åè¢«æ‰§è¡Œï¼Œä¼šæœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½å¦è®©Redisä¸»åŠ¨çš„åœ¨ç¼“å­˜å¤±æ•ˆçš„æ—¶å€™é€šçŸ¥æˆ‘ä»¬å‘¢ï¼Ÿ</p><h4 id="è§£æ"><a class="markdownIt-Anchor" href="#è§£æ"></a> è§£æ</h4><p>ç”±æœåŠ¡ç«¯ä¸»åŠ¨é€šçŸ¥å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆå°±æ˜¯éœ€è¦é€šè¿‡ä¸€ä¸ªäº‹ä»¶æ¥è§¦å‘æŸé¡¹é€šçŸ¥ï¼Œäº‹ä»¶é€šè¿‡Redisçš„è®¢é˜…å’Œå‘å¸ƒåŠŸèƒ½æ¥è¿›è¡Œåˆ†å‘ï¼Œæˆ‘ä»¬æŸ¥çœ‹Redisçš„é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªEVENT NOTIFICATIONé…ç½®ï¼Œä¹Ÿåé”®ç©ºé—´é€šçŸ¥</p><p><img src="/images/image-20200512002406401.png" alt="image-20200512002406401"></p><p>æ³¨é‡Šä¸Šè¯´ï¼šRediså¯ä»¥é€šçŸ¥å‘å¸ƒ/è®¢é˜…å®¢æˆ·ç«¯å…³äºé”®ç©ºé—´ä¸­å‘ç”Ÿçš„äº‹ä»¶ï¼Œå¦‚æœRediså¼€å¯äº†é”®ç©ºé—´äº‹ä»¶é€šçŸ¥ï¼Œä¸”å®¢æˆ·ç«¯è®¢é˜…äº†æŸäº›é”®çš„äº‹ä»¶ï¼Œåˆ™åœ¨ç›¸åº”çš„é”®å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œä¼šé€šè¿‡å‘å¸ƒ/è®¢é˜…å‘å®¢æˆ·ç«¯å‘é€ä¸¤æ¡æ¶ˆæ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUBLISH __keyspace@0__:foo del</span><br><span class="line">PUBLISH __keyevent@0__:del foo</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸€ç»„ç±»ä¸­é€‰æ‹©Redisçš„é€šçŸ¥äº‹ä»¶ï¼Œæ¯ä¸ªç±»éƒ½éœ€è¦ç”±å”¯ä¸€å­—ç¬¦è¿›è¡Œæ ‡è¯†ã€‚</p><h5 id="é…ç½®"><a class="markdownIt-Anchor" href="#é…ç½®"></a> é…ç½®</h5><p>å½“å¼€å¯é”®ç©ºé—´é€šçŸ¥åŠŸèƒ½æ—¶ï¼Œéœ€è¦é¢å¤–çš„æ¶ˆè€—ä¸€äº›CPUï¼Œæ‰€ä»¥æ­¤åŠŸèƒ½é»˜è®¤ä¸ºå…³é—­çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹redis.confæ–‡ä»¶æˆ–è€…ä½¿ç”¨config setå‘½ä»¤æ¥å¼€å¯æˆ–å…³é—­é”®ç©ºé—´é€šçŸ¥åŠŸèƒ½</p><ul><li>å½“<code>notify-keyspace-events</code>çš„å€¼ä¸ºç©ºå­—ç¬¦ä¸²æ—¶ï¼ŒåŠŸèƒ½å…³é—­</li><li>å½“å‚æ•°çš„å€¼ä¸æ˜¯ç©ºå­—ç¬¦ä¸²æ—¶ï¼ŒåŠŸèƒ½å¼€å¯ï¼Œä¸”å‚æ•°çš„å€¼çš„å–å€¼èŒƒå›´æ˜¯å›ºå®šçš„</li></ul><blockquote><p>å‚æ•°çš„å¯é€‰å€¼</p></blockquote><table><thead><tr><th>å­—ç¬¦</th><th>é€šçŸ¥äº‹ä»¶</th></tr></thead><tbody><tr><td><code>K</code></td><td>é”®ç©ºé—´é€šçŸ¥ï¼Œæ‰€æœ‰é€šçŸ¥ä»¥ <code>__keyspace@__</code> ä¸ºå‰ç¼€</td></tr><tr><td><code>E</code></td><td>é”®äº‹ä»¶é€šçŸ¥ï¼Œæ‰€æœ‰é€šçŸ¥ä»¥ <code>__keyevent@__</code> ä¸ºå‰ç¼€</td></tr><tr><td><code>g</code></td><td><code>DEL</code> ã€ <code>EXPIRE</code> ã€ <code>RENAME</code> ç­‰ç±»å‹æ— å…³çš„é€šç”¨å‘½ä»¤çš„é€šçŸ¥</td></tr><tr><td><code>$</code></td><td>å­—ç¬¦ä¸²å‘½ä»¤çš„é€šçŸ¥</td></tr><tr><td><code>l</code></td><td>åˆ—è¡¨å‘½ä»¤çš„é€šçŸ¥</td></tr><tr><td><code>s</code></td><td>é›†åˆå‘½ä»¤çš„é€šçŸ¥</td></tr><tr><td><code>h</code></td><td>å“ˆå¸Œå‘½ä»¤çš„é€šçŸ¥</td></tr><tr><td><code>z</code></td><td>æœ‰åºé›†åˆå‘½ä»¤çš„é€šçŸ¥</td></tr><tr><td><code>x</code></td><td>è¿‡æœŸäº‹ä»¶ï¼šæ¯å½“æœ‰è¿‡æœŸé”®è¢«åˆ é™¤æ—¶å‘é€</td></tr><tr><td><code>e</code></td><td>é©±é€(evict)äº‹ä»¶ï¼šæ¯å½“æœ‰é”®å› ä¸º <code>maxmemory</code> æ”¿ç­–è€Œè¢«åˆ é™¤æ—¶å‘é€</td></tr><tr><td><code>A</code></td><td>å‚æ•° <code>g$lshzxe</code> çš„åˆ«å</td></tr></tbody></table><p>è¾“å…¥çš„å‚æ•°ä¸­è‡³å°‘è¦æœ‰ä¸€ä¸ª<code>K</code>æˆ–<code>E</code>æ¥æŒ‡å®šé€šçŸ¥ç±»å‹ï¼Œå¦åˆ™é…ç½®ä¸ä¼šç”Ÿæ•ˆ</p><h5 id="è¿‡æœŸé€šçŸ¥äº‹ä»¶"><a class="markdownIt-Anchor" href="#è¿‡æœŸé€šçŸ¥äº‹ä»¶"></a> è¿‡æœŸé€šçŸ¥äº‹ä»¶</h5><p>åœ¨Redisä¸­æœ‰ä¸¤ç§æ–¹å¼å°†keyåˆ é™¤ï¼š</p><ol><li>å½“ä¸€ä¸ªé”®è¢«è®¿é—®æ—¶ï¼ŒRedisä¼šå¯¹è¿™ä¸ªé”®è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœé”®å·²ç»è¿‡æœŸï¼Œåˆ™å°†è¯¥é”®åˆ é™¤</li><li>Redisåå°ä¼šå®šæœŸåˆ é™¤é‚£äº›å·²ç»è¿‡æœŸçš„é”®</li></ol><p>å½“è¿‡æœŸé”®è¢«åˆ é™¤æ—¶ï¼ŒRedisä¼šäº§ç”Ÿä¸€ä¸ªexpiredé€šçŸ¥ã€‚åœ¨æ­¤è¦ç†è§£ä¸€ç‚¹ï¼Œå°±æ˜¯å¹¶ä¸æ˜¯å½“keyçš„TTLå˜ä¸º0æ—¶å°±ä¼šç«‹å³è¢«åˆ é™¤ï¼Œæ‰€ä»¥Redisäº§ç”Ÿexpiredé€šçŸ¥çš„æ—¶é—´ä¸ºé”®è¢«åˆ é™¤çš„æ—¶å€™è€Œä¸æ˜¯é”®çš„TTLå˜ä¸º0çš„æ—¶å€™ã€‚</p><p>ä¾æ®ä¸Šè¿°è¡¨æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>notify-keyspace-events</code>è®¾ç½®ä¸º<code>Ex</code>ï¼Œè¡¨ç¤ºé”®è¿‡æœŸäº‹ä»¶é€šçŸ¥ã€‚</p><h5 id="javaåº”ç”¨ä¸­é€šçŸ¥ç›‘æ§"><a class="markdownIt-Anchor" href="#javaåº”ç”¨ä¸­é€šçŸ¥ç›‘æ§"></a> Javaåº”ç”¨ä¸­é€šçŸ¥ç›‘æ§</h5><p>Spring Data Redis å®ç°å‘å¸ƒè®¢é˜…åŠŸèƒ½éå¸¸ç®€å•ï¼Œåªæœ‰è¿™æ ·çš„å‡ ä¸ªç±»ï¼š<code>Topic</code>ã€<code>MessageListener</code>ã€<code>RedisMessageListenerContainer</code>ã€‚ä¸‹é¢å¯¹å®ƒä»¬è¿›è¡Œè§£é‡Šï¼š</p><p><code>org.springframework.data.redis.listener.Topic</code>æ¶ˆæ¯å‘é€è€…ä¸æ¥æ”¶è€…ä¹‹é—´çš„ channel å®šä¹‰ï¼Œæœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š</p><ol><li><code>org.springframework.data.redis.listener.ChannelTopic</code>ï¼šä¸€ä¸ªç¡®å®šçš„å­—ç¬¦ä¸²</li><li><code>org.springframework.data.redis.listener.PatternTopic</code>ï¼šåŸºäºæ¨¡å¼åŒ¹é…</li></ol><p><code>org.springframework.data.redis.connection.MessageListener</code>ä¸€ä¸ªå›è°ƒæ¥å£ï¼Œæ¶ˆæ¯ç›‘å¬å™¨ï¼Œç”¨äºæ¥æ”¶å‘é€åˆ° channel çš„æ¶ˆæ¯ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.data.redis.connection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç›‘å¬Redisçš„è®¢é˜…é€šçŸ¥</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Costin Leau</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Christoph Strobl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½“ä»Redisæ¥æ”¶åˆ°é€šçŸ¥åçš„å›è°ƒæ–¹æ³•</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message message must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pattern pattern matching the channel (if specified) - can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, @Nullable <span class="keyword">byte</span>[] pattern)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>org.springframework.data.redis.listener.RedisMessageListenerContainer</code>ç”¨äºæ¶ˆæ¯ç›‘å¬ï¼Œéœ€è¦å°† <code>Topic</code>å’Œ<code>MessageListener</code>æ³¨å†Œåˆ°<code>RedisMessageListenerContainer</code>ä¸­ï¼Œå½“ Topic ä¸Šæœ‰æ¶ˆæ¯æ—¶ï¼Œç”±<code>RedisMessageListenerContainer</code>é€šçŸ¥<code>MessageListener</code>ï¼Œå®¢æˆ·ç«¯é€šè¿‡onMessage()æ‹¿åˆ°æ¶ˆæ¯åï¼Œè‡ªè¡Œå¤„ç†ã€‚</p><ul><li><p>å¼•å…¥redisçš„ä¾èµ–åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º<code>RedisMessageListenerContainer</code>å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisListenerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">container</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        container.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºkeyè¿‡æœŸäº‹ä»¶ç›‘å¬å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.KeyExpirationEventMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisKeyExpirationListener</span> <span class="keyword">extends</span> <span class="title">KeyExpirationEventMessageListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisKeyExpirationListener</span><span class="params">(RedisMessageListenerContainer listenerContainer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(listenerContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, <span class="keyword">byte</span>[] pattern)</span> </span>&#123;</span><br><span class="line">        String key = message.toString();</span><br><span class="line">        System.out.println(<span class="string">"ç›‘å¬åˆ°key: "</span> + key + <span class="string">" è¿‡æœŸ!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å·¥ä½œä¸­å¶å°”ä¼šé‡åˆ°è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šç”¨æˆ·ä¸‹å•ä¹‹åï¼Œè‹¥30åˆ†é’Ÿå†…æœªå®Œæˆæ”¯ä»˜ï¼Œåˆ™å–æ¶ˆè®¢å•ã€‚&lt;/p&gt;
&lt;p&gt;åšè¿‡ç”µå•†ä¸šåŠ¡çš„åŒå­¦ï¼Œå°¤å…¶æ˜¯åšç»Ÿä¸€ä¸‹å•ä¸šåŠ¡çš„åŒå­¦ä¸€èˆ¬éƒ½ä¼šæ¥è§¦è¿‡è¿™ä¸ªåœºæ™¯çš„éœ€æ±‚ï¼Œä¸€èˆ¬çš„å¤„ç†æ–¹å¼æ˜¯å°†è®¢å•æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼ˆMySQLä¹‹ç±»çš„ï¼‰ï¼Œç„¶åç”±ä¸€ä¸ªå®šæ—¶Jobä¸æ–­çš„å»æ‰«æç¬¦åˆæ¡
      
    
    </summary>
    
    
      <category term="Redis" scheme="http://luxiaowan.github.io/categories/Redis/"/>
    
    
  </entry>
  
  <entry>
    <title>JVMå‘½ä»¤ä¹‹jcmd</title>
    <link href="http://luxiaowan.github.io/2020/05/11/JVM%E5%91%BD%E4%BB%A4%E4%B9%8Bjcmd/"/>
    <id>http://luxiaowan.github.io/2020/05/11/JVMå‘½ä»¤ä¹‹jcmd/</id>
    <published>2020-05-11T10:21:00.000Z</published>
    <updated>2020-05-11T12:21:17.456Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>åœ¨jdk1.7ä¹‹åï¼Œjdkå‘½ä»¤å®¶æ—æ–°å¢äº†ä¸€ä¸ªç‰¹ç‰›çš„å‘½ä»¤ï¼šjcmdï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½çš„æ ¹æ®ï¼Œæ±‡é›†äº†jpsã€jmapã€jstackã€jinfoã€jstatç­‰å¤šä¸ªå‘½ä»¤çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰è¦ä½¿ç”¨å¤šä¸ªJVMå‘½ä»¤æ‰èƒ½è¾¾åˆ°çš„ç›®çš„ï¼Œç°åœ¨åªéœ€è¦ä½¿ç”¨ä¸€ä¸ªjcmdå‘½ä»¤å³å¯ã€‚</p><p><img src="/images/image-20200511182956340.png" alt="image-20200511182956340"></p><ul><li>jcmd &lt;pid | main class&gt; &lt;command â€¦ | PerfCounter.print | -f file&gt;<ul><li>pidï¼šJavaè¿›ç¨‹ID</li><li>main classï¼šJavaè¿›ç¨‹çš„mainç±»ï¼Œmainç±»åç§°å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œå¦‚æœæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸­æœ‰å¤šä¸ªè¿›ç¨‹çš„mainç±»åç§°ç›¸åŒï¼Œåˆ™ä¼šå°†è¯Šæ–­å‘½ä»¤è¯·æ±‚å‘é€åˆ°æ‰€æœ‰çš„å‘½ä¸­è¿›ç¨‹ä¸­</li><li>commandï¼šè¯Šæ–­æŒ‡ä»¤å‚æ•°ï¼Œå¯ä»¥é€šè¿‡<code>jcmd pid help</code>æŸ¥çœ‹è¿›ç¨‹æ”¯æŒçš„å‚æ•°</li><li>PerfCounter.printï¼šæ‰“å°Javaè¿›ç¨‹ä¸Šå¯ç”¨çš„æ€§èƒ½è®¡æ•°å™¨ï¼Œè¯¥è®¡æ•°å™¨çš„åˆ—è¡¨ä¼šéšç€Javaè¿›ç¨‹çš„ä¸åŒè€Œå‘ç”Ÿå˜åŒ–</li><li>-f fileï¼šä»æ–‡ä»¶fileä¸­è¯»å–å‘½ä»¤å¹¶åœ¨ç›®æ ‡Javaè¿›ç¨‹ä¸Šæ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚åœ¨æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªå‘½ä»¤å¿…é¡»å•ç‹¬çš„å†™åœ¨ä¸€è¡Œé‡Œï¼Œä»¥<code>#</code>å¼€å¤´çš„è¡Œä¼šè¢«å¿½ç•¥ï¼Œå½“æ‰€æœ‰è¡Œéƒ½è¢«è°ƒç”¨å®Œæ¯•ä¹‹åï¼Œæˆ–è€…è¯»å–åˆ°stopå‘½ä»¤ï¼Œå°†ä¼šç»ˆæ­¢å¯¹fileçš„å¤„ç†</li></ul></li><li>-lï¼šåˆ—å‡ºJVMè¿›ç¨‹</li><li>-hï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</li></ul><h3 id="ç¤ºä¾‹"><a class="markdownIt-Anchor" href="#ç¤ºä¾‹"></a> ç¤ºä¾‹</h3><ol><li><p>jcmd -l</p><p>æŸ¥çœ‹å½“å‰æœºå™¨ä¸Šæ‰€æœ‰çš„jvmè¿›ç¨‹ä¿¡æ¯ï¼Œä¸<code>jps -l</code>ã€<code>jcmd</code>å‘½ä»¤æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511193521904.png" alt="image-20200511193521904"></p></li><li><p>jcmd pid PerfCounter.print</p><p>æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯ï¼Œç›¸å½“äº<code>jstat -J-Djstat.showUnsupported=true -snap pid</code>æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511193725364.png" alt="image-20200511193725364"></p></li><li><p>jcmd pid help</p><p>æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹æ”¯æŒçš„æ“ä½œå‚æ•°</p><p><img src="/images/image-20200511193818369.png" alt="image-20200511193818369"></p></li><li><p>jcmd pid help command</p><p>æŸ¥çœ‹æŒ‡å®šå‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯</p><p><img src="/images/image-20200511193938227.png" alt="image-20200511193938227"></p></li><li><p>jcmd pid VM.uptime</p><p>æŸ¥çœ‹è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶é•¿</p><p><img src="/images/image-20200511194101355.png" alt="image-20200511194101355"></p></li><li><p>jcmd pid VM.classloader_stats</p><p>æŸ¥çœ‹ç±»åŠ è½½å™¨ä¿¡æ¯ï¼Œç­‰åŒäº<code>jmap -clstats</code>å‘½ä»¤</p><p><img src="/images/image-20200511194314593.png" alt="image-20200511194314593"></p></li><li><p>jcmd pid Thread.print</p><p>æ‰“å°Javaè¿›ç¨‹çš„çº¿ç¨‹ä¿¡æ¯ï¼Œä¸<code>jstack</code>æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511194510978.png" alt="image-20200511194510978"></p></li><li><p>jcmd pid GC.class_histogram</p><p>æŸ¥çœ‹è¿›ç¨‹ä¸­çš„ç±»ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸<code>jmap -histo</code>æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511194712997.png" alt="image-20200511194712997"></p></li><li><p>jcmd pid GC.heap_dump filepath</p><p>ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶ï¼Œä¸<code>jmap -dump:format=b,file=a.hprof</code>æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511194938288.png" alt="image-20200511194938288"></p></li><li><p>jcmd pid GC.heap_info</p><p>æŸ¥çœ‹JVMçš„å †ä¿¡æ¯ï¼Œä¸<code>jmap -heap</code>æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511195121583.png" alt="image-20200511195121583"></p></li><li><p>jcmd pid GC.finalizer_info</p><p>æŸ¥çœ‹æ­£åœ¨ç­‰å¾…å›æ”¶çš„å¯¹è±¡ä¿¡æ¯ï¼Œä¸<code>jmap -finalizerinfo</code>æ•ˆæœä¸€æ ·</p></li><li><p>jcmd pid GC.run</p><p>å‘Šè¯‰åƒåœ¾æ”¶é›†å™¨è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œç­‰äºæ˜¯å¯¹JVMæ‰§è¡Œäº†<code>System.gc()</code></p></li><li><p>jcmd pid VM.version</p><p>æŸ¥çœ‹JVMå½“å‰ç‰ˆæœ¬ï¼Œå’Œ<code>jinfo pid | grep version</code>æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511200800384.png" alt="image-20200511200800384"></p></li><li><p>jcmd pid VM.system_properties</p><p>æŸ¥çœ‹JVMç³»ç»Ÿå±æ€§ä¿¡æ¯ï¼Œå’Œ<code>jinfo</code>æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511200911867.png" alt="image-20200511200911867"></p></li><li><p>jcmd pid VM.flags</p><p>æŸ¥çœ‹JVMçš„å¯åŠ¨å‚æ•°ï¼Œä¸<code>jinfo -flags</code>æ•ˆæœä¸€æ ·</p><p><img src="/images/image-20200511202039543.png" alt="image-20200511202039543"></p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å‰è¨€&quot;&gt;&lt;/a&gt; å‰è¨€&lt;/h3&gt;
&lt;p&gt;åœ¨jdk1.7ä¹‹åï¼Œjdkå‘½ä»¤å®¶æ—æ–°å¢äº†ä¸€ä¸ªç‰¹ç‰›çš„å‘½ä»¤ï¼šjcmdï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½çš„æ ¹æ®ï¼Œæ±‡é›†äº†jpsã€jmapã€jstackã€jinfoã€jst
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>JVMå‘½ä»¤ä¹‹jmap</title>
    <link href="http://luxiaowan.github.io/2020/05/11/JVM%E5%91%BD%E4%BB%A4%E4%B9%8Bjmap/"/>
    <id>http://luxiaowan.github.io/2020/05/11/JVMå‘½ä»¤ä¹‹jmap/</id>
    <published>2020-05-11T07:40:00.000Z</published>
    <updated>2020-05-11T10:02:02.532Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h3><p>jmapæ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½å‘½ä»¤ï¼Œå®ƒå¯ä»¥ç”ŸæˆJavaåº”ç”¨çš„dumpæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹å †å†…å¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ã€æŸ¥çœ‹ClassLoaderä¿¡æ¯å’Œfinalizeré˜Ÿåˆ—ç­‰ï¼Œä½†æ˜¯jmapä¼šå°†æ•´ä¸ªJVMçš„çº¿ç¨‹å…¨éƒ¨æš‚åœï¼Œæ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ…é‡jmapå‘½ä»¤ã€‚</p><img src="/images/image-20200511155155703.png" alt="image-20200511155155703" style="zoom:50%;"><blockquote><p>å‚æ•°</p></blockquote><ul><li>optionï¼šé€‰é¡¹å‚æ•°</li><li>pidï¼šè¿›ç¨‹ID</li><li>executableï¼šç”Ÿæˆæ ¸å¿ƒdumpçš„Javaå¯æ‰§è¡Œæ–‡ä»¶</li><li>coreï¼šéœ€è¦æ‰“å°é…ç½®ä¿¡æ¯çš„æ ¸å¿ƒæ–‡ä»¶</li><li>server_idï¼šå”¯ä¸€æœåŠ¡IDï¼Œè‹¥ä¸€å°ä¸»æœºä¸Šå¼€å¯äº†å¤šä¸ªè¿œç¨‹debugæœåŠ¡</li><li>remote server IP or hostnameï¼šè¿œç¨‹debugæœåŠ¡çš„ä¸»æœºåæˆ–IP</li></ul><blockquote><p>optioné€‰é¡¹</p></blockquote><ul><li>noneï¼šæŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ åƒä¿¡æ¯ï¼Œå’ŒSolarisçš„pmapå‘½ä»¤ç±»ä¼¼</li><li>heapï¼šæ˜¾ç¤ºJVMå †è¯¦ç»†ä¿¡æ¯</li><li>histo[:live]ï¼šæ‰“å°å †ä¸­å¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œ<code>:live</code>å­é€‰é¡¹æ˜¯æŒ‡å®šä»…æ‰“å°å‡ºå­˜æ´»çš„å¯¹è±¡</li><li>clstatsï¼šæ‰“å°ç±»åŠ è½½å™¨ä¿¡æ¯</li><li>finalizerinfoï¼šæ˜¾ç¤ºæ­£åœ¨å‡†å¤‡è¢«å›æ”¶çš„å¯¹è±¡ä¿¡æ¯</li><li>dump:&lt;dump-options&gt;ï¼šç”Ÿæˆå †è½¬å‚¨å¿«ç…§<ul><li>liveï¼šä»…è½¬å‚¨å †ä¸­å­˜æ´»çš„å¯¹è±¡</li><li>format=bï¼šäºŒè¿›åˆ¶æ–¹å¼</li><li>fileï¼šå †è½¬å‚¨å¿«ç…§æ–‡ä»¶</li></ul></li><li>Fï¼šå½“dumpæˆ–histoæ²¡æœ‰å“åº”æ—¶ï¼Œä½¿ç”¨è¯¥å‚æ•°å¯ä»¥å¼ºåˆ¶æ‰§è¡Œï¼Œä½†æ˜¯è‹¥å­é€‰é¡¹æ˜¯<code>:live</code>åˆ™ä½¿ç”¨-Fä¹Ÿæ— æ•ˆ</li><li>h | helpï¼šæ˜¾ç¤ºå‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯</li><li>j&lt;flag&gt;ï¼šç»™è¿è¡Œä¸­çš„JVMä¼ å‚æ•°ç»™jmap</li></ul><h3 id="ç¤ºä¾‹"><a class="markdownIt-Anchor" href="#ç¤ºä¾‹"></a> ç¤ºä¾‹</h3><blockquote><p>å‡†å¤‡ï¼šå¯åŠ¨ä¸€ä¸ªæ­»å¾ªç¯çš„mainæ–¹æ³•</p><p>é€šè¿‡jpså‘½ä»¤æŸ¥çœ‹åº”ç”¨çš„pid</p><p>pidï¼š10456</p></blockquote><ol><li><p>jmap pid</p><p>æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ åƒä¿¡æ¯</p><img src="/images/image-20200511162040121.png" alt="image-20200511162040121" style="zoom:50%;"></li><li><p>jmap -heap pid</p><p>æ˜¾ç¤ºJVMå †è¯¦ç»†ä¿¡æ¯</p><p><img src="/images/image-20200511162552365.png" alt="image-20200511162552365"></p></li><li><p>jmap -histo:live pid</p><p>æ˜¾ç¤ºå †ä¸­å­˜æ´»çš„å¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¿¡æ¯åŒ…å«æ¯ä¸ªå­˜æ´»çš„Javaç±»ã€å¯¹è±¡æ•°é‡ã€å†…å­˜å¤§å°ï¼ˆä»å¤§åˆ°å°æ’åˆ—ï¼Œå•ä½ï¼šå­—èŠ‚ï¼‰ã€ç±»å…¨é™å®šå</p><p><img src="/images/image-20200511173916727.png" alt="image-20200511173916727"></p></li><li><p>jmap -clstats pid</p><p>æ‰“å°ç±»åŠ è½½å™¨ä¿¡æ¯ï¼Œä¿¡æ¯åŒ…å«ç±»åŠ è½½å™¨åç§°ã€æ‰€åŠ è½½çš„ç±»çš„æ•°é‡ã€æ‰€åŠ è½½çš„ç±»çš„å¤§å°ã€çˆ¶åŠ è½½å™¨ã€å­˜æ´»çŠ¶æ€ã€åŠ è½½å™¨åœ°å€ç­‰</p><p><img src="/images/image-20200511174142448.png" alt="image-20200511174142448"></p></li><li><p>jmap -finalizerinfo pid</p><p>æ‰“å°æ­£åœ¨ç­‰å¾…è¢«å›æ”¶çš„å¯¹è±¡ä¿¡æ¯</p><p><img src="/images/image-20200511174414285.png" alt="image-20200511174414285"></p><p>è¡¨ç¤ºå½“å‰å¹¶æ— å¾…å›æ”¶å¯¹è±¡</p></li><li><p>jmap -dump:format=b,file=heapdump.hprof pid</p><p>ç”Ÿæˆå †è½¬å‚¨å¿«ç…§dumpæ–‡ä»¶ï¼Œä»¥hprofäºŒè¿›åˆ¶æ ¼å¼è½¬å‚¨Javaå †ä¿¡æ¯åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨liveå­é€‰é¡¹æŒ‡å®šåªå°†å †ä¸­å­˜æ´»çš„å¯¹è±¡è½¬å‚¨å‡ºæ¥ï¼Œç”Ÿæˆçš„æ–‡ä»¶å¯ä»¥ä½¿ç”¨jhatå‘½ä»¤æˆ–è€…MATå·¥å…·è§£æ</p><p><img src="/images/image-20200511175932610.png" alt="image-20200511175932610"></p></li></ol><h3 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h3><p>åœ¨jmapæ‰§è¡Œæ—¶ï¼ŒJVMä¸ºäº†ä¿è¯dumpçš„ä¿¡æ¯çš„å¯é æ€§ï¼Œä¼šæš‚åœåº”ç”¨çš„æ‰€æœ‰çº¿ç¨‹ï¼Œå¦‚æœå †å†…å¯¹è±¡è¿‡å¤§çš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šéå¸¸è€—æ—¶ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒæ…ç”¨ã€‚</p><p>ä½†æ˜¯å½“ç”Ÿäº§æœåŠ¡å¤„äº†é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™ä¸å¾—ä¸ä½¿ç”¨çš„è¯ï¼Œé‚£å°±ç”¨å§ï¼Œåº”ç”¨éƒ½å‡ºé—®é¢˜äº†ï¼Œè¿˜åœ¨æ„ä¼šä¸ä¼šSTWå¹²å•¥ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç®€ä»‹&quot;&gt;&lt;/a&gt; ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;jmapæ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½å‘½ä»¤ï¼Œå®ƒå¯ä»¥ç”ŸæˆJavaåº”ç”¨çš„dumpæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹å †å†…å¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ã€æŸ¥çœ‹ClassLoaderä¿¡æ¯å’Œfinalizer
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>JVMå‘½ä»¤ä¹‹jstack</title>
    <link href="http://luxiaowan.github.io/2020/05/11/JVM%E5%91%BD%E4%BB%A4%E4%B9%8Bjstack/"/>
    <id>http://luxiaowan.github.io/2020/05/11/JVMå‘½ä»¤ä¹‹jstack/</id>
    <published>2020-05-10T16:11:00.000Z</published>
    <updated>2020-05-11T18:15:48.226Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç®€è¿°"><a class="markdownIt-Anchor" href="#ç®€è¿°"></a> ç®€è¿°</h3><p>jstackæ˜¯jdkè‡ªå¸¦çš„çº¿ç¨‹å †æ ˆåˆ†æå·¥å…·ï¼Œä½¿ç”¨è¯¥å‘½ä»¤å¯ä»¥æŸ¥çœ‹æˆ–å¯¼å‡ºJavaåº”ç”¨ä¸­çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œä¸»è¦ç”¨æ³•ï¼š</p><img src="/images/image-20200511001238117.png" alt="image-20200511001238117" style="zoom:50%;"><ul><li>-Fï¼šå¼ºåˆ¶æ‰“å°çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œå½“<code>jstack [-l] &lt;pid&gt;</code>æ— å“åº”æ—¶ä½¿ç”¨</li><li>-mï¼šæ‰“å°Javaå’Œnativeæ¡†æ¶çš„æ‰€æœ‰å †æ ˆä¿¡æ¯</li><li>-lï¼šé•¿åˆ—è¡¨ï¼Œæ‰“å°å…³äºé”çš„é™„åŠ ä¿¡æ¯</li><li>-h or -helpï¼šæ‰“å°å¸®åŠ©ä¿¡æ¯</li></ul><p><code>pid</code>æ˜¯éœ€è¦è¢«æ‰“å°å †æ ˆä¿¡æ¯çš„Javaè¿›ç¨‹idï¼Œå¯ä»¥ä½¿ç”¨jpsæŸ¥çœ‹ï¼Œé€šè¿‡jstackå‘½ä»¤å¯ä»¥è·å–å½“å‰è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯ï¼Œæ¯ä¸ªçº¿ç¨‹å †ä¿¡æ¯ä¸­å¯ä»¥çœ‹åˆ°çº¿ç¨‹IDã€çº¿ç¨‹çŠ¶æ€ã€æ˜¯å¦æŒæœ‰é”ç­‰ä¿¡æ¯ã€‚</p><h3 id="æ­»é”æ’æŸ¥"><a class="markdownIt-Anchor" href="#æ­»é”æ’æŸ¥"></a> æ­»é”æ’æŸ¥</h3><p>çº¿ç¨‹æ­»é”çš„æƒ…å†µå¾ˆç®€å•ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€å¼ å›¾å³å¯ç†è§£ï¼š</p><img src="/images/image-20200511011015785.png" alt="image-20200511011015785" style="zoom:50%;"><p>é¦–å…ˆæˆ‘ä»¬å†™ä¸€æ®µæ­»é”ä»£ç ï¼Œä»£ç é€»è¾‘å¾ˆç®€å•ï¼Œå†™ä¸¤ä¸ªçº¿ç¨‹ï¼Œæä¾›ä¸¤ä¸ªReentrantLockå¯¹è±¡ï¼Œåœ¨çº¿ç¨‹1ä¸­å…ˆå¯¹lock1åŠ é”ï¼Œç„¶åå†å¯¹lock2åŠ é”ï¼Œè€Œåœ¨çº¿ç¨‹2ä¸­å…ˆå¯¹lock2åŠ é”ï¼Œå†å¯¹lock1åŠ é”ï¼Œä½¿è¿™ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç«äº‰é”lock1å’Œlock2ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLockTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Lock lock1 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        Lock lock2 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        </span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock1.lock();</span><br><span class="line">                System.out.println(<span class="string">"cc1è·å–åˆ°lock1"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                lock2.lock();</span><br><span class="line">                System.out.println(<span class="string">"cc1è·å–åˆ°lock2"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock1.unlock();</span><br><span class="line">                lock2.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"cc1"</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock2.lock();</span><br><span class="line">                System.out.println(<span class="string">"cc2è·å–åˆ°lock2"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                lock1.lock();</span><br><span class="line">                System.out.println(<span class="string">"cc2è·å–åˆ°lock1"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock1.unlock();</span><br><span class="line">                lock2.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"cc2"</span>);</span><br><span class="line">        </span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç¨‹åºä¹‹åï¼Œæ§åˆ¶å°è¾“å‡ºå†…å®¹ï¼š</p><img src="/images/image-20200511004249590.png" alt="image-20200511004249590" style="zoom:50%;"><p>ç„¶åå°±ä¸€ç›´åœé¡¿åœ¨è¿™é‡Œï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨jstackæ’æŸ¥ä¸€ä¸‹ï¼š</p><ol><li><p>ä½¿ç”¨jpsæŸ¥çœ‹è¿›ç¨‹pid</p><img src="/images/image-20200511004456408.png" alt="image-20200511004456408" style="zoom:50%;"><p>æˆ‘ä»¬çœ‹åˆ°è¿›ç¨‹çš„pidä¸º75169ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ ¹æ®è¯¥pidæ‰“å°å‡ºå †æ ˆä¿¡æ¯</p></li><li><p>é€šè¿‡jstackæŸ¥çœ‹è¿›ç¨‹çš„å †æ ˆä¿¡æ¯</p><p>æ‰§è¡Œå‘½ä»¤<code>jstack -l 75169</code>ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºçš„ä¿¡æ¯</p><img src="/images/image-20200511005029659.png" alt="image-20200511005029659" style="zoom:50%;"></li><li><p>æ’æŸ¥æ­»é”</p><ul><li>ç›´æ¥æ–¹æ³•</li></ul><p>æŸ¥çœ‹çº¢æ¡†å†…çš„ä¿¡æ¯ï¼Œå‘ç°åœ¨å †æ ˆä¿¡æ¯ä¸­å·²ç»å‘Šè¯‰äº†æˆ‘ä»¬æ­»é”çš„ä¿¡æ¯ï¼ŒåŠå‘ç”Ÿæ­»é”çš„çº¿ç¨‹åç§°å’Œæ­£åœ¨ç­‰å¾…çš„é”ï¼Œä»¥åŠç­‰å¾…çš„é”çš„å½“å‰æ‹¥æœ‰è€…çš„çº¿ç¨‹åç§°ã€‚</p><p>æŸ¥çœ‹é»„æ¡†å†…çš„ä¿¡æ¯ï¼Œè¿™æ˜¯æˆ‘ä»¬æ’æŸ¥ä»£ç é—®é¢˜çš„å…³é”®æ‰€åœ¨ï¼Œä¹Ÿå°±æ˜¯åœ¨å †æ ˆä¿¡æ¯ä¸­ï¼Œä¼šå‘Šè¯‰æˆ‘ä»¬å‘ç”Ÿæ­»é”çš„ä»£ç ä½ç½®ï¼Œä¾¿äºæˆ‘ä»¬å®šä½å‘ç”Ÿæ­»é”çš„ä»£ç ã€‚</p><ul><li>é—´æ¥æ–¹æ³•</li></ul><p>å¦‚æœå †æ ˆä¸­æœªå‘Šè¯‰æˆ‘ä»¬æ­»é”çš„å…³è”çº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡çº¿ç¨‹æ­£åœ¨ç­‰å¾…çš„é”çš„ä¿¡æ¯åœ¨å †æ ˆä¿¡æ¯ä¸­è¿›è¡Œæœç´¢ï¼Œæœ¬ç¤ºä¾‹ä¸­ï¼Œçº¿ç¨‹cc2çš„å †æ ˆä¿¡æ¯ä¸­<code>- parking to wait for &lt;0x000000076b2839a8&gt;</code>å‘Šè¯‰æˆ‘ä»¬å½“å‰çº¿ç¨‹cc2æ­£åœ¨ç­‰å¾…é”0x000000076b2839a8ï¼Œå¹¶ä¸”å½“å‰å·²ç»éœ¸å äº†é”0x000000076b2839d8ï¼›</p><img src="/images/image-20200511005806128.png" alt="image-20200511005806128" style="zoom:50%;"><p>è€Œçº¿ç¨‹cc1çš„å †æ ˆä¿¡æ¯ä¸­<code>- parking to wait for &lt;0x000000076b2839d8&gt;</code>å‘Šè¯‰æˆ‘ä»¬å®ƒæ­£åœ¨ç­‰å¾…é”0x000000076b2839d8ï¼Œä¸”å½“å‰å·²ç»æŒæœ‰äº†é”0x000000076b2839a8ã€‚</p><img src="/images/image-20200511005950037.png" alt="image-20200511005950037" style="zoom:50%;"><p>é€šè¿‡çº¿ç¨‹cc1å’Œcc2çš„å †æ ˆä¿¡æ¯æˆ‘ä»¬èƒ½å¤Ÿç›´è§‚çš„åˆ†æå‡ºå®ƒä»¬ç›¸äº’éœ¸å äº†å¯¹æ–¹æƒ³è¦è·å–çš„é”ï¼Œå¹¶ä¸”åœ¨æœªè·å¾—æ‰€éœ€è¦çš„é”ä¹‹å‰ï¼Œç›¸äº’ä¹‹é—´éƒ½ä¸ä¼šé‡Šæ”¾å·²ç»æŒæœ‰çš„é”ï¼Œå› æ­¤å¯¼è‡´äº†ç¨‹åºå‡ºç°äº†æ­»é”ã€‚</p></li></ol><h5 id="å°ç»“"><a class="markdownIt-Anchor" href="#å°ç»“"></a> å°ç»“</h5><p>ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬é€šå¸¸æƒ…å†µä¸‹æ’æŸ¥çº¿ç¨‹æ­»é”çš„åŸºæœ¬æ“ä½œï¼Œä¸»è¦æ“ä½œé¡ºåºä¸ºï¼š</p><ol><li>ä½¿ç”¨jpsæŸ¥çœ‹è¿›ç¨‹pid</li><li>ä½¿ç”¨<code>jstack -l pid</code>æŸ¥çœ‹çº¿ç¨‹å †æ ˆä¿¡æ¯</li><li>é€šè¿‡å †æ ˆä¿¡æ¯åˆ†ææ­»é”æƒ…å†µ</li></ol><h3 id="æ’æŸ¥cpuè¿‡é«˜"><a class="markdownIt-Anchor" href="#æ’æŸ¥cpuè¿‡é«˜"></a> æ’æŸ¥CPUè¿‡é«˜</h3><p>å½“è¿è¡Œä¸­çš„çº¿ç¨‹è¿‡å¤šæ—¶ï¼ŒCPUè´Ÿè½½ä¼šæé€Ÿé£™å‡ï¼Œå¦‚æœæˆ‘ä»¬ä¸åŠæ—¶è§£å†³å°±ä¼šå¯¼è‡´å› CPUè¿‡é«˜è€Œå”¤é†’çš„ç³»ç»Ÿçš„è‡ªæˆ‘ä¿æŠ¤ï¼Œå°†è¿›ç¨‹æ€æ­»ã€‚åœ¨å®é™…å·¥ä½œå½“ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°æ­¤ç§æƒ…å†µï¼Œå½“ç„¶æˆ‘ä»¬ä¸èƒ½çœ‹åˆ°CPUè¾¾åˆ°100%æˆ–è€…300%äº†å°±è®¤ä¸ºæ˜¯CPUè´Ÿè½½è¿‡é«˜ï¼Œè¿™è¦æ ¹æ®æˆ‘ä»¬æœåŠ¡å™¨çš„CPUä¸ªæ•°å’Œæ¯ä¸ªCPUçš„è´Ÿè½½æ¥åˆ¤æ–­CPUæ˜¯å¦è¿‡é«˜ã€‚</p><blockquote><p>æŸ¥çœ‹æœåŠ¡å™¨è´Ÿè½½ï¼šä½¿ç”¨topå‘½ä»¤æŸ¥çœ‹æœºå™¨è´Ÿè½½</p><p><img src="/images/image-20200511013557261.png" alt="image-20200511013557261"></p><ul><li>load averageåé¢åˆ†è¡¨ä»£è¡¨1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿçš„ç³»ç»Ÿå¹³å‡è´Ÿè½½æƒ…å†µï¼Œä¸€èˆ¬ä¸è¶…è¿‡CPUä¸ªæ•°*0.7å³å¯è®¤ä¸ºæ˜¯æ­£å¸¸ï¼Œä½¿ç”¨uptimeå‘½ä»¤ä¹Ÿå¯ä»¥æŸ¥çœ‹è¯¥å±æ€§</li><li>æŒ‰é”®1å¯ä»¥æŸ¥çœ‹æ¯ä¸ªCPUçš„è´Ÿè½½æƒ…å†µï¼Œè‹¥æœ‰ä¸€ä¸ªCPUä½¿ç”¨é‡è¶…è¿‡75%ï¼Œé‚£ä¹ˆå°±éœ€è¦æ’æŸ¥äº†</li></ul></blockquote><p>æˆ‘ä»¬å†™ä¸€ä¸ªæ­»å¾ªç¯æ¥å°†CPUåƒæ»¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FullCpuTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> sum = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            sum += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>è¿è¡Œç¨‹åºä¹‹åï¼Œé€šè¿‡topå‘½ä»¤æŸ¥çœ‹CPUè´Ÿè½½</p><img src="/images/image-20200511021314252.png" alt="image-20200511021314252" style="zoom:50%;"><p>æˆ‘ä»¬çœ‹åˆ°load averageå¹¶ä¸æ˜¯å¾ˆé«˜ï¼Œå› ä¸ºåˆšå¯åŠ¨ï¼Œå¾…ä¼šå°±é£™èµ·æ¥äº†ï¼Œä½†æ˜¯CPU0çš„usageå·²ç»è¾¾åˆ°äº†94.7%ï¼Œæˆ‘ä»¬çš„Javaè¿›ç¨‹çš„pidä¸º23731ã€‚</p></li><li><p>é€šè¿‡<code>top -Hp 23731</code>æŸ¥çœ‹è¿›ç¨‹å†…çš„çº¿ç¨‹è´Ÿè½½æƒ…å†µ</p><p><img src="/images/image-20200511021510357.png" alt="image-20200511021510357"></p><p>å‘ç°pidä¸º23732çš„çº¿ç¨‹å ç”¨çš„CPUæœ€é«˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ‰¾åˆ°äº†é—®é¢˜æ‰€åœ¨</p></li><li><p>æŸ¥çœ‹çº¿ç¨‹çš„å †æ ˆä¿¡æ¯</p><ul><li><p>é€šè¿‡<code>jstack hpid</code>æŸ¥çœ‹çº¿ç¨‹ä¸­å¤„äºRUNNABLEçŠ¶æ€çš„çº¿ç¨‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 23732æ˜¯çº¿ç¨‹çš„pid</span></span><br><span class="line">jstack 23732</span><br></pre></td></tr></table></figure><p><img src="/images/image-20200511021836792.png" alt="image-20200511021836792"></p></li><li><p>é€šè¿‡<code>jstack pid</code>å®šä½å…·ä½“çš„çº¿ç¨‹</p><ol><li><p>æ‰“å°çº¿ç¨‹23732çš„16è¿›åˆ¶æ•°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf '%x\n' 23732</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡jstackæ’æŸ¥å…·ä½“çš„çº¿ç¨‹ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 23731æ˜¯è¿›ç¨‹çš„pid</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5cb4æ˜¯çº¿ç¨‹pidçš„åå…­è¿›åˆ¶æ•°</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -C2æ˜¯è¾“å‡ºå‘½ä¸­è¡Œçš„ä¸Šä¸‹è¡Œæ•°ï¼Œ-C2è¡¨ç¤ºä¸Šä¸‹å„æ‰“å°ä¸¤è¡Œ</span></span><br><span class="line">jstack 23731 | grep '0x5cb4' -C2 --color</span><br></pre></td></tr></table></figure><p><img src="/images/image-20200511022609016.png" alt="image-20200511022609016"></p></li></ol></li><li><p>é€šè¿‡<code>kill -3 pid</code>æŸ¥çœ‹çº¿ç¨‹å †æ ˆä¿¡æ¯</p></li></ul></li></ol><h3 id="å…¶ä»–"><a class="markdownIt-Anchor" href="#å…¶ä»–"></a> å…¶ä»–</h3><p>ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸ä¼šè®©ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæ“ä½œï¼Œæ‰€ä»¥å¯ä»¥å°†å †æ ˆä¿¡æ¯è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œç„¶åå†è¯¦ç»†åˆ†æ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ç®€è¿°&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç®€è¿°&quot;&gt;&lt;/a&gt; ç®€è¿°&lt;/h3&gt;
&lt;p&gt;jstackæ˜¯jdkè‡ªå¸¦çš„çº¿ç¨‹å †æ ˆåˆ†æå·¥å…·ï¼Œä½¿ç”¨è¯¥å‘½ä»¤å¯ä»¥æŸ¥çœ‹æˆ–å¯¼å‡ºJavaåº”ç”¨ä¸­çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œä¸»è¦ç”¨æ³•ï¼š&lt;/p&gt;
&lt;img src=&quot;/ima
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>Javaåƒåœ¾å›æ”¶åè¯</title>
    <link href="http://luxiaowan.github.io/2020/05/10/Java%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%90%8D%E8%AF%8D/"/>
    <id>http://luxiaowan.github.io/2020/05/10/Javaåƒåœ¾å›æ”¶åè¯/</id>
    <published>2020-05-10T14:50:00.000Z</published>
    <updated>2020-05-10T15:17:07.978Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨å­¦ä¹ JVMçš„GCç›¸å…³çŸ¥è¯†æ—¶ï¼Œå¿…å®šä¼šæ¥è§¦åˆ°å‡ ä¸ªGCçš„ä¸“æœ‰åè¯ï¼šMinor GCã€Major GCã€Young GCã€Old GCã€Full GCã€Stop The Worldï¼ˆSTWï¼‰ï¼Œç°åœ¨æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹è¿™äº›åè¯å…·ä½“æŒ‡çš„æ˜¯ä»€ä¹ˆã€‚</p><h4 id="minor-gc-young-gc"><a class="markdownIt-Anchor" href="#minor-gc-young-gc"></a> Minor GC &amp;&amp; Young GC</h4><p>Minor GCå’ŒYoung GCéƒ½æ˜¯æŒ‡æ–°ç”Ÿä»£çš„å†…å­˜å›æ”¶ï¼Œä¸¤ä¸ªåè¯æŒ‡çš„æ˜¯åŒä¸€ä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ç°åœ¨çš„å•†ä¸šåŒ–è™šæ‹Ÿæœºä¸­ï¼Œæ–°ç”Ÿä»£è¢«åˆ†ä¸ºEdenå’ŒSurvivoråŒºï¼Œå…³äºMinor GCæˆ‘ä»¬éœ€è¦çŸ¥é“ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>å½“EdenåŒºæ— æ³•ä¸ºæ–°åˆ›å»ºçš„å¯¹è±¡åˆ†é…ç©ºé—´æ—¶ï¼Œä¼šè§¦å‘Minor GCã€‚EdenåŒºç©ºé—´è¶Šå°ï¼ŒMinor GCçš„é¢‘ç‡è¶Šé«˜</li><li>å½“EdenåŒºç©ºé—´ä¸è¶³è§¦å‘Minor GCæ—¶ï¼Œæ–°ç”Ÿä»£ä¸­ä¼šæœ‰éƒ¨åˆ†å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ï¼Œæ‰€ä»¥Minor GCä¹‹åï¼Œè€å¹´ä»£çš„ç©ºé—´ä½¿ç”¨é‡é€šå¸¸ä¼šæœ‰æ‰€å‡é«˜</li><li>æ–°ç”Ÿä»£çš„å¤§éƒ¨åˆ†åƒåœ¾æ”¶é›†å™¨éƒ½ä¼šè§¦å‘STWï¼Œä½†æ˜¯æ–°ç”Ÿä»£çš„å¤§éƒ¨åˆ†å¯¹è±¡é€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œæ‰€ä»¥EdenåŒºçš„å¤§éƒ¨åˆ†å¯¹è±¡éƒ½å¯ä»¥è®¤ä¸ºæ˜¯åƒåœ¾å¯¹è±¡ï¼Œåªæœ‰å¾ˆå°‘çš„ä¸€éƒ¨åˆ†å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°SurvivoråŒºå’Œè€å¹´ä»£ï¼Œè¿™ç§æƒ…å†µä¸‹STWçš„æ—¶é—´ä¼šå¾ˆçŸ­ï¼›è€Œå½“Minor GCä¹‹åEdenåŒºä»å­˜æ´»éå¸¸å¤šçš„å¯¹è±¡ï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å™¨å°±ä¼šå°†è¿™äº›å¯¹è±¡å¤åˆ¶åˆ°SurvivoråŒºæˆ–è€å¹´ä»£ï¼Œæ­¤æ—¶STWçš„æ—¶é—´å°±ä¼šå˜çš„å¾ˆé•¿ï¼Œå› ä¸ºå¤åˆ¶å¤§é‡å¯¹è±¡ç›¸æ¯”å¤åˆ¶å°‘é‡å¯¹è±¡æ›´è€—æ—¶ã€‚</li></ol><h4 id="major-gc-old-gc"><a class="markdownIt-Anchor" href="#major-gc-old-gc"></a> Major GC &amp;&amp; Old GC</h4><p>è¿™ä¸¤ä¸ªåè¯éƒ½æŒ‡çš„æ˜¯è€å¹´ä»£ç©ºé—´å›æ”¶ï¼Œä¹Ÿå±äºæ˜¯åŒä¸€ä»¶äº‹ã€‚å¾ˆå¤šæƒ…å†µä¸‹ï¼ŒMajor GCæ˜¯ç”±Minor GCè§¦å‘çš„ï¼Œæ¯”å¦‚å½“å‘ç”ŸMinor GCæ—¶ï¼Œä¼šå°†æ–°ç”Ÿä»£çš„éƒ¨åˆ†æ»¡è¶³æ¡ä»¶çš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ï¼Œå¦‚æœæ­¤æ—¶è€å¹´ä»£çš„å¯ç”¨ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘Major GCï¼Œå› æ­¤è¯´åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹Major GCéƒ½æ˜¯ç”±Minor GCè§¦å‘çš„ã€‚</p><h4 id="full-gc"><a class="markdownIt-Anchor" href="#full-gc"></a> Full GC</h4><p>Full GCæ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ç§ï¼Œå®ƒç­‰äºæ˜¯Minor GCå’ŒMajor GCçš„ç»“åˆï¼Œä¸»è¦ç”¨äºå›æ”¶æ–°ç”Ÿä»£ã€è€å¹´ä»£å’Œæ°¸ä¹…ä»£ã€‚</p><ol><li>å½“è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šè§¦å‘Full GC</li><li>åœ¨ä»£ç ä¸­æ˜¾å¼è°ƒç”¨<code>System.gc()</code>æ—¶ï¼ŒJVMä¼šå»ºè®®æ‰§è¡ŒFull GC</li><li>æ–¹æ³•åŒºç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šè§¦å‘Full GCï¼Œä½†æ˜¯åœ¨jdk1.8ä¹‹åé‡‡ç”¨Metaspaceæ¥ä»£æ›¿æ–¹æ³•åŒºï¼Œæ‰€ä»¥åœ¨æ­¤ä¹‹åä¸€èˆ¬ä¸ä¼šå› ä¸ºæ–¹æ³•åŒºç©ºé—´ä¸è¶³è€Œè§¦å‘Full GC</li><li>é€šè¿‡Minor GCä¹‹åå­˜æ´»çš„å¯¹è±¡å¤§äºä¹‹å‰æ¯æ¬¡æ™‹å‡æ—¶è€å¹´ä»£çš„å¹³å‡å¯ç”¨ç©ºé—´æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘Full GC</li></ol><h4 id="stop-the-worldstw"><a class="markdownIt-Anchor" href="#stop-the-worldstw"></a> Stop-The-Worldï¼ˆSTWï¼‰</h4><p>STWæ„ä¸ºåœæ­¢å…¨ä¸–ç•Œï¼Œå¯¹äºJVMæ¥è¯´ï¼Œå®ƒçš„ä¸–ç•Œé‡Œå­˜æ´»çš„éƒ½æ˜¯ä¸€ä¸ªä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥æ„æ€ä¹Ÿå°±æ˜¯åœ¨è¿›è¡ŒGCæ—¶ï¼Œä¼šå°†è™šæ‹Ÿæœºä¸­å…¶ä»–çš„å·¥ä½œçº¿ç¨‹å…¨éƒ¨æš‚åœï¼Œå½“GCç»“æŸä¹‹åï¼Œå†ç»§ç»­æ¢å¤å·¥ä½œã€‚</p><p>æ‰€ä»¥å¯¹äºä¸€ä¸ªåƒåœ¾æ”¶é›†å™¨æ¥è¯´ï¼ŒSTWçš„æ—¶é—´æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ€§èƒ½æŒ‡æ ‡ï¼Œå¹¶ä¸”STWç›´æ¥å½±å“çš„æ˜¯è™šæ‹Ÿæœºçš„ååé‡ï¼ˆååé‡ = è™šæ‹Ÿæœºè¿è¡Œæ—¶é—´ / (STWæ—¶é—´ + è™šæ‹Ÿæœºè¿è¡Œæ—¶é—´)ï¼‰ï¼Œä¹Ÿå°±æ˜¯STWæ—¶é—´è¶ŠçŸ­ï¼Œè™šæ‹Ÿæœºååé‡è¶Šé«˜ï¼Œæ‰§è¡Œæ•ˆç‡è¶Šé«˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æˆ‘ä»¬åœ¨å­¦ä¹ JVMçš„GCç›¸å…³çŸ¥è¯†æ—¶ï¼Œå¿…å®šä¼šæ¥è§¦åˆ°å‡ ä¸ªGCçš„ä¸“æœ‰åè¯ï¼šMinor GCã€Major GCã€Young GCã€Old GCã€Full GCã€Stop The Worldï¼ˆSTWï¼‰ï¼Œç°åœ¨æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹è¿™äº›åè¯å…·ä½“æŒ‡çš„æ˜¯ä»€ä¹ˆã€‚&lt;/p&gt;
&lt;h4 id=&quot;minor-gc
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>Synchronizedä½œç”¨åœ¨é™æ€å’Œéé™æ€æ–¹æ³•ä¸Šçš„åŒºåˆ«</title>
    <link href="http://luxiaowan.github.io/2020/05/09/Synchronized%E4%BD%9C%E7%94%A8%E5%9C%A8%E9%9D%99%E6%80%81%E5%92%8C%E9%9D%9E%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E4%B8%8A%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <id>http://luxiaowan.github.io/2020/05/09/Synchronizedä½œç”¨åœ¨é™æ€å’Œéé™æ€æ–¹æ³•ä¸Šçš„åŒºåˆ«/</id>
    <published>2020-05-09T15:21:00.000Z</published>
    <updated>2020-05-10T14:33:04.503Z</updated>
    
    <content type="html"><![CDATA[<p>synchronizedå…³é”®å­—çš„ç”¨æ³•ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><ol><li><p>ä½œç”¨åœ¨éé™æ€æ–¹æ³•ä¸Š</p><p>éé™æ€æ–¹æ³•æ˜¯åªèƒ½æä¾›ç±»çš„å®ä¾‹è¿›è¡Œè°ƒç”¨ï¼Œæ‰€ä»¥å®é™…ä¸Šå°±æ˜¯å¯¹è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡åŠ é”ï¼Œä¿—ç§°å¯¹è±¡é”</p></li><li><p>ä½œç”¨åœ¨é™æ€æ–¹æ³•ä¸Š</p><p>é™æ€æ–¹æ³•æ˜¯å¯ä»¥é€šè¿‡ç±»åç›´æ¥è°ƒç”¨ï¼Œæ‰€ä»¥å®é™…ä¸Šå°±æ˜¯å¯¹è°ƒç”¨æ–¹æ³•çš„ç±»åŠ é”ï¼Œä¿—ç§°ç±»é”</p></li><li><p>ä½œç”¨åœ¨ä»£ç å—</p><p>æ ¹æ®ä¼ å…¥çš„æ˜¯ç±»å¯¹è±¡æˆ–ç±»å®ä¾‹åˆ¤æ–­åŠ é”æ–¹å¼</p></li></ol><h4 id="åœºæ™¯åˆ†æ"><a class="markdownIt-Anchor" href="#åœºæ™¯åˆ†æ"></a> åœºæ™¯åˆ†æ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é™æ€åŒæ­¥æ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncStaticClazz</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€å®ä¾‹åŒæ­¥æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"static---method1--"</span> + Thread.currentThread());</span><br><span class="line">        <span class="keyword">try</span> &#123;Thread.sleep(<span class="number">2000</span>);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€å®ä¾‹åŒæ­¥æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"static---method2--"</span> + Thread.currentThread());</span><br><span class="line">        <span class="keyword">try</span> &#123;Thread.sleep(<span class="number">2000</span>);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éé™æ€å®ä¾‹åŒæ­¥æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"static---method3--"</span> + Thread.currentThread());</span><br><span class="line">        <span class="keyword">try</span> &#123;Thread.sleep(<span class="number">2000</span>);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éé™æ€åŒæ­¥æ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncNormalClazz</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éé™æ€å®ä¾‹åŒæ­¥æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"normal---method1--"</span> + Thread.currentThread());</span><br><span class="line">        <span class="keyword">try</span> &#123;Thread.sleep(<span class="number">2000</span>);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç±»çº§åˆ«çš„åŒæ­¥ä»£ç å—</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SyncNormalClazz.class) &#123;</span><br><span class="line">            System.out.println(<span class="string">"normal---method2--"</span> + Thread.currentThread());</span><br><span class="line">            <span class="keyword">try</span> &#123;Thread.sleep(<span class="number">2000</span>);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç±»çº§åˆ«çš„åŒæ­¥ä»£ç å—</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SyncNormalClazz.class) &#123;</span><br><span class="line">            System.out.println(<span class="string">"normal---method3--"</span> + Thread.currentThread());</span><br><span class="line">            <span class="keyword">try</span> &#123;Thread.sleep(<span class="number">2000</span>);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç±»å®ä¾‹çº§åˆ«çš„åŒæ­¥ä»£ç å—</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"normal---method4--"</span> + Thread.currentThread());</span><br><span class="line">            <span class="keyword">try</span> &#123;Thread.sleep(<span class="number">2000</span>);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>åœºæ™¯1</p><ul><li><p>æè¿°ï¼šä½¿ç”¨ç±»å¯¹è±¡åœ¨ä¸åŒçº¿ç¨‹ä¸­è®¿é—®ä¸åŒçš„é™æ€åŒæ­¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    SyncStaticClazz.method1();</span><br><span class="line">&#125;, <span class="string">"ssc1"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    SyncStaticClazz.method2();</span><br><span class="line">&#125;, <span class="string">"ssc2"</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœï¼šäº’æ–¥</p></li><li><p>è§£æï¼šé™æ€åŒæ­¥æ–¹æ³•çš„åŠ é”èŒƒå›´æ˜¯æ•´ä¸ªç±»ï¼Œæ‰€ä»¥æ— è®ºæ˜¯ä½¿ç”¨å¯¹è±¡æˆ–ç±»å»è®¿é—®é™æ€åŒæ­¥æ–¹æ³•ï¼Œé”éƒ½ä¼šåŠ åˆ°ç±»å¯¹è±¡ä¸Šã€‚å°±å¥½æ¯”æ˜¯æˆ¿å­çš„å¤§é—¨ï¼Œæˆ¿å­å†…ä¸è®ºæœ‰å¤šå°‘æˆ¿é—´ï¼Œåªè¦æœ‰ä¸€ä¸ªäººæ‰“å¼€å¤§é—¨è¿›å…¥åˆ°æˆ¿å­é‡Œï¼Œå…¶ä»–äººå°±åªèƒ½ç­‰ä»–å‡ºæ¥ä¹‹åå†è¿›å»ï¼Œè€Œå·²ç»è¿›å»çš„äººæ‹¥æœ‰æ‰€æœ‰æˆ¿é—´çš„ä½¿ç”¨æƒã€‚</p></li></ul></li><li><p>åœºæ™¯2</p><ul><li><p>æè¿°ï¼šåœ¨ä¸åŒçº¿ç¨‹ä¸­ç”¨ä¸åŒçš„ç±»å®ä¾‹è®¿é—®ç›¸åŒé™æ€æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    SyncStaticClazz c = <span class="keyword">new</span> SyncStaticClazz();</span><br><span class="line">    c.method1();</span><br><span class="line">&#125;, <span class="string">"ssc1"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    SyncStaticClazz c = <span class="keyword">new</span> SyncStaticClazz();</span><br><span class="line">    c.method1();</span><br><span class="line">&#125;, <span class="string">"ssc2"</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœï¼šäº’æ–¥</p></li><li><p>è§£æï¼šå’Œåœºæ™¯1ç›¸åŒï¼Œé™æ€æ–¹æ³•è™½ç„¶å¯ä»¥è¢«ç±»å®ä¾‹è®¿é—®ï¼Œä½†é”ä¾ç„¶æ˜¯ç±»é”</p></li></ul></li><li><p>åœºæ™¯3</p><ul><li><p>æè¿°ï¼šåŒä¸€ä¸ªå¯¹è±¡åœ¨ä¸åŒçº¿ç¨‹ä¸­è®¿é—®ä¸åŒçš„éé™æ€åŒæ­¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SyncNormalClazz snc = <span class="keyword">new</span> SyncNormalClazz();</span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    snc.method1();</span><br><span class="line">&#125;, <span class="string">"snc1"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    snc.method2();</span><br><span class="line">&#125;, <span class="string">"snc2"</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœï¼šäº’æ–¥</p></li><li><p>è§£æï¼šéé™æ€æ–¹æ³•ä¸ŠåŠ çš„æ˜¯å¯¹è±¡é”ï¼Œå½“å¯¹è±¡è°ƒç”¨ä¸€ä¸ªéé™æ€çš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çš„éé™æ€åŒæ­¥æ–¹æ³•éœ€è¦ç­‰å¾…è¢«æ‰§è¡Œã€‚</p></li></ul></li><li><p>åœºæ™¯4</p><ul><li><p>æè¿°ï¼šä¸åŒå¯¹è±¡åœ¨ä¸åŒçº¿ç¨‹ä¸­è®¿é—®åŒä¸€ä¸ªéé™æ€æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    SyncNormalClazz snc = <span class="keyword">new</span> SyncNormalClazz();</span><br><span class="line">    snc.method1();</span><br><span class="line">&#125;, <span class="string">"snc1"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    SyncNormalClazz snc = <span class="keyword">new</span> SyncNormalClazz();</span><br><span class="line">    snc.method1();</span><br><span class="line">&#125;, <span class="string">"snc2"</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœï¼šä¸äº’æ–¥</p></li><li><p>è§£æï¼šå› ä¸ºé€šè¿‡ä¸åŒçš„å¯¹è±¡è°ƒç”¨çš„æ˜¯éé™æ€æ–¹æ³•ï¼Œè™½ç„¶è°ƒç”¨çš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯éé™æ€æ–¹æ³•åŠ çš„é”æ˜¯å¯¹è±¡é”ï¼Œé’ˆå¯¹çš„æ˜¯å¯¹è±¡å¹¶ä¸æ˜¯æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œä¸ä¼šäº’æ–¥ã€‚å¦‚æœåƒåœºæ™¯1ä¸­çš„æ¯”å–»çš„è¯ï¼Œå°±æ˜¯ä¸¤ä¸ªå¯¹è±¡æ˜¯ä¸¤å¥—æˆ¿å­ï¼Œæˆ·å‹ç›¸åŒè€Œå·²ã€‚</p></li></ul></li><li><p>åœºæ™¯5</p><ul><li><p>æè¿°ï¼šä¸åŒå¯¹è±¡åœ¨ä¸åŒçº¿ç¨‹ä¸­è®¿é—®åŒä¸€ä¸ªéé™æ€éåŒæ­¥æ–¹æ³•ï¼Œæ–¹æ³•å†…é€šè¿‡synchronizedé”å®šä»£ç å—ï¼Œä¸”é”å®šå¯¹è±¡ä¸ºç±»å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    SyncNormalClazz snc = <span class="keyword">new</span> SyncNormalClazz();</span><br><span class="line">    snc.method2();</span><br><span class="line">&#125;, <span class="string">"snc3"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    SyncNormalClazz snc = <span class="keyword">new</span> SyncNormalClazz();</span><br><span class="line">    snc.method2();</span><br><span class="line">&#125;, <span class="string">"snc4"</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœï¼šäº’æ–¥</p></li><li><p>è§£æï¼šå› ä¸ºæ–¹æ³•<code>method2()</code>å†…çš„synchronizedé”çš„æ˜¯<code>SyncNormalClazz.class</code>ï¼Œä¹Ÿå°±æ˜¯é”å®šçš„æ˜¯ç±»å¯¹è±¡ï¼Œæ‰€ä»¥ä¸åœºæ™¯2ç›¸åŒ</p></li></ul></li><li><p>åœºæ™¯6</p><ul><li><p>æè¿°ï¼šåŒä¸€ä¸ªå¯¹è±¡åœ¨ä¸åŒçº¿ç¨‹ä¸­è®¿é—®ä¸åŒçš„éé™æ€éåŒæ­¥æ–¹æ³•ï¼Œæ–¹æ³•å†…é€šè¿‡synchronizedé”å®šä»£ç å—ï¼Œä¸”é”å®šå¯¹è±¡ä¸ºç±»å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SyncNormalClazz snc = <span class="keyword">new</span> SyncNormalClazz();</span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    snc.method2();</span><br><span class="line">&#125;, <span class="string">"snc2"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    snc.method3();</span><br><span class="line">&#125;, <span class="string">"snc3"</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœï¼šäº’æ–¥</p></li><li><p>è§£æï¼šå› ä¸ºæ–¹æ³•<code>method2()</code>å†…çš„synchronizedé”çš„æ˜¯<code>SyncNormalClazz.class</code>ï¼Œä¹Ÿå°±æ˜¯é”å®šçš„æ˜¯ç±»å¯¹è±¡ï¼Œæ‰€ä»¥ä¸åœºæ™¯2ç›¸åŒ</p></li></ul></li><li><p>åœºæ™¯7</p><ul><li><p>æè¿°ï¼šåŒä¸€ä¸ªå¯¹è±¡åœ¨ä¸åŒçº¿ç¨‹ä¸­è®¿é—®ä¸åŒæ–¹æ³•ï¼Œä¸€ä¸ªè°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¸€ä¸ªè°ƒç”¨éé™æ€æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SyncStaticClazz ssc = <span class="keyword">new</span> SyncStaticClazz();</span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    ssc.method2();</span><br><span class="line">&#125;, <span class="string">"ssc2"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    ssc.method3();</span><br><span class="line">&#125;, <span class="string">"ssc3"</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœï¼šä¸äº’æ–¥</p></li><li><p>è§£æï¼šè™½ç„¶æ˜¯åŒä¸€ä¸ªå¯¹è±¡è°ƒç”¨ï¼Œä½†æ˜¯ä¸¤ä¸ªæ–¹æ³•çš„é”ç±»å‹ä¸åŒï¼Œé™æ€æ–¹æ³•æ˜¯ç±»é”ï¼Œéé™æ€æ–¹æ³•æ˜¯å¯¹è±¡é”ï¼Œæ‰€ä»¥ä¸ä¼šäº’æ–¥</p></li></ul></li><li><p>åœºæ™¯8</p><ul><li><p>æè¿°ï¼šåŒä¸€ä¸ªå¯¹è±¡åœ¨ä¸åŒçº¿ç¨‹ä¸­è®¿é—®ä¸åŒsynchronizedä»£ç å—æ–¹æ³•ï¼Œä¸€ä¸ªè°ƒç”¨ç±»å¯¹è±¡åŒæ­¥ï¼Œä¸€ä¸ªè°ƒç”¨ç±»å®ä¾‹åŒæ­¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SyncNormalClazz ssc = <span class="keyword">new</span> SyncNormalClazz();</span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    ssc.method3();</span><br><span class="line">&#125;, <span class="string">"snc3"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    ssc.method4();</span><br><span class="line">&#125;, <span class="string">"snc4"</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœï¼šä¸äº’æ–¥</p></li><li><p>è§£æï¼šä¸åœºæ™¯8ç›¸åŒ</p></li></ul></li></ul><h4 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h4><ul><li>å¯¹è±¡é”ä»…é”å½“å‰å¯¹è±¡ï¼Œä¸åŒå¯¹è±¡ä¹‹é—´ä¸ä¼šäº’æ–¥</li><li>é™æ€æ–¹æ³•ä¸Šçš„é”æ˜¯ç±»é”ï¼Œéé™æ€æ–¹æ³•ä¸Šçš„é”æ˜¯å¯¹è±¡é”</li><li>æ‰€æœ‰é™æ€åŒæ­¥æ–¹æ³•äº’æ–¥ï¼Œæ— è®ºæ˜¯é€šè¿‡ç±»è°ƒç”¨è¿˜æ˜¯å¯¹è±¡è°ƒç”¨</li><li>é™æ€æ–¹æ³•ä¸ŠåŠ synchronizedä¸åœ¨éé™æ€æ–¹æ³•å†…åŠ synchronized(Xxx.class)æ•ˆæœä¸€è‡´ï¼Œéƒ½æ˜¯ç±»é”</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;synchronizedå…³é”®å­—çš„ç”¨æ³•ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;ä½œç”¨åœ¨éé™æ€æ–¹æ³•ä¸Š&lt;/p&gt;
&lt;p&gt;éé™æ€æ–¹æ³•æ˜¯åªèƒ½æä¾›ç±»çš„å®ä¾‹è¿›è¡Œè°ƒç”¨ï¼Œæ‰€ä»¥å®é™…ä¸Šå°±æ˜¯å¯¹è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡åŠ é”ï¼Œä¿—ç§°å¯¹è±¡é”&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ä½œç”¨åœ¨é™æ€æ–¹æ³•ä¸Š&lt;/p&gt;
&lt;p
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>JVMå‚æ•°ä»‹ç»</title>
    <link href="http://luxiaowan.github.io/2020/05/09/JVM%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D/"/>
    <id>http://luxiaowan.github.io/2020/05/09/JVMå‚æ•°ä»‹ç»/</id>
    <published>2020-05-09T01:30:00.000Z</published>
    <updated>2020-05-14T15:51:44.663Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-jvmå¸¸ç”¨å‚æ•°"><a class="markdownIt-Anchor" href="#1-jvmå¸¸ç”¨å‚æ•°"></a> 1. JVMå¸¸ç”¨å‚æ•°</h4><table><thead><tr><th><strong>å‚æ•°åç§°</strong></th><th><strong>å«ä¹‰</strong></th><th><strong>é»˜è®¤å€¼</strong></th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>-Xms</td><td>åˆå§‹å †å¤§å°</td><td>ç‰©ç†å†…å­˜çš„1/64</td><td>é»˜è®¤(MinHeapFreeRatioå‚æ•°å¯ä»¥è°ƒæ•´)ç©ºä½™å †å†…å­˜å°äº40%æ—¶ï¼ŒJVMå°±ä¼šå¢å¤§å †ç›´åˆ°-Xmxçš„æœ€å¤§é™åˆ¶</td></tr><tr><td>-Xmx</td><td>æœ€å¤§å †å¤§å°</td><td>ç‰©ç†å†…å­˜çš„1/4</td><td>é»˜è®¤(MaxHeapFreeRatioå‚æ•°å¯ä»¥è°ƒæ•´)ç©ºä½™å †å†…å­˜å¤§äº70%æ—¶ï¼ŒJVMä¼šå‡å°‘å †ç›´åˆ° -Xmsçš„æœ€å°é™åˆ¶</td></tr><tr><td>-Xmn</td><td>å¹´è½»ä»£å¤§å°</td><td></td><td>æ­¤å¤„çš„å¤§å°æ˜¯Eden + Survivorï¼Œå’Œjmap -heapä¸­æ˜¾ç¤ºçš„New Genæ˜¯ä¸åŒçš„ã€‚ æ•´ä¸ªå †å¤§å°=å¹´è½»ä»£å¤§å° + è€å¹´ä»£å¤§å° + æŒä¹…ä»£å¤§å°(1.7åŠä¹‹å‰)ï¼Œå¢å¤§å¹´è½»ä»£åï¼Œå°†ä¼šå‡å°è€å¹´ä»£å¤§å°ï¼Œæ­¤å€¼å¯¹ç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§ï¼ŒSunå®˜æ–¹æ¨èé…ç½®ä¸ºæ•´ä¸ªå †çš„3/8</td></tr><tr><td>-XX:NewSize</td><td>å¹´è½»ä»£å¤§å°</td><td></td><td></td></tr><tr><td>-XX:MaxNewSize</td><td>å¹´è½»ä»£æœ€å¤§å€¼</td><td></td><td></td></tr><tr><td>-XX:PermSize</td><td>è®¾ç½®æŒä¹…ä»£(perm gen)åˆå§‹å€¼</td><td>ç‰©ç†å†…å­˜çš„1/64</td><td>jdk1.7åŠä¹‹å‰</td></tr><tr><td>-XX:MaxPermSize</td><td>è®¾ç½®æŒä¹…ä»£æœ€å¤§å€¼</td><td>ç‰©ç†å†…å­˜çš„1/4</td><td>jdk1.7åŠä¹‹å‰</td></tr><tr><td>-Xss</td><td>æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆå¤§å°</td><td></td><td>JDK5ä»¥åæ¯ä¸ªçº¿ç¨‹å †æ ˆå¤§å°ä¸º1Mï¼Œä¹‹å‰æ¯ä¸ªçº¿ç¨‹å †æ ˆå¤§å°ä¸º256K.æ›´å…·åº”ç”¨çš„çº¿ç¨‹æ‰€éœ€å†…å­˜å¤§å°è¿›è¡Œ è°ƒæ•´.åœ¨ç›¸åŒç‰©ç†å†…å­˜ä¸‹ï¼Œå‡å°è¿™ä¸ªå€¼èƒ½ç”Ÿæˆæ›´å¤šçš„çº¿ç¨‹ã€‚ä½†æ˜¯æ“ä½œç³»ç»Ÿå¯¹ä¸€ä¸ªè¿›ç¨‹å†…çš„çº¿ç¨‹æ•°è¿˜æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸èƒ½æ— é™ç”Ÿæˆï¼Œç»éªŒå€¼åœ¨3000~5000å·¦å³ ä¸€èˆ¬å°çš„åº”ç”¨ï¼Œ å¦‚æœæ ˆä¸æ˜¯å¾ˆæ·±ï¼Œ åº”è¯¥æ˜¯128kå¤Ÿç”¨çš„ï¼Œå¤§çš„åº”ç”¨å»ºè®®ä½¿ç”¨256kã€‚</td></tr><tr><td>-XX:ThreadStackSize</td><td>Thread Stack Size</td><td></td><td></td></tr><tr><td>-XX:NewRatio</td><td>å¹´è½»ä»£ä¸è€å¹´ä»£çš„æ¯”å€¼</td><td></td><td>-XX:NewRatio=4è¡¨ç¤ºå¹´è½»ä»£ä¸è€å¹´ä»£æ‰€å æ¯”å€¼ä¸º1:4ï¼Œå¹´è½»ä»£å æ•´ä¸ªå †æ ˆçš„1/5ï¼ŒXms=Xmxå¹¶ä¸”è®¾ç½®äº†Xmnçš„æƒ…å†µä¸‹ï¼Œè¯¥å‚æ•°ä¸éœ€è¦è¿›è¡Œè®¾ç½®ã€‚</td></tr><tr><td>-XX:SurvivorRatio</td><td>EdenåŒºä¸SurvivoråŒºçš„å¤§å°æ¯”å€¼</td><td></td><td>è®¾ç½®ä¸º8ï¼Œåˆ™ä¸¤ä¸ªSurvivoråŒºä¸ä¸€ä¸ªEdenåŒºçš„æ¯”å€¼ä¸º2:8ï¼Œä¸€ä¸ªSurvivoråŒºå æ•´ä¸ªå¹´è½»ä»£çš„1/10</td></tr><tr><td>-XX:LargePageSizeInBytes</td><td>å†…å­˜é¡µçš„å¤§å°ä¸å¯è®¾ç½®è¿‡å¤§ï¼Œ ä¼šå½±å“Permçš„å¤§å°</td><td></td><td>=128m</td></tr><tr><td>-XX:+UseFastAccessorMethods</td><td>åŸå§‹ç±»å‹çš„å¿«é€Ÿä¼˜åŒ–</td><td></td><td></td></tr><tr><td>-XX:+DisableExplicitGC</td><td>å…³é—­System.gc()</td><td></td><td>è¿™ä¸ªå‚æ•°éœ€è¦ä¸¥æ ¼çš„æµ‹è¯•</td></tr><tr><td>-XX:MaxTenuringThreshold</td><td>åƒåœ¾æœ€å¤§å¹´é¾„</td><td>15</td><td>å¦‚æœè®¾ç½®ä¸º0çš„è¯ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡ä¸ç»è¿‡SurvivoråŒºï¼Œç›´æ¥è¿›å…¥è€å¹´ä»£. å¯¹äºè€å¹´ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œå¯ä»¥æé«˜æ•ˆç‡ã€‚æ­¤å€¼é»˜è®¤ä¸º15ï¼Œå–å€¼èŒƒå›´ä¸º0~15</td></tr><tr><td>-XX:+AggressiveOpts</td><td>åŠ å¿«ç¼–è¯‘</td><td></td><td></td></tr><tr><td>-XX:+UseBiasedLocking</td><td>é”æœºåˆ¶çš„æ€§èƒ½æ”¹å–„</td><td></td><td></td></tr><tr><td>-Xnoclassgc</td><td>ç¦ç”¨åƒåœ¾å›æ”¶</td><td></td><td></td></tr><tr><td>-XX:SoftRefLRUPolicyMSPerMB</td><td>æ¯å…†å †ç©ºé—²ç©ºé—´ä¸­SoftReferenceçš„å­˜æ´»æ—¶é—´</td><td>1s</td><td></td></tr><tr><td>-XX:PretenureSizeThreshold</td><td>å¯¹è±¡è¶…è¿‡å¤šå¤§æ˜¯ç›´æ¥åœ¨æ—§ç”Ÿä»£åˆ†é…</td><td>0</td><td>å•ä½å­—èŠ‚ æ–°ç”Ÿä»£é‡‡ç”¨Parallel Scavenge GCæ—¶æ— æ•ˆ å¦ä¸€ç§ç›´æ¥åœ¨æ—§ç”Ÿä»£åˆ†é…çš„æƒ…å†µæ˜¯å¤§çš„æ•°ç»„å¯¹è±¡ï¼Œä¸”æ•°ç»„ä¸­æ— å¤–éƒ¨å¼•ç”¨å¯¹è±¡.</td></tr><tr><td>-XX:+UseTLAB</td><td>å¼€å¯TLAB</td><td></td><td>é»˜è®¤å¼€å¯</td></tr><tr><td>-XX:TLABSize</td><td>TLABå¤§å°</td><td></td><td>æ‰‹åŠ¨æŒ‡å®šTLABçš„å¤§å°</td></tr><tr><td>-XX:TLABWasteTargetPercent</td><td>TLABå edenåŒºçš„ç™¾åˆ†æ¯”</td><td>1%</td><td></td></tr><tr><td>-XX:TLABRefillWasteFraction</td><td>TLABå…è®¸æµªè´¹çš„å¤§å°æ¯”ä¾‹</td><td>64</td><td>é»˜è®¤TLABç©ºé—´çš„1/64ç©ºé—´</td></tr><tr><td>-XX:-ResizeTLAB</td><td>ç¦ç”¨ResizeTLAB</td><td></td><td></td></tr><tr><td>-XX:+CollectGen0First</td><td>FullGCæ—¶æ˜¯å¦å…ˆYGC</td><td>false</td><td></td></tr><tr><td>-XX:+HeapDumpOnOutOfMemoryError</td><td>åœ¨å‘ç”ŸOOMæ—¶åˆ°å¤„å †æ ˆä¿¡æ¯</td><td></td><td></td></tr><tr><td>-XX:HeapDumpPath</td><td>å †æ ˆä¿¡æ¯è¾“å‡ºåœ°å€</td><td></td><td></td></tr></tbody></table><h4 id="2-parallelæ”¶é›†å™¨å‚æ•°"><a class="markdownIt-Anchor" href="#2-parallelæ”¶é›†å™¨å‚æ•°"></a> 2. Parallelæ”¶é›†å™¨å‚æ•°</h4><table><thead><tr><th><strong>å‚æ•°åç§°</strong></th><th><strong>å«ä¹‰</strong></th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>-XX:+UseParallelGC</td><td>Full GCé‡‡ç”¨parallel MSC</td><td>é€‰æ‹©åƒåœ¾æ”¶é›†å™¨ä¸ºå¹¶è¡Œæ”¶é›†å™¨ã€‚æ­¤é…ç½®ä»…å¯¹å¹´è½»ä»£æœ‰æ•ˆï¼Œå³ä¸Šè¿°é…ç½®ä¸‹ï¼Œå¹´è½»ä»£ä½¿ç”¨å¹¶å‘æ”¶é›†ï¼Œè€Œè€å¹´ä»£ä»æ—§ä½¿ç”¨ä¸²è¡Œæ”¶é›†</td></tr><tr><td>-XX:+UseParNewGC</td><td>è®¾ç½®å¹´è½»ä»£ä¸ºå¹¶è¡Œæ”¶é›†</td><td>å¯ä¸CMSæ”¶é›†åŒæ—¶ä½¿ç”¨ï¼ŒJVMä¼šæ ¹æ®ç³»ç»Ÿé…ç½®è‡ªè¡Œè®¾ç½®ï¼Œæ‰€ä»¥æ— éœ€å†è®¾ç½®æ­¤å€¼</td></tr><tr><td>-XX:ParallelGCThreads</td><td>å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°</td><td>æ­¤å€¼æœ€å¥½é…ç½®ä¸å¤„ç†å™¨æ•°ç›®ç›¸ç­‰</td></tr><tr><td>-XX:+UseParallelOldGC</td><td>è€å¹´ä»£åƒåœ¾æ”¶é›†æ–¹å¼ä¸ºå¹¶è¡Œæ”¶é›†(Parallel Compacting)</td><td></td></tr><tr><td>-XX:MaxGCPauseMillis</td><td>æ¯æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶çš„æœ€é•¿æ—¶é—´(æœ€å¤§æš‚åœæ—¶é—´)</td><td>å¦‚æœæ— æ³•æ»¡è¶³æ­¤æ—¶é—´ï¼ŒJVMä¼šè‡ªåŠ¨è°ƒæ•´å¹´è½»ä»£å¤§å°ï¼Œä»¥æ»¡è¶³æ­¤å€¼.</td></tr><tr><td>-XX:+UseAdaptiveSizePolicy</td><td>è‡ªåŠ¨é€‰æ‹©å¹´è½»ä»£åŒºå¤§å°å’Œç›¸åº”çš„SurvivoråŒºæ¯”ä¾‹</td><td>è®¾ç½®æ­¤é€‰é¡¹åï¼Œå¹¶è¡Œæ”¶é›†å™¨ä¼šè‡ªåŠ¨é€‰æ‹©å¹´è½»ä»£åŒºå¤§å°å’Œç›¸åº”çš„SurvivoråŒºæ¯”ä¾‹ï¼Œä»¥è¾¾åˆ°ç›®æ ‡ç³»ç»Ÿè§„å®šçš„æœ€ä½ç›¸åº”æ—¶é—´æˆ–è€…æ”¶é›†é¢‘ç‡ç­‰ï¼Œæ­¤å€¼å»ºè®®ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨æ—¶ï¼Œä¸€ç›´æ‰“å¼€.</td></tr><tr><td>-XX:GCTimeRatio</td><td>è®¾ç½®åƒåœ¾å›æ”¶æ—¶é—´å ç¨‹åºè¿è¡Œæ—¶é—´çš„ç™¾åˆ†æ¯”</td><td>å…¬å¼ä¸º1/(1+n)</td></tr><tr><td>-XX:+ScavengeBeforeFullGC</td><td>Full GCå‰è°ƒç”¨YGC</td><td>=true</td></tr></tbody></table><h4 id="3-cmsæ”¶é›†å™¨å‚æ•°"><a class="markdownIt-Anchor" href="#3-cmsæ”¶é›†å™¨å‚æ•°"></a> 3. CMSæ”¶é›†å™¨å‚æ•°</h4><table><thead><tr><th><strong>å‚æ•°åç§°</strong></th><th><strong>å«ä¹‰</strong></th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>-XX:+UseSerialGC</td><td>ä½¿ç”¨Serialæ”¶é›†å™¨</td><td>å¹´è½»ä»£</td></tr><tr><td>-XX:+UseConcMarkSweepGC</td><td>ä½¿ç”¨CMSæ”¶é›†å™¨</td><td></td></tr><tr><td>-XX:+AggressiveHeap</td><td></td><td>è¯•å›¾æ˜¯ä½¿ç”¨å¤§é‡çš„ç‰©ç†å†…å­˜ é•¿æ—¶é—´å¤§å†…å­˜ä½¿ç”¨çš„ä¼˜åŒ–ï¼Œèƒ½æ£€æŸ¥è®¡ç®—èµ„æºï¼ˆå†…å­˜ï¼Œ å¤„ç†å™¨æ•°é‡ï¼‰ è‡³å°‘éœ€è¦256MBå†…å­˜ å¤§é‡çš„CPUï¼å†…å­˜ï¼Œ ï¼ˆåœ¨1.4.1åœ¨4CPUçš„æœºå™¨ä¸Šå·²ç»æ˜¾ç¤ºæœ‰æå‡ï¼‰</td></tr><tr><td>-XX:CMSFullGCsBeforeCompaction</td><td>å¤šå°‘æ¬¡åè¿›è¡Œå†…å­˜å‹ç¼©</td><td>ç”±äºCMSæ”¶é›†å™¨ä¸å¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©ï¼Œæ•´ç†ï¼Œæ‰€ä»¥è¿è¡Œä¸€æ®µæ—¶é—´ä»¥åä¼šäº§ç”Ÿ&quot;ç¢ç‰‡&quot;ï¼Œä½¿å¾—è¿è¡Œæ•ˆç‡é™ä½.æ­¤å€¼è®¾ç½®è¿è¡Œå¤šå°‘æ¬¡GCä»¥åå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©ï¼Œæ•´ç†.</td></tr><tr><td>-XX:+CMSParallelRemarkEnabled</td><td>é™ä½æ ‡è®°åœé¡¿</td><td></td></tr><tr><td>-XX+UseCMSCompactAtFullCollection</td><td>åœ¨FULL GCçš„æ—¶å€™ï¼Œ å¯¹è€å¹´ä»£çš„å‹ç¼©</td><td>CMSæ˜¯ä¸ä¼šç§»åŠ¨å†…å­˜çš„ï¼Œä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œ å¢åŠ è¿™ä¸ªå‚æ•°å¯ä»¥æ¶ˆé™¤ç¢ç‰‡</td></tr><tr><td>-XX:+UseCMSInitiatingOccupancyOnly</td><td>ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰åˆå§‹åŒ–å®šä¹‰å¼€å§‹CMSæ”¶é›†</td><td>ç¦æ­¢hostspotè‡ªè¡Œè§¦å‘CMS GC</td></tr><tr><td>-XX:CMSInitiatingOccupancyFraction=70</td><td>ä½¿ç”¨cmsä½œä¸ºåƒåœ¾å›æ”¶ ä½¿ç”¨70ï¼…åå¼€å§‹CMSæ”¶é›†</td><td>=92ã€‚ä¸ºäº†ä¿è¯ä¸å‡ºç°promotion failedé”™è¯¯</td></tr><tr><td>-XX:CMSInitiatingPermOccupancyFraction</td><td>è®¾ç½®Perm Genä½¿ç”¨åˆ°è¾¾å¤šå°‘æ¯”ç‡æ—¶è§¦å‘</td><td>=92</td></tr><tr><td>-XX:+CMSIncrementalMode</td><td>è®¾ç½®ä¸ºå¢é‡æ¨¡å¼</td><td>ç”¨äºå•CPUæƒ…å†µ</td></tr><tr><td>-XX:+CMSClassUnloadingEnabled</td><td></td><td></td></tr></tbody></table><h4 id="4-å…¶ä»–å‚æ•°"><a class="markdownIt-Anchor" href="#4-å…¶ä»–å‚æ•°"></a> 4. å…¶ä»–å‚æ•°</h4><table><thead><tr><th><strong>å‚æ•°åç§°</strong></th><th><strong>å«ä¹‰</strong></th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>-XX:+PrintGC</td><td>è¾“å‡ºGCåŸºæœ¬ä¿¡æ¯</td><td>è¾“å‡ºå½¢å¼ï¼š[GC (Allocation Failure)  1024K-&gt;612K(5632K)ï¼Œ 0.0021628 secs]</td></tr><tr><td>-XX:+PrintGCDetails</td><td>è¾“å‡ºGCè¯¦ç»†ä¿¡æ¯</td><td>è¾“å‡ºå½¢å¼ï¼š[GC (Allocation Failure) [PSYoungGen: 1024K-&gt;492K(1536K)] 1024K-&gt;556K(5632K)ï¼Œ 0.0024829 secs] [Times: user=0.00 sys=0.00ï¼Œ real=0.00 secs]</td></tr><tr><td>-XX:+PrintGCTimeStamps</td><td>åœ¨GCä¿¡æ¯ä¸Šè¾“å‡ºç³»ç»Ÿè¿è¡Œæ—¶é—´</td><td>è¾“å‡ºå½¢å¼ï¼š0.185: [GC (Allocation Failure)  1620K-&gt;853K(5632K)ï¼Œ 0.0008322 secs]</td></tr><tr><td>-XX:+PrintGCApplicationStoppedTime</td><td>æ‰“å°åƒåœ¾å›æ”¶æœŸé—´ç¨‹åºæš‚åœçš„æ—¶é—´.å¯ä¸ä¸Šé¢æ··åˆä½¿ç”¨</td><td>è¾“å‡ºå½¢å¼ï¼šTotal time for which application threads were stopped: 0.0006927 secondsï¼Œ Stopping threads took: 0.0000094 seconds</td></tr><tr><td>-XX:+PrintGCApplicationConcurrentTime</td><td>æ‰“å°æ¯æ¬¡åƒåœ¾å›æ”¶å‰ï¼Œç¨‹åºæœªä¸­æ–­çš„æ‰§è¡Œæ—¶é—´.å¯ä¸ä¸Šé¢æ··åˆä½¿ç”¨</td><td>è¾“å‡ºå½¢å¼ï¼šApplication time: 0.0183349 seconds</td></tr><tr><td>-XX:+PrintHeapAtGC</td><td>æ‰“å°GCå‰åçš„è¯¦ç»†å †æ ˆä¿¡æ¯ï¼Œå¯å•ç‹¬ä½¿ç”¨</td><td></td></tr><tr><td>-Xloggc:filepath</td><td>æŠŠç›¸å…³æ—¥å¿—ä¿¡æ¯è®°å½•åˆ°æ–‡ä»¶ä»¥ä¾¿åˆ†æ. ä¸ä¸Šé¢å‡ ä¸ªé…åˆä½¿ç”¨</td><td></td></tr><tr><td>-XX:+PrintClassHistogram</td><td>garbage collects before printing the histogram.</td><td>ç­‰åŒäºjmap -histo</td></tr><tr><td>-XX:+PrintTLAB</td><td>æŸ¥çœ‹TLABç©ºé—´çš„ä½¿ç”¨æƒ…å†µ</td><td>è¾“å‡ºï¼šTLAB: gc thread: 0x00007fe8d4008800 [id: 3331] desired_size: 20KB slow allocs: 8  refill waste: 320B alloc: 0.99983     1024KB refills: 42 waste  0.5% gc: 0B slow: 4576B fast: 0B<br>TLAB totals: thrds: 1  refills: 42 max: 42 slow allocs: 8 max 8 waste:  0.5% gc: 0B max: 0B slow: 4576B max: 4576B fast: 0B max: 0B</td></tr><tr><td>-XX:+PrintTenuringDistribution</td><td>æŸ¥çœ‹æ¯æ¬¡minor GCåæ–°çš„å­˜æ´»å‘¨æœŸçš„é˜ˆå€¼</td><td>è¾“å‡ºï¼šDesired survivor size 524288 bytesï¼Œ new threshold 5 (max 15)</td></tr></tbody></table><h4 id="5-å¸¸ç”¨é…ç½®"><a class="markdownIt-Anchor" href="#5-å¸¸ç”¨é…ç½®"></a> 5. å¸¸ç”¨é…ç½®</h4><ul><li>å †è®¾ç½®<ul><li>-Xmsï¼šå †åˆå§‹å¤§å°ï¼Œ-Xms10m</li><li>-Xmxï¼šå †æœ€å¤§å¤§å°ï¼Œ-Xmx20m</li><li>-Xmnï¼šæ–°ç”Ÿä»£å¤§å°ï¼Œ-Xmn5mï¼šNewSize=MaxNewSize=5m</li><li>-XX:NewSizeï¼šæ–°ç”Ÿä»£åˆå§‹å¤§å° ï¼Œ-XX:NewSize=5m</li><li>-XX:MaxNewSizeï¼šæ–°ç”Ÿä»£æœ€å¤§å¤§å°ï¼Œ-XX:MaxNewSize=10m</li><li>-XX:NewRatioï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£å¤§å°æ¯”å€¼ï¼Œ-XX:NewRatio=4ï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£æ¯”å€¼ä¸º1:4ï¼Œæ–°ç”Ÿä»£å å †çš„1/5</li><li>-XX:ServivorRatioï¼šæ–°ç”Ÿä»£ä¸­Edenå’ŒSurvivorå¤§å°æ¯”å€¼ï¼Œ-XX:SurvivorRatio=8ï¼šEdenå’ŒSurvivorçš„æ¯”ä¾‹ä¸º2:8ï¼Œä¸€ä¸ªSurvivoråŒºå æ•´ä¸ªæ–°ç”Ÿä»£å¤§å°çš„1/10</li><li>-XX:MaxTenuringThresholdï¼šæ–°ç”Ÿä»£å¯¹è±¡è½¬ç§»åˆ°è€å¹´ä»£çš„å¹´é¾„ï¼Œé»˜è®¤ä¸º15ï¼Œå€¼åŸŸ0~15ï¼Œè®¾ç½®ä¸º0çš„è¯å°±è¡¨ç¤ºæ–°ç”Ÿä»£å¯¹è±¡ä»Edenä¸ç»è¿‡SurvivoråŒºè€Œç›´æ¥è½¬ç§»åˆ°è€å¹´ä»£ï¼Œ-XX:MaxTenuringThreshold=10ï¼šæ–°ç”Ÿä»£å¯¹è±¡å¹´é¾„è¾¾åˆ°10æ—¶ï¼Œä¹Ÿå°±æ˜¯ç»å†10æ¬¡YGCä¹‹åï¼Œè½¬ç§»åˆ°è€å¹´ä»£</li></ul></li><li>åƒåœ¾æ”¶é›†å™¨è®¾ç½®<ul><li>-XX:+UseSerialGCï¼šæ–°ç”Ÿä»£ä½¿ç”¨Serialæ”¶é›†å™¨ï¼Œå¯ä¸CMSå’ŒSerial Oldæ­é…ä½¿ç”¨</li><li>-XX:+UseParNewGCï¼šæ–°ç”Ÿä»£ä½¿ç”¨ParNewæ”¶é›†å™¨</li><li>-XX:+UseParallelGCï¼šæ–°ç”Ÿä»£ä½¿ç”¨Parallel Scavengeæ”¶é›†å™¨<ul><li>-XX:+ParallelGCThreadsï¼šè®¾ç½®å¹¶è¡Œæ”¶é›†å™¨æ”¶é›†æ—¶ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œå¯ä»¥è®¾ç½®ä¸ºCPUä¸ªæ•°ï¼Œ-XX:+ParallelGCThreads=8ï¼šä½¿ç”¨8ä¸ªçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†</li><li>-XX:MaxGCPauseMillisï¼šè®¾ç½®å¹¶è¡Œæ”¶é›†çš„æœ€å¤§æš‚åœæ—¶é—´ï¼Œ-XX:MaxGCPauseTime=20ï¼Œå•ä½ï¼šæ¯«ç§’</li><li>-XX:GCTimeRatioï¼šè®¾ç½®åƒåœ¾å›æ”¶å ç”¨è¿è¡Œæ—¶é—´çš„ç™¾åˆ†æ¯”ï¼Œ-XX:GCTimeRatio=9ï¼šåƒåœ¾å›æ”¶å ç”¨æ€»è¿è¡Œæ—¶é—´çš„1/10</li></ul></li><li>-XX:+UseParallelOldGCï¼šè€å¹´ä»£ä½¿ç”¨Parallel Oldæ”¶é›†å™¨</li><li>-XX:+UseConcMarkSweepGCï¼šè€å¹´ä»£ä½¿ç”¨CMSæ”¶é›†å™¨<ul><li>-XX:+CMSIncrementalModeï¼šè®¾ç½®ä¸ºå¢é‡æ¨¡å¼ï¼Œé€‚ç”¨äºå•CPUç¯å¢ƒ</li><li>-XX:+UseCMSCompactAtFullCollectionï¼šåœ¨å‘ç”ŸFGCæ—¶å¯¹è€å¹´ä»£è¿›è¡Œå‹ç¼©</li><li>-XX:CMSFullGCsBeforeCompactionï¼šè®¾ç½®åœ¨å¤šå°‘æ¬¡FGCåï¼Œå¯¹è€å¹´ä»£è¿›è¡Œå‹ç¼©ï¼Œä¾èµ–äº-XX:+UseCMSCompactAtFullCollectionï¼Œ-XX:CMSFullGCsBeforeCompaction=5ï¼š5æ¬¡FGCåå¯¹è€å¹´ä»£è¿›è¡Œå‹ç¼©</li></ul></li><li>-XX:+UseSerialOldGCï¼šè€å¹´ä»£ä½¿ç”¨Serial Oldæ”¶é›†å™¨</li></ul></li><li>åƒåœ¾æ”¶é›†ä¿¡æ¯<ul><li>-XX:+PrintGCï¼šè¾“å‡ºGCä¿¡æ¯</li><li>-XX:+PrintGCDetailsï¼šè¾“å‡ºGCè¯¦ç»†ä¿¡æ¯</li><li>-XX:+PrintGCTimeStampsï¼šè¾“å‡ºGCæ‰§è¡Œæ—¶é—´ç‚¹ï¼ˆè™šæ‹Ÿæœºå¯åŠ¨ä¹‹åçš„æ—¶é—´ç‚¹ï¼‰</li><li>-Xloggc:filepathï¼šå°†GCä¿¡æ¯è¾“å‡ºåˆ°æŸä¸ªæ–‡ä»¶ä¸­ï¼Œä¸åœ¨æ§åˆ¶å°è¾“å‡º</li></ul></li><li>TLABè®¾ç½®<ul><li>-XX:+UseTLABï¼šå¯ç”¨TLAB</li><li>-XX:+PrintTLABï¼šè¾“å‡ºTLABä½¿ç”¨ä¿¡æ¯</li><li>-XX:-ResizeTLABï¼šç¦ç”¨resizeTLAB</li><li>-XX:TLABSizeï¼šæŒ‡å®šTLABå¤§å°</li><li>-XX:TLABWasteTargetPrecentï¼šè®¾ç½®TLABç©ºé—´å EdenåŒºçš„æ¯”ä¾‹å¤§å°ï¼Œé»˜è®¤ä¸º1%</li><li>-XX:TLABRefillWasteFractionï¼šè®¾ç½®TLABç©ºé—´å…è®¸è¢«æµªè´¹çš„æœ€å¤§ç©ºé—´æ¯”ä¾‹ï¼Œé»˜è®¤TLABç©ºé—´çš„1/64ç©ºé—´</li></ul></li><li>OOMè®¾ç½®<ul><li>-XX:+HeapDumpOnOutOfMemoryErrorï¼šå½“å‘ç”ŸOOMæ—¶è‡ªåŠ¨ç”Ÿæˆå †æ ˆä¿¡æ¯</li><li>-XX:HeapDumpPathï¼šå½“å‘ç”ŸOOMæ—¶å †æ ˆä¿¡æ¯æ–‡ä»¶è¾“å‡ºè·¯å¾„ï¼Œ-XX:HeapDumpPath=/var/data/heapd/</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;1-jvmå¸¸ç”¨å‚æ•°&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-jvmå¸¸ç”¨å‚æ•°&quot;&gt;&lt;/a&gt; 1. JVMå¸¸ç”¨å‚æ•°&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;å‚æ•°åç§°&lt;/strong&gt;&lt;/th&gt;
&lt;
      
    
    </summary>
    
    
      <category term="Java" scheme="http://luxiaowan.github.io/categories/Java/"/>
    
    
  </entry>
  
</feed>
